<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="./elements/ht-spinner/ht-spinner.html">


<link rel="import" href="./shared-styles.html">
<link rel="import" href="./scrollbar-style.html">
<link rel="import" href="./spinner-style.html">
<link rel="import" href="./dialog-style.html">

<script src="../bower_components/webcrypto-shim/webcrypto-shim.js"></script>

<dom-module id="ht-main">
	<template>
		<style include="iron-flex iron-flex-alignment"></style>
		<style include="shared-styles scrollbar-style spinner-style dialog-style">
			:host {
				display: block;
				padding: 12px 24px 24px;
				height: calc(100vh - 64px);
				box-sizing: border-box;
				--grid-columns: 1fr 1fr;
				--grid-rows: 1fr 1fr 1fr;
			}

			.grid-container {
				display:grid;
				width:100%;
				height: calc(100% - 52px);
				grid-template-columns: var(--grid-columns);
				grid-template-rows: var(--grid-rows);

				grid-template-areas: var(--grid-layout);
				grid-column-gap: 24px;
  				grid-row-gap: 24px;
			}

			.row {
				cursor: pointer;
			}

			.card {
				color: var(--app-text-color);
				background: var(--app-background-color);
				border-radius: 2px;
				@apply --shadow-elevation-2dp;
				overflow:auto;
				position: relative;
				z-index:0;
				transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
			}

			.card-title-container {
				background: #ffffff;
				padding: 0 16px;
				display: flex;
				flex-flow: row wrap;
				justify-content: space-between;
				align-items: center;
				height: 56px;
    			box-sizing: border-box;
			}

			.card-title {
                display: flex;
                flex-grow: 1;
				padding: 0;
				margin: 0;
				font-size: 16px;
				font-weight: bold;
				text-align: center;
				color: var(--app-text-color);
			}

			.card-title-container paper-icon-button{
				color: rgba(0,0,0,0);
				height: 20px;
				width: 20px;
				padding: 2px;
				transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
			}

			.card-title-container:hover paper-icon-button, .card-title-container:focus-within paper-icon-button{
				color: var(--app-text-color-disabled);
				padding: 0;
			}

			.card-body {
				display: block;
				padding: 16px;
				height: calc(100% - 96px);
				overflow: auto;
				position: relative;
			}

			.consultations-list {
				margin: 8px;
				width: calc(100% - 16px);
			}

			.row {
				width: 100%;
				display: flex;
				flex-direction: row;
				justify-content: space-around;
				align-items: center;
				flex-wrap: nowrap;
				margin-bottom: 24px;
			}

			.row:last-child {
				margin-bottom: 0;
			}

			.consultations-patient-photo {
				background: rgba(0, 0, 0, 0.1);
				height: 26px;
				width: 26px;
				border-radius: 50%;
				margin-right: 8px;
				overflow: hidden;
			}

			.consultations-patient-photo img {
				width: 100%;
				margin: 50%;
				transform: translate(-50%, -50%);
			}

			.consultations-patient-name {
				font-size: 14px;
				font-weight: bold;
				margin-right: 16px;
				text-transform: capitalize;
			}

			.consultations-message-texte {
				font-size: 14px;
				margin-right: 16px;
			}

			.consultations-patient-type {
				color: var(--app-secondary-color);
				font-size: 14px;
				margin-right: 16px;
			}

			.divider {
				border-bottom: 1px solid lightgrey;
				flex-grow: 7;
			}

			.consultations-time {
				font-size: 14px;
				text-align: right;
				margin-left: 16px;
			}

			.card-table-header {
				font-size: 10px;
				text-transform: uppercase;
				text-align: left;
			}

			.card-table-header.row {
				margin-bottom:12px;
				position:sticky;
				top:-16px;
				background: var(--app-background-color);
				z-index:1;
				border-bottom: 1px dotted var(--app-background-color-dark);
				padding:4px 0;
			}

			.card-table-header div, .card-table-cell {
				width: 50%;
			}

			.card-header-cell--date, .card-table-cell--date {
				width: 20%!important ;
			}


			.card-table-row {
				width: 100%;
			}

			.todo-card paper-listbox paper-item {
				padding: 0;
			}

            .card-table-cell {
                font-size: 14px;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                text-align: left;
                padding-right: 8px;
            }

            .card-table-header div.lab-name, .card-table-cell.lab-name {
                padding-left: 8px;
                box-sizing: border-box;
                width: 35%;
            }
            .card-table-header div.main-cell, .card-table-cell.main-cell {
                width: 55%;
            }

			.card-table-cell.main-cell, div.card-table-cell.unread {
				display: flex;
				flex-direction: row;
				flex-wrap: nowrap;
				align-items: center;
				font-size: 14px;
				font-weight:600;
			}

			.card-table-cell:first-child {
				justify-content: flex-start;
			}

			.card-table-row {
				justify-content: space-around;
				flex-wrap: nowrap;
				height:48px;
				margin:0;
                border-bottom: 1px solid var(--app-background-color-dark);
			}
            .card-table-row:hover {
                background-color: var(--app-background-color-dark);
            }



			.latest-patients-row {
				justify-content: flex-start;
			}

			.latest-patients-row:hover .consultations-patient-name,
			.latest-patients-row:hover .consultations-time,
			.latest-consultations-row:hover .consultations-patient-name,
			.latest-consultations-row:hover .consultations-time {
				text-shadow: 0 0 1px rgba(0,0,0,0.3);
			}

			.latest-consultations-row {
				justify-content: flex-start;
			}

			.patient-dateofbirth {
				color:var(--app-text-color-disabled);
				font-weight:400;
				font-size:14psx;
				font-style:italic;
			}

			#latestPatientsWidget, #todaysConsultationsWidget, #latestLabResultsWidget, #todoWidget {
				/* --columns: 1;
				--rows: 1;
				--row: 0;
				--col: 0; */
				/* grid-area: var(--row) / var(--col) / span var(--rows) / span var(--columns); */
				grid-area: var(--area);
			}

			a {
				text-decoration: none;
				color: var(--app-text-color);
			}

			paper-checkbox {
				--paper-checkbox-unchecked-color: var(--app-text-color);
				--paper-checkbox-label-color: var(--app-text-color);
				--paper-checkbox-checked-color: var(--app-secondary-color);
				--paper-checkbox-checked-ink-color: var(--app-secondary-color-dark);
			}

			paper-listbox {
				--paper-listbox-background-color: red;
				background: transparent;
				padding: 0;
			}

			paper-item {
				outline: 0;
				background: var(--app-background-color);
			}

			.new-notif::after {
				content: '';
				display: inline-block;
				width: 7px;
				height: 7px;
				margin-left: 6px;
				margin-bottom: 8px;
				border-radius: 3.5px;
				background-color: var(--app-secondary-color);
			}


			@media (max-width: 1024px) {
				.grid-container {
					/* display:grid; */
					/* width:100%;
					height:100%; */
					/* grid-template-columns: 1fr 1fr 1fr 1fr;
					grid-template-rows: 1fr 1fr; */
					grid-column-gap: 12px;
					grid-row-gap: 12px;
				}
				
				.card {
					overflow:hidden;
				}
			
				.card-body {
					overflow-x: hidden;
					overflow-y: scroll;
				}
				.card-table-cell .consultations-patient-photo, .todays-consultations .consultations-patient-photo{
					display:none;
				}

				.card-table-cell:first-child {
					text-align: left;
					display: block;
					font-weight:600;
				}

				.consultations-list {
					width:100%;
					margin:0;
				}

				.card-table-header.row{
					top: 0;
				}

			}

			@media (max-width: 950px) {
				.grid-container {
					height: calc(3 * 50%);
					padding-bottom: 24px;
				}

				.layout-buttons paper-icon-button{
					display: none;
				}
			}

			@media (max-width: 600px) {
				.grid-container {
					height: calc( 6 * 50% );
				}
			}

			.spinner {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
            }

			.layout-buttons{
				display: flex;
				flex-flow: row wrap;
				justify-content: flex-end;
				align-items: center;
				margin: 0 0 12px;
			}

			.layout-buttons paper-icon-button{
				--paper-icon-button: {
					color: var(--app-text-color-disabled);
					border-radius: 50%;
				};
				--paper-icon-button-hover: {
					color: var(--app-text-color-dark);
					background-color: var(--app-background-color-dark);
				}
			}


			#layoutDialog, #widgetSettingsDialog{
				height: 30%;
				width: 30%;
			}

			#layoutDialog .content{
				display: flex;
				flex-flow: row wrap;
				justify-content: space-around;
				align-items: center;
				padding: 24px;
			}

			.layout-button{
				height: 90%;
				width: calc((100% / 3) - 24px);
				border: 1px solid var(--app-background-color-dark);
				padding: 4px;
				display: grid;
				grid-column-gap: 4px;
 				grid-row-gap: 4px;
				transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
			}

			.layout-button:hover{
				background: var(--app-background-color-light)
			}

			.layout-button.selected{
				margin-top: -1px;
				box-shadow: var(--app-shadow-elevation-1);
			}

			.layout-button.selected span:nth-child(3n+1){
				background: var(--app-secondary-color-highlight);
			}

			.layout-button.selected span{
				background: var(--app-secondary-color);
			}


			.layout-button span:after{
				content: '';
				display: block;
				height: 100%;
				width: 0;
				position: absolute;
				background: rgba(218, 107, 107, 0.05);
				transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
			}

			.layout-button span:nth-child(2n+1):after{
				transition-delay: 0.06s;
			}

			.layout-button:hover span:after{
				width: 100%;
			}

			.layout-a{
				grid-template-columns: repeat(2, 1fr);
				grid-template-rows: repeat(3, 1fr);
			}

			.layout-b{
				grid-template-columns: repeat(3, 1fr);
				grid-template-rows: repeat(2, 1fr);
			}

			.layout-c{
				grid-template-columns: repeat(4, 1fr);
				grid-template-rows: repeat(2, 1fr);
			}

			.layout-a span, .layout-b span, .layout-c span{
				grid-column:  span 1;
				grid-row: span 1;
			}

			.layout-button span{
				background: var(--app-background-color-dark);
				position: relative;
			}

			.layout-a span:first-child{
				grid-column: 1 / span 1;
				grid-row: 1 / span 3;
			}

			.layout-b span:last-child{
				grid-column: 3 / span 1;
				grid-row: 1 / span 2;
			}

			.layout-c span:first-child{
				grid-column: 1 / span 4;
				grid-row: span 1;
			}

			paper-menu-button.widget-settings-menu div{
				width: 160px;
				height: auto;
			}

			paper-menu-button.widget-settings-menu div paper-button{
				width: 100%;
				margin: 0;
				background-color: var(--app-secondary-color);
				color: var(--app-text-color);
				text-transform: capitalize;
				font-size: 14px;
				font-weight: 500;
				border-radius: 0;
			}

			paper-menu-button.widget-settings-menu div paper-input{
				margin: 0 8px;
				--paper-input-container-input: {
					padding: 0;
				};
				--paper-input-container-focus-color: var(--app-secondary-color);
			}

			.card.dragging{
				opacity: 0.4;
				transform-origin: center center;
				transform: scale(.9);
			}

			.card.over{
				border: 3px dashed var(--app-text-color-disabled);
			}

			ht-spinner{
				height: 42px;
				width: 42px;
			}

		</style>

		<div class="layout-buttons">
			<!-- <paper-icon-button id="addWidgetButton" icon="add-box"></paper-icon-button> -->
			<paper-icon-button id="changeLayoutButton" icon="dashboard" on-tap="_layoutDialog"></paper-icon-button>
			<!-- <paper-tooltip  offset="4" for="addWidgetButton">Add a widget</paper-tooltip> -->
			<paper-tooltip  offset="4" for="changeLayoutButton">Edit layout</paper-tooltip>
		</div>
		<div id="gridContainer" class="grid-container ">
			<template is="dom-repeat" items="{{widgets}}" as="widget">
				<template is="dom-if" if="[[_isEqual(widget.id,'latestPatientsWidget')]]">
					<div id="[[widget.id]]" class="card latest-patients-card" style="--area:latestPatientsWidget;" draggable="true" on-dragstart="_dragWidgetStart" on-dragover="_dragWidgetOver" on-dragenter="_dragWidgetEnter" on-dragleave="_dragWidgetLeave" on-dragEnd="_dragWidgetEnd" on-drop="_dropWidget">
						<div class="card-title-container">
							<h1 class="card-title">[[localize('lat_pat','Latest Patients',language)]]</h1>
							<paper-menu-button class="widget-settings-menu" horizontal-align="right" close-on-activate no-overlap no-animations focused="false">
								<paper-icon-button icon="settings" slot="dropdown-trigger" alt="widget settings menu" ></paper-icon-button>
								<div slot="dropdown-content">
									<paper-input type="number" min="1" always-float-label label="Nr of columns" value="{{widget.nrCols}}"></paper-input>
									<paper-input type="number" min="1" always-float-label label="Nr of rows"  value="{{widget.nrRows}}"></paper-input>
									<!-- <paper-button on-tap="_handleWidgetChange" data-item$="{{widget}}">Apply settings</paper-button> -->
								</div>
							</paper-menu-button>
						</div>
						<div class="card-body">
							<div class="card-table-header row">
								<div class="card-header-cell">[[localize('pati','Patient',language)]]</div>
								<div class="card-header-cell card-header-cell--date">[[localize('last_edi','last edit',language)]]</div>
							</div>
							<template is="dom-repeat" items="[[accessLogs]]" as="access">
								<div class="row latest-patients-row" data-id$="[[access.patient.id]]" on-tap="openPatient">
									<div class="consultations-patient-photo"><img src$="[[picture(access.patient)]]"></div>
									<div class="consultations-patient-name">[[access.patient.firstName]] [[access.patient.lastName]] <span class="patient-dateofbirth">°[[_timeFormat(access.patient.dateOfBirth)]]</span></div>
									<div class="divider"></div>
									<div class="consultations-time">[[_timeFormat(access.access.date)]]</div>
								</div>
							</template>
							<ht-spinner class="spinner" active=[[_isLoadingLatestPatients]]></ht-spinner>
						</div>
					</div>
				</template>
				<template is="dom-if" if="[[_isEqual(widget.id,'todaysConsultationsWidget')]]">
					<div id="[[widget.id]]" class="card todays-consultations" style="--area:todaysConsultationsWidget;" draggable="true" on-dragstart="_dragWidgetStart" on-dragover="_dragWidgetOver" on-dragenter="_dragWidgetEnter" on-dragleave="_dragWidgetLeave" on-dragEnd="_dragWidgetEnd" on-drop="_dropWidget">
						<div class="card-title-container">
							<h1 class="card-title">[[localize('tod_app','Today‘s Appointment',language)]]</h1>
							<paper-menu-button class="widget-settings-menu" horizontal-align="right" close-on-activate no-overlap no-animations focused="false">
								<paper-icon-button icon="settings" slot="dropdown-trigger" alt="widget settings menu" ></paper-icon-button>
								<div slot="dropdown-content">
									<paper-input type="number" min="1" always-float-label label="Nr of columns" value="{{widget.nrCols}}"></paper-input>
									<paper-input type="number" min="1" always-float-label label="Nr of rows" value="{{widget.nrRows}}"></paper-input>
									<!-- <paper-button on-tap="_handleWidgetChange" data-item$="[[widget]]">Apply settings</paper-button> -->
								</div>
							</paper-menu-button>
						</div>
						<div class="card-body">
							<div class="card-table-header row">
								<div class="card-header-cell">[[localize('pati','Patient',language)]]</div>
								<div class="card-header-cell">[[localize('type','Type',language)]]</div>
								<div class="card-header-cell card-header-cell--date">[[localize('hour','Hour',language)]]</div>
							</div>
							<div class="consultations-list">
								<template is="dom-repeat" items="[[appointments]]" as="appointment">
									<div class="row latest-consultations-row" data-id$="[[appointment.patient.id]]" on-tap="openPatient">
										<div class="consultations-patient-photo"><img src$="[[picture(appointment.patient)]]"></div>
										<div class="consultations-patient-name">[[appointment.patient.firstName]] [[appointment.patient.lastName]]</div>
										<div class="consultations-patient-type">#[[appointment.type]]</div>
										<div class="divider"></div>
										<div class="consultations-time">[[_shortTimeFormat(appointment.startTime)]]</div>
									</div>
								</template>
							</div>
							<ht-spinner class="spinner" active=[[_isLoadingTodaysConsultations]]></ht-spinner>
						</div>
					</div>
				</template>
				<template is="dom-if" if="[[_isEqual(widget.id,'latestLabResultsWidget')]]">
					<div id="[[widget.id]]" class="card latest-lab-result" style="--area:latestLabResultsWidget;"  draggable="true" on-dragstart="_dragWidgetStart" on-dragover="_dragWidgetOver" on-dragenter="_dragWidgetEnter" on-dragleave="_dragWidgetLeave" on-dragEnd="_dragWidgetEnd" on-drop="_dropWidget">
						<div class="card-title-container">
							<h1 class="card-title new-notif">[[localize('lat_lab_res','Latest Lab Results',language)]] [[unreadCount]]</h1>
                            <paper-icon-button icon="refresh" on-tap="_updateLabResults"></paper-icon-button>
							<paper-menu-button class="widget-settings-menu" horizontal-align="right" close-on-activate no-overlap no-animations focused="false">
								<paper-icon-button icon="settings" slot="dropdown-trigger" alt="widget settings menu" ></paper-icon-button>
								<div slot="dropdown-content">
									<paper-input type="number" min="1" always-float-label label="Nr of columns" value="{{widget.nrCols}}"></paper-input>
									<paper-input type="number" min="1" always-float-label label="Nr of rows" value="{{widget.nrRows}}"></paper-input>
									<!-- <paper-button on-tap="_handleWidgetChange" data-item$="[[widget]]">Apply settings</paper-button> -->
								</div>
							</paper-menu-button>
						</div>
						<div class="card-body">
							<div class="card-table-header row">
								<div class="card-header-cell card-header-cell--date">[[localize('dat','Date',language)]]</div>
								<div class="card-header-cell">[[localize('pat_ident','Patient',language)]]</div>
								<div class="card-header-cell lab-name">[[localize('boxtitle.labResult','Laboratory',language)]]</div>
							</div>
							<template is="dom-repeat" items="[[labResults]]" as="result">
								<div class="row card-table-row" data-id$="[[result.patient.id]]" on-tap="openPatient">
									<div class="card-table-cell card-table-cell--date">[[_timeFormat(result.created)]]</div>
									<div class$="card-table-cell [[result.readStatus]]">[[result.patient.name]]</div>
									<div class="card-table-cell lab-name">[[result.descr]]</div>
								</div>
							</template>
							<ht-spinner class="spinner" active=[[_isLoadingLatestLabResults]]"></ht-spinner>
						</div>
					</div>
				</template>
				<template is="dom-if" if="[[_isEqual(widget.id,'todoWidget')]]">
					<div id="[[widget.id]]" class="card todo-card" style="--area:todoWidget;" draggable="true" on-dragstart="_dragWidgetStart" on-dragover="_dragWidgetOver" on-dragenter="_dragWidgetEnter" on-dragleave="_dragWidgetLeave" on-dragEnd="_dragWidgetEnd" on-drop="_dropWidget">
						<div class="card-title-container">
							<h1 class="card-title">[[localize('pla','Planning',language)]]</h1>
							<paper-menu-button class="widget-settings-menu" horizontal-align="right" close-on-activate no-overlap no-animations focused="false">
								<paper-icon-button icon="settings" slot="dropdown-trigger" alt="widget settings menu" ></paper-icon-button>
								<div slot="dropdown-content">
									<paper-input type="number" min="1" always-float-label label="Nr of columns" value="{{widget.nrCols}}"></paper-input>
									<paper-input type="number" min="1" always-float-label label="Nr of rows" value="{{widget.nrRows}}"></paper-input>
									<!-- <paper-button on-tap="_handleWidgetChange" data-item$="[[widget]]">Apply settings</paper-button> -->
								</div>
							</paper-menu-button>
						</div>
						<div class="card-body">
							<div class="card-table-header row">
								<div class="card-header-cell">[[localize('pati','Patient',language)]]</div>
								<div class="card-header-cell card-header-cell--date">[[localize('due_dat','Due date',language)]]</div>
								<div class="card-header-cell">[[localize('des','Description',language)]]</div>
							</div>
							<template is="dom-repeat" items="[[services]]" as="service">
								<paper-listbox>
									<paper-item>
										<div class="row card-table-row" data-id$="[[service.service.id]]">
											<div class="card-table-cell main-cell">
												<div class="consultations-patient-photo"><img src$="[[picture(service.patient)]]"></div>
												<div class="consultations-patient-name">[[service.patient.firstName]] [[service.patient.lastName]]</div>
											</div>
											<div class="card-table-cell card-table-cell--date">[[_timeFormat(service.service.valueDate)]]</div>
											<div class="card-table-cell">[[service.service.content.language.stringValue]]</div>
										</div>
									</paper-item>
								</paper-listbox>
							</template>
							<ht-spinner class="spinner" active=[[_isLoadingLatestPatients]]></ht-spinner>
						</div>
					</div>
				</template>
				<template is="dom-if" if="[[_contains(widget.id,'empty')]]">
					<div id="[[widget.id]]" class="card empty-card" on-dragstart="_dragWidgetStart" on-dragover="_dragWidgetOver" on-dragenter="_dragWidgetEnter" on-dragleave="_dragWidgetLeave" on-dragEnd="_dragWidgetEnd" on-drop="_dropWidget" style="--area:[[widget.id]];">
					</div>
				</template>
			</template>
		</div>

		<paper-dialog id="layoutDialog">
			<h2 class="modal-title">Edit layout</h2>
			<div class="content">
				<div id="layoutA" class$="layout-button layout-a [[_isSelected(selectedLayout, 'layoutA')]]" on-tap="setSelectedLayout">
					<span style="--area:latestPatientsWidget;"></span>
					<span style="--area:todaysConsultationsWidget;"></span>
					<span style="--area:latestLabResultsWidget;"></span>
					<span style="--area:todoWidget;"></span>
				</div>
				<div id="layoutB" class$="layout-button layout-b [[_isSelected(selectedLayout, 'layoutB')]]" on-tap="setSelectedLayout">
					<span></span>
					<span></span>
					<span></span>
					<span></span>
					<span></span>
				</div>
				<div id="layoutC" class$="layout-button layout-c [[_isSelected(selectedLayout, 'layoutC')]]" on-tap="setSelectedLayout">
					<span></span>
					<span></span>
					<span></span>
					<span></span>
					<span></span>
					<span></span>
					<span></span>
					<span></span>
				</div>
				<slot name="suffix"></slot>
			</div>
			<div class="buttons">
				<paper-button class="modal-button" on-tap="setFromSavedLayout" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
				<paper-button class="modal-button modal-button--save" on-tap="saveSelectedLayout" dialog-dismiss>[[localize('apply','Apply',language)]]</paper-button>
			</div>
		</paper-dialog>


	</template>

	<script>

// TODO 1 : collapse card

import moment from 'moment/src/moment';
import _ from 'lodash/lodash';
import * as models from 'icc-api/dist/icc-api/model/models';

class HtMain extends Polymer.TkLocalizerMixin(Polymer.Element) {
	static get is() {
		return 'ht-main';
	}

	static get properties() {
		return {
			api: {
				type: Object,
                noReset: true
			},
			user: {
				type: Object,
                noReset: true
			},
			accessLogs: {
				type: Array,
				value: function () {
					return [];
				}
			},
			appointments: {
				type: Array,
				value: function () {
					return [];
				}
			},
            labResults: {
				type: Array,
				value: function () {
					return [];
				}
			},
			labres: {
				type: Array,
				value: function () {
					return [];
				}
			},
			services: {
				type: Array,
				value: function () {
					return [];
				}
			},
			selectedLayout: {
				type: String,
				value: "layoutA"
			},
			layoutGrid: {
				type: Object,
				value: new GridLayout()
			},
			dragSrcEl: {
				type: Object,
				value: null
			},
			widgets: {
				type: Array,
				value: () => [
					{
						id: "latestPatientsWidget",
						nrRows: 3,
						nrCols: 1,
						posRow: 0,
						posCol: 0
					},
					{
						id: "todaysConsultationsWidget",
						nrRows: 1,
						nrCols: 1,
						posRow: 0,
						posCol: 1
					},
					{
						id: "latestLabResultsWidget",
						nrRows: 1,
						nrCols: 1,
						posRow: 1,
						posCol: 1
					},
					{
						id: "todoWidget",
						nrRows: 1,
						nrCols: 1,
						posRow: 2,
						posCol: 1
					}
				],
				notify: true,
				observers: this._applySettings,
			}
		};
	}

    static get observers() {
        return ['apiReady(user,api)', 'widgetsChanged(widgets.*)'];
    }

    constructor() {
		super();
	}

    reset() {
        const props = HtMain.properties
        Object.keys(props).forEach(k => { if (!props[k].noReset) { this.set(k, (typeof props[k].value === 'function' ? props[k].value() : (props[k].value || null))) }})
    }

    ready() {

		super.ready();

		window.addEventListener('resize', this.handleResize.bind(this))
		this.setFromSavedLayout()

    }

    apiReady() {
		if (!this.user || !this.api) { return }

		this._isLoadingLatestPatients = true;
        this.set('_isLoadingLatestLabResults',true)
		this._isLoadingTodaysConsultations = true;
		this._isLoadingToDoList = true;
		this.api.hcparty().getCurrentHealthcareParty().then(hcp => {
			const language = (hcp.languages || ['fr']).find(lng => lng && lng.length === 2);
			language && this.set('language', language);
			return hcp;
		}).then(hcp => {
			this.api.accesslog().findByUserAfterDate(this.user.id, 'USER_ACCESS', +new Date() - 1000 * 3600 * 24 * 365, null, null, 100, true).then(accessLogs => {
				const accesses = accessLogs.rows.reduce((acc, access) => {
					const latestAccessForPatId = acc[access.patientId] || (acc[access.patientId] = { access: access });
					if (latestAccessForPatId.access.date < access.date) {
						latestAccessForPatId.access = access;
					}
					return acc;
				}, {});
				return this.api.patient().getPatientsWithUser(this.user, { ids: Object.keys(accesses) }).then(patients => {
					patients.forEach(p => accesses[p.id] && (accesses[p.id].patient = p));
					this._isLoadingLatestPatients = false;
					return accesses;
				});
			}).then(accesses => this.set('accessLogs', _.sortBy(Object.values(accesses), a => -a.access.date)));

            this._updateLabResults()

			this.api.bemikrono().appointments(parseInt(moment().format('YYYYMMDD'))).then(appointments => {
				return appointments && this.api.patient().getPatientsWithUser(this.user, new models.ListOfIdsDto({ ids: appointments.map(a => a.patientId) })).then(patients => {
					//todo wtf JSON not valid
					patients.forEach((p, idx) => appointments[idx].patient = p);
					this._isLoadingTodaysConsultations = false;
					return appointments;
				});
			}).then(appointments => this.set('appointments', appointments || []));

			const start = parseInt(moment().subtract(1, 'month').format('YYYYMMDD'));
			const end = parseInt(moment().add(1, 'month').format('YYYYMMDD'));
			const maxplanningsize = 10;
			const sort = 'valueDate';
			const desc = 'desc';

			const planningFilter = { '$type': 'UnionFilter', 'filters': [{ '$type': 'ServiceByHcPartyTagCodeDateFilter', healthcarePartyId: hcp.id, tagCode: 'planned', tagType: 'CD-LIFECYCLE', startValueDate: start, endValueDate: end }, { '$type': 'ServiceByHcPartyTagCodeDateFilter', healthcarePartyId: hcp.id, tagCode: 'planned', tagType: 'CD-LIFECYCLE', startValueDate: start * 1000000, endValueDate: end * 1000000 }] };
			this.api.contact().filterServicesBy(null, null, 1000, new models.FilterChain({ filter: planningFilter })) //todo wtf JSON not valid
			.then(planningList => {
				const svcDict = planningList.rows.reduce((acc, s) => {
					const cs = acc[s.id];
					if (!cs || !cs.modified || s.modified && this.api.after(s.modified, cs.modified)) {
						acc[s.id] = s;
					}
					return acc;
				}, {});
				const services = _.sortBy(Object.values(svcDict).filter(s => !s.endOfLife), [s => +this.api.moment( /*s.modified||s.created||*/s.valueDate)]);
				const hcpId = this.user.healthcarePartyId;

				const ownersOfDelegations = services.reduce((acc, s) => {
					s.cryptedForeignKeys[hcpId].forEach(d => acc[d.owner] = 1);return acc;
				}, {});
				const importedAESHcPartyKeys = {};

				return this.api.hcparty().getHcPartyKeysForDelegate(hcpId).then(keys => Promise.all(Object.keys(ownersOfDelegations).map(ownerId => this.api.crypto().decryptHcPartyKey(ownerId, hcpId, keys[ownerId]).then(importedAESHcPartyKey => importedAESHcPartyKeys[ownerId] = importedAESHcPartyKey)))).then(() => Promise.all(services.map(s => Promise.all(s.cryptedForeignKeys[hcpId].map(k => this.api.crypto().AES.decrypt(importedAESHcPartyKeys[k.owner].key, this.api.crypto().utils.hex2ua(k.key)))).then(patIds => {
					const decodedPatIds = patIds.map(ua => this.api.crypto().utils.ua2text(ua).split(':')[1]);
					s.patId = decodedPatIds.find(id => id != null);return decodedPatIds;
				})))).then(arraysOfArraysOfPatIdsAsUa => {
					return this.api.patient().filterByWithUser(this.user, null, null, maxplanningsize, /*index*/null, sort, desc, {
						filter: {
							'$type': 'PatientByIdsFilter',
							'ids': _.uniqBy(_.compact(_.flatMap(arraysOfArraysOfPatIdsAsUa)))
						}
					});
				}).then(patients => {
					return services.map(s => ({ service: s, patient: patients.rows.find(p => p.id === s.patId) }))
				});
			}).then(services => this.set('services', (services || []).filter(it => it.patient)));
			this._isLoadingToDoList = false;

		});
	}

	_updateLabResults() {
	    console.log('update Lab Results')
        this.set('_isLoadingLatestLabResults',true)
        this.api.contact().getServiceCodesOccurences('labResult',0).then(occurences=>{
            let occurList = []
            occurences.map(occurence=>occurList.push(occurence.label))
            return occurList
        }).then((occurList)=>{
            return this.api.contact().getContactsWithUser(this.user,{ids:occurList}).then(cs=>{
                let resList = []
                cs.forEach(c=>{
                    console.log('c',c)
                    const svc = c.services.filter(s=> s.label==='labResult')
                    resList.push({
                        patient: {name: svc[0].content.patientName ? svc[0].content.patientName.stringValue : 'no patient or test',id: svc[0].content.patientId ? svc[0].content.patientId.stringValue : '0'},
                        created: c.created,
                        descr: c.descr,
                        readStatus: 'unread'
                    })
                })
                let unreadCount = 0
                resList.forEach(res=>{if(res.readSatus === 'unread') unreadCount+= 1})
                this.set('unreadCount',unreadCount)
                this.set('_isLoadingLatestLabResults',false)
                return _.sortBy(resList,'created').reverse()
            }).then(resList=> this.set('labResults',resList || []))
        })
    }

	_timeFormat(date) {
		return date && this.api.moment(date).format(date > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY') || '';
	}

	_shortTimeFormat(date) {
		return date && this.api.moment(date).format(date > 99991231 ? 'HH:mm' : 'DD/MM/YYYY') || '';
	}

	_isSelected(a, b) {
		return (a === b) ? 'selected' : ''
	}

	_isEqual(a, b) {
		return (a === b)
	}

	_contains(a, b) {
		return a.includes(b)
	}
	picture(pat) {
		if (!pat) {
			return require('../images/male-placeholder.png');
		}
		return pat.picture ? 'data:image/png;base64,' + pat.picture : pat.gender === 'female' ? require('../images/female-placeholder.png') : require('../images/male-placeholder.png');
	}

	openPatient(ev) {
		let target = ev.target;
		while (target && !target.dataset.id) {
			target = target.parentNode;
		}
		location.replace(location.href.replace(/(.+?)#.*/, `$1#/pat/${target.dataset.id}`));
	}

	// openLabResult(ev) {
	// 	let target = ev.target;
    //     while (target && !target.dataset.id) {
    //         target = target.parentNode;
    //     }
	// 	console.log(target)
    //     console.log(target.dataset.id)
	// 	// location.replace(location.href.replace(/(.+?)#.*/, `$1#/msg/${target.dataset.id}`));
	// }

	_layoutDialog(e){
		e.stopPropagation()
		e.preventDefault()
		this.$['layoutDialog'].open()
	}

	_dragWidgetStart(e) {
		e.target.classList.add('dragging')
		this.dragSrcEl = e.target.id
	}

	_dragWidgetOver(e){
		e.preventDefault()	
		return false
	}

	_dragWidgetEnter(e){
		e.target.closest(".card").classList.add('over')
	}

	_dragWidgetLeave(e){
		e.target.parentNode.classList.remove('over')
	}

	_dragWidgetEnd() {
		this.shadowRoot.querySelectorAll('.card').forEach(card => card.classList.remove('over') )
		this.shadowRoot.querySelector('#'+this.dragSrcEl).classList.remove('dragging')
	}

	_dropWidget(e) {
		e.stopPropagation();
		this._swap(e.currentTarget.id)
		this.shadowRoot.querySelector('#'+this.dragSrcEl).classList.remove('dragging')
		return false;
	}

	setSelectedLayout(e) {

		this.set('selectedLayout', e.currentTarget.id)

		switch (this.selectedLayout) {
			case 'layoutA':
				this.widgets = WIDGETSA
				break;
			case 'layoutB':
				this.widgets = WIDGETSB
				break;
			case 'layoutC':
				this.widgets = WIDGETSC
				break;
			case 'layoutTab':
				this.widgets = WIDGETSTAB
				break;
			case 'layoutMobile':
				this.widgets = WIDGETSMOBILE
				break;
			default:
				this.widgets = WIDGETSA
				break;
		}

		this.updateGrid(false)

	}

	saveSelectedLayout(e) {

		e.preventDefault();

		this.updateGrid()

	}

	handleResize(e) {

		if (this.layoutGrid.setLayoutFromSize(e.target.innerWidth)) {

			this.setSelectedLayout({currentTarget: { id: this.layoutGrid.layout } })

			this.layoutGrid.save(this.user, this.widgets)
		}

	}

	setFromSavedLayout() {

		const storage = JSON.parse(localStorage.getItem(`org.taktik.icure.${this.user.id}.settings.main.grid`))

		if (storage) {
			this.set('selectedLayout', storage.layout)
			this.set('widgets', storage.widgets)
		}

		this.layoutGrid.setFromStorage(this.user, this.widgets)

		this.setStyles(this.layoutGrid.styleStrings)

	}

	updateGrid(save = true) {

		this.sanitizeEmpties()

		this.layoutGrid
			.setGridSize(this.selectedLayout)
			.init()
			.fill(this.widgets)

		const empties = this.layoutGrid.getEmptySpaces()
		this.push('widgets', ...empties)

		this.setStyles(this.layoutGrid.styleStrings)

		if (save) this.layoutGrid.save(this.user, this.widgets)
	}

	sanitizeEmpties() {


		this.set('widgets', this.widgets.filter(widget => {
			if (widget && widget.id) {
				return !widget.id.includes('empty')
			}
		}))
	}

	setStyles(styleStrings) {
		this.updateStyles({ '--grid-columns': styleStrings.gridCol, '--grid-rows': styleStrings.gridRow })
		this.updateStyles({ '--grid-layout': styleStrings.templateArea })
	}

	_swap(elToSwap) {

		const idx1 = this.widgets.findIndex(k => k.id === this.dragSrcEl)
		const idx2 = this.widgets.findIndex(k => k.id === elToSwap )

		const temp = this.widgets[idx1]
		this.widgets[idx1] = this.widgets[idx2]
		this.widgets[idx2] = temp

		this.widgets[idx1].id = this.dragSrcEl
		this.widgets[idx2].id = elToSwap

		this.updateGrid()
	}

	widgetsChanged(e){

		const path = e.path

		const index = parseInt(path.split('.')[1])

		if((index + 1)) {

			const newWidget = this.layoutGrid.computeCardSize(this.widgets[index])

			const currentWidget = this.widgets[index];

			if(
				currentWidget.nrCols != newWidget.nrCols || 
				currentWidget.nrRows != newWidget.nrRows ||
				currentWidget.posCol != newWidget.posCol || 
				currentWidget.posRow != newWidget.posRow
			) {

				this.set(['widgets', index], newWidget)

			}else {
				this.updateGrid()
			}


		}

	}

}


class GridLayout {

	constructor() {

		this.grid = []
		this.cols = 0;
		this.rows = 0;
		this.layout = 'layoutA';

	}

	init() {

		const grid = []

		for (let row = 0; row < this.rows; row++) {
			grid.push([])
			for (let col = 0; col < this.cols; col++) {
				grid[row][col] = 'empty'
			}
		}

		this.grid = grid

		return this;

	}

	fill(widgets) {

		const widgetsInOrder = widgets.sort( (a, b) => a.order - b.order )

		widgetsInOrder.map( (widget, index) => {

			for( let rowIndex = 0; rowIndex < widget.nrRows; rowIndex++ ){

					for( let colIndex = 0; colIndex < widget.nrCols; colIndex++ ) {

							this.grid[widget.posRow + rowIndex][widget.posCol + colIndex] = widget.id

					}

			}

		})

		return this;

	}

	computeCardSize(w) {

		const widget = _.clone(w,true)

		if(widget) {

			// Calculate the available space around the card
			let rowSpace = 0;
			let spaceUnder = 0;
			let rowIsPartOfCard = false;

			let rowsData = [];

			for( let rowIndex = 0; rowIndex < this.grid.length; rowIndex++) {

				let colSpace = 0
				let spaceRight = 0

				let colIsPartOfCard = false


				// COLUMNS
				for (let colIndex = 0; colIndex < this.grid[widget.posRow].length; colIndex++) {

					const widgetId = this.grid[rowIndex][colIndex]
					if (widgetId.includes('empty') || widgetId == widget.id) {

						if (colIsPartOfCard) {
							spaceRight++
						} else if (widget.posCol == colIndex) {
							colIsPartOfCard = true
						}

						colSpace++

					} else if (!colIsPartOfCard) {
						colSpace = 0
					} else {
						break;
					}

				}


				//We add column data for every row even if the row is not available
				const colData = { space: colSpace, rightSide: spaceRight };
				rowsData.push(colData)

				//ROWS
				if(colIsPartOfCard) {

					if (rowIsPartOfCard) {
						spaceUnder++
					} else if (widget.posRow == rowIndex) {
						rowIsPartOfCard = true
					}

					rowSpace++

				}else if(!rowIsPartOfCard) {

					rowSpace = 0

				} else {

					break;

				}


			}

			// Now scale or move vertically, according to need or possibility
			if(widget.nrRows > rowSpace) widget.nrRows = rowSpace
			if( widget.nrRows > spaceUnder + 1) widget.posRow -= widget.nrRows - (spaceUnder + 1)


			// calculate minimum available horizontal space for the above computed occupied rows
			let minSpace = Infinity,
				minRightSpace = Infinity

			for( let rowIndex = widget.posRow; rowIndex < widget.posRow + parseInt(widget.nrRows); rowIndex++) {

				minSpace = minSpace > rowsData[rowIndex].space ? rowsData[rowIndex].space : minSpace;
				minRightSpace = minRightSpace > rowsData[rowIndex].rightSide ? rowsData[rowIndex].rightSide : minRightSpace;

			}

			// Now scale or move horizontally, according to need or possibility
			if (widget.nrCols > minSpace) widget.nrCols = minSpace
			if (widget.nrCols <= minRightSpace + 1) return widget

			widget.posCol -= widget.nrCols - (minRightSpace + 1)

			return widget
				

		}


	}

	getEmptySpaces() {

		const empties = []

		for (let rowIndex in this.grid) {
			for (let colIndex in this.grid[rowIndex]) {

				if (this.grid[rowIndex][colIndex].includes('empty')) {

					const idName = "empty" + empties.length
					this.grid[rowIndex][colIndex] = idName;

					empties.push({
						id: idName,
						nrRows: 1,
						nrCols: 1,
						posCol: parseInt(colIndex),
						posRow: parseInt(rowIndex)
					})

				}



			}
		}

		return empties

	}

	setFromStorage(user, widgets) { 

		const savedGridLayout = localStorage.getItem(`org.taktik.icure.${user.id}.settings.main.grid`)

		if (savedGridLayout) {

			this.clone( JSON.parse(savedGridLayout) )

			if( this.setLayoutFromSize(window.innerWidth) ) {

				this.init().fill(widgets).save(user,widgets)

			}

		}else if(widgets) {

			this.setGridSize('layoutA').init().fill(widgets).save(user,widgets)

		}

		return this

	}

	clone(nGrid) {

		this.grid = nGrid.grid;
		this.cols = nGrid.cols;
		this.rows = nGrid.rows;
		this.layout = nGrid.layout;

		return this

	}

	save(user, widgets) {

		const data = {}

		Object.assign(data, this)
		data.widgets = widgets
		data.size = window.innerWidth

		localStorage.setItem(`org.taktik.icure.${user.id}.settings.main.grid`, JSON.stringify(data))

		return this

	}

	setGridSize(layout = this.layout) {
		
		switch (layout) {
			case 'layoutA':
				this.cols = 2;
				this.rows = 3;
				break;
			case 'layoutB':
				this.cols = 3;
				this.rows = 2;
				break;
			case 'layoutC':
				this.cols = 4;
				this.rows = 2;
				break;
			case 'layoutTab':
				this.cols = 2;
				this.rows = 3;
				break;
			case 'layoutMobile':
				this.cols = 1;
				this.rows = 6;
				break;
			default:
				this.cols = 2;
				this.rows = 3;
				break;
		}

		this.layout = layout

		return this;
	} 

	setLayoutFromSize(size) {

		if( size >= 950 ){
			
			if( this.layout == 'layoutTab' || this.layout == 'layoutMobile') {
			
				this.setGridSize('layoutA')
				return true

			}

			return false

		}

		if( size > 600 ) {

			this.setGridSize('layoutTab')
			return true
		}

		this.setGridSize('layoutMobile')
		return true
	}

	get styleStrings() {

		const layout = this.layout
		const gridCol = `repeat(${this.cols}, 1fr)`
		const gridRow = `repeat(${this.rows}, 1fr)`

		let templateArea = "";

		this.grid.map(row => {
			templateArea += "\'"
			row.forEach(area => {
				templateArea += area ? area + " " : ". "
			})
			templateArea += "\' "
		})

		return { layout, gridCol, gridRow, templateArea }

	}

}

const WIDGETSA = [
		{
			id: "latestPatientsWidget",
			nrRows: 3,
			nrCols: 1,
			posRow: 0,
			posCol: 0
		},
		{
			id: "todaysConsultationsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 0,
			posCol: 1
		},
		{
			id: "latestLabResultsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 1,
			posCol: 1
		},
		{
			id: "todoWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 2,
			posCol: 1
		}
	]

const WIDGETSB = [
		{
			id: "latestPatientsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 0,
			posCol: 0
		},
		{
			id: "todaysConsultationsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 0,
			posCol: 1
		},
		{
			id: "latestLabResultsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 1,
			posCol: 0
		},
		{
			id: "todoWidget",
			nrRows: 2,
			nrCols: 1,
			posRow: 0,
			posCol: 2
		}
	]

const WIDGETSC = [
		{
			id: "latestPatientsWidget",
			nrRows: 1,
			nrCols: 4,
			posRow: 0,
			posCol: 0
		},
		{
			id: "todaysConsultationsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 1,
			posCol: 2
		},
		{
			id: "latestLabResultsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 1,
			posCol: 0
		},
		{
			id: "todoWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 1,
			posCol: 3
		}
	]

const WIDGETSTAB = [
		{
			id: "latestPatientsWidget",
			nrRows: 2,
			nrCols: 1,
			posRow: 0,
			posCol: 0
		},
		{
			id: "todaysConsultationsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 0,
			posCol: 1
		},
		{
			id: "latestLabResultsWidget",
			nrRows: 2,
			nrCols: 1,
			posRow: 1,
			posCol: 1
		},
		{
			id: "todoWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 2,
			posCol: 0
		}
	]

const WIDGETSMOBILE = [
		{
			id: "latestPatientsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 0,
			posCol: 0
		},
		{
			id: "todaysConsultationsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 1,
			posCol: 0
		},
		{
			id: "latestLabResultsWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 2,
			posCol: 0
		},
		{
			id: "todoWidget",
			nrRows: 1,
			nrCols: 1,
			posRow: 3,
			posCol: 0
		}
	]

customElements.define(HtMain.is, HtMain);
</script>
</dom-module>
