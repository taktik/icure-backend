<link rel="import" href="../../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-grid.html">

<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">


<link rel="import" href="../../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../../../bower_components/tk-token-field/tk-token-field.html">

<link rel="import" href="../../../../scrollbar-style.html">
<link rel="import" href="../../../../spinner-style.html">

<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="ht-pat-mcn-chapteriv-verse.html">

<dom-module id="ht-pat-mcn-chapteriv-agreement">
    <template>
        <style include="scrollbar-style spinner-style">
            #dialog {
                min-height: 600px;
                min-width: 800px;
                height: 80%;
                width: 80%;
            }

            .links {
                position: absolute;
                right: 0;
            }

            .pills {
                float: right;
            }

            dynamic-link {
                float: right;
                top: 4px;
            }

            .container {
                margin: 0;
                padding: 0;
                display: grid;
                height: calc(100% - 108px);
                width: 100%;
                grid-template-columns: 25% auto;
                grid-template-rows: 100%;
                box-sizing: border-box;
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .list-panel {
                height: 100%;
                background: var(--app-background-color);
                grid-column: 1/2;
                grid-row: 1/1;
                display: inline-grid;
                grid-template-columns: 1fr;
                grid-template-rows: calc(280px) 1fr 48px;
                margin-top: 0;
                padding: 0;
                box-sizing: border-box;
            }

            .list-panel.search-load-container-collapsed {
                grid-template-rows: calc(40px + 16px) 1fr 48px;
            }

            .searchLoadContainer{
                grid-column: 1/1;
                grid-row: 1/1;
                display: flex;
                flex-flow: row wrap;
                padding: 0 12px;
            }

            .searchLoadContainer .tool{
                height: 57px;
                margin: 0;
            }

            .searchLoadContainer vaadin-date-picker.tool{
                width: calc(50% - 8px);
                box-sizing: border-box;
            }

            #_chapter_listbox{
                outline: 0;
                background: transparent;
                padding: 8px 24px;
                grid-column: 1/1;
                grid-row: 2/2;
                overflow-y: overlay;
                overflow-x: hidden;
                --paper-listbox-selected-item: {
                    color: var(--app-text-color-light);
                    background: var(--app-primary-color);
                };
            }

            .bottom-btn-container {
                width: 100%;
                height: 100%;
                grid-column: 1/1;
                grid-row: 3/3;
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                padding: 4px 0;
                box-sizing: border-box;
            }

            .detail-panel {
                height: 100%;
                margin: 0;
                grid-column: 2/2;
                grid-row: 1/1;
                padding: 0 24px;
                box-sizing: border-box;
                position: relative;
                display: inline-grid;
                grid-template-columns: 1fr;
                grid-template-rows: 56px calc(100% - 56px);
            }

            .detail-panel vaadin-combo-box {
                grid-column: 1/1;
                grid-row: 1/1;
                width: 100%;
                height: 72px;
            }

            .detail-panel .paragraph{
                grid-column: 1/1;
                grid-row: 2/2;
                display:flex;
                flex-flow: column nowrap;
                justify-content: space-between;
            }

            iron-pages{
                align-self: stretch;
                overflow-y: overlay;
                flex-grow: 1;
            }

            page {
                height:100%;
            }

            .detail-panel div.paragraph-content {
                position: relative;
                text-align: justify;
                padding: 0 24px;
                overflow-y: auto;
            }

            .detail-panel div.paragraph-content p{
                padding-bottom: 12px;
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .chapterDateInfo {
                font-size: 12px;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                padding: 4px 0;
                max-height: 24px;
            }
            .chapterDateInfo > div{
                height: 100%;
                max-height: 24px;
            }

            .chapterDateInfo span {
                margin-left: 4px;
            }

            .chapterDateInfoIcon {
                height: 14px;
                width: 14px;
            }

            .chapter-text {
                background: transparent;
                flex-direction: column;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
                height: 100%;
                padding: 0;
            }

            .chapter-text:focus::before, .chapter-text:focus::after {
                background: transparent;
            }

            .chapter-text-row p {
                width: 100%;
                text-overflow: ellipsis;
                overflow-x: hidden;
                white-space: nowrap;
            }

            .chapter-text-row h4 {
                width: 100%;
            }


            .chapter-item .chapter-text-row {
                width: calc(100% - 32px);
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                font-size: 12px;
                @apply --padding-right-left-16;
            }

            .chapter-text-date {
                justify-content: space-between !important;
                position: relative;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, .1);
                @apply --padding-right-left-16;
                color: var(--app-text-color-disabled);
                height: 24px;
            }

            paper-material.iron-selected > .chapter-text > .chapter-text-date {
                color: var(--app-text-color-light) !important;
            }

            .chapter--big {
                min-height: 96px;
                outline: 0;
                /*@apply --padding-16;*/
                /*border-bottom: 1px solid var(--app-background-color-dark);*/
            }

            .chapter--small {
                min-height: 32px;
                /*@apply --padding-right-left-16;*/
                padding-bottom: 8px;
            }

            .chapter--small .chapter-text-row:nth-child(2) {
                justify-content: space-between;
            }

            .chapter--small .chapter-text-row:last-child {
                display: none;
            }

            .chapter--small .he-dots-container {
                display: none;
            }



            .bottom-btn {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                background: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: bold;
                font-size: 12px;
                height: 40px;
                min-width: 100px;
                @apply --shadow-elevation-2dp;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .message {
                height: 40px;
                padding: 0 24px;
                flex-grow: 2;
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: flex-start;
            }

            .warning {
                color: #c8a100;
                background: #fcdf3521;
                padding: 0 8px;
                font-weight: bold;
                width: fit-content;
            }

            .error {
                color: var(--app-error-color);
                background: #e539353b;
                font-weight: bold;
                border-radius: 2px;
                padding: 0 8px;
                width: fit-content;
            }

            paper-listbox {
                background: transparent;
            }

            .addedDocuments {
                position: absolute;
                top: 16px;
                right: 16px;
            }

            ul {
                list-style: none;
            }

            ul.outer-ul {
                padding-left: 0;
            }

            iron-icon.smaller {
                padding-right: 8px;
                width: 16px;
                height: 16px;
            }

            paper-button[disabled] {
                background-color: var(--app-secondary-color-dark);
                color: var(--app-text-color-disabled);
                box-shadow: none;
            }

            paper-tabs {
                height: 40px;
                min-height: 40px;
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                --paper-tabs: {
                    color: var(--app-text-color);
                };
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            paper-tab.iron-selected {
                font-weight: bold;
            }

            paper-tab.iron-selected iron-icon {
                opacity: 1;
            }

            paper-tab iron-icon {
                opacity: 0.5;
                color: var(--app-text-color);
            }

            .detail-panel .tool-container {
                width: calc(100% - 48px);
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: flex-start;
                box-sizing: border-box;
                margin: 0 8px;
                height: 103px;
                min-height: 103px;
            }

            .detail-panel .btns-container{
                padding: 4px 0;
            }

            vaadin-date-picker {
                min-width: 132px;
            }

            .tool {
                padding: 0 4px;
                flex-grow: 1;
                height: 50%;
            }

            tk-token-field.tool {
                min-width: 180px;
                height: 80px;
                flex-grow: 3;
            }
            vaadin-checkbox.tool{
                height: auto;
            }

            #appendix-upload-container {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                z-index: 1000;
                display: none;
            }

            vaadin-upload {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                margin: 16px 16px 0;
                min-height: 280px;
                background: var(--app-background-color);
                --vaadin-upload-buttons-primary: {
                    padding: 16px;
                };
                --vaadin-upload-button-add: {
                    background: var(--app-secondary-color);
                    color: var(--app-text-color);
                };
                --vaadin-upload-file-progress: {
                    --paper-progress-active-color: var(--app-secondary-color);
                };
                --vaadin-upload-file-commands: {
                    color: var(--app-primary-color);
                }

            }

            .close-button-icon {
                position: absolute;
                top: 16px;
                right: 16px;
                margin: 0;
                transform: translate(50%, -50%);
                height: 32px;
                width: 32px;
                padding: 8px;
                background: var(--app-primary-color);
            }

            .chapter-item {
                height: 90px;
                width: auto;
                box-shadow: var(--shadow-elevation-3dp_-_box-shadow);
                margin-top: 12px;
            }

            .chapter-item h4 {
                font-size: 14px;
                font-weight: 600;
                margin: 0;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */

                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;

            }

            .ichapter-item .label-container {
                display: flex;
                flex-flow: row nowrap;
            }

            .chapter-item.iron-selected {
                background: var(--app-primary-color);
                color: var(--app-light-color);
                @apply --text-shadow;
            }

            .chapter-item:first-child {
                margin-top: 0;
            }

            .chapter-item:nth-of-type(1) .chapter-text-row p {
                padding-right: 32px;
            }

            .chapter-item .colour-code:not(:first-child) {
                margin-left: 4px;
            }

            .chapter-item p {
                @apply --paper-font-body1;
                margin: 0;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */

                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;
            }

            .chapter-item-title {
                height: 20px;
                width: auto;
                background: rgba(0, 0, 0, .1);
            }



            .layout.vertical {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                flex-wrap: nowrap;
            }

            .ch4AcceptedStatus {
                height: 10px;
                width: 10px;
                color: var(--app-status-color-ok);
            }

            .ch4PendingStatus {
                height: 10px;
                width: 10px;
                color: var(--app-status-color-pending);
            }



            .modal-title {
                background: var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }

            .modal-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .buttons {
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 48px;
                display: flex;
                flex-flow: row wrap;
                justify-content: space-between;
                padding: 4px 0;
                box-sizing: border-box;
            }

            .accepted-status {
                background: #00f9743b;
                border-radius: 20px;
                padding: 1px 12px 1px 8px;
                width: auto;
                font-size: 12px;
                line-height: 16px;
            }
            .pending-status {
                background: #fcdf354d;
                border-radius: 20px;
                padding: 1px 12px 1px 8px;
                width: auto;
                font-size: 12px;
                line-height: 16px;
            }

            .chapter-list-spinner {
                grid-column: 1/1;
                grid-row: 2/2;
                place-self: center center;
            }

            .paragraph-spinner {
                position: absolute;
                grid-column: 1/1;
                grid-row: 2/2;
                place-self: center center;
            }

            .ioref-icon{
                opacity: 0.7;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .ioref-icon:hover{
                opacity: 1;
            }

            .searchLoadContainer .search-load-container-collapsed {
                max-height: 40px;
                overflow-y: hidden;
            }

            .options-bar {
                position: relative;
                text-overflow: ellipsis;
                overflow-x: hidden;
                white-space: nowrap;
                width: 100%;
                height: 40px;
                padding: 8px 0;
            }

            .options-bar paper-icon-button {
                position: absolute;
                right: 0;
                top: 0;
            }
            .small-text {
                width: 100%;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
                text-decoration: none;
                font-weight: lighter;
                font-size: 0.8em;
            }
        </style>

        <paper-dialog id="dialog" opened="{{opened}}">
            <h2 class="modal-title">[[localize('chap-iv','Chapter IV',language)]]</h2>
            <div class="container">
                <div class$="list-panel [[searchLoadContainerClass(searchLoadContainerCollapsed)]]">
                    <div class="searchLoadContainer">
                        <div class$="[[searchLoadContainerClass(searchLoadContainerCollapsed)]]">
                            <div class="chapter-text-row grey options-bar">
                                [[_formatDateShort(consultationStartDateAsString)]] - [[_formatDateShort(consultationEndDateAsString)]] - [[_formatParagraph(selectedLoadParagraph, language)]]
                                <paper-icon-button class="menu-item-icon" icon="hardware:keyboard-arrow-down" hover="none" on-tap="toggleMenu"></paper-icon-button>
                            </div>
                            <vaadin-date-picker class="tool" i18n="[[i18n]]" initial-position="[[initialFrom]]"
                                            label="[[localize('From','From',language)]]"
                                            value="{{consultationStartDateAsString}}"></vaadin-date-picker>

                            <vaadin-date-picker class="tool" i18n="[[i18n]]" initial-position="[[initialTo]]"
                                            label="[[localize('To','To',language)]]"
                                            value="{{consultationEndDateAsString}}"></vaadin-date-picker>

                            <paper-input class="tool" label="[[localize('par','Paragraph',language)]]"
                                     value="{{selectedLoadParagraph}}"></paper-input>
                        </div>
                    </div>
                    <paper-listbox id="_chapter_listbox" selectable="paper-material"
                                   selected="{{selectedAgreementIndex}}">
                        <template is="dom-repeat" items="[[_agreements(medications.*, orphanAgreements.*)]]">
                            <paper-material class="layout vertical chapter-item chapter--big"
                                            id="[[item.ioDecisionReference]]">
                                <paper-item class="chapter-text">
                                    <div class="chapter-text-row chapter-text-date">
                                        <label>
                                            <iron-icon icon="vaadin:book" class="chapterDateInfoIcon"></iron-icon>
                                            [[item.paragraph]]
                                        </label>
                                        <div>
                                            <iron-icon icon="vaadin:calendar-clock"
                                                        class="chapterDateInfoIcon"></iron-icon>
                                                <span>[[_formatDate(item.start)]]</span>
                                                &nbsp;
                                                <iron-icon icon="vaadin:calendar-clock"
                                                        class="chapterDateInfoIcon"></iron-icon>
                                                <span>[[_formatDate(item.ioDecisionEndOfValidity)]]</span>
                                            </div>

                                    </div>
                                    <div class="chapter-text-row grey">
                                        <h4>
                                            <div class="small-text">[[item.paragraphName]]</div>
                                            [[item.strength]] [[item.strengthUnit]]
                                            <template is="dom-repeat" items="[[item.medications]]">
                                                [[item]],
                                            </template>
                                        </h4>
                                        <div class="chapterDateInfo">
                                            <template is="dom-if" if="[[item.accepted]]">
                                                <span class="accepted-status">
                                                    <iron-icon icon="vaadin:circle" class="ch4AcceptedStatus"></iron-icon>
                                                    [[localize('ch4Accept','Accepted',language)]]
                                                </span>
                                            </template>
                                            <template is="dom-if" if="[[item.inTreatment]]">
                                                <span class="pending-status">
                                                    <iron-icon icon="vaadin:book" class="ch4PendingStatus"></iron-icon>
                                                    [[localize('ch4Pending','Pending',language)]]
                                                </span>
                                            </template>
                                            <iron-icon class="chapterDateInfoIcon ioref-icon" id="ioref-[[item.ioDecisionReference]][[item.ioRequestReference]]" icon="info"></iron-icon>
                                            <paper-tooltip for="ioref-[[item.ioDecisionReference]][[item.ioRequestReference]]" position="left" animation-delay="0">[[item.ioDecisionReference]] [[item.ioRequestReference]]</paper-tooltip>

                                        </div>
                                    </div>
                                </paper-item>
                            </paper-material>
                        </template>
                    </paper-listbox>
                    <paper-spinner class="spinner chapter-list-spinner" alt="Loading chapter4 list" active=[[_isLoadingChapter]]></paper-spinner>
                    <div class="bottom-btn-container">
                        <paper-button disabled="[[_isLoadingChapter]]" class="bottom-btn" on-tap="_loadChapter4">[[localize('load_agr','Load
                            agr.',language)]]
                        </paper-button>
                    </div>
                </div>
                <div class="detail-panel" on-dragover="_onDrag">
                    <vaadin-combo-box id="entities-list" filtered-items="[[searchResults]]" value="{{cbValue}}"
                                      on-filter-changed="_filterChanged" item-label-path="descr"
                                      selected-item="{{selectedParagraph}}" item-value-path="id"
                                      label="[[localize('sea_for_par','Search for paragraph‚ medication‚ pathology...',language)]]"></vaadin-combo-box>
                    <paper-spinner class="spinner paragraph-spinner" alt="Loading chapter4 list" active=[[_isLoadingParagraph]]></paper-spinner>
                    <div class="paragraph">
                        <template is="dom-if" if="[[paragraph]]">
                            <paper-tabs selected="{{tabs}}">
                                <paper-tab class="adm-tab">
                                    <iron-icon class="smaller" icon="vaadin:clipboard-text"></iron-icon>
                                    [[localize('que_form','Query Form',language)]]
                                </paper-tab>
                                <paper-tab class="adm-tab">
                                    <iron-icon class="smaller" icon="vaadin:family"></iron-icon>
                                    [[localize('agr_res','Agreement response',language)]]
                                </paper-tab>
                            </paper-tabs>


                            <iron-pages selected="[[tabs]]" class="">
                                <page>
                                    <div class="paragraph-content">
                                        <h2>[[localize('chapter','Chapter',language)]] [[paragraph.chapterName]],
                                            [[localize('paragraph','Paragraph',language)]]
                                            [[paragraph.paragraphName]]</h2>
                                        <template is="dom-if" if="[[addedDocuments.length]]">
                                            <paper-dropdown-menu id="addedDocuments" class="addedDocuments" label="Annexes"
                                                                on-selected-item-changed="_downloadAnnex">
                                                <paper-listbox slot="dropdown-content" class="dropdown-content">
                                                    <template id="addedDocumentsDr" is="dom-repeat" items="[[addedDocuments]]">
                                                        <paper-item>
                                                            <template is="dom-if" if="[[_isFrench(language)]]">
                                                                [[item.descrFr]]
                                                            </template>
                                                            <template is="dom-if" if="[[!_isFrench(language)]]">
                                                                [[item.descrNl]]
                                                            </template>
                                                        </paper-item>
                                                    </template>
                                                </paper-listbox>
                                            </paper-dropdown-menu>
                                        </template>
                                        <p>
                                            <template is="dom-if" if="[[_isFrench(language)]]">[[paragraph.keyStringFr]]
                                            </template>
                                            <template is="dom-if" if="[[_isDutch(language)]]">[[paragraph.keyStringNl]]
                                            </template>
                                        </p>
                                        <ul class="outer-ul">
                                            <ht-pat-mcn-chapteriv-verse verse="[[paragraph.headerVerse]]"
                                                                        checked-verses="{{checkedVerses}}"
                                                                        language="[[language]]"></ht-pat-mcn-chapteriv-verse>
                                        </ul>
                                    </div>
                                </page>
                                <page>
                                    <div class="paragraph-content">
                                        <template is="dom-if" if="[[agreementResponse]]">
                                            <template is="dom-if" if="[[agreementResponse.acknowledge]]">
                                                <h3>[[localize('the_req_was_suc', 'The request was successfully transmitted
                                                    to the IO', language)]]</h3>
                                            </template>
                                            <template is="dom-if" if="[[agreementResponse.acknowledge]]">
                                                <h3>[[localize('the_req_cou_not', 'The request could not be successfully
                                                    transmitted to the IO', language)]]</h3>
                                            </template>
                                            <template is="dom-if" if="[[agreementResponse.errors.length]]">
                                                <h4>Error(s)</h4>
                                                <template is="dom-repeat" items="[[agreementResponse.errors]]" as="e">
                                                    <p class="error">[[localizeObjectKey(e,'msg',language)]] [ code :
                                                        [[e.code]], path: [[e.path]] ]</p>
                                                </template>
                                            </template>
                                            <template is="dom-if" if="[[agreementResponse.warnings.length]]">
                                                <h4>Warning(s)</h4>
                                                <template is="dom-repeat" items="[[agreementResponse.warnings]]" as="e">
                                                    <p class="warning">[[localizeObjectKey(e,'msg',language)]] [ code :
                                                        [[e.code]], path: [[e.path]] ]</p>
                                                </template>
                                            </template>
                                            <template is="dom-repeat" items="[[agreementResponse.transactions]]" as="t">
                                                <h4>[[localize('agr_res','Agreement response',language)]],
                                                    [[_formatDateTime(t.timestamp)]]</h4>
                                                <template is="dom-if" if="[[t.accepted]]">
                                                    <p>[[localize('status','Status',language)]]:
                                                        [[localize('agreed','Agreement conceded',language)]]</p>
                                                </template>
                                                <template is="dom-if" if="[[t.inTreatment]]">
                                                    <p>[[localize('status','Status',language)]]:
                                                        [[localize('req_in_tre','Request in treatment',language)]]</p>
                                                </template>
                                                <template is="dom-if" if="[[_none(t.accepted, t.inTreatment)]]">
                                                    <p>[[localize('status','Status',language)]]:
                                                        [[localize('req_in_tre','Request rejected',language)]]</p>
                                                    <p>[[localize('ref_jus','Justification of refusal',language)]]:
                                                        <template is="dom-if" if="[[_isFrench(language)]]">
                                                            <span class="error">[[t.refusalJustification.fr]]</span>
                                                        </template>
                                                        <template is="dom-if" if="[[!_isFrench(language)]]">
                                                            <span class="error">[[t.refusalJustification.nl]]</span>
                                                        </template>
                                                    </p>
                                                </template>
                                                <p>[[localize('ref_io','Reference IO',language)]]: [[t.decisionReference]]</p>
                                                <p>[[localize('from','From',language)]]: [[_formatDate(t.start)]]</p>
                                                <p>[[localize('to','to',language)]]: [[_formatDate(t.end)]]</p>
                                                <h4>[[localize('tec_dat','Technical data',language)]]</h4>
                                                <p>[[localize('req_ref_io','Request Reference IO',language)]]: [[t.ioRequestReference]]</p>
                                                <p>[[localize('raw_res','Raw response',language)]]: [[t.responseType]]</p>
                                                <h4>[[localize('medications','Medications',language)]]</h4>
                                                <vaadin-grid id="insurabilities-list" class="material" overflow="bottom"
                                                             items="[[_mpps(t.paragraph, agreementMpps.*)]]"
                                                             active-item="{{selectedMedication}}">
                                                    <vaadin-grid-column flex-grow="10">
                                                        <template class="header">
                                                            <vaadin-grid-sorter path="mut">
                                                                [[localize('medication','Medication',language)]]
                                                            </vaadin-grid-sorter>
                                                        </template>
                                                        <template>
                                                            <div class="cell frozen">[[item.name]])</div>
                                                        </template>
                                                    </vaadin-grid-column>
                                                    <vaadin-grid-column flex-grow="1">
                                                        <template class="header">
                                                            <vaadin-grid-sorter path="periodStart">
                                                                [[localize('selected','Selected',language)]]
                                                            </vaadin-grid-sorter>
                                                        </template>
                                                        <template>
                                                            <div class="cell frozen">
                                                                <vaadincheckbox checked="{{item.selected}}"></vaadincheckbox>
                                                            </div>
                                                        </template>
                                                    </vaadin-grid-column>
                                                </vaadin-grid>
                                            </template>
                                            <h4>[[localize('tec_dat','Technical data',language)]]</h4>
                                            <p>commonInput: [[agreementResponse.commonOutput.inputReference]]</p>
                                            <p>nipReference: [[agreementResponse.commonOutput.nipReference]]</p>
                                            <p>commonOutput: [[agreementResponse.commonOutput.outputReference]]</p>
                                        </template>
                                    </div>
                                </page>
                            </iron-pages>

                            <div class="tool-container">
                                <vaadin-date-picker class="tool" i18n="[[i18n]]" initial-position="[[initialFrom]]"
                                                    label="[[localize('From','From',language)]]"
                                                    value="{{fromAsString}}"></vaadin-date-picker>
                                <vaadin-date-picker class="tool" i18n="[[i18n]]" initial-position="[[initialTo]]"
                                                    label="[[localize('To','To',language)]]"
                                                    value="{{toAsString}}"></vaadin-date-picker>
                                <tk-token-field class="tool" label="Appendices" value="{{appendicesTokens}}"
                                                on-value-splices-change="_localizedValueChanged" data-value-path="id"
                                                data-label-path="descr" always-float-label></tk-token-field>
                                <vaadin-checkbox class="tool" checked="{{incomplete}}">[[localize('incomplete request',
                                    'incomplete
                                    request', language)]]
                                </vaadin-checkbox>
                            </div>
                            <div class="btns-container">
                                <template is="dom-if" if="[[isAgreementSelected]]">
                                    <paper-button class="bottom-btn" id="cancelChapter" on-tap="_cancelChapter">[[localize('can_agr','Cancel
                                        agreement',language)]]
                                    </paper-button>
                                    <paper-button class="bottom-btn" id="closeChapter" on-tap="_closeChapter">[[localize('clos_agr','Close
                                        agreement',language)]]
                                    </paper-button>
                                    <paper-button class="bottom-btn" id="extendChapter" on-tap="_requestChapter4">[[localize('ext_agr','Extend
                                        agreement',language)]]
                                    </paper-button>
                                </template>

                                <template is="dom-if" if="[[!isAgreementSelected]]">
                                    <paper-button class="bottom-btn" id="requestChapter" on-tap="_requestChapter4">
                                        [[localize('req_agr','Request
                                        agreement',language)]]
                                    </paper-button>
                                </template>
                            </div>

                            <div id="appendix-upload-container">
                                <vaadin-upload id="appendix-upload" no-auto files="{{appendices}}"
                                               accept="image/jpeg,application/pdf"
                                               target="[[api.host]]/document/{documentId}/attachment/multipart" method="PUT"
                                               form-data-name="attachment"
                                               on-upload-success="_fileUploaded"></vaadin-upload>
                                <paper-fab class="close-button-icon" icon="icons:close" on-tap="_hideUpload"></paper-fab>
                            </div>
                        </template>
                    </div>
                    <template is="dom-if" if="[[loadResponse]]">

                    </template>
                </div>
            </div>
            <div class="buttons">
                <div class="message">
                    <div class="warning">[[warnings]]</div>
                    <div class="error">[[errors]]</div>
                </div>
                <paper-button class="modal-button" dialog-dismiss>[[localize('clo','Close',language)]]
                </paper-button>
            </div>
        </paper-dialog>

    </template>
    <script>
        import moment from 'moment/src/moment'

        class HtPatMcnChapterIVAgreement extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-mcn-chapteriv-agreement'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        value: null,
                        noReset: true
                    },
                    language: {
                        type: String,
                        noReset: true
                    },
                    appendices: {
                        type: Array,
                        value: () => []
                    },
                    appendicesTokens: {
                        type: Array,
                        value: () => []
                    },
                    errors: {
                        type: String,
                        value: null
                    },
                    warnings: {
                        type: String,
                        value: null
                    },
                    opened: {
                        type: Boolean,
                        value: false,
                        noReset: true
                    },
                    paragraph: {
                        type: Object,
                        value: () => null
                    },
                    searchResults: {
                        type: Array,
                        value: () => []
                    },
                    selectedParagraph: {
                        type: Object,
                        observer: "_selectedParagraphChanged"
                    },
                    displayedParagraph: {
                        type: Object,
                        observer: "_displayedParagraphChanged"
                    },
                    medications: {
                        type: Array,
                        value: () => []
                    },
                    orphanAgreements: {
                        type: Array,
                        value: () => []
                    },

                    tabs: {
                        type: Number,
                        value: 0
                    },
                    initialFrom: {
                        type: String,
                        value: () => moment().startOf('month').format('YYYY-MM-DD')
                    },
                    initialTo: {
                        type: String,
                        value: () => moment().endOf('month').format('YYYY-MM-DD')
                    },
                    fromAsString: {
                        type: String,
                        value: () => moment().startOf('month').format('YYYY-MM-DD')
                    },
                    toAsString: {
                        type: String
                    },
                    selectedAgreementIndex: {
                        type: Number,
                        value: null
                    },
                    isAgreementSelected: {
                        type: Boolean,
                        value: false
                    },
                    consultationStartDateAsString: {
                        type: String,
                        value: () => moment().startOf('month').format('YYYY-MM-DD')
                    },
                    consultationEndDateAsString: {
                        type: String,
                        value: () => moment().endOf('month').format('YYYY-MM-DD')
                    },
                    selectedLoadParagraph: {
                        type: String
                    },
                    searchLoadContainerCollapsed: {
                        type: Boolean,
                        value: true
                    }
                }
            }

            static get observers() {
                return ['_appendicesChanged(appendices.*)', '_appendicesTokenChanged(appendicesToken.*)', '_selectAgreementInList(selectedAgreementIndex)']
            }

            reset() {
                const props = HtPatMcnChapterIVAgreement.properties
                Object.keys(props).forEach(k => { if (!props[k].noReset) { this.set(k, (typeof props[k].value === 'function' ? props[k].value() : (props[k].value || null))) }})
            }

            ready() {
                super.ready()
                this.addEventListener('iron-resize', () => this.onWidthChange())
            }

            attached() {
                super.attached()
                this.async(this.notifyResize, 1)
            }

            searchLoadContainerClass(collapsed) {
                return collapsed ? 'search-load-container-collapsed' :''
            }

            toggleMenu() {
                this.set('searchLoadContainerCollapsed',!this.searchLoadContainerCollapsed)
            }

            _filterChanged(text) {
                if (text.detail && text.detail.value && text.detail.value.length > 2) {
                    const searchString = text.detail.value
                    this.latestSearchString = searchString
                    setTimeout(() => {
                        if (this.latestSearchString !== searchString) {
                            return
                        }
                        this.api.fhc().Chaptercontroller().findParagraphsUsingGET(searchString, this.language).then((paragraphs) => {
                            if (searchString === this.latestSearchString) {
                                this.set('searchResults', paragraphs.map(p => ({
                                    id: `${p.paragraphName}/${p.paragraphVersion}`,
                                    descr: `${p.paragraphName} - ${p.keyStringFr}`
                                })))
                            }
                        })
                    }, 600)
                } else {
                    this.set('searchResults', [])
                }
            }

            _selectedParagraphChanged() {
                if (this.selectedParagraph && this.selectedParagraph.id) {
                    this.set('agreementResponse', [])
                    this.set('selectedAgreementIndex', null);

                    this.set('isAgreementSelected', false)

                    this.set('displayedParagraph', this.selectedParagraph);
                    this.set('tabs', 0)
                }
            }

            _displayedParagraphChanged() {
                if (this.displayedParagraph && this.displayedParagraph.id) {
                    (this.displayedParagraph.ioRequestReference || this.displayedParagraph.ioDecisionReference) ? this.set('isAgreementSelected', true) : this.set('isAgreementSelected', false)
                    this.set('checkedVerses', [])
                    this.set('paragraph', [])
                    const paragraph = this.displayedParagraph.id.split('/')[0]
                    ;(this.displayedParagraph.paragraphInfo ? Promise.resolve(this.displayedParagraph.paragraphInfo) : this.api.fhc().chaptercontrollerfhc.getParagraphInfosUsingGET('IV', paragraph))
                        .then(pi => {
                            this.set('paragraph', pi)
                            return this.api.fhc().Chaptercontroller().getAddedDocumentsUsingGET('IV', paragraph)
                        })
                        .then(addedDocuments => {
                            console.log(addedDocuments)
                            this.set('addedDocuments', addedDocuments)
                        })

                } else {
                    this.set('paragraph', null)
                }
            }


            onWidthChange() {
                /*const offsetWidth = this.$.dialog.offsetWidth
                const offsetHeight = this.$.dialog.offsetHeight
                if (!offsetWidth || !offsetHeight) {
                    return
                }*/
            }

            close() {
                this.set('opened', false)
            }

            open() {
                this.set('opened', true)
            }

            _none(a, b, c) {
                return !a && !b && !c
            }

            _formatParagraph(p) {
                return p || this.localize('any','Any')
            }

            _formatDate(d) {
                return d && this.api.moment(d).format('DD/MM/YYYY')
            }

            _formatDateShort(d) {
                return d && this.api.moment(d).format('DD/MM/YY')
            }

            _formatDateTime(d) {
                return d && this.api.moment(d).format('DD/MM/YYYY HH:mm:ss')
            }

            _isFrench(language) {
                return this.language === 'fr'
            }

            _isDutch(language) {
                return this.language === 'nl'
            }

            _convertedMedications() {
                return (this.medications || []).filter(svc => Object.values(svc.content).some(c => !!c.medicationValue.options && c.medicationValue.options.ioChapter4Paragraph)).map(svc => {
                    const content = svc.content.find(c => !!c.medicationValue.options.ioChapter4Paragraph)
                    return {
                        id: svc.id,
                        paragraphName: content.medicationValue.options.ioChapter4ParagraphName,
                        paragraph: content.medicationValue.options.ioChapter4Paragraph,
                        verses: content.medicationValue.options.ioChapter4Verses,
                        ioRequestReference: content.medicationValue.options.ioRequestReference,
                        ioDecisionReference: content.medicationValue.options.ioDecisionReference,
                        ioDecisionEndOfValidity: content.medicationValue.options.ioDecisionEndOfValidity,
                        medication: this.api.contact().shortServiceDescription(svc, this.language)
                    }
                })
            }

            _agreements() {
                return this._convertedMedications().concat(this.orphanAgreements)
            }

            _mpps(p) {
                //const mpps = this.agreementMpps && this.agreementMpps.mpps.find(mpps => mpps.paragraph === p)
                return  this.agreementMpps && this.agreementMpps.mpps
            }

            _loadChapter4() {
                this._isLoadingChapter = true;
                this.set('agreementResponse', [])
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
                    this.api.fhc().Chaptercontroller().agreementRequestsConsultationUsingGET(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.nihii, hcp.ssin, hcp.firstName, hcp.lastName,
                        this.patient.ssin, this.patient.dateOfBirth, this.patient.firstName, this.patient.lastName, this.patient.gender, null, this.selectedLoadParagraph !== "" ? this.selectedLoadParagraph : null, this.api.moment(this.consultationStartDateAsString).valueOf(), this.consultationEndDateAsString !== "" ? this.api.moment(this.consultationEndDateAsString).valueOf() : null)
                ).then(agreements => {
                    if (agreements.warnings && agreements.warnings.length) {
                        this.set('warnings', agreements.warnings.map(w => w.msgFr).join(', '))
                    }
                    if (agreements.errors && agreements.errors.length) {
                        this.set('errors', agreements.errors.map(w => w.msgFr).join(', '))
                    }
                    console.log(agreements)
                    const medications = this._convertedMedications()
                    const ioRequestReferences = medications.map(x => x.ioRequestReference)
                    const ioDecisionReferences = medications.map(x => x.ioDecisionReference)
                    return Promise.all(
                        agreements.transactions.map(t => Promise.all([this.api.fhc().chaptercontrollerfhc.getVtmNamesForParagraphUsingGET('IV', t.paragraph, this.language), this.api.fhc().chaptercontrollerfhc.getParagraphInfosUsingGET('IV', t.paragraph)]).then(([vtm, pi]) => [t, vtm, pi]))
                    ).then((transactions) => {
                        this.set('orphanAgreements', transactions.filter(([t]) => !((t.ioRequestReference && ioRequestReferences.includes(t.ioRequestReference)) || (t.decisionReference && ioDecisionReferences.includes(t.decisionReference))))
                            .map(([t, vtm, pi]) => ({
                                careProviderReference: t.careProviderReference,
                                content: t.content,
                                coverageType: t.coverageType,
                                refusalJustification: t.refusalJustification,
                                paragraph: t.paragraph,
                                paragraphName: this.localizeObjectKey(pi,'keyString', this.language),
                                ioRequestReference: t.ioRequestReference,
                                ioDecisionReference: t.decisionReference,
                                ioDecisionEndOfValidity: t.end,
                                start: t.start,
                                strength: t.strength,
                                strengthUnit: t.strengthUnit,
                                accepted: t.accepted,
                                inTreatment: t.inTreatment,
                                end: t.end,
                                responseType: t.responseType,
                                timestamp: t.timestamp,
                                unitNumber : t.unitNumber,
                                medications: vtm,
                                paragraphInfo: pi
                            })))
                        this.set('agreementResponse', agreements)
                    })
                }).finally(() => {
                    this._isLoadingChapter = false;
                })
            }

            _requestChapter4(e) {
                this.set('agreementResponse', {})
                const requestType = (e.target && e.target.id === "requestChapter") ? "newrequest" :
                                    (e.target && e.target.id === "extendChapter" && (this.api.moment(this.fromAsString).diff(this.api.moment(this.displayedParagraph.end), "days")) === 1 ) ? "extension" :
                                    (e.target && e.target.id === "extendChapter" && (this.api.moment(this.fromAsString).diff(this.api.moment(this.displayedParagraph.end), "days")) > 1 ) ? "noncontinuousextension" :
                            null   //newrequest, extension, noncontinuousextension, complimentaryannex

                if (requestType != null) {
                    this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
                        Promise.all(this.appendicesTokens.map(ap =>
                            this.api.document().getDocument(ap.id)
                                .then(doc =>
                                    this.api.document().getAttachment(doc.id, doc.attachmentId)
                                ).then(a => ({
                                    verseSeq: ap.verseSeq,
                                    documentSeq: ap.docSeq,
                                    data: btoa(new Uint8Array(a).reduce((data, byte) => data + String.fromCharCode(byte), '')),
                                    mimeType: 'application/pdf',
                                    path: ap.name
                                })
                            ))
                        ).then(appendices =>
                            this.api.fhc().Chaptercontroller().requestAgreementUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                                hcp.nihii, hcp.ssin, hcp.firstName, hcp.lastName,
                                this.patient.ssin, this.patient.dateOfBirth, this.patient.firstName, this.patient.lastName, this.patient.gender,
                                requestType, this.paragraph.paragraphVersion, this.paragraph.paragraphName,
                                this.checkedVerses.join(','), appendices, this.incomplete, requestType !== "complimentaryannex" ? this.api.moment(this.fromAsString).valueOf() : null , null,
                                (requestType === "extension" || requestType === "noncontinuousextension" || requestType === "complimentaryannex") ? this.displayedParagraph.ioDecisionReference : null,
                                ((requestType === "noncontinuousextension" || requestType === "complimentaryannex") && !this.displayedParagraph.ioDecisionReference) ? this.displayedParagraph.ioRequestReference : null)
                        )
                    ).then(res => {
                        console.log(res)
                        this.set('agreementResponse', res)
                        this.set('tabs', 1)

                        return Promise.all(((res || {}) && res.transactions || []).map(t => this.api.fhc().Chaptercontroller().getMppsForParagraphUsingGET('IV', t.paragraph).then(it => ({
                            paragraph: t.paragraph,
                            mpps: it
                        })))).then(links =>
                            this.set('agreementMpps', links)
                        )
                    })
                }

            }

            _annexBaseName(addedDoc) {
                return `${this.paragraph.paragraphName}_${this.paragraph.paragraphVersion}_${addedDoc.verseSeq}_${addedDoc.documentSeq}_${this.localizeObjectKey(addedDoc, 'descr')}`
            }

            _downloadAnnex(e) {
                if (e && e.detail && e.detail.value) {
                    const tpl = this.root.querySelector('#addedDocumentsDr').modelForElement(e.detail.value)
                    if (tpl.item.addressUrl) {
                        const url = `${this.api.fhcHost}/chap4/sam/docpreview/IV/${this.paragraph.paragraphName}/${tpl.item.verseSeq}/${tpl.item.documentSeq}/${this.language}`
                        var a = document.createElement('a')
                        return fetch(url, {
                            method: 'GET'
                        }).then((resp) => {
                            return resp.blob();
                        }).then((blob) => {
                            a.href = window.URL.createObjectURL(blob);
                            a.download = `${this._annexBaseName(tpl.item)}.pdf`
                            a.click();
                            return null
                        }).finally(() => a.remove())
                    }
                }
                this.root.querySelector('#addedDocuments').set('value', null)
            }

            _appendicesTokenChanged() {
                const files = _.clone(this.appendices)
                files.forEach(f => {
                    if (!this.appendicesTokens.map(x => x && x.id).includes(f.doc.id)) {
                        this.splice('appendices', this.appendices.indexOf(f), 1)
                    }
                })
            }

            _appendicesChanged() {
                const files = _.clone(this.appendices)
                const vaadinUpload = this.root.querySelector('#appendix-upload')

                Promise.all(files.filter(f => !f.attached).map(f => {
                    f.attached = true
                    return this.api.document().newInstance(this.user, null, {
                        documentType: 'result',
                        mainUti: this.api.document().uti(f.type, f.name.replace(/.+\.(.+)/,'$1')),
                        name: f.name
                    }).then(d => this.api.document().createDocument(d)).then(d => {
                        f.doc = d
                        f.uploadTarget = (f.uploadTarget || vaadinUpload.target).replace(/\{documentId\}/, d.id)
                        return f
                    })
                })).then(files => {
                    if (files.length) {
                        vaadinUpload.uploadFiles(files)
                        files.forEach(f => {
                            const regAnnex = this.addedDocuments.find(a => f.name.startsWith(this._annexBaseName(a))) || {}
                            this.appendicesTokens.map(x => x && x.id).includes(f.doc.id) || this.push('appendicesTokens', {
                            descr: f.name.replace(/^(.{5})...+(.{5})$/, '$1…$2'),
                            id: f.doc.id,
                            name: f.name,
                            docSeq: regAnnex.documentSeq,
                            verseSeq: regAnnex.verseSeq
                        })})
                    }
                })
            }

            _hideUpload() {
                this.root.querySelector('#appendix-upload-container').style.display = 'none'
            }

            _onDrag() {
                this.root.querySelector('#appendix-upload-container').style.display = 'block'
            }

            _selectAgreementInList(idx) {
                if (!idx && idx !== 0) {
                    this.set('isAgreementSelected', false)
                    this.set('cbValue', '')
                    this.set('displayedParagraph', null);
                    this.set('agreementResponse', null);
                    this.set('agreementMpps', null);

                    return
                }
                this._isLoadingParagraph = true
                const selectedAgreement = this._agreements()[idx]

                ;(selectedAgreement.paragraphInfo ? Promise.resolve(selectedAgreement.paragraphInfo) : this.api.fhc().chaptercontrollerfhc.getParagraphInfosUsingGET('IV', selectedAgreement.paragraph))
                    .then(pi => {
                        this.set('isAgreementSelected', true)
                        this.set('cbValue', '')
                        this.set('displayedParagraph', {
                            descr: pi.headerVerse.textFr,
                            id: pi.paragraphName,
                            ioRequestReference: selectedAgreement.ioRequestReference,
                            ioDecisionReference: selectedAgreement.ioDecisionReference,
                            start: selectedAgreement.start,
                            end: selectedAgreement.ioDecisionEndOfValidity,
                            paragraphInfo : pi
                        })
                        this.set('agreementResponse', {
                            transactions: [selectedAgreement]
                        })

                       this.api.fhc().Chaptercontroller().getMppsForParagraphUsingGET('IV', selectedAgreement.paragraph).then(it => ({
                            paragraph: selectedAgreement.paragraph,
                            mpps: it
                        })).then(links =>
                            this.set('agreementMpps', links)
                        )
                        this._isLoadingParagraph = false
                 })
            }

            _closeChapter(e) {
                if (this.displayedParagraph) {
                    this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => this.api.fhc().chaptercontrollerfhc.closeAgreementUsingDELETE(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, hcp.nihii, hcp.ssin, hcp.firstName, hcp.lastName,
                        this.patient.ssin, this.patient.dateOfBirth, this.patient.firstName, this.patient.lastName, this.patient.gender, this.displayedParagraph.ioDecisionReference, this.displayedParagraph.ioRequestReference))
                        .then(response => {
                            this.set('agreementResponse', response)
                            this.set('tabs', 1)
                            console.log(response)
                        })
                }

            }

            _cancelChapter(e) {
                if (this.displayedParagraph) {
                    this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => this.api.fhc().chaptercontrollerfhc.cancelAgreementUsingDELETE(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, hcp.nihii, hcp.ssin, hcp.firstName, hcp.lastName,
                        this.patient.ssin, this.patient.dateOfBirth, this.patient.firstName, this.patient.lastName, this.patient.gender, this.displayedParagraph.ioDecisionReference))
                        .then(response => {
                            this.set('agreementResponse', response)
                            this.set('tabs', 1)
                            console.log(response)
                        })
                }
            }
        }

        customElements.define(HtPatMcnChapterIVAgreement.is, HtPatMcnChapterIVAgreement)
    </script>
</dom-module>

