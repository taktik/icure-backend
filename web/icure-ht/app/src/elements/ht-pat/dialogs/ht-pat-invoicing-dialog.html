<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">

<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">


<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">


<link rel="import" href="../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="related-code-link.html">

<dom-module id="ht-pat-invoicing-dialog">
    <template>
        <style>


            .invoice-item {
                height: 90px;
                width: auto;
                box-shadow: var(--shadow-elevation-3dp_-_box-shadow);
                margin-top: 12px;
            }

            .invoice-item:first-child{
                margin-top: 0;
            }

            .invoice-item-title {
                height: 20px;
                width: auto;
                background: rgba(0, 0, 0, .1);
            }

            #invoiceDialog {
                height: calc(100vh - 40px);
                width: calc(100% - 40px);
                z-index: 1100;
                display: grid;
                grid-template-columns: 20% 80%;
                grid-template-rows: 100%;
                position: fixed;
                top: 64px;
                left: 0;
                bottom: 0;
                right: 0;
            }

            .invoice-panel {
                height: 100%;
                background: var(--app-background-color-dark);
                box-shadow: var(--shadow-elevation-3dp_-_box-shadow);
                grid-column: 1/2;
                grid-row: 1/1;
                z-index: 3;
                overflow-y: auto;
                margin-top: 0px;
                padding: 24px;
                box-sizing: border-box;
            }

            .detail-panel {
                height: calc(100% - 80px);
                background: var(--app-background-color);
                /*box-shadow: var(--shadow-elevation-2dp_-_box-shadow);*/
                border-bottom: 1px solid var(--app-background-color-dark);
                margin: 0;
                grid-column: 2/2;
                grid-row: 1/1;
                z-index: 2;
                overflow-y: auto;
                padding: 24px;
                box-sizing: border-box;
            }

            .invoice-header {
                height: auto;
                width: auto;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
            }

            .invoice-nomenclature-code {
                height: auto;
                overflow-y: auto;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                margin-top: 24px;
            }

            .invoice-detail {
                min-height: 200px;
                height: auto;
                width: auto;
                overflow-y: auto;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                margin-top: 12px;
                margin-bottom: 12px;
            }

            .buttons {
                position: absolute;
                bottom: 20px;
                right: 22px;
            }

            .modal-button{
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--save{
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-secondary-color-dark);
                --paper-input-container-invalid-color: var(--app-error-color);
            }

            .flex-container {
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: flex-start;
            }

            .flex-container-nmcl {
                display: flex;
                flex-flow: row nowrap;
                align-items: flex-end;
            }

            .flex-container-nmcl-row {
                flex: 1;
                padding: 4px;
            }

            .flex-container-descr-nmcl-row {
                flex: 8;
                padding: 4px;
            }

            vaadin-text-field{
                padding: 0;
            }

            #invoice-type {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-mode {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-number {
                flex: 1;
                margin: 0;
                padding-top: 3px;
                --paper-input-container-underline: {
                    opacity: 0.42;
                }
            }

            #invoice-date {
                flex: 1;
                margin: 0;
                padding: 8px 8px 0;
            }

            #invoice-period {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-careProviderType {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-nihiiTrainee {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-thirdPartyJustification {
                flex: 3;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            #invoice-dmg {
                flex: 1;
                margin: 0;
                padding: 3px 8px 0 8px;
                --paper-input-container-underline: {
                    opacity: 0.42;
                }
            }

            #invoice-creditNote {
                flex: 1;
                margin: auto;
                padding: 0 8px 0 8px;
            }

            .title {
                height: 20px;
                color: var(--app-text-color);
                background-color: var(--app-background-color-dark);
                font-weight: 700;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
            }

            .title-txt {
                padding-left: 8px;
                width: 100%;
            }

            .invoice-nomenclature-code-container {
            }

            .nmcl-descr {
                overflow-y: auto;
                height: 332px;
            }

            .nmcl-favorite {
                display: flex;
                height: 25px;
                padding: 5px;
            }

            .nmcl-favorite span{
                margin-right: 8px;
            }

            .invoice-nomenclature-code-option {
                display: flex;
                padding: 0 8px;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: space-around;
                margin-bottom: 15px;
            }

            .nmcl-list {
                overflow-y: auto;
            }

            #nmclGrid {
                height: 202px;
            }

            #nmcl-search {
                flex: 1;
            }

            .invoice-item {
                background: var(--app-light-color);
                color: var(--app-text-color);
                outline: 0;
                padding: 0;
                align-items: flex-start !important;
                @apply --shadow-elevation-2dp;
                position: relative;
            }

            .invoice-item .label-container {
                display: flex;
                flex-flow: row nowrap;
            }

            .invoice-item.iron-selected {
                background: var(--app-primary-color);
                color: var(--app-light-color);
                @apply --text-shadow;
            }

            .invoice-item h4 {
                font-size: 14px;
                font-weight: 600;
                margin: 0;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */

                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;

            }

            .invoice-item .invoice-text-row {
                width: calc(100% - 32px);
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                font-size: 14px;
                @apply --padding-right-left-16;
            }

            .invoice-item:nth-of-type(1) .invoice-text-row p {
                padding-right: 32px;
            }

            .invoice-item .invoice-text-row:first-child, .invoice-item .invoice-text-row:last-child {
                height: 24px;
            }

            .invoice-item .colour-code:not(:first-child) {
                margin-left: 4px;
            }

            .invoice-item p {
                @apply --paper-font-body1;
                margin: 0;
                -webkit-user-select: none; /* Chrome/Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+ */

                /* Rules below not implemented in browsers yet */
                -o-user-select: none;
                user-select: none;
            }

            .invoice-item--big {
                min-height: 96px;
                /*@apply --padding-16;*/
                /*border-bottom: 1px solid var(--app-background-color-dark);*/
            }

            .invoice-item--small {
                min-height: 32px;
                /*@apply --padding-right-left-16;*/
                padding-bottom: 8px;
            }

            .invoice-item--small .invoice-text-row:nth-child(2) {
                justify-content: space-between;
            }

            .invoice-item--small .invoice-text-row:last-child {
                display: none;
            }

            .invoice-item--small .he-dots-container {
                display: none;
            }

            .he-dots-container {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-end;
            }

            paper-item.menu-item.opened {
                @apply --padding-right-left-16;
            }

            paper-item {
                background: transparent;
                outline: 0;
                --paper-item-selected: {

                };

                --paper-item-disabled-color: {
                    color: red;
                };

                --paper-item-focused: {
                    background: transparent;
                };
                --paper-item-focused-before: {
                    background: transparent;
                };

            }

            paper-item.opened {
                padding-top: 8px;

            }

            .opened {
                color: var(--app-text-color);
                background: var(--app-text-color-light);
                border-radius: 2px 2px 0 0;
                box-shadow: 0 4px 0 0 white,
                0 -2px 0 0 white,
                0 2px 2px 0 rgba(0, 0, 0, 0.14),
                0 1px 5px 0 rgba(0, 0, 0, 0.12),
                0 3px 1px -2px rgba(0, 0, 0, 0.2);

            }

            paper-material.iron-selected > .invoice-text > .invoice-text-date {
                color: var(--app-text-color-light) !important;
            }

            .invoice-text {
                background: transparent;
                flex-direction: column;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
                height: 100%;
                padding: 0;
            }

            .invoice-text:focus::before, .invoice-text:focus::after {
                background: transparent;
            }

            .invoice-text-row p {
                width: 100%;
                text-overflow: ellipsis;
                overflow-x: hidden;
                white-space: nowrap;
            }

            .invoice-text-date {
                justify-content: space-between !important;
                position: relative;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, .1);
                @apply --padding-right-left-16;
                color: var(--app-text-color-disabled);
                height: 24px;
            }

            .invoice--big {
                min-height: 96px;
                /*@apply --padding-16;*/
                /*border-bottom: 1px solid var(--app-background-color-dark);*/
            }

            .invoice--small {
                min-height: 32px;
                /*@apply --padding-right-left-16;*/
                padding-bottom: 8px;
            }

            .invoice--small .invoice-text-row:nth-child(2) {
                justify-content: space-between;
            }

            .invoice--small .invoice-text-row:last-child {
                display: none;
            }

            .invoice--small .he-dots-container {
                display: none;
            }

            .he-dots-container {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-end;
            }

            paper-listbox {
                outline: 0;
                --paper-listbox-selected-item: {
                    color: var(--app-text-color-light);
                    background: var(--app-primary-color);
                };
                --paper-listbox-disabled-color: {
                    color: red;
                };

                background: transparent;
                padding: 0;
            }

            #_invoice_listbox {
                padding: 0;
            }

            .layout.vertical {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                flex-wrap: nowrap;
            }

            .verifiedNmcl {
                color: var(--app-status-color-ok);
                height: 8px;
            }

            .unverifiedNmcl {
                color: var(--app-status-color-nok);
                height: 8px;
            }

            vaadin-grid.material {

                font-family: Roboto, sans-serif;
                --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                --vaadin-grid-cell: {
                    padding: 8px;
                };

                --vaadin-grid-header-cell: {
                    height: 64px;
                    color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                    font-size: 12px;
                };

                --vaadin-grid-body-cell: {
                    height: 48px;
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                    font-size: 13px;
                };

                --vaadin-grid-body-row-hover-cell: {
                    background-color: var(--paper-grey-200);
                };

                --vaadin-grid-body-row-selected-cell: {
                    background-color: var(--paper-grey-100);
                };

                --vaadin-grid-focused-cell: {
                    box-shadow: none;
                    font-weight: bold;
                };
            }

            vaadin-grid.material .cell {
                overflow: hidden;
                text-overflow: ellipsis;
            }

            vaadin-grid.material .cell.last {
                padding-right: 24px;
            }

            vaadin-grid.material .cell.numeric {
                text-align: right;
            }

            vaadin-grid.material paper-checkbox {
                --primary-color: var(--paper-indigo-500);
                margin: 0 24px;
            }

            vaadin-grid.material vaadin-grid-sorter .cell {
                flex: 1;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            vaadin-grid.material vaadin-grid-sorter iron-icon {
                transform: scale(0.8);
            }

            vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                color: rgba(0, 0, 0, var(--dark-disabled-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction] {
                color: rgba(0, 0, 0, var(--dark-primary-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                transform: scale(0.8) rotate(180deg);
            }

            .clearBtn {
                height: 16px;
                width: 16px;
            }

            .nmclFavoriteCode {
                background-color: var(--app-secondary-color-dark);
                margin: 0 5px 0 0;
                color: var(--app-text-color-light);
                height: 20px;
                font-size: 12px;
                min-width: initial;
                text-transform: none;
                padding-left: 8px;
            }

            .tarificationError {
                padding: 5px;
                width: auto;
                height: 20px;
                color: var(--app-error-color);
            }

            .tarificationBtnEnable {
                background: var(--app-secondary-color);
            }

            .tarificationBtnDisable {
                background-color: var(--app-background-color-darker);
            }

            .tarificationBtnEnableWithWarning {
                background-color: var(--app-status-color-pending);
            }

            .invoiceBtnDisable {
                background-color: var(--app-background-color-darker);
            }

            .invoiceBtnEnable {
                background: var(--app-secondary-color);
            }

            .infoDmg {
                height: 18px;
                width: 18px;
            }

            .invoiceDateInfo{
                font-size: 12px;
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
            }

            .invoiceDateInfo span{
                margin-left: 4px;
            }

            .invoiceDateInfoIcon{
                height: 14px;
                width: 14px;
            }

            #relativeCodeDialog{
                height: 100px;
                width: 220px;
            }

            #eidDialog{
                height: 220px;
                width: 500px;
            }

            #containerEidDialog{
                heigth: 200px;
                width: auto;
                display: flex;
            }

            .eidContainerBtn{
                flex: auto;
                text-align: center;
            }

            .eidBtn{
                height: 60px;
                width: 60px;
            }

            .eidReadingBtnContainer{
                right: 0px;
                float: right;
            }

            #manualEncodingDialog{
                height: 340px;
                width: 500px;
            }

            .manualEncodingContainer{
                display: flex;
            }

            .manualEncodingContainerChild{
                flex: auto;
            }


        </style>

        <paper-dialog id="invoiceDialog" opened="{{opened}}" id="invoicingDialog">
            <div class="invoice-panel">
                <paper-listbox id="_invoice_listbox" focused multi toggle-shift selectable="paper-material" selected="{{selectValue}}">
                    <template is="dom-repeat" items="[[invoices]]">
                        <paper-material class="layout vertical invoice-item invoice--big" on-tap="_selectInvoice"
                                        id="[[item.id]]">
                            <paper-item class="invoice-text">
                                <div class="invoice-text-row invoice-text-date">
                                    <label>N° [[item.invoiceReference]]</label>
                                    <label>[[_formatInvoiceDate(item.invoiceDate)]]</label>
                                </div>
                                <div class="invoice-text-row grey">
                                    <h4>[[getInvoiceType(item.invoiceType)]] [[getSentMediumType(item.sentMediumType)]]</h4>
                                    <p>
                                        <template is="dom-repeat" items="[[item.invoicingCodes]]">
                                            [[item.code]],
                                        </template>
                                    </p>
                                    <div class="invoiceDateInfo">
                                        <template is="dom-if" if="[[_ifStatusDateExist(item.printedDate)]]">
                                            <iron-icon icon="vaadin:print" class="invoiceDateInfoIcon"></iron-icon> <span>[[_formatInvoiceDate(item.printedDate)]]</span>
                                        </template>
                                        <template is="dom-if" if="[[_ifStatusDateExist(item.sentDate)]]">
                                            <iron-icon icon="vaadin:paperplane" class="invoiceDateInfoIcon"></iron-icon> <span>[[_formatInvoiceDate(item.sentDate)]]</span>
                                        </template>
                                    </div>
                                </div>
                                <div class="invoice-text-row label-container">

                                </div>
                            </paper-item>
                        </paper-material>
                    </template>
                </paper-listbox>
            </div>
            <div class="detail-panel">
                <div class="invoice-header">
                    <div class="title">
                        <div class="title-txt">
                            [[localize('header','Header',language)]]
                            <div class="eidReadingBtnContainer">
                                <iron-icon icon="vaadin:user-card" on-tap="_openEidDialog" style="height: 18px;"></iron-icon>
                            </div>
                        </div>
                    </div>
                    <div class="flex-container">
                        <vaadin-combo-box id="invoice-type" filtered-items="[[invoiceType]]"
                                          item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                          label="[[localize('inv_type','Invoice type',language)]]"
                                          value="{{selectedInvoice.invoiceType}}"
                                          on-value-changed="" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                        <vaadin-combo-box id="invoice-mode" filtered-items="[[sentMediumType]]"
                                          item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                          label="[[localize('inv_smt','Sent Medium Type',language)]]"
                                          value="{{selectedInvoice.sentMediumType}}"
                                          on-value-changed="analyzeMediumType" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                        <paper-input id="invoice-number" label="[[localize('inv_num','Invoice number',language)]]"
                                     value="{{selectedInvoice.invoiceReference}}" readonly always-float-label="true"></paper-input>
                        <vaadin-date-picker id="invoice-date" label="[[localize('inv_date','Invoice date',language)]]"
                                            value="{{invoiceDateAsString}}" i18n="[[i18n]]" readOnly="[[isInvoiceClosed]]"></vaadin-date-picker>
                        <vaadin-combo-box id="invoice-period" filtered-items="[[invoicePeriod]]"
                                          item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                          label="[[localize('inv_per','Invoice period',language)]]"
                                          value="{{selectedInvoice.invoicePeriod}}" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                    </div>
                    <template is="dom-if" if="[[_checkInvoiceMediumType]]">
                        <div class="flex-container">
                            <div id="invoice-creditNote">
                                <template is="dom-if" if="[[!isInvoiceClosed]]">
                                    <vaadin-checkbox on-checked-changed="_isCreditNote"></vaadin-checkbox>
                                    [[localize('inv_cr_no','Credit note',language)]]<br/>

                                    <vaadin-checkbox on-checked-changed="_isLiftingLimitationPeriod"></vaadin-checkbox>
                                    [[localize('inv_llp','Lifting limitation period',language)]]
                                </template>

                                <template is="dom-if" if="[[isInvoiceClosed]]">
                                    <vaadin-checkbox on-checked-changed="_isCreditNote">[[localize('inv_cr_no','Credit note',language)]]<br/></vaadin-checkbox>
                                    <vaadin-checkbox on-checked-changed="_isLiftingLimitationPeriod">[[localize('inv_llp','Lifting limitation period',language)]]</vaadin-checkbox>
                                </template>


                            </div>
                            <vaadin-combo-box id="invoice-careProviderType" filtered-items="[[careProviderType]]"
                                              item-label-path="label.[[language]]" item-value-path="id"
                                              on-value-changed="analyzeCareProviderType"
                                              label="[[localize('inv_care_prov_ty','Care provider type',language)]]"
                                              value="{{selectedInvoice.careProviderType}}" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                            <template is="dom-if" if="[[_isTrainee(selectedInvoice.careProviderType)]]">
                                <paper-input id="invoice-nihiiTrainee"
                                             label="[[localize('train_nihii','NIHII trainee',language)]]"
                                             value="{{selectedInvoice.internshipNihii}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            </template>
                            <vaadin-combo-box id="invoice-thirdPartyJustification"
                                              filtered-items="[[thirdPartyJustification]]"
                                              item-label-path="label.[[language]]" item-value-path="id"
                                              on-filter-changed=""
                                              label="[[localize('inv_tpj','Third party justification',language)]]"
                                              value="{{selectedInvoice.thirdPartyReference}}"
                                              on-value-changed="" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                            <paper-input id="invoice-dmg" label="[[localize('inv_dmgOwner','Dmg owner',language)]]"
                                         value="{{selectedInvoice.gnotionNihii}}" readOnly="[[isInvoiceClosed]]">
                                         <div slot="suffix">
                                             <iron-icon icon="info" id="invoice-dmg-icon"
                                            class="infoDmg"></iron-icon>
                                        </div>
                            </paper-input>
                            <paper-tooltip for="invoice-dmg-icon">[[localize('gnotion','Gnotion',language)]]</paper-tooltip>
                        </div>
                    </template>
                </div>
                <div class="invoice-nomenclature-code">
                    <div class="invoice-nomenclature-code-container">
                        <div class="nmcl-descr">
                            <div class="title">
                                <div class="title-txt">
                                    [[localize('nmcl','Nomenclature',language)]]
                                </div>
                            </div>
                            <div class="nmcl-list">
                                <vaadin-grid id="nmclGrid" items="[[selectedInvoice.invoicingCodes]]" class="material"
                                             active-item="{{activeNmclItem}}" on-tap="_showDetail">
                                    <vaadin-grid-column width="20px">
                                        <template>
                                            <div class="cell frozen">
                                                <template is="dom-if" if="[[item.valid]]">
                                                    <iron-icon icon="vaadin:check" class="verifiedNmcl"></iron-icon>
                                                </template>
                                            </div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell frozen">[[localize('co','Code',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell frozen">[[item.code]]</div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="650px">
                                        <template class="header">
                                            <div class="cell frozen">[[localize('lab','Label',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell frozen">[[item.label]]</div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('tot_pat','Patient fees',language)]]
                                            </div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[item.patientIntervention]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.patientIntervention]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('reimb','Reimbursement',language)]]
                                            </div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[item.reimbursement]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.reimbursement]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('extra','Extra',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[item.doctorSupplement]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.doctorSupplement]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric">[[localize('tot','Fees',language)]]</div>
                                        </template>
                                        <template>
                                            <div class="cell numeric">[[item.totalAmount]]&nbsp€</div>
                                        </template>
                                        <template class="footer"> <div class="cell numeric">[[totalInvoice.totalAmount]]&nbsp€</div></template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="80px">
                                        <template class="header">
                                            <div class="cell numeric"></div>
                                        </template>
                                        <template>
                                            <template is="dom-if" if="[[item.prescriberNeeded]]">
                                                <iron-icon class="clearBtn" icon="vaadin:doctor"></iron-icon>
                                            </template>
                                            <template is="dom-if" if="[[item.isRelativePrestation]]">
                                                <!--<related-code-link language="[[language]]" linkables="[[selectedInvoice.invoicingCodes]]" represented-object-id="[[item.id]]" api="[[api]]" on-link-nmcl-to-related-code="linkNmclToRelatedCode"></related-code-link>-->
                                                <template id="dom-if" if="[[!!isInvoiceClosed]]">
                                                    <iron-icon class="clearBtn" icon="vaadin:link" id="[[item.id]]" on-tap="_openlinkRelativePrestationDialog"></iron-icon>
                                                </template>
                                                  [[item.relatedCode]]
                                            </template>

                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="20px">
                                        <template>
                                            <div class="cell frozen">
                                                <template is="dom-if" if="[[!isInvoiceClosed]]">
                                                    <iron-icon icon="vaadin:exchange" class="clearBtn"
                                                               on-tap="_openTransfertDialog"></iron-icon>
                                                </template>
                                            </div>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column width="20px">
                                        <template>
                                            <div class="cell frozen">
                                                <template is="dom-if" if="[[!isInvoiceClosed]]">
                                                    <iron-icon icon="clear" class="clearBtn"
                                                               data-item$="[[item.tarificationId]]"
                                                               on-tap="_deleteNmclCode"></iron-icon>
                                                </template>
                                            </div>
                                        </template>
                                    </vaadin-grid-column>
                                </vaadin-grid>
                            </div>
                            <template is="dom-if" if="[[!isInvoiceClosed]]">
                                <div class="nmcl-favorite">
                                    <span>[[localize('fav','Favorites code',language)]]:</span>
                                    <template is="dom-repeat" items="[[favoriteCode]]">
                                        <paper-button on-tap="_addNmcl" data-item$="[[item]]" class="nmclFavoriteCode">
                                            [[item.code]]
                                            <iron-icon icon="clear" class="clearBtn" data-item$="[[item.id]]"
                                                       on-tap="_deleteFavoriteCode"></iron-icon>
                                        </paper-button>
                                    </template>
                                </div>
                                <div class="invoice-nomenclature-code-option">
                                    <vaadin-combo-box id="nmcl-search" filtered-items="[[nmclListItem]]" item-label-path="descr"
                                                      item-value-path="id" on-filter-changed="_nmclSearch" on-keydown="isEnterPressed"
                                                      label="[[localize('nmcl','Nomenclature',language)]]"
                                                      value="{{nmcl-value}}" autofocus></vaadin-combo-box>
                                    <vaadin-combo-box id="code-type" filtered-items="[[sentMediumType]]"
                                                      item-label-path="label.[[language]]" item-value-path="id" on-filter-changed=""
                                                      label="[[localize('code_type','Code type',language)]]"
                                                      value="{{selectedMediumCodeType}}"></vaadin-combo-box>
                                    <paper-icon-button icon="icons:add-circle-outline" on-tap="_addNmcl"></paper-icon-button>
                                    <paper-icon-button icon="icons:star" on-tap="_addFavoriteCode"></paper-icon-button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="invoice-detail">
                    <div class="title">
                        <div class="title-txt">
                            [[localize('det','Detail',language)]]
                        </div>
                    </div>
                    <template is="dom-if" if="[[isTarificationError]]">
                        <template is="dom-repeat" items="[[tarificationError]]">
                            <div class="tarificationError">[[item.code]]: [[_getErrorMsg(item, language)]]
                                ([[item.value]])
                            </div>
                        </template>
                    </template>
                    <template is="dom-if" if="[[isDetailNmcl]]">
                        <div class="flex-container-nmcl">
                            <paper-input class="flex-container-nmcl-row" label="[[localize('co','Code',language)]]"
                                         value="{{activeNmclItem.code}}" readonly></paper-input>
                            <paper-input class="flex-container-descr-nmcl-row"
                                         label="[[localize('lab','Label',language)]]" value="{{activeNmclItem.label}}"
                                         readonly></paper-input>
                        </div>
                        <div class="flex-container-nmcl">
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('tot_pat','Patient fee',language)]]"
                                         value="{{activeNmclItem.patientIntervention}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('reimb','Reimbursement',language)]]"
                                         value="{{activeNmclItem.reimbursement}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('extra','Extra',language)]]"
                                         value="{{activeNmclItem.doctorSupplement}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            <paper-input prevent-invalid-input allowed-pattern="[.\d]" class="flex-container-nmcl-row"
                                         label="[[localize('tot','Fee',language)]]"
                                         value="{{activeNmclItem.totalAmount}}" readonly></paper-input>
                        </div>
                        <div class="flex-container-nmcl">
                            <vaadin-combo-box id="prescriberType" class="flex-container-nmcl-row"
                                              label="[[localize('prescriber','Prescriber',language)]]"
                                              filtered-items="[[prescriberType]]" item-label-path="label.[[language]]"
                                              item-value-path="id" value="{{activeNmclItem.prescriberNorm}}"
                                              on-value-changed="_checkIfPrescriberIsNeeded" readOnly="[[isInvoiceClosed]]"></vaadin-combo-box>
                            <template is="dom-if" if="[[isPrescriberIsNeeded]]">
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('prescriber_nihii','Prescriber nihii',language)]]"
                                             value="{{activeNmclItem.prescriberNihii}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                            </template>
                        </div>
                        <template is="dom-if" if="[[isTravellingExpenses(activeNmclItem.*)]]">
                            <div class="flex-container-nmcl">
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('fraisDepAll','frais de déplacement - aller',language)]]"
                                             value="{{activeNmclItem.qteAll}}" readOnly="[[isInvoiceClosed]]"></paper-input>
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('fraisDepAllRet','frais de déplacement - aller & retour',language)]]"
                                             value="[[quantityAllHasChanged(activeNmclItem.qteAll.*)]]" readOnly></paper-input>
                                <paper-input class="flex-container-nmcl-row"
                                             label="[[localize('fraisDepRemb','frais de déplacement - rembourser',language)]]"
                                             value="{{activeNmclItem.units}}" readOnly></paper-input>
                            </div>
                        </template>
                        <div class="flex-container-nmcl">
                            <paper-input class="flex-container-nmcl-row"
                                         label="[[localize('valid','Validation',language)]]"
                                         value="{{activeNmclItem.valid}}" readonly></paper-input>
                            <paper-input class="flex-container-nmcl-row"
                                         label="[[localize('fin_con','Financial contract',language)]]"
                                         value="{{activeNmclItem.contract}}" readonly></paper-input>
                            <paper-input class="flex-container-nmcl-row"
                                         label="[[localize('inv_tpj','Justification TP',language)]]"
                                         value="{{_getOvveride3PayerCodeAsString(activeNmclItem.override3rdPayerCode)}}" readonly></paper-input>
                        </div>
                    </template>

                </div>
                <div class="buttons">
                    <paper-button class="modal-button" on-tap="_closeDialog">[[localize('can','Cancel',language)]]</paper-button>

                    <template is="dom-if" if="[[!isInvoiceClosed]]">
                        <template is="dom-if" if="[[!isTarificationMcnError]]">
                            <template is="dom-if" if="[[npi]]">
                                <paper-button class="modal-button modal-button--save tarificationBtnEnable" on-tap="_verifyTarification">
                                    [[localize('eTarif','Validation eTarif',language)]]
                                </paper-button>
                            </template>
                            <template is="dom-if" if="[[!npi]]">
                                <paper-button class="modal-button tarificationBtnDisable" on-tap="">[[localize('eTarif','Validation
                                    eTarif',language)]]
                                </paper-button>
                            </template>
                        </template>

                        <template is="dom-if" if="[[isTarificationMcnError]]">
                            <paper-button on-tap="_verifyTarification" class="tarificationBtnEnableWithWarning">
                                [[localize('eTarif','Validation eTarif',language)]]
                            </paper-button>
                        </template>

                        <template is="dom-if" if="[[isNmclVerified]]">
                            <paper-button on-tap="_createInvoice" class="modal-button modal-button--save invoiceBtnEnable">
                                [[localize('val_invoice','Justificatory + create invoice',language)]]
                            </paper-button>
                        </template>
                        <template is="dom-if" if="[[!isNmclVerified]]">
                            <paper-button on-tap="" class="modal-button invoiceBtnDisable">[[localize('val_invoice','Justificatory +
                                create invoice',language)]]
                            </paper-button>
                        </template>
                    </template>
                    <template is="dom-if" if="[[isInvoiceClosed]]">
                        <paper-button on-tap="_createInvoice" class="modal-button invoiceBtnEnable">
                            [[localize('val_justificatory','Justificatory',language)]]
                        </paper-button>
                    </template>
                </div>
            </div>
        </paper-dialog>

        <paper-dialog id="transferDialog">
            <div>
                <vaadin-combo-box id="code-type" filtered-items="[[sentMediumType]]"
                                  item-label-path="label.[[language]]" item-value-path="id"
                                  label="[[localize('code_type','Code type',language)]]"
                                  value="{{bufferTypeCode}}"></vaadin-combo-box>
            </div>
        </paper-dialog>

        <paper-dialog id="relativeCodeDialog">
            <vaadin-combo-box id="related-code" filtered-items="[[selectedInvoice.invoicingCodes]]"
                              item-label-path="code" item-value-path="id"
                              label="Link"
                              value="{{childRelativeCodeId}}"></vaadin-combo-box>
        </paper-dialog>

        <paper-dialog id="eidDialog">
            <h4>Type de lecture</h4>
            <div id="containerEidDialog">
                <div class="eidContainerBtn">
                    <paper-icon-button icon="vaadin:user-card" class="eidBtn" on-tap="_readEidCard"></paper-icon-button>
                    <p>EID</p>
                </div>
                <div class="eidContainerBtn">
                    <paper-icon-button icon="vaadin:qrcode" class="eidBtn" on-tap="_readBarreCode"></paper-icon-button>
                    <p>QR code && code-barre</p>
                </div>
                <div class="eidContainerBtn">
                    <paper-icon-button icon="vaadin:pencil" class="eidBtn" on-tap="_showManualEncodingDialog"></paper-icon-button>
                    <p>Encodage manuel</p>
                </div>
            </div>
            <div class="buttons">
                <paper-button on-tap="_closeEidDialog">[[localize('can','Cancel',language)]]</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id="manualEncodingDialog">
            <h4>Encodage manuel</h4>
            <div class="manualEncodingContainer">
                <vaadin-combo-box id="reasonOfManualEncoding" filtered-items="[[reasonOfManualEncoding]]"
                                  item-label-path="label.[[language]]" item-value-path="id"
                                  label="Raison"
                                  value="{{manualEncoding.reason}}" class="manualEncodingContainerChild"></vaadin-combo-box>
            </div>
            <div class="manualEncodingContainer">
                <vaadin-combo-box id="code-type" filtered-items="[[typeOfSupport]]"
                                  item-label-path="label.[[language]]" item-value-path="id"
                                  label="Type de support"
                                  value="{{manualEncoding.supportType}}" class="manualEncodingContainerChild"></vaadin-combo-box>
            </div>
            <div class="manualEncodingContainer">
                <paper-input class="flex-container-nmcl-row"
                             label="N° de serie"
                             value="{{manualEncoding.serialNumber}}" class="manualEncodingContainerChild"></paper-input>
            </div>
            <div class="buttons">
                <paper-button on-tap="_closeManualEncodingDialog">[[localize('can','Cancel',language)]]</paper-button>
                <paper-button on-tap="_closeManualEncodingDialog">[[localize('add','Add',language)]]</paper-button>
            </div>
        </paper-dialog>

    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models'
        import jsPDF from 'jspdf/dist/jspdf.min';
        import moment from 'moment/src/moment'
        import * as evaljs from "evaljs"

        class HtPatInvoicingDialog extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-invoicing-dialog'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    patient: {
                        type: Object,
                        value: null
                    },
                    contact: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    currentContact: {
                        type: Object,
                        value: null
                    },
                    resources: {
                        type: Object
                    },
                    opened: {
                        type: Boolean,
                        value: false
                    },
                    invoiceType: {
                        type: Array,
                        value: () => [
                            {
                                id: "mutualfund",
                                label: {"fr": "Mutuelle", "nl": "Mutual", "en": "Mutual"}
                            },
                            {
                                id: "patient",
                                label: {"fr": "Patient", "nl": "Patient", "en": "Patient"}
                            },
                            {
                                id: "payingagency",
                                label: {"fr": "Autre organisme", "nl": "Anders", "en": "Paying agency"}
                            }
                        ]
                    },
                    sentMediumType: {
                        type: Array,
                        value: () => [
                            {
                                id: "efact",
                                label: {"fr": "eFact", "nl": "eFact", "en": "eFact"}
                            },
                            {
                                id: "eattest",
                                label: {"fr": "eAttest", "nl": "eAttest", "en": "eAttest"}
                            },
                            {
                                id: "cdrom",
                                label: {"fr": "cdrom", "nl": "cdrom", "en": "cdrom"}
                            },
                            {
                                id: "email",
                                label: {"fr": "Email", "nl": "Email", "en": "Email"}
                            },
                            {
                                id: "mediprima",
                                label: {"fr": "Mediprima", "nl": "Mediprima", "en": "Mediprima"}
                            },
                            {
                                id: "paper",
                                label: {"fr": "Papier", "nl": "Paper", "en": "Paper"}
                            }
                        ]
                    },
                    invoicePeriod: {
                        type: Array,
                        value: () => [
                            {
                                id: 0,
                                label: {"fr": "Semaine", "nl": "Week", "en": "Week"}
                            },
                            {
                                id: 1,
                                label: {"fr": "Nuit", "nl": "Nacht", "en": "Night"}
                            },
                            {
                                id: 2,
                                label: {"fr": "Weekend", "nl": "Weekend", "en": "Weekend"}
                            },
                            {
                                id: 3,
                                label: {"fr": "Jour férié", "nl": "Vakantie", "en": "Public holiday"}
                            }
                        ]
                    },
                    careProviderType: {
                        type: Array,
                        value: () => [
                            {
                                id: "persphysician",
                                label: {"fr": "Médecin", "nl": "Arts", "en": "Physician"}
                            },
                            {
                                id: "traineeDoctor",
                                label: {"fr": "Médecin stagiaire", "nl": "Stagiair arts", "en": "Trainee physician"}
                            }
                        ]
                    },
                    prescriberType: {
                        type: Array,
                        value: () => [
                            {
                                id: 0,
                                label: {"fr": "Pas de prescripteur", "nl": "No prescriber", "en": "No prescriber"},
                                prescriber: false
                            },
                            {
                                id: 1,
                                label: {
                                    "fr": "La prestation peut être attribuée à un prescripteur",
                                    "nl": "The benefit can be attributed to a prescriber",
                                    "en": "The benefit can be attributed to a prescriber physician"
                                },
                                prescriber: true
                            },
                            {
                                id: 3,
                                label: {
                                    "fr": "Les prestations sont effectuées pour ses propres patients",
                                    "nl": "The services are performed for his own patients",
                                    "en": "The services are performed for his own patients"
                                },
                                prescriber: false
                            },
                            {
                                id: 4,
                                label: {
                                    "fr": "Il s'agit de prestations ajoutées",
                                    "nl": "These are added benefits",
                                    "en": "These are added benefits"
                                },
                                prescriber: true
                            },
                            {
                                id: 5,
                                label: {
                                    "fr": "La prestation peut être attribuée à un prescripteur et elle a été substituée",
                                    "nl": "The benefit can be attributed to a prescriber and has been substituted",
                                    "en": "The benefit can be attributed to a prescriber and has been substituted"
                                },
                                prescriber: true
                            },
                            {
                                id: 6,
                                label: {
                                    "fr": "La prestation est prescrite par différents prescripteurs et elle a été substituée",
                                    "nl": "The benefit is prescribed by different prescribers and has been substituted",
                                    "en": "The benefit is prescribed by different prescribers and has been substituted"
                                },
                                prescriber: true
                            }
                        ]
                    },
                    thirdPartyJustification: {
                        type: Array,
                        value: () => [
                            {
                                id: "5",
                                label: {
                                    "fr": "5. Prestations dispensées dans les centres de santé mentale, centres de planning familial et centres d'accueil pour toxicomanes",
                                    "nl": "5. Services Provided in Mental Health Centers, Family Planning Centers and Addiction Centers",
                                    "en": "5. Services Provided in Mental Health Centers, Family Planning Centers and Addiction Centers"
                                }
                            },
                            {
                                id: "9",
                                label: {
                                    "fr": "9. Interdiction de facturer en tiers-payant via efact",
                                    "nl": "9. Prohibition of third-party billing via efact",
                                    "en": "9. Prohibition of third-party billing via efact"
                                }
                            },
                            {
                                id: "0",
                                label: {
                                    "fr": "0. Pas de justification",
                                    "nl": "0. No justification",
                                    "en": "0. No justification"
                                }
                            },
                            {
                                id: "1",
                                label: {"fr": "1. Décès, coma", "nl": "1. Death, coma", "en": "1. Death, coma"}
                            },
                            {
                                id: "2",
                                label: {
                                    "fr": "2. Etat d'urgence financière",
                                    "nl": "2. State of financial emergency",
                                    "en": "2. State of financial emergency"
                                }
                            },
                            {
                                id: "3",
                                label: {"fr": "3. BIM", "nl": "3. BIM", "en": "3. BIM"}
                            },
                            {
                                id: "4",
                                label: {
                                    "fr": "4. Prestations dispensées dans le cadre d'un accord prévoyant le paiement forfaitaire de cetaines prestations",
                                    "nl": "4. Benefits provided under an agreement providing for the payment of certain benefits",
                                    "en": "4. Benefits provided under an agreement providing for the payment of certain benefits"
                                }
                            },
                            {
                                id: "6",
                                label: {
                                    "fr": "6. Prestations dispensées dans des établissements spécialisés dans les soins aux enfants, aux personnes agées ou aux handicapés",
                                    "nl": "6. Services provided in institutions specializing in the care of children, the elderly people or the disabled",
                                    "en": "6. Services provided in institutions specializing in the care of children, the elderly people or the disabled"
                                }
                            },
                            {
                                id: "7",
                                label: {
                                    "fr": "7. Prestations effectuées dans le cadre d'un service de garde de médecine générale",
                                    "nl": "7. Services provided as part of a general medical care service",
                                    "en": "7. Services provided as part of a general medical care service"
                                }
                            },
                            {
                                id: "8",
                                label: {
                                    "fr": "8. Statut affection chronique (sur base d'une attestation fournie par le patient)",
                                    "nl": "8. Chronic condition",
                                    "en": "8. Chronic condition"
                                }
                            },
                            {
                                id: "p",
                                label: {
                                    "fr": "P. Patients palliatifs à domicile",
                                    "nl": "P. Home palliative patients",
                                    "en": "P. Home palliative patients"
                                }
                            }
                        ]
                    },
                    reasonOfManualEncoding:{
                        type: Object,
                        value: () => [
                            {
                                id: 1,
                                label: {
                                            "fr": "Utilisation d’un document d’identité sans puce",
                                            "nl": "Using an identity document without a chip",
                                            "en": "Using an identity document without a chip"
                                }
                            },
                            {
                                id: 2,
                                label: {
                                            "fr": "Indisponibilité du lecteur de carte",
                                            "nl": "Unavailability of the card reader",
                                            "en": "Unavailability of the card reader"
                                }
                            },
                            {
                                id: 3,
                                label: {
                                            "fr": "Panne du système informatique",
                                            "nl": "Computer system failure",
                                            "en": "Computer system failure"
                                }
                            }
                        ]

                    },
                    typeOfSupport:{
                        type: Object,
                        value: () => [
                            {
                                id: 1,
                                label: {
                                    "fr": "Carte d’identité électronique belge (ou Kids-id)",
                                    "nl": "Belgium electronic identity card (or Kids-id)",
                                    "en": "Belgium electronic identity card (or Kids-id)"
                                }
                            },
                            {
                                id: 2,
                                label: {
                                    "fr": "Carte d’identité électronique étranger",
                                    "nl": "Other country electronic identity card",
                                    "en": "Other country electronic identity card"
                                }
                            },
                            {
                                id: 4,
                                label: {
                                    "fr": "Carte ISI+",
                                    "nl": "ISI+ card",
                                    "en": "ISI+ card"
                                }
                            },
                            {
                                id: 5,
                                label: {
                                    "fr": "Document de séjour électronique",
                                    "nl": "Electronic residence document",
                                    "en": "Electronic residence document"
                                }
                            },
                            {
                                id: 7,
                                label: {
                                    "fr": "Vignette avec code-à-barres",
                                    "nl": "Thumbnail with barcode",
                                    "en": "Thumbnail with barcode"
                                }
                            },
                            {
                                id: 8,
                                label: {
                                    "fr": "Attestation d’assuré social",
                                    "nl": "Social insurance certificate",
                                    "en": "Social insurance certificate"
                                }
                            },
                            {
                                id: 9,
                                label: {
                                    "fr": "Attestation de perte ou de vol",
                                    "nl": "Certificate of loss or theft",
                                    "en": "Certificate of loss or theft"
                                }
                            }
                        ]

                    },
                    manualEncoding:{
                        type: Object,
                        value: () => ({
                            reason: "",
                            supportType: "",
                            serialNumber: ""
                        })
                    },
                    selectedInvoice: {
                        type: Object,
                        value: () => {
                        }
                    },
                    invoices: {
                        type: Object,
                        value: () => {
                        }
                    },
                    totalInvoice: {
                        type: Object,
                        value: () => ({
                            reimbursement: Number(0.00).toFixed(2),
                            totalAmount: Number(0.00).toFixed(2),
                            patientIntervention: Number(0.00).toFixed(2),
                            doctorSupplement: Number(0.00).toFixed(2)
                        })
                    },
                    isThirdParty: {
                        type: Boolean,
                        value: true
                    },
                    nmclListItem: {
                        type: Array,
                        value: () => []
                    },
                    nmclFilterValue: {
                        type: String
                    },
                    npi: {
                        type: Boolean,
                        value: false
                    },
                    favoriteCode: {
                        type: Object
                    },
                    isTarificationError: {
                        type: Boolean,
                        value: false
                    },
                    isDetailNmcl: {
                        type: Boolean,
                        value: false
                    },
                    tarificationError: {
                        type: Array
                    },
                    activeNmclItem: {
                        type: Object
                    },
                    isPrescriberIsNeeded: {
                        type: Boolean,
                        value: false
                    },
                    isNmclVerified: {
                        type: Boolean,
                        value: false
                    },
                    isTrainee: {
                        type: Boolean,
                        value: false
                    },
                    isTarificationMcnError: {
                        type: Boolean,
                        value: false
                    },
                    hcp: {
                        type: Object,
                        value: () => ({})
                    },
                    selectedMediumCodeType: {
                        type: String
                    },
                    i18n: {
                        type: Object
                    },
                    invoiceDateAsString: {
                        type: String,
                        observer: '_invoiceDateAsStringChanged'
                    },
                    isInvoiceClosed:{
                        type: Boolean,
                        value: false
                    },
                    bufferTypeCode:{
                        type : String,
                        observer: '_tranferNmcl'
                    },
                    isSelected:{
                        type: Boolean
                    },
                    childRelativeCodeId:{
                        type: String,
                        value: "",
                        observer: '_linkCode'
                    },
                    parentRelatedCodeId: {
                        type: String,
                        value: ""
                    }

                }

            }

            static get observers() {
                return ['_invoicingCodeChange(activeNmclItem, activeNmclItem.*)','selectedInvoiceChanged(selectedInvoice.*)']
            }

            ready() {
                super.ready()
            }


            _selectInvoice(e) {
                this.isSelected=true;
                const invoiceId = (e.currentTarget) ? e.currentTarget.id : e
                this.set("isTarificationError", false)
                this.set("isTarificationMcnError", false)
                this.set('isDetailNmcl', false)
                this.set('isNmclVerified', false)
                this.set('npi', false)

                const selected = this.invoices.find(inv => inv.id === invoiceId)

                this.api.tarification().getTarifications(new models.ListOfIdsDto({ids: selected.invoicingCodes.map(tar => tar.tarificationId)})).then(nmcls =>
                    nmcls.map(nmcl =>{
                        const sn = selected.invoicingCodes.find(n => n.tarificationId === nmcl.id) || null
                        if(sn){
                            sn.prescriberNeeded = nmcl.needsPrescriber
                            sn.isRelativePrestation = nmcl.hasRelatedCode
                        }
                    })
                ).finally(() => {
                    this.set('selectedInvoice', selected)
                    this.set('selectedMediumCodeType', selected.sentMediumType)
                    this.set('invoiceDateAsString', this.returnDatePickerDate(selected.invoiceDate))

                    invoiceId !== "" ? this.calculateTotalOfInvoice() : null
                    this.selectedInvoice.invoicingCodes.length > 0 ? this.set('npi', true) : this.set('npi', false)
                    this.set('isInvoiceClosed', !!this.selectedInvoice.sentDate)
                    this.isSelected=false;
                })
            }

            open() {
                Promise.all([this.api.hcparty().getHealthcareParties(this.user.healthcarePartyId), this.api.invoice().findBy(this.user.healthcarePartyId, this.patient)]).then(([hcp, invoices]) => {
                    this.set('hcp', hcp)
                    this.set('invoices',invoices)
                    this.set('nmcl-value','')

                    const invoiceOfDay = invoices.find( i=> i.invoiceDate === moment().format("YYYYMMDD") && !i.sentDate )

                    if(!invoiceOfDay){
                        const newInvoice = {}

                        newInvoice.id = ""
                        newInvoice.invoicingCodes = []
                        newInvoice.invoiceDate = moment().format("YYYYMMDD")
                        newInvoice.invoiceReference = null
                        newInvoice.thirdPartyReference = "0"
                        newInvoice.invoiceType = (this.patient.insurabilities[0].parameters.tc1%2===1) ? "mutualfund" : "patient"
                        newInvoice.sentMediumType = (this.patient.insurabilities[0].parameters.tc1%2===1) ? "efact" : "eattest"
                        newInvoice.invoicePeriod = 0
                        newInvoice.longDelayJustification = 0
                        newInvoice.gnotionNihii = null
                        newInvoice.internshipNihii = null
                        newInvoice.creditNote = 0
                        newInvoice.careProviderType = "persphysician"

                        this.push('invoices',newInvoice)

                        this._selectInvoice("")
                    }else{
                        this._selectInvoice(invoiceOfDay.id)
                    }

                    this.set('invoices', _.orderBy(this.invoices, ['invoiceDate'], ['desc']))

                    this.$.invoiceDialog.open()

                    this.getFavoritesCodes()
                })
            }

            _closeDialog() {
                this.$.invoiceDialog.close()
            }

            _isTrainee(careProviderType) {
                return careProviderType === "persphysician" ? false : true
            }

            _checkInvoiceMediumType() {
                return this.selectedInvoice.sentMediumType === "efact" ? true : false
            }

            getFavoritesCodes() {
                const preferedCode = this.user.properties.find(p => p.type && p.type.identifier === "org.taktik.icure.tarification.favorites")

                if (preferedCode && preferedCode.typedValue) {
                    const code = JSON.parse(preferedCode.typedValue.stringValue)

                    this.api.tarification().getTarifications(new models.ListOfIdsDto({ids: code.cs.map(c => c)})).then(t => {
                        this.set("favoriteCode", t)
                    })
                }

            }

            analyzeMediumType(e) {
                this.set('selectedMediumCodeType', e.detail.value)
                return e.detail.value === "efact" ? this.set('isThirdParty', true) : this.set('isThirdParty', false)
            }

            _nmclSearch(e) {
                let latestSearchValue = e && e.detail.value
                this.latestSearchValue = latestSearchValue
                if (!latestSearchValue || latestSearchValue.length < 2) {
                    console.log("Cancelling empty search")
                    this.set('nmclListItem', [])
                    return
                }
                this._nmclDataProvider() && this._nmclDataProvider().filter(latestSearchValue).then(res => {
                    if (latestSearchValue !== this.latestSearchValue) {
                        console.log("Cancelling obsolete search")
                        return
                    }
                    this.set('nmclListItem', res.rows)
                })
            }

            _nmclDataProvider() {
                return {
                    filter: function (nmclFilterValue) {
                        let count = 10
                        return Promise.all([this.api.tarification().findPaginatedTarificationsByLabel('be', 'INAMI-RIZIV', 'fr', nmclFilterValue, null, count)]).then(results => {
                            const nmclList = results[0]
                            const filtered = _.flatten(nmclList.rows.map(nmcl => ({
                                id: nmcl.id,
                                descr: nmcl.code + ': ' + nmcl.label[this.language],
                                code: nmcl.code,
                                label: nmcl.label,
                                valorisations: nmcl.valorisations
                            })))
                            return {totalSize: filtered.length, rows: filtered}
                        })

                    }.bind(this)
                }

            }

            _getDescription(label) {
                return label[this.language]
            }

            _addNmcl(e) {
                this.set("isTarificationMcnError", false)
                this.set("isTarificationError", false)
                this.set('isDetailNmcl', false)
                this.set('isNmclVerified', false)
                this.set('npi', false)

                if (this.shadowRoot.querySelector("#nmcl-search").selectedItem || e.target.dataset.item) {

                    const nmcl = (e.target.dataset.item) ? JSON.parse(e.target.dataset.item) : this.shadowRoot.querySelector("#nmcl-search").selectedItem

                    const newNmcl = {
                        code: nmcl.code,
                        contactId: this.currentContact.id,
                        tarificationId: nmcl.id,
                        label: nmcl.label[this.language],
                        totalAmount: Number(0.00).toFixed(2),
                        reimbursement: Number(0.00).toFixed(2),
                        patientIntervention: Number(0.00).toFixed(2),
                        doctorSupplement: Number(0.00).toFixed(2),
                        units: 1,
                        canceled: false,
                        accepted: false,
                        pending: false,
                        resent: false,
                        dateCode: this.selectedInvoice.invoiceDate,
                        prescriberNeeded: nmcl.needsPrescriber,
                        isRelativePrestation: nmcl.hasRelatedCode,
                        valid: false,
                        id: this.api.crypto().randomUuid(),
                        prescriberNihii: null,
                        prescriberNorm: 0

                    }
                    const ins = this.patient.insurabilities.find(i => !i.endDate)
                    const age = moment().diff(this.patient.dateOfBirth, 'years', true)
                    const dmg = this.patient.patientHealthCareParties.find(hcp => !hcp.referral)

                    const trainee = this.hcp.statuses
                    const convention = this.hcp.convention


                    const env = new evaljs.Environment({
                        patient: {
                            preferentialstatus: (ins && ins.parameters) ? !!ins.parameters.preferentialstatus : false,
                            age: age,
                            dmg: (dmg && dmg.referral) ? !!dmg.referral : false,
                            chronical: (ins && ins.parameters) ? !!ins.parameters.chronicalDisease : false
                        }, hcp: {trainee: trainee, convention: convention}
                    })

                    nmcl.valorisations.map(val => {
                        const gen = (env.gen(val.predicate)())
                        let status = {done: false}

                        while (!status.done) {
                            status = gen.next()
                        }

                        if (status.value && (moment().format('YYYYMMDD') > val.startOfValidity && moment().format('YYYYMMDD') < val.endOfValidity)) {
                            newNmcl.totalAmount = Number(val.totalAmount).toFixed(2)
                            newNmcl.reimbursement = Number(val.reimbursement).toFixed(2)
                            newNmcl.patientIntervention = Number(val.patientIntervention).toFixed(2)
                        }
                    })

                    this.api.crypto().extractDelegationsSFKs(this.patient, this.user.healthcarePartyId).then(secretForeignKeys => {

                        const patientKeys = secretForeignKeys.join(",")

                        console.log(this.selectedInvoice)
                        this.api.invoice().appendCodes(this.user.id, this.selectedInvoice.invoiceType, this.selectedMediumCodeType, this.patient.insurabilities[0].insuranceId, patientKeys, null, 0, [newNmcl]).then(inv => {

                            inv.map(invoice => {
                                if (!invoice.id) {

                                    invoice.invoiceDate = this.selectedInvoice.invoiceDate
                                    invoice.invoiceReference = this.selectedInvoice.invoiceReference
                                    invoice.thirdPartyReference = this.selectedInvoice.thirdPartyReference
                                    invoice.invoicePeriod = this.selectedInvoice.invoicePeriod
                                    invoice.longDelayJustification = this.selectedInvoice.longDelayJustification
                                    invoice.gnotionNihii = this.selectedInvoice.gnotionNihii === "" ? null : this.selectedInvoice.gnotionNihii
                                    invoice.internshipNihii = this.selectedInvoice.internshipNihii === "" ? null : this.selectedInvoice.internshipNihii
                                    invoice.creditNote = this.selectedInvoice.creditNote
                                    invoice.careProviderType = this.selectedInvoice.careProviderType

                                    this.api.invoice().newInstance(this.user, this.patient, invoice)
                                        .then(invoice => this.api.register(invoice,'invoice'))
                                        .then(invoice => this.api.invoice().createInvoice(invoice))
                                        .then(invoice => this.api.register(invoice,'invoice'))
                                        .then(invoice => {
                                            this.$['nmclGrid'].clearCache()
                                            console.log(this.selectedInvoice)
                                            this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => {
                                                this.set('invoices', invoices)
                                                this._selectInvoice(invoice.id)
                                            })

                                        })
                                }else{
                                    this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => {
                                        this.set('invoices', invoices)
                                        const selectedInvoice = invoices.find(i => i.id === this.selectedInvoice.id)
                                        this._selectInvoice(selectedInvoice.id)
                                    })
                                }
                            })
                        })
                    })
                }

                this.set('nmcl-value','')
                this.shadowRoot.querySelector("#nmcl-search").focus()
            }


            _addFavoriteCode() {
                if (this.shadowRoot.querySelector("#nmcl-search").selectedItem) {

                    const newCode = this.shadowRoot.querySelector("#nmcl-search").selectedItem
                    const preferedCode = this.user.properties.find(p => p.type && p.type.identifier === "org.taktik.icure.tarification.favorites")

                    if (preferedCode && preferedCode.typedValue) {
                        const code = JSON.parse(preferedCode.typedValue.stringValue)

                        let existingCode = code.cs.find(c => c === newCode.id)

                        if (!existingCode) {
                            code.cs.push(newCode.id)

                            preferedCode.typedValue.stringValue = JSON.stringify(code)

                            this.set('user.properties', this.user.properties.map(x => x))

                            console.log(this.user)

                            this.api.user().modifyUser(this.user)
                                .then(user => this.api.register(user,"user"))
                                .then(user => this.dispatchEvent(new CustomEvent('user-saved', {
                                detail: user,
                                bubbles: true,
                                composed: true
                            })))

                            this.getFavoritesCodes()
                        }
                    }
                }
                this.set('nmcl-value','')
                this.shadowRoot.querySelector("#nmcl-search").focus()
            }

            _deleteFavoriteCode(e) {
                const preferedCode = this.user.properties.find(p => p.type && p.type.identifier === "org.taktik.icure.tarification.favorites")

                if (preferedCode && preferedCode.typedValue) {
                    let code = JSON.parse(preferedCode.typedValue.stringValue)

                    const index = code.cs.indexOf(e.target.dataset.item)
                    delete(code.cs[index])
                    code.cs.splice(index, 1)

                    preferedCode.typedValue.stringValue = JSON.stringify(code)

                    this.set('user.properties', this.user.properties.map(x => x))

                    this.api.user().modifyUser(this.user)
                        .then(user => this.api.register(user,'user'))
                        .then(user => this.dispatchEvent(new CustomEvent('user-saved', {
                        detail: user,
                        bubbles: true,
                        composed: true
                    })))

                    this.getFavoritesCodes()
                }

            }

            _verifyTarification() {
                if (this.patient.ssin && this.api.tokenId && this.selectedInvoice.invoiceDate !== "" && this.api.isValidSsin(this.patient.ssin)) {
                    this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                        .then(hcp =>
                            this.api.fhc().Tarificationcontroller().consultTarificationUsingPOST(
                                this.patient.ssin, this.api.tokenId, this.api.keystoreId, this.api.credentials.ehpassword,
                                hcp.firstName, hcp.lastName, hcp.nihii, hcp.ssin,
                                this.selectedInvoice.invoicingCodes.filter(ic => ic.code!="109955").map(ic=>ic.code), this.selectedInvoice.invoiceDate, this.selectedInvoice.gnotionNihii === ""  ? null : this.selectedInvoice.gnotionNihii,
                                this.selectedInvoice.thirdPartyReference === "0" ? null : this.selectedInvoice.thirdPartyReference).then(r => this.api.logMcn(r, this.user, this.selectedInvoice.id))
                        )
                        .then(r => {
                            console.log(r)
                            this.set('isDetailNmcl', false)
                            this.set("tarificationError", null)

                            if (r.errors.length > 0) {
                                const errors = r.errors
                                this.set("tarificationError", errors)
                                this.set("isTarificationError", true)

                                if (errors[0].code === "999999") {
                                    this.set("isTarificationMcnError", true)
                                    this.set("isNmclVerified", true)
                                }

                            } else {
                                this.set("isTarificationError", false)
                                this.set("isNmclVerified", true)
                                this.set("isTarificationMcnError", false)

                                r.codeResults.forEach((c,idx) => {
                                    let invCode = this.selectedInvoice.invoicingCodes[idx]
                                    if (c.code !== invCode.code) {
                                        //Desperate measure
                                        invCode = this.selectedInvoice.invoicingCodes.find(invCode => invCode.code === c.code)
                                        idx = this.selectedInvoice.invoicingCodes.indexOf(invCode)
                                    }

                                    this.set(`selectedInvoice.invoicingCodes.${idx}.reimbursement`, c.reimbursement.amount)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.patientIntervention`, c.patientFee.amount)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.totalAmount`, c.fee.amount)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.contract`, c.contract)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.valid`, true)
                                    this.set(`selectedInvoice.invoicingCodes.${idx}.override3rdPayerCode`, c.justification)

                                    //this.$['nmclGrid'].clearCache()
                                })
                                this.calculateTotalOfInvoice()
                                console.log(this.selectedInvoice)
                            }
                        }).catch((e) => {
                        console.log("Exception", e)
                    })

                } else {
                    //Todo manage mandatory fields
                }
            }

            calculateTotalOfInvoice() {
                let totalAmount = 0
                let patientIntervention = 0
                let reimbursement = 0
                let doctorSupplement = 0

                this.selectedInvoice.invoicingCodes.map(n => {
                    totalAmount += Number(n.totalAmount)
                    patientIntervention += Number(n.patientIntervention)
                    reimbursement += Number(n.reimbursement)
                    doctorSupplement += Number(n.doctorSupplement)
                })

                this.set('totalInvoice.totalAmount', Number(totalAmount).toFixed(2))
                this.set('totalInvoice.patientIntervention', Number(patientIntervention).toFixed(2))
                this.set('totalInvoice.reimbursement', Number(reimbursement).toFixed(2))
                this.set('totalInvoice.doctorSupplement', Number(doctorSupplement).toFixed(2))
            }

            _getErrorMsg(item, language) {
                return language === "fr" ? item.msgFr : item.msgNl
            }

            _showDetail() {
                if (this.activeNmclItem) {
                    const selected = this.activeNmclItem
                    if(selected.code==="109955"){
                        this.set('activeNmclItem.qteAll',(this.activeNmclItem.units+6)/2)
                    }
                    this.set('isDetailNmcl', true)
                    console.log(this.activeNmclItem)
                } else {
                    this.set('isDetailNmcl', false)
                }
            }

            _checkIfPrescriberIsNeeded(e) {
                if (e.detail.value === 0 || e.detail.value === 3) {
                    this.set("isPrescriberIsNeeded", false)
                } else {
                    this.set("isPrescriberIsNeeded", true)
                }

            }

            _deleteNmclCode(e) {
                e.stopPropagation()
                if (e.target.dataset.item) {
                    //this.api.invoice().removeCodes(this.user.id, service, this.patient.secretForeignKeys, e.target.item.tarificationId
                    this.set('isDetailNmcl', false)
                    let tabNmcl = this.selectedInvoice.invoicingCodes

                    const item = tabNmcl.find(n => n.tarificationId === e.target.dataset.item)
                    const iindex = tabNmcl.indexOf(item)

                    delete(tabNmcl[iindex])
                    tabNmcl.splice(iindex, 1)

                    this.set("selectedInvoice.invoicingCodes", this.selectedInvoice.invoicingCodes.map(x => x))

                    this.api.invoice().modifyInvoice(this.selectedInvoice)
                        .then(invoice => this.api.register(invoice,'invoice'))
                        .then(invoice => {
                            console.log(invoice)
                            this.set('selectedInvoice', invoice)
                            this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => this.set('invoices', invoices))
                    })

                    this.$['nmclGrid'].clearCache()

                    this.calculateTotalOfInvoice()
                }
            }

            analyzeCareProviderType(e) {
                if (e.detail.value === "traineeDoctor") {
                    this.set("isTrainee", true)
                } else {
                    this.set("isTrainee", false)
                }
            }

            _createInvoice() {

                this.set('selectedInvoice.printedDate', moment().format("YYYYMMDD"))

                if(this.selectedInvoice.creditNote){
                    console.log(this.selectedInvoice)
                    this.selectedInvoice.invoicingCodes.map(invoiceCode =>{
                        this.set("selectedInvoice.invoicingCodes."+this.selectedInvoice.invoicingCodes.indexOf(invoiceCode)+".reimbursement",0-invoiceCode.reimbursement)
                        this.set("selectedInvoice.invoicingCodes."+this.selectedInvoice.invoicingCodes.indexOf(invoiceCode)+".patientIntervention",0-invoiceCode.patientIntervention)
                        this.set("selectedInvoice.invoicingCodes."+this.selectedInvoice.invoicingCodes.indexOf(invoiceCode)+".doctorSupplement",0-invoiceCode.doctorSupplement)
                        this.set("selectedInvoice.invoicingCodes."+this.selectedInvoice.invoicingCodes.indexOf(invoiceCode)+".totalAmount",0-invoiceCode.totalAmount)

                    })
                }
                //return;
                this.api.entityRef().getLatest("Invoice::").then(latest => {
                    console.log(latest)
                    const lastReference = latest.id.replace(/\Invoice:[^_]/g, '')
                    const newReference = Number(lastReference) + 1

                    this.set("selectedInvoice.invoiceReference", newReference)
                    this.api.invoice().modifyInvoice(this.selectedInvoice)
                        .then(invoice => this.api.register(invoice,'invoice'))
                        .then(invoice => this.api.entityRef().createEntityReference({docId: invoice.id, id: "Invoice::"+newReference})
                        .then( () => {
                            console.log(invoice)
                            this.set('selectedInvoice', invoice)
                            this._selectInvoice(invoice.id)
                            this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => {
                                this.set('invoices', invoices)
                                this.generateJustificatory()
                            })
                        }))
                })
            }

            _invoicingCodeChange() {
                if (this.activeNmclItem) {
                    const code = this.selectedInvoice.invoicingCodes.find(code => code.id === this.activeNmclItem.id)
                    const codeIdx = this.selectedInvoice.invoicingCodes.indexOf(code)

                    let totalAmount = Number(this.activeNmclItem.patientIntervention) + Number(this.activeNmclItem.reimbursement) + Number(this.activeNmclItem.doctorSupplement)

                    this.set('activeNmclItem.totalAmount', Number(totalAmount).toFixed(2))
                    this.set('selectedInvoice.invoicingCodes.'+codeIdx, this.activeNmclItem)
                    this.$['nmclGrid'].clearCache()
                    this.calculateTotalOfInvoice()
                    this.selectedInvoiceChanged();
                }
            }

            returnDatePickerDate(date) {
                return date ? ("" + date).replace(/([0-9]{4})([0-9]{2})([0-9]{2})/, '$1-$2-$3') : 'N/A'

            }

            _formatInvoiceDate(date) {
                return date ? this.api.moment(date).format("DD/MM/YYYY") : 'N/A'
            }

            datePickerChanged() {
                console.log('datePickerChange')
            }

            _invoiceDateAsStringChanged(invoiceDateAsString) {
                const dateNow = parseInt(this.api.moment(Date.now()).format('YYYYMMDD'));
                const dateInt = parseInt(invoiceDateAsString.replace(/(....)-(..)-(..)/, '$1$2$3'))
                if (this.selectedInvoice && (this.selectedInvoice.invoiceDate !== dateInt)) {
                    if (dateInt <= dateNow) {
                        this.set('selectedInvoice.invoiceDate', dateInt)
                    } else {
                        this.$['invoice-date'].set(Date.now())
                    }

                }
            }
            findAndReplace(string, target, replacement) {
                for (let i = 0; i < string.length; i++) { string = string.replace(target, replacement); }
                return string;
            }

            getInvoiceType(invoiceType){
               const type = this.invoiceType.find(type => type.id == invoiceType)
               return type.label[this.language]
            }

            getSentMediumType(sentMediumType){
                const type = this.sentMediumType.find(type => type.id == sentMediumType)
                return type.label[this.language]
            }

            generateJustificatory(){
                const width = 210
                const height = 297

                const center = function (pdf, x, txt, fontSize) {
                    return x - pdf.getStringUnitWidth(txt) * fontSize / pdf.internal.scaleFactor / 2;
                };

                const pdf = new jsPDF('p', 'mm', [width, height]);


                pdf.setFontSize(9);
                pdf.setFont('Arial');
                pdf.text("Numéro d'ordre:"+this.selectedInvoice.invoiceReference, 20, 24)
                pdf.text("DOCUMENT JUSTIFICATIF DE SOINS DE SANTE DESTINE AU PATIENT", 86, 24)
                pdf.text("Patient", 38.5, 31.5)
                pdf.text("Dispensateur de soins", 117, 31.5)
                pdf.text("Identification", 20, 38.5)
                pdf.text("Identification", 77, 38.5)
                pdf.text("Les prestations de santé ont été effectuées pour le\n compte de :", 134, 38.5)
                pdf.text("Nom: "+this.patient.firstName, 20, 45.5)
                pdf.text("Nom: "+this.hcp.firstName, 77, 45.5)
                pdf.text("Nom: ", 135, 45.5)
                pdf.text("Prénom: "+this.patient.lastName, 20, 52)
                pdf.text("Prénom: "+this.hcp.firstName, 77, 52)
                pdf.text("BCE: ", 135, 52)
                pdf.text("NISS: "+this.patient.inss, 20, 58)
                pdf.text("Adresse: "+this.patient.firstName, 77, 58)
                pdf.text("INAMI: "+this.hcp.nihii, 77, 70)
                pdf.text("BCE: "+this.hcp.cbe, 77, 76)


                pdf.text("PRESTATION(S) DE SANTE REMBOURSABLE(S)", 86, 90)
                pdf.text("Date des prestations", 20, 96)
                pdf.text("Prestation(s) facturée(s) en tiers payant", 86, 96)

                pdf.text("Code prestation", 51, 102)
                pdf.text("Intervention OA", 80, 102)
                pdf.text("Intervention personnelle", 110, 102)
                pdf.text("Supplément", 150, 102)
                pdf.text("Total", 180, 102)

                let startNmclHeight = 108

                let totTotal=0;
                let totOA=0;
                let totPers=0;
                let totSupp=0;

                this.selectedInvoice.invoicingCodes.map(code => {
                    let invoiceDate = this._formatInvoiceDate(code.dateCode)
                    pdf.text(invoiceDate,20, startNmclHeight)
                    pdf.text(code.code.toString(),50, startNmclHeight)
                    pdf.text(code.reimbursement.toString(),95, startNmclHeight)
                    pdf.text(code.patientIntervention.toString(),132, startNmclHeight)
                    pdf.text(code.doctorSupplement.toString(),160, startNmclHeight)
                    pdf.text(code.totalAmount.toString(),184, startNmclHeight)

                    startNmclHeight = Number(startNmclHeight) + 6

                    totTotal+=code.totalAmount;
                    totOA+=code.reimbursement;
                    totPers+=code.patientIntervention;
                    totSupp+=code.doctorSupplement;
                })

                pdf.text("Total", 20, 260)
                pdf.text(totOA.toString(), 95, 260)
                pdf.text(totPers.toString(), 132, 260)
                pdf.text(totSupp.toString(), 160, 260)
                pdf.text(totTotal.toString(), 184, 260)

                pdf.text("Total dû par le patient", 20, 266)
                pdf.text(totPers.toString(), 184, 266)

                pdf.text("Montant total facturé à l'organisme assureur (OA)", 20, 272)
                pdf.text(totOA.toString(), 184, 272)

                pdf.text("Montant total à payer par le patient ", 20, 278)
                pdf.text((totPers+totSupp).toString(), 184, 278)

                pdf.setFontSize(6);
                pdf.text("Le présent document justificatif ne donne aucun droit au remboursement", 20, 284)


                //Horizontals lines
                pdf.lines([[0, 0], [180, 0]], 18, 20);
                pdf.lines([[0, 0], [180, 0]], 18, 27.5);
                pdf.lines([[0, 0], [180, 0]], 18, 34.5);
                pdf.lines([[0, 0], [180, 0]], 18, 80);
                pdf.lines([[0, 0], [180, 0]], 18, 86);
                pdf.lines([[0, 0], [180, 0]], 18, 92);
                pdf.lines([[0, 0], [180, 0]], 18, 98);
                pdf.lines([[0, 0], [180, 0]], 18, 262);
                pdf.lines([[0, 0], [180, 0]], 18, 268);
                pdf.lines([[0, 0], [180, 0]], 18, 274);
                pdf.lines([[0, 0], [180, 0]], 18, 280);


                //Verticals lines
                pdf.lines([[0, 60], [0, 0]], 18, 20);
                pdf.lines([[0, 60], [0, 0]], 68, 20);
                pdf.lines([[0, 45], [0, 0]], 75, 34.5);
                pdf.lines([[0, 45], [0, 0]], 132, 34.5);
                pdf.lines([[0, 60], [0, 0]], 198, 20);

                pdf.lines([[0, 194], [0, 0]], 18, 86);
                pdf.lines([[0, 194], [0, 0]], 198, 86);

                pdf.addPage()

                pdf.setFontSize(9);
                pdf.setFont('Arial');
                pdf.text("Numéro d'ordre:"+this.selectedInvoice.invoiceReference, 20, 24)
                pdf.text("DOCUMENT JUSTIFICATIF DE SOINS DE SANTE DESTINE AU MEDECIN", 86, 24)
                pdf.text("Dispensateur de soins", 117, 31.5)
                pdf.text("Identification", 20, 38.5)
                pdf.text("Les prestations de santé ont été effectuées pour le\n compte de :", 134, 38.5)
                pdf.text("Nom: "+this.hcp.firstName, 20, 45.5)
                pdf.text("Nom: ", 135, 45.5)
                pdf.text("Prénom: "+this.hcp.lastName, 20, 52)
                pdf.text("BCE: ", 135, 52)
                pdf.text("Adresse: ", 20, 58)
                pdf.text("INAMI: "+this.hcp.nihii, 20, 64)
                pdf.text("BCE: "+this.hcp.cbe, 20, 70)
                pdf.text("N° mutuelle: "+ "/ N° OA", 20, 76)


                pdf.text("PRESTATION(S) DE SANTE REMBOURSABLE(S)", 86, 90)
                pdf.text("Date des prestations", 20, 96)
                pdf.text("Prestation(s) facturée(s) en tiers payant", 86, 96)

                pdf.text("Code prestation", 51, 102)
                pdf.text("Intervention OA", 80, 102)
                pdf.text("Intervention personnelle", 110, 102)
                pdf.text("Supplément", 150, 102)
                pdf.text("Total", 180, 102)

                startNmclHeight = 108

                totTotal=0;
                totOA=0;
                totPers=0;
                totSupp=0;

                this.selectedInvoice.invoicingCodes.map(code => {
                    let invoiceDate = this._formatInvoiceDate(code.dateCode)
                    pdf.text(invoiceDate,20, startNmclHeight)
                    pdf.text(code.code.toString(),50, startNmclHeight)
                    pdf.text(code.reimbursement.toString(),95, startNmclHeight)
                    pdf.text(code.patientIntervention.toString(),132, startNmclHeight)
                    pdf.text(code.doctorSupplement.toString(),160, startNmclHeight)
                    pdf.text(code.totalAmount.toString(),184, startNmclHeight)

                    startNmclHeight = Number(startNmclHeight) + 6

                    totTotal+=code.totalAmount;
                    totOA+=code.reimbursement;
                    totPers+=code.patientIntervention;
                    totSupp+=code.doctorSupplement;
                })

                pdf.text("Total", 20, 260)
                pdf.text(totOA.toString(), 95, 260)
                pdf.text(totPers.toString(), 132, 260)
                pdf.text(totSupp.toString(), 160, 260)
                pdf.text(totTotal.toString(), 184, 260)

                pdf.text("Total dû par le patient", 20, 266)
                pdf.text(totPers.toString(), 184, 266)

                pdf.text("Montant total facturé à l'organisme assureur (OA)", 20, 272)
                pdf.text(totOA.toString(), 184, 272)

                pdf.text("Montant total à payer par le patient ", 20, 278)
                pdf.text((totPers+totSupp).toString(), 184, 278)

                pdf.setFontSize(6);
                pdf.text("Le présent document justificatif ne donne aucun droit au remboursement", 20, 284)

                //Horizontals lines
                pdf.lines([[0, 0], [180, 0]], 18, 20);
                pdf.lines([[0, 0], [180, 0]], 18, 27.5);
                pdf.lines([[0, 0], [180, 0]], 18, 34.5);
                pdf.lines([[0, 0], [180, 0]], 18, 80);
                pdf.lines([[0, 0], [180, 0]], 18, 86);
                pdf.lines([[0, 0], [180, 0]], 18, 92);
                pdf.lines([[0, 0], [180, 0]], 18, 98);
                pdf.lines([[0, 0], [180, 0]], 18, 262);
                pdf.lines([[0, 0], [180, 0]], 18, 268);
                pdf.lines([[0, 0], [180, 0]], 18, 274);
                pdf.lines([[0, 0], [180, 0]], 18, 280);


                //Verticals lines
                pdf.lines([[0, 60], [0, 0]], 18, 20);
                pdf.lines([[0, 7], [0, 0]], 68, 20);
                pdf.lines([[0, 45], [0, 0]], 132, 34.5);
                pdf.lines([[0, 60], [0, 0]], 198, 20);

                pdf.lines([[0, 194], [0, 0]], 18, 86);
                pdf.lines([[0, 194], [0, 0]], 198, 86);



                pdf.autoPrint();

                pdf.save(`efactJustificatory_${this.patient.lastName || 'Doe'}_${this.patient.firstName || 'John'}_${this.selectedInvoice.invoiceDate || '00000000'}.pdf`);

            }

            _ifStatusDateExist(date){
                return (date && date !== "") ? true : false
            }

            _getOvveride3PayerCodeAsString(tp){
                    const tpAsString = this.thirdPartyJustification.find(tpRef => tpRef.id == tp)
                    return (tpAsString) ? tpAsString.label[this.language] : ""

            }

            _tranferNmcl(){
                if(this.bufferTypeCode!=this.selectedMediumCodeType){
                    this.api.crypto().extractDelegationsSFKs(this.patient, this.user.healthcarePartyId).then(secretForeignKeys => {
                        const patientKeys = secretForeignKeys.join(",")
                        this.api.invoice().appendCodes(this.user.id,this.selectedInvoice.invoiceType, this.bufferTypeCode, this.patient.insurabilities[0].insuranceId, patientKeys, null, 0, [this.activeNmclItem]).then(response => {
                            response.map(invoice => {
                                if (!invoice.id) {
                                    invoice.invoiceDate = this.selectedInvoice.invoiceDate
                                    invoice.invoiceReference = this.selectedInvoice.invoiceReference
                                    invoice.thirdPartyReference = this.selectedInvoice.thirdPartyReference
                                    invoice.invoicePeriod = this.selectedInvoice.invoicePeriod
                                    invoice.longDelayJustification = this.selectedInvoice.longDelayJustification
                                    invoice.gnotionNihii = this.selectedInvoice.gnotionNihii === "" ? null : this.selectedInvoice.gnotionNihii
                                    invoice.internshipNihii = this.selectedInvoice.internshipNihii === "" ? null : this.selectedInvoice.internshipNihii
                                    invoice.creditNote = this.selectedInvoice.creditNote
                                    invoice.careProviderType = this.selectedInvoice.careProviderType

                                    this.api.invoice().newInstance(this.user, this.patient, invoice)
                                        .then(invoice => this.api.register(invoice,'invoice'))
                                        .then(invoice => this.api.invoice().createInvoice(invoice))
                                        .then(invoice => this.api.register(invoice,'invoice'))
                                        .then(invoice => {
                                            this.$['nmclGrid'].clearCache()
                                            this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => {
                                                this.set('invoices', invoices)
                                                this._selectInvoice(invoice.id)
                                            })

                                        })
                                }else{
                                    this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => {
                                        this.set('invoices', invoices)
                                        const selectedInvoice = invoices.find(i => i.id === this.selectedInvoice.id)
                                        this._selectInvoice(selectedInvoice.id)
                                    })
                                }
                            })



                            this.set('isDetailNmcl', false)
                            let tabNmcl = this.selectedInvoice.invoicingCodes

                            const item = tabNmcl.find(n => n.tarificationId === this.activeNmclItem)
                            const iindex = tabNmcl.indexOf(item)

                            delete(tabNmcl[iindex])
                            tabNmcl.splice(iindex, 1)

                            this.set("selectedInvoice.invoicingCodes", this.selectedInvoice.invoicingCodes.map(x => x))

                            this.api.invoice().modifyInvoice(this.selectedInvoice)
                                .then(invoice => this.api.register(invoice,'invoice'))
                                .then(invoice => {
                                    this.set('selectedInvoice', invoice)
                                    this.api.invoice().findBy(this.user.healthcarePartyId, this.patient).then(invoices => this.set('invoices', invoices))
                            })

                            this.$['nmclGrid'].clearCache()

                            this.calculateTotalOfInvoice()

                            this._selectInvoice(this.selectedInvoice.id)
                        })
                    })
                }
            }

            _openTransfertDialog(e){
                e.stopPropagation()
                this.$["transferDialog"].open()
            }

            _openlinkRelativePrestationDialog(e){
                e.stopPropagation()
                this.parentRelatedCodeId = e.target.id
                this.$["relativeCodeDialog"].open()
            }

            _linkCode(selectedNmclId){
                if(selectedNmclId != ""){
                    const childNmcl = this.selectedInvoice.invoicingCodes.find(nmcl => selectedNmclId === nmcl.id) || null
                    const parentNmcl = this.selectedInvoice.invoicingCodes.find(nmcl => this.parentRelatedCodeId === nmcl.id) || null

                    if(childNmcl !== null && parentNmcl !== null){
                        parentNmcl.relatedCode = childNmcl.code
                        this.$["relativeCodeDialog"].close()
                    }

                }

            }

            //Obsolete because related-code.html is not supported by vaadin-grid for the moment.
            linkNmclToRelatedCode(e) {
                if (e.detail.relativeCode && e.detail.parentId) {
                    let selectedNmcl = this.selectedInvoice.invoicingCodes.find(n => n.id === e.detail.parentId) || null
                    if (selectedNmcl !== null) {
                        selectedNmcl.relatedCode = e.detail.relativeCode
                    }
                }
            }

            savingInvoices(){
                if (this.saveTimeout) {
                    clearTimeout(this.saveTimeout);
                }
                this.saveAction = () => {
                    this.isSelected=true;
                    const invoice = this.invoices.find(invoice => invoice===this.selectedInvoice)
                    //console.log(invoice)
                    //invoice.longDelayJustification=invoice.longDelayJustification ? 1 : 0
                    this.api.invoice().modifyInvoice(invoice)
                        .then(invoice => this.api.register(invoice,'invoice'))
                        .then(response => {
                            this.api.tarification().getTarifications(new models.ListOfIdsDto({ids: response.invoicingCodes.map(tar => tar.tarificationId)})).then(nmcls =>
                                nmcls.map(nmcl =>{
                                    const sn = response.invoicingCodes.find(n => n.tarificationId === nmcl.id) || null
                                    if(sn){
                                        sn.prescriberNeeded = nmcl.needsPrescriber
                                        sn.isRelativePrestation = nmcl.hasRelatedCode
                                    }
                                })
                            ).finally(()=>{
                                this.set("invoices."+this.invoices.indexOf(invoice),response)
                                this.isSelected=true;
                                this.set("selectedInvoice",response)
                                this.isSelected=false;
                            })
                    })
                };
                this.saveTimeout = setTimeout(this.saveAction, 10000);
            }

            selectedInvoiceChanged(){
                if(this.isSelected) return;
                this.savingInvoices();
            }

            isEnterPressed(e){
                if(e.keyCode==13){
                    this._addNmcl(e);
                }
            }

            /*isLongDelay() {
                return this.selectedInvoice.longDelayJustification ? true : false
            }*/

            _openEidDialog(){
                this.$["eidDialog"].open()
            }

            _readEidCard(){

            }

            _readBarreCode(){

            }

            _showManualEncodingDialog(){
                this.$['eidDialog'].close()
                this.$['manualEncodingDialog'].open()
            }

            _closeEidDialog(){
                this.$['eidDialog'].close()
            }

            _closeManualEncodingDialog(){
                this.$['manualEncodingDialog'].close()
            }

            _isCreditNote(e) {
                this.set('selectedInvoice.creditNote', e.target.checked)
            }

            _isLiftingLimitationPeriod(e) {
                this.set('selectedInvoice.longDelayJustification', e.target.checked)
            }

            isTravellingExpenses(){
                return this.activeNmclItem.code==="109955"
            }

            quantityAllHasChanged(){
                this.set("activeNmclItem.units",Math.round(this.activeNmclItem.qteAll*2)-6)
                if(this.activeNmclItem.units<0)this.set("activeNmclItem.units",0)
                if(this.activeNmclItem.qteAll>20)this.set("activeNmclItem.units",34)

                const total = Math.round(this.activeNmclItem.units*0.92*100)/100
                //entre 1.103 et 1.10 ils ont super mal calculé leurs éléments et ils donnent pas la formule.

                const remb = [0.84,1.67,2.51,3.34,4.17,5.01,5.84,6.67,7.51,8.34,9.17,10.01,10.84,11.68,12.51,13.34,14.18,15.01,15.84,16.68,17.51,18.35,19.18,20.01,20.84,21.68,22.51,23.35,24.18,25.01,25.85,26.68,27.51,28.35]

                this.set("activeNmclItem.patientIntervention",(total-remb[this.activeNmclItem.units-1]).toFixed(2))
                this.set("activeNmclItem.reimbursement",remb[this.activeNmclItem.units-1])

                return Math.round(this.activeNmclItem.qteAll*2)
            }


        }

        customElements.define(HtPatInvoicingDialog.is, HtPatInvoicingDialog)
    </script>
</dom-module>
