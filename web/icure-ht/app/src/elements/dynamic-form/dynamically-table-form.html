
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<link rel="import" href="dynamic-form.html">

<dom-module id="dynamically-table-form">
    <template>
        <style include="icd-styles">
            .form-title-bar-btn {
                height: 20px;
                width: 20px;
                padding: 2px;
            }
            .horizontal vaadin-date-picker {
                height: 90px;
                padding-bottom: 0px;
                @apply --padding-right-left-16
            }

            vaadin-grid.material {

                font-family: Roboto, sans-serif;
                --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                --vaadin-grid-cell: {
                    padding: 8px;
                };

                --vaadin-grid-header-cell: {
                    height: 64px;
                    color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                    font-size: 12px;
                };

                --vaadin-grid-body-cell: {
                    height: 48px;
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                    font-size: 13px;
                };

                --vaadin-grid-body-row-hover-cell: {
                    background-color: var(--paper-grey-200);
                };

                --vaadin-grid-body-row-selected-cell: {
                    background-color: var(--paper-grey-100);
                };

                --vaadin-grid-focused-cell: {
                    box-shadow: none;
                    font-weight: bold;
                };
            }

            vaadin-grid.material .cell {
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 56px;
            }

            vaadin-grid.material .cell.last {
                padding-right: 24px;
            }

            vaadin-grid.material .cell.numeric {
                text-align: right;
            }

            vaadin-grid.material paper-checkbox {
                --primary-color: var(--paper-indigo-500);
                margin: 0 24px;
            }

            vaadin-grid.material vaadin-grid-sorter .cell {
                flex: 1;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            vaadin-grid.material vaadin-grid-sorter iron-icon {
                transform: scale(0.8);
            }

            vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                color: rgba(0, 0, 0, var(--dark-disabled-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction] {
                color: rgba(0, 0, 0, var(--dark-primary-opacity));
            }

            vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                transform: scale(0.8) rotate(180deg);
            }

            .link .ICD-10 span {
                content: '';
                display: inline-block;
                height: 6px;
                width: 6px;
                border-radius: 3px;
                margin-right: 3px;
                margin-bottom: 1px;
            }

            paper-listbox {
                min-width: 200px;
            }

            paper-menu-button {
                padding: 0;
            }
        </style>

        <ckmeans-grouping id="ckmeans-grouping" max-distance="1800000"></ckmeans-grouping>

        <vaadin-grid id="dynamic-list" size="10" multi-sort="[[multiSort]]" items="[[_labels(contacts,contacts.*, columns.*)]]" class="material" active-item="{{activeItem}}" on-tap="click">
            <vaadin-grid-column width="100px">
                <template class="header">Label</template>
                <template>[[item.label]]</template>
            </vaadin-grid-column>
            <template is="dom-repeat" items="[[columns]]" as="date" index-as="columnIndex">
                <vaadin-grid-column width="100px">
                    <template class="header">
                        [[date]]
                    </template>
                    <template>[[_itemValueAtIndex(item,index)]]</template>
                </vaadin-grid-column>
            </template>
        </vaadin-grid>
    </template>
    <script>
        Polymer({
            is: 'dynamically-table-form',
            properties: {
                api: {
                    type: Object
                },
                language: {
                    type: String
                },
                user: {
                    type: Object
                },
                patient: {
                    type: Object,
                    value: null
                },
                contact: {
                    type: Object,
                    value: null
                },
                contacts: {
                    type: Array,
                    value: []
                },
                activeItem: {
                    type: Object
                },
                healthElements: {
                    type: Array,
                    value: function () {
                        return []
                    }
                },
                currentContact: {
                    type: Object,
                    value: null
                },
                columns: {
                    type: Array,
                    value: null
                },
                clusters: {
                    type: Array,
                    value: null
                },
                labelsServices: {
                    type: Array,
                    value: null
                }
            },
            observers: [ '_updateTable(contacts, contacts.*)' ],

            _updateTable: function(contacts) {
                const services = _.sortBy(_.flatMap(contacts, c=>c.services.filter(s=>this.api.contact().isNumeric(s, this.language) && !s.endOfLife)),['modified'])
                const datesServices = services.reduce((acc,s)=>{
                    (acc[s.modified] || (acc[s.modified] = [])).push(s)
                    return acc
                }, {})
                console.log(datesServices)
                const labelsServices = services.reduce((acc,s)=>{
                    (acc[s.label] || (acc[s.label] = {label: s.label, services :[]})).services.push(s)
                    return acc
                }, {})
                console.log(labelsServices)
                this.set('labelsServices', labelsServices)
                const clusters = (Object.keys(datesServices).length>2) ? this.$['ckmeans-grouping'].cluster(_.sortBy(Object.keys(datesServices).map(d => parseInt(d)))).clusters : _.sortBy(Object.keys(datesServices)).map(d=>parseInt(d))
                this.set('clusters',clusters)
                const columns = clusters.map(a=> this.averageDate(a))//todo column cluster && ligne label
                this.set('columns',columns)
            },

            averageDate: function(cluster){
                if (!cluster) { return 0 }
                return (cluster.reduce((acc, val) => { return acc + val; }, 0)) / cluster.length;
            },

            _isNotInCurrentContact: function (currentContact, contact) {
                return currentContact === null || contact !== currentContact
            },

            _labels(){
                return this.labelsServices ? Object.values(this.labelsServices): []
            },

            _columnsIndex: function (item,index){
                return item? item[index][0]+'': ''
            },

            _shortDescription(svc) {
                return this.api.contact().shortServiceDescription(svc,this.language)
            },

            _itemValueAtIndex(item, index) {
                const services = item && item.services && item.services.filter(s=>this.clusters[index] && this.clusters[index].includes(s.modified)) || [];
                return services.length ? services.map(s=>this._shortDescription(s)).join(', ') : '-'
            }

        })
    </script>
</dom-module>
