<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-tree-toggle.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter-mixin.html">
<link rel="import" href="../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../dynamic-form/ckmeans-grouping.html">
<link rel="import" href="../../vaadin-icure-theme.html">
<link rel="import" href="../../spinner-style.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">

<link rel="import" href="../ht-pat/dialogs/ht-pat-invoicing-dialog.html">

<dom-module id="ht-msg-flatrate-invoice">
    <template>


        <custom-style>
            <style include="shared-styles vaadin-icure-theme spinner-style">

                :host {
                    display: block;
                    z-index:2;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                vaadin-grid {
                    height: calc(100vh - 145px);
                    box-shadow: var(--app-shadow-elevation-1);
                    border: none;
                    box-sizing: border-box;
                }

                vaadin-grid.material {
                    outline: 0 !important;
                    font-family: Roboto, sans-serif;
                    background: rgba(0, 0, 0, 0);
                    border: none;
                    --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                    --vaadin-grid-cell: {
                        padding: 8px;
                    };

                    --vaadin-grid-header-cell: {
                        height: 48px;
                        padding: 11.2px;
                        color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                        font-size: 12px;
                        background: rgba(0, 0, 0, 0);
                        border-top: 0;
                    };

                    --vaadin-grid-body-cell: {
                        height: 48px;
                        color: rgba(0, 0, 0, var(--dark-primary-opacity));
                        font-size: 13px;
                    };

                    --vaadin-grid-body-row-hover-cell: {
                        background-color: var(--app-background-color-dark);
                    };

                    --vaadin-grid-body-row-selected-cell: {
                        background-color: var(--paper-grey-100);
                    };

                    --vaadin-grid-focused-cell: {
                        box-shadow: none;
                        font-weight: bold;
                    };

                }

                vaadin-grid.material .cell {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    height: 100%;
                }

                vaadin-grid.material .cell.last {
                    padding-right: 24px;
                    text-align: center;
                }

                vaadin-grid.material .cell.numeric {
                    text-align: right;
                }

                vaadin-grid.material paper-checkbox {
                    --primary-color: var(--paper-indigo-500);
                    margin: 0 24px;
                }

                vaadin-grid.material vaadin-grid-sorter {
                    --vaadin-grid-sorter-arrow: {
                        display: none !important;
                    };
                }

                vaadin-grid.material vaadin-grid-sorter .cell {
                    flex: 1;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                vaadin-grid.material vaadin-grid-sorter iron-icon {
                    transform: scale(0.8);
                }

                vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                    color: rgba(0, 0, 0, var(--dark-disabled-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction] {
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                    transform: scale(0.8) rotate(180deg);
                }

                vaadin-grid.material::slotted(div) {
                    outline: 0 !important;
                }

                .invoice-panel{
                    height: 100%;
                    width: 100%;
                    padding: 0 20px;
                    box-sizing: border-box;
                    position:relative;
                }

                .oa-col{
                    min-width: 25px;
                }

                .ref-col{
                    min-width: 75px;
                }

                .invoice-col{
                    min-width: 40px;
                }

                .month-col{
                    min-width: 40px;
                }

                .invoiceDate-col{
                    min-width: 50px;
                }

                .invAmount-col{
                    min-width: 50px;
                }

                .accAmount-col{
                    min-width: 50px;
                }

                .refAmount-col{
                    min-width: 50px;
                }

                .stat-col{
                    min-width: 50px;
                }

                .reject-col{
                    min-width: 100px;
                }

                .payRef-col{
                    min-width: 50px;
                }

                .payDate-col{
                    min-width: 40px;
                }

                .payTot-col{
                    min-width: 40px;
                }

                .payBank-col{
                    min-width: 50px;
                }

                .payPaid-col{
                    min-width: 50px;
                }

                .facture-title {
                    padding: 15px;
                    font-size: 25px;
                    text-transform: capitalize;
                    margin: 0;
                    color: #212121;
                    height: 25px;
                    line-height: 25px;
                }


                @media screen and (max-width:1025px){
                    .invoice-panel {
                        left: 0;
                        width: 100%;
                    }
                }
                .gridContainer{
                    height: 100%;
                    overflow-y: hidden;
                    overflow-x: hidden;
                    box-shadow: var(--app-shadow-elevation-1);
                }

                .invoice-status {
                    border-radius: 20px;
                    padding: 1px 12px 1px 8px;
                    font-size: 12px;
                    display: block;
                    width: auto;
                    max-width: fit-content;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    overflow: hidden;
                }

                .invoice-status--orangeStatus{
                    background: #fcdf354d;
                }

                .invoice-status--greenStatus{
                    background: #07f8804d;
                }

                .invoice-status--blueStatus {
                    background: #84c8ff;
                }

                .invoice-status--redStatus{
                    background: #ff4d4d4d;
                }

                .statusIcon{
                    height: 8px;
                    width: 8px;
                }
                .statusIcon.invoice-status--orangeStatus {
                    color: var(--app-status-color-pending);
                }
                .statusIcon.invoice-status--greenStatus {
                    color: var(--app-status-color-ok);
                }
                .statusIcon.invoice-status--blueStatus {
                    color: var(--paper-blue-400);
                }
                .statusIcon.invoice-status--redStatus {
                    color: var(--app-status-color-nok);
                }
                .statusIcon.invoice-status--orangeStatus,
                .statusIcon.invoice-status--greenStatus,
                .statusIcon.invoice-status--redStatus {
                    background: transparent !important;
                }

                *.txtcolor--orangeStatus {
                    color: var(--app-status-color-pending);
                }
                *.txtcolor--greenStatus {
                    color: var(--app-status-color-ok);
                }
                *.txtcolor--blueStatus {
                    color: var(--paper-blue-400);
                }
                *.txtcolor--redStatus {
                    color: var(--app-status-color-nok);
                }

                #pendingDetailDialog{
                    height: calc(100vh - 40px);
                    width: calc(85% - 40px);
                    z-index: 1100;
                    position: fixed;
                    top: 64px;
                }

                #pendingGridDetail{
                    height: calc(100% - 185px);
                    padding: 0;
                    width: 100%;
                }

                .batch-status {
                    font-size: 24px;
                    text-transform: capitalize;
                    padding-top: 5px;
                    display: flex;
                    flex-flow: row wrap;
                    align-items: center;
                    justify-content: flex-start;
                }

                .unlockBtn {
                    height: 12px;
                    width: 12px;
                }

                .hidden {
                    display: none;
                }

                #messagesGridContainer {
                    overflow-y: auto;
                }

                .invoiceContainer{
                    overflow-x: hidden;
                    overflow-y: hidden;
                    height: calc(100vh - 145px);
                    box-shadow: var(--app-shadow-elevation-1);
                }
                .invoiceSubContainerBig {
                   height: 100%;
                }

                .invoiceSubContainerMiddle {
                    height: calc(100%);
                    transition: all .5s ease;
                }
                .invoiceSubContainerMiddle vaadin-grid {
                    /*height: 100%;*/
                }
                .invoiceSubContainerMiddle.half {
                    height: 49%;
                }

                .invoiceDetailContainer,
                .toBeCorrectedDetailContainerC{
                    height: 50%;
                    opacity: 0;
                    transition: all .75s ease-out;
                    overflow-y: auto;
                }
                .invoiceDetailContainer.open,
                .toBeCorrectedDetailContainerC.open {
                    opacity: 1;
                    width: 100%;
                    height: 37%;
                }

                tr.hidden {
                    display: none !important;
                }

                .mb0 {
                    margin-bottom: 0;
                }

                #pendingDetailDialog {
                    max-height: 80vh;
                }

                .helpdeskIcon {
                    height: 12px;
                    width: 12px;
                    cursor: pointer;
                    opacity: 0.7;
                    transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
                }

                .helpdeskIcon:hover{
                    transform: scale(1.05);
                    opacity: 1;
                }

                iron-collapse-button #trigger{
                    height: 45px;
                    background: var(--app-background-color-dark);
                    display: initial;
                }

                #invoiceCollapser {
                    display: block;
                    background: white;
                    height: calc(100% - 75px);
                    overflow-y: auto;
                }

                h3.header {
                    margin: 0 auto
                }
                #collapse-grid .recipient-col {
                    background: grey;
                }

                .rejectionReason-col {
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    max-width: 100%;
                }

                .containScroll {
                    overflow: auto;
                    height: 100%;
                }

                .scrollBox {
                    width: 100%;
                    overflow: hidden;
                    height: 100%;
                }
                .scrollBox > #messagesGrid {
                    width: 100%;
                    height: 100%;
                }

                .flex-header{
                    width: 100%;
                    display: flex;
                    flex-flow: row nowrap;
                    justify-content: flex-start;
                    align-items: center;
                    height: 48px;
                }

                iron-collapse-button:hover{
                    background: var(--app-background-color-dark);
                }

                .flex-header span{
                    display:block;
                    font-size: 12px;
                    font-weight: 400;
                    padding: 4px 12px;
                    box-sizing:border-box;
                    cursor: pointer;
                    color: rgb(115,115,115);
                }

                .flex-header span.center{
                    text-align: center;
                }

                #invoiceGrid .footer{
                    background: red;
                }

                #helpdeskInfoDialog{
                    position: fixed;
                    width: 50%;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%);
                    max-width: none !important;
                    max-height: none !important;
                    overflow-y: auto;
                }

                .modal-title {
                    background: var(--app-background-color-dark);
                    margin-top: 0;
                    padding: 16px 24px;
                }

                .modal-content{
                    display: flex;
                    flex-flow: row wrap;
                    align-items: center;
                    justify-content: flex-start;
                }

                .modal-button{
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                    color: var(--app-text-color);
                    font-weight: 400;
                    font-size: 14px;
                    height: 40px;
                    min-width: 100px;
                    padding: 10px 1.2em;
                    text-transform: capitalize;
                }

                .modal-input{
                    margin: 0 12px;
                    flex-grow: 1;
                }

                paper-input{
                    --paper-input-container-focus-color: var(--app-primary-color);
                }

                .buttons {
                    position: absolute;
                    right: 0;
                    bottom: 0;
                    margin: 8px 16px;
                }

                .modal-button{
                    --paper-button-ink-color: var(--app-secondary-color);
                    background-color: var(--app-secondary-color);
                    color: var(--app-text-color);
                    font-weight: 700;
                    font-size: 14px;
                    height: 40px;
                    min-width: 100px;
                    padding: 10px 1.2em;
                    text-transform: capitalize;
                }

                .modal-button--close,
                .modal-button--cancel{
                    background: transparent;
                    color: var(--app-primary-color-dark);
                    font-weight: 400;
                }

                .modal-button--save{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-secondary-color);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;

                }

                .modal-button[disabled] {
                    background: var(--app-secondary-color-dark);
                }

                .batchNumber{
                    color: var(--app-text-color-light);
                    border-radius: 25px;
                    min-height: 0;
                    margin-left: 8px;
                    font-size: .6em;
                    display: inline-block;
                    padding: 4px 6px;
                    line-height: 0.8;
                    text-align: center;
                    height: 10px;
                }
                .batchPending{background-color: var(--paper-orange-400);}
                .batchToBeCorrected{background-color: var(--paper-red-400);}
                .batchProcessed{background-color: var(--paper-blue-400);}
                .batchRejected{background-color: var(--paper-red-400);}
                .batchAccepted{background-color: var(--paper-green-400);}
                .batchArchived{background-color: var(--paper-purple-300);}
                .batchToBeSend{background-color: var(--paper-orange-400);}

                ht-spinner {
                    margin-top:10px;
                    margin-bottom:10px;
                    height:42px;
                    width:42px;
                }

                .tool-btn{
                    margin: 0;
                    box-sizing: border-box;
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                    display: inline-block;
                    text-align: center;
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: auto;
                        margin: 0 auto;
                        font-size: 13px;
                        font-weight: 700;
                        padding:10px;
                    };
                }

                .tool-btn-previous-month {
                    color:#ffffff;
                    --paper-button: {
                        background: var(--app-text-color);
                        font-weight: 400;
                    };
                }

                #rightPanel {
                    position: absolute;
                    right: -350px;
                    width:300px;
                    top: 0px;
                    background: rgba(255,255,255,1);
                    border-left:1px solid #dddddd;
                    box-shadow:0px 0px 3px 0px #dddddd;
                    height: 100%;
                    z-index: 5;
                    transition: all 400ms ease;
                    -moz-transition: all 400ms ease;
                    -webkit-transition: all 400ms ease;
                    -o-transition: all 400ms ease;
                    -ms-transition: all 400ms ease;
                }

                #rightPanel.opened {
                    right:0;
                }

                .header {
                    padding: 10px;
                    color: #ffffff;
                    text-transform: uppercase;
                    margin: 0;
                    font-weight: 700;
                    background-color: #777777;
                    cursor: pointer;
                }

                #rightPanel label {
                    margin:0;
                    padding:0;
                }

                #rightPanel .pullRightIcon {
                    margin:0;
                    padding:0;
                    min-width:1px;
                    float:right;
                }

                #rightPanel .body {
                    padding: 10px;
                }

                #rightPanel .body h4 {
                    text-transform: uppercase;
                    margin-bottom: 20px;
                    border-bottom: 1px solid #000000;
                    font-weight: 700;
                    margin-top:12px;
                    padding-bottom:2px;
                }

                #rightPanelToggleContainer {
                    position:absolute;
                    right:20px;
                    top:10px;
                }

                #rightPanelToggleContainer .header {
                    margin:0;
                    color:#000000;
                    background-color: initial;
                    padding:0;
                }

                .w30px {
                    width:30px
                }

                .h30px {
                    height:30px
                }

                .w20px {
                    width:20px
                }

                .h20px {
                    height:20px
                }

                .p-35px {
                    padding:35px;
                }

                .p-10px {
                    padding:10px;
                }

                .p-15px {
                    padding:15px;
                }

                .p-r-15px {
                    padding-right:15px;
                }

                .p-l-15px {
                    padding-left:15px;
                }

                .datePicker {
                    width:95%;
                }

                .m-t-40 {
                    margin-top:40px;
                }

                .m-t-50 {
                    margin-top:50px!important;
                }

                .m-t-20 {
                    margin-top:20px!important;
                }

                .m-t-25 {
                    margin-top:25px!important;
                }

                .w-100-pc {
                    width:100%;
                }

                .fr {
                    float:right
                }

                .m-t-20 {
                    margin-top:20px;
                }

                @media screen and (max-width: 1024px) {
                    .hideOnMobile {display: none;opacity: 0;}
                }

                .warningMessage {
                    margin-top: 20px;
                    margin-bottom: 30px;
                }

                .warningMessageBody {
                    padding:20px 35px;
                    color:#7E0000;
                    background-color: rgba(255, 0, 0, 0.15);
                    font-weight: 700;
                    border:1px dashed #7e0000;
                    text-transform: uppercase;
                    text-align: center;
                }

                #loadingContainer {
                    position:absolute;
                    width: 100%;
                    height: 100%;
                    top: 0;left: 0;
                    background-color: rgba(0,0,0,.3);
                    z-index: 10;
                    text-align: center;
                }

                #loadingContentContainer {
                    position:relative;
                    width: 400px;
                    min-height: 200px;
                    background-color: #ffffff;
                    padding:20px;
                    border:3px solid var(--app-secondary-color);
                    margin:40px auto 0 auto;
                    text-align: center;
                }

                .loadingIcon {
                    margin-right:5px;
                }

                .loadingIcon.done {
                    color: var(--app-secondary-color);
                }

                .f-s-1em {
                    font-size:1em;
                }

                .f-s-08em {
                    font-size:.8em;
                }

                #exportRangeNotification {
                    font-style:italic;
                    margin-top:10px;
                    color:#555555;
                }

                #exportRangeNotification span {
                    font-weight: 700;
                }

                .centerCenter {
                    text-align:center;
                    margin-top:30vh;
                    text-align:center;
                }

                .bordered {
                    border:1px solid #888888;
                }

                .textRed {
                    color:#A80000;
                }

                .textAlignCenter {
                    text-align: center;
                }

                .onlyIfRejectRate {
                    font-weight: 400;
                    color: #ffb7b7;
                    display:block;
                }

                .exportMonthPicker {
                    padding:0px 0 10px 0;
                    border:1px solid #ddd;
                    margin:40px auto;
                    max-width:520px;
                    -webkit-box-shadow: 2px 2px 5px 0 rgba(0,0,0,0.2);
                    box-shadow: 2px 2px 5px 0 rgba(0,0,0,0.2);
                }

                vaadin-combo-box {
                    margin:10px 30px 0 30px;
                    width:130px;
                }

                .exportMonthPickerTitle {
                    text-transform: uppercase;
                    margin-bottom:20px;
                    padding:10px 0 13px 0;
                    background-color:var(--app-secondary-color);
                    font-weight: 700;
                }

            </style>
        </custom-style>


        <div class="invoice-panel">


            <template is="dom-if" if="[[_isLoading]]">
                <div id="loadingContainer">
                    <div id="loadingContentContainer">
                        <ht-spinner class="spinner" alt="Loading..." active></ht-spinner>
                        <div id="loadingContent"><p><iron-icon icon="arrow-forward" class="loadingIcon"></iron-icon> [[localize("mhListing.spinner.step_1", language)]]</p></div>
                    </div>
                </div>
            </template>



            <div id="batchStatus" class="batch-status">
                [[localize(flatrateMenuSection, language)]]
                <template is="dom-if" if="[[_isEqual(flatrateMenuSection,'j20_toBeCorrected')]]"><span class="batchNumber j20_batchNumber batchToBeCorrected">[[j20_batchCounter.toBeCorrected]]</span></template>
                <template is="dom-if" if="[[_isEqual(flatrateMenuSection,'j20_toBeSend')]]"><span class="batchNumber j20_batchNumber batchToBeSend">[[j20_batchCounter.toBeSend]]</span></template>
                <template is="dom-if" if="[[_isEqual(flatrateMenuSection,'j20_process')]]"><span class="batchNumber j20_batchNumber batchProcessed">[[j20_batchCounter.processing]]</span></template>
                <template is="dom-if" if="[[_isEqual(flatrateMenuSection,'j20_accept')]]"><span class="batchNumber j20_batchNumber batchAccepted">[[j20_batchCounter.rejected]]</span></template>
                <template is="dom-if" if="[[_isEqual(flatrateMenuSection,'j20_reject')]]"><span class="batchNumber j20_batchNumber batchRejected">[[j20_batchCounter.accepted]]</span></template>
                <template is="dom-if" if="[[_isEqual(flatrateMenuSection,'j20_archive')]]"><span class="batchNumber j20_batchNumber batchArchived">[[j20_batchCounter.archived]]</span></template>
            </div>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'j3')]]">
                <template is="dom-if" if="[[_showWarningMessageEarlyInvoicingListing()]]"><div class="warningMessage" id="warningMessageListing"><div class="warningMessageBody"><iron-icon icon="icons:warning" class="w30px h30px"></iron-icon> &nbsp; [[localize('earlyInvoicingWarningMessage', 'Attention\, veuillez ne procéder à la facturation qu\'entre le premier et le cinquième jour du mois.', language)]]</div></div></template>
                <div class="centerCenter">
                    <paper-button class="tool-btn p-35px m-t-20 f-s-1em bordered" on-tap="_getListingJ3"><iron-icon icon="icons:cloud-download" class="w30px h30px"></iron-icon> &nbsp; [[localize('downloadListing','Téléchargement listing',language)]] (*)</paper-button>
                    <div id="exportRangeNotification">(*) [[localize('exportedPeriod', language)]]: [[localize('from2', language)]] <span>[[_startOfPreviousMonth()]]</span> [[localize('till', language)]] <span>[[_endOfPreviousMonth()]]</span></div>
                    <paper-button class="tool-btn tool-btn-previous-month p-10px m-t-50 f-s-08em bordered" id="getListingJ3PreviousMonth" on-tap="_getListingJ3"><iron-icon icon="icons:cloud-download" class="w30px h30px"></iron-icon> &nbsp; [[localize('downloadListingPreviousMonth','Téléchargement listing du mois précédent',language)]]<span class="onlyIfRejectRate">[[localize('downloadListingPreviousMonthRemark','Only when rejection rate > 5%',language)]]</span></paper-button>
                </div>
            </template>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'archivej3')]]">

                <div id="rightPanelToggleContainer" class=""><div class="header"><paper-button class="tool-btn p-r-15px p-l-15px w-100-pc" on-tap="_toggleRightPanel"><iron-icon icon="icons:build" class="w20px h20px"></iron-icon> &nbsp; [[localize('tools', language)]]</paper-button></div></div>

                <div id="rightPanel" class="">
                    <div class="header"  on-tap="_toggleRightPanel">
                        <label><iron-icon icon="icons:build"  class="w20px h20px"></iron-icon> &nbsp;[[localize('tools', language)]]</label>
                        <paper-button class="pullRightIcon"><iron-icon icon="icons:arrow-forward"></iron-icon></paper-button>
                    </div>
                    <div class="body">
                        <h4 class="m-t-50"><iron-icon icon="date-range"></iron-icon> &nbsp; [[localize('filterByDate','Filtrer par date',language)]]</h4>
                        <vaadin-date-picker label="[[localize('begin','Début',language)]]" i18n="[[i18n]]" class="datePicker" value="" id="dateRangeStart" always-float-label></vaadin-date-picker>
                        <vaadin-date-picker label="[[localize('end','Fin',language)]]" i18n="[[i18n]]" class="datePicker" value="" id="dateRangeEnd" always-float-label></vaadin-date-picker>
                        <paper-button class="tool-btn p-r-15px p-l-15px m-t-20 w-100-pc" on-tap="_getListingArchives" ><iron-icon icon="icons:update" class="force-left"></iron-icon> &nbsp; [[localize('filterResults','Filtrer les résultats',language)]]</paper-button>
                    </div>
                </div>

                <div class="gridContainer m-t-25">
                    <div class="invoiceContainer">
                        <div id="messagesGridContainer" class="invoiceSubContainerMiddle">
                            <div class="gridContainer grid-archives-listing">
                                <div class="containScroll">
                                    <vaadin-grid id="noscroll" items="[[archiveListingMessages]]">
                                        <vaadin-grid-column flex-grow="0" width="10%" class="" >
                                            <template class="header"><vaadin-grid-sorter path="created">[[localize('date','Date',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.hrDate]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="9%" class="">
                                            <template class="header"><vaadin-grid-sorter path="created">[[localize('time','Heure',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.hrTime]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="35%" class="">
                                            <template class="header"><vaadin-grid-sorter path="filename">[[localize('filename','Fichier',language)]]</vaadin-grid-sorter></template>
                                            <template><iron-icon icon="image:picture-as-pdf" class="force-left textRed"></iron-icon> &nbsp; [[item.filename]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="15%" class="">
                                            <template class="header"><vaadin-grid-sorter path="totalPages">[[localize('totalPages','Nombre de pages',language)]]</vaadin-grid-sorter></template>
                                            <template class="textAlignCenter">[[item.totalPages]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="1" class="">
                                            <template class="header"><vaadin-grid-sorter path="id">[[localize('downloadArchive',"Télécharger l'archive",language)]]</vaadin-grid-sorter></template>
                                            <template><paper-button class="tool-btn p-r-15px p-l-15px downloadListingArchive" on-tap="_downloadListingArchive" messageId="[[item.id]]" ><iron-icon icon="icons:cloud-download" class="force-left"></iron-icon> &nbsp; [[localize('download','Télécharger',language)]]</paper-button></vaadin-grid-sorter></template>
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </template>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'j20_toBeCorrected')]]">
                <div class="centerCenter">
                    j20_toBeCorrected
                </div>
            </template>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'j20_toBeSend')]]">
                <template is="dom-if" if="[[_showWarningMessageEarlyInvoicingDownload()]]"><div class="warningMessage" id="warningMessageInvoicing"><div class="warningMessageBody"><iron-icon icon="icons:warning" class="w30px h30px"></iron-icon> &nbsp; [[localize('earlyInvoicingDownloadWarningMessage', 'Please only download invoicing at the end of the month', language)]]</div></div></template>
                <div class="textAlignCenter">

                    <div class="exportMonthPicker">
                        <div class="exportMonthPickerTitle"><iron-icon icon="vaadin:calendar" style="max-width:20px; max-height:20px; margin-right:7px;"></iron-icon> Mois à générer</div>
                        <vaadin-combo-box id="exportedMonth" filtered-items="[[_getExportMonthsList()]]" item-label-path="label" item-value-path="id" label="[[localize('month','Month',language)]]" value="[[_getExportCurrentMonth()]]"></vaadin-combo-box>
                        <vaadin-combo-box id="exportedYear" filtered-items="[[_getExportYearsList()]]" item-label-path="label" item-value-path="id" label="[[localize('year','Year',language)]]" value="[[_getExportCurrentYear()]]"></vaadin-combo-box>
                    </div>

                    <paper-button class="tool-btn p-15px f-s-1em bordered" on-tap="_exportFlatRateInvoicing"><iron-icon icon="icons:cloud-download" class="w30px h30px"></iron-icon> &nbsp; [[localize('invoicingExport','Télécharger la facturation',language)]]</paper-button>
                </div>
            </template>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'j20_process')]]">
                <div class="centerCenter">
                    j20_process
                </div>
            </template>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'j20_accept')]]">
                <div class="centerCenter">
                    j20_accept
                </div>
            </template>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'j20_reject')]]">
                <div class="centerCenter">
                    j20_reject
                </div>
            </template>



            <template is="dom-if" if="[[_isEqual(flatrateMenuSection, 'j20_archive')]]">
                <div class="centerCenter">
                    j20_archive
                </div>
            </template>




        </div>

    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'
        import mustache from "mustache/mustache.js";

        class HtMsgFlatrateInvoice extends Polymer.TkLocalizerMixin(Polymer.Element) {

            static get is() {
                return 'ht-msg-flatrate-invoice';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    hcp: {
                        type : Object
                    },
                    contactPerson: {
                        type : String,
                        value: ""
                    },
                    i18n: {
                        type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        }
                    },
                    flatrateMenuSection: {
                        type: String,
                        observer: '_flatRateListingMenuSectionChanged'
                    },
                    activeGridItem:{
                        type: Object,
                        value: function () {
                            return [];
                        }
                    },
                    displayedYear: {
                        type: Number,
                        value: () => Number(moment().format('YYYY'))
                    },
                    processing:{
                        type: Boolean,
                        value: false
                    },
                    flatRateAllPatients : {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    _isLoading: {
                        type: Boolean,
                        value: false,
                        observer: '_loadingStatusChanged'
                    },
                    _loadingMessages: {
                        type: Array,
                        value: () => []
                    },
                    oaData: {
                        type: Array,
                        value: () => []
                    },
					archiveListingMessages:{
						type:Object,
						value: {}
                    },
                    downloadFileName: {
                        type: String,
                        value: ""
                    },
                    reportCurrentDateMomentObject: {
                        type: Object,
                        value: moment()
                    },
                    reportMonthGap: {
                        type: Number,
                        value: 1
                    },
                    j20_batchCounter: {
                        type: Object,
                        value: () => ({
                            toBeSend: 0,
                            toBeCorrected: 0,
                            processing: 0,
                            rejected: 0,
                            accepted: 0,
                            archived: 0
                        })
                    },
                    flatRateInvoicingDataObject: {
                        type: Object,
                        value: null
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                // return [];
            }

            ready() {
                super.ready();
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(response =>{
                    this.set("hcp",response)
                    if(response.contactPersonHcpId){
                    this.api.hcparty().getHealthcareParty(response.contactPersonHcpId).then(hcpCt => {
                        this.set("contactPerson", _.trim( _.trim(_.get(hcpCt, "lastName", "")) + " " + _.trim(_.get(hcpCt, "firstName", "")) ));
                    })}
                })
            }

            _loadingStatusChanged() {
                if(!this._isLoading) this._resetLoadingMessage();
            }

            _flatRateListingMenuSectionChanged(){
                console.log("Menu section: " + this.flatrateMenuSection);
                if( this.flatrateMenuSection === "archivej3" ) this._getListingArchives();
            }

            formatDate(d,f) {
                const input = d.toString()
                const yyyy = input.slice(0,4), mm = input.slice(4,6), dd = input.slice(6,8)
                switch(f) {
                    case 'date' :
                        return `${dd}/${mm}/${yyyy}`;
                    case 'month' :
                        const monthStr =
                            (mm.toString() === '01') ? this.localize('Jan',this.language) :
                            (mm.toString() === '02') ? this.localize('Feb',this.language) :
                            (mm.toString() === '03') ? this.localize('Mar',this.language) :
                            (mm.toString() === '04') ? this.localize('Apr',this.language) :
                            (mm.toString() === '05') ? this.localize('May',this.language) :
                            (mm.toString() === '06') ? this.localize('Jun',this.language) :
                            (mm.toString() === '07') ? this.localize('Jul',this.language) :
                            (mm.toString() === '08') ? this.localize('Aug',this.language) :
                            (mm.toString() === '09') ? this.localize('Sep',this.language) :
                            (mm.toString() === '10') ? this.localize('Oct',this.language) :
                            (mm.toString() === '11') ? this.localize('Nov',this.language) :
                            this.localize('Dec',this.language)
                        return `${monthStr} ${yyyy}`
                }
            }

            SEG_getErrSegment_200(zones){
                var erreur = '';

                //Erreur sur le nom du message
                if(zones.find(z => z.zone === "2001") !== '00'){
                    if(zones.find(z => z.zone === "2001") === '10'){
                        erreur += 'Nom du message => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2001") === '11'){
                        erreur += 'Nom du message => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "2001") === '20'){
                        erreur += 'Nom du message => Codification inconnue<br>';
                    }else if(zones.find(z => z.zone === "2001") === '21'){
                        erreur += 'Nom du message => Message non autorisé pour cet émetteur<br>';
                    }else if(zones.find(z => z.zone === "2001") === '22'){
                        erreur += 'Nom du message => # de 920000<br>';
                    }
                }

                //Erreur sur le n° de version du message
                if(zones.find(z => z.zone === "2011") !== '00'){
                    if(zones.find(z => z.zone === "2011") === '10'){
                        erreur += 'N° version mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2011") === '11'){
                        erreur += 'N° version mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2011") === '20'){
                        erreur += 'N° version mess => N° de version n\'est plus d\'application<br>';
                    }else if(zones.find(z => z.zone === "2011") === '21'){
                        erreur += 'N° version mess => N° de version pas encore d\'application<br>';
                    }else if(zones.find(z => z.zone === "2011") === '30'){
                        erreur += 'N° version mess => N° de version non autorisé pour ce flux<br>';
                    }
                }

                //Erreur sur le type de message
                if(zones.find(z => z.zone === "2021") !== '00'){
                    if(zones.find(z => z.zone === "2021") === '10'){
                        erreur += 'Type de mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2021") === '11'){
                        erreur += 'Type de mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2021") === '20'){
                        erreur += 'Type de mess => Valeur non permise<br>';
                    }else if(zones.find(z => z.zone === "2021") === '30'){
                        erreur += 'Type de mess => Message test dans un buffer de production (1er car zone 107 = P)<br>';
                    }else if(zones.find(z => z.zone === "2021") === '31'){
                        erreur += 'Type de mess => Message de production dans un buffer de test (1er car zone 107 = T)<br>';
                    }
                }

                //Erreur sur le statut du message
                if(zones.find(z => z.zone === "2031") !== '00'){
                    if(zones.find(z => z.zone === "2031") === '10'){
                        erreur += 'Statut mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2031") === '20'){
                        erreur += 'Statut mess => Valeur non permise<br>';
                    }
                }

                //Erreur sur la référence message institution ou prestataire de soins
                if(zones.find(z => z.zone === "2041") !== '00'){
                    if(zones.find(z => z.zone === "2041") === '10'){
                        erreur += 'Réf mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2041") === '11'){
                        erreur += 'Réf mess => Erreur format<br>';
                    }
                }

                //Erreur sur la référence message O.A
                if(zones.find(z => z.zone === "2051") !== '00'){
                    if(zones.find(z => z.zone === "2051") === '10'){
                        erreur += 'Réf mess OA => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2051") === '11'){
                        erreur += 'Réf mess OA => Erreur format<br>';
                    }
                }

                return erreur;
            }

            SEG_getErrSegment_300(zones){
                var erreur = '';

                //Erreur sur l'année et le mois de facturation
                if(zones.find(z => z.zone === "3001") !== '00'){
                    if(zones.find(z => z.zone === "3001") === '10'){
                        erreur += 'Année mois fact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3001") === '11'){
                        erreur += 'Année mois fact => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3001") === '20'){
                        erreur += 'Année mois fact => Valeur non permise<br>';
                    }
                }

                //Erreur sur le n° d'envoi
                if(zones.find(z => z.zone === "3011") !== '00'){
                    if(zones.find(z => z.zone === "3011") === '10'){
                        erreur += 'N° envoi => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3011") === '11'){
                        erreur += 'N° envoi => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3011") === '40'){
                        erreur += 'N° envoi => Signalisation de double fichier de facturation transmis<br>';
                    }
                }

                //Erreur sur la date de création de la facture
                if(zones.find(z => z.zone === "3021") !== '00'){
                    if(zones.find(z => z.zone === "3021") === '10'){
                        erreur += 'Date création facture => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3021") === '11'){
                        erreur += 'Date création facture => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3021") === '20'){
                        erreur += 'Date création facture => Date > date du jour<br>';
                    }else if(zones.find(z => z.zone === "3021") === '21'){
                        erreur += 'Date création facture => Date invraisemblable ( date < 01/01/2002)<br>';
                    }
                }


                //Erreur sur le n° de version des instruction
                if(zones.find(z => z.zone === "3041") !== '00'){
                    if(zones.find(z => z.zone === "3041") === '10'){
                        erreur += 'N° version instruction => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3041") === '11'){
                        erreur += 'N° version instruction => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3041") === '20'){
                        erreur += 'N° version instruction => Valeur non permise<br>';
                    }else if(zones.find(z => z.zone === "3041") === '21'){
                        erreur += 'N° version instruction => Incompatibilité avec valeur reprise en zone 202<br>';
                    }
                }

                //Erreur sur le nom de la personne de contact
                if(zones.find(z => z.zone === "3051") !== '00'){
                    if(zones.find(z => z.zone === "3051") === '10'){
                        erreur += 'Nom personne de contact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3051") === '11'){
                        erreur += 'Nom personne de contact => Erreur format<br>';
                    }
                }

                //Erreur sur le prenom de la personne de contact
                if(zones.find(z => z.zone === "3061") !== '00'){
                    if(zones.find(z => z.zone === "3061") === '10'){
                        erreur += 'Prénom personne de contact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3061") === '11'){
                        erreur += 'Prénom personne de contact => Erreur format<br>';
                    }
                }

                //Erreur sur le n° de tel de contact
                if(zones.find(z => z.zone === "3071") !== '00'){
                    if(zones.find(z => z.zone === "3071") === '10'){
                        erreur += 'N° téléphone => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3071") === '11'){
                        erreur += 'N° téléphone => Erreur format<br>';
                    }
                }

                //Erreur sur le type de la facture
                if(zones.find(z => z.zone === "3081") !== '00'){
                    if(zones.find(z => z.zone === "3081") === '10'){
                        erreur += 'Type de la facture => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3081") === '11'){
                        erreur += 'Type de la facture => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3081") === '20'){
                        erreur += 'Type de la facture => Valeur non permise en fonction du secteur qui émet la facturation';
                    }
                }

                //Erreur sur le type de facturation
                if(zones.find(z => z.zone === "3091") !== '00'){
                    if(zones.find(z => z.zone === "3091") === '10'){
                        erreur += 'Type de facturation => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3091") === '11'){
                        erreur += 'Type de facturation => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3091") === '20'){
                        erreur += 'Type de facturation => Valeur non permise en fonction du secteur qui émet la facturation';
                    }else if(zones.find(z => z.zone === "3091") === '30'){
                        erreur += 'Type de facturation => Valeur # de 1 ou 2 alors que la zone 308 = 3';
                    }
                }

                return erreur;

            }

            SEG_getErrSegment_400(zones){
                var erreur = '';

                //Erreur sur le type de record
                if(zones.find(z => z.zone === "4001") !== '00'){
                    if(zones.find(z => z.zone === "4001") === '10'){
                        erreur +='Type de record => Zone obligatoire<br>';
                    }else if(zones.find(z => z.zone === "4001") === '11'){
                        erreur += 'Type de record => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4001") === '20'){
                        erreur += 'Type de record => Valeur non permise<br>';
                    }
                }

                //Erreur sur le num de mut
                if(zones.find(z => z.zone === "4011") !== '00'){
                    if(zones.find(z => z.zone === "4011") === '10'){
                        erreur += 'N° de mutualité => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4011") === '11'){
                        erreur +='N° de mutualité => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4011") === '20'){
                        erreur +='N° de mutualité => Numéro inconnu ou codification erronée<br>';
                    }else if(zones.find(z => z.zone === "4011") === '21'){
                        erreur += 'N° de mutualité => N° de mutualité non retrouvé dans le détail de la facturation<br>';
                    }
                }

                //Erreur sur le num fact
                if(zones.find(z => z.zone === "4021") !== '00'){
                    if(zones.find(z => z.zone === "4021") === '10'){
                        erreur +='N° de facture récapitulative => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4021") === '11'){
                        erreur += 'N° de facture récapitulative => Erreur de format<br>';
                    }
                }

                //Erreur sur le signe montant a ou montant demande a
                if(zones.find(z => z.zone === "4041") !== '00'){
                    if(zones.find(z => z.zone === "4041") === '11'){
                        erreur += 'Montant demandé cpt a => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4041") === '40'){
                        erreur += 'Montant demandé cpt a => Erreur code signe (# de + ou -)<br>';
                    }else if(zones.find(z => z.zone === "4041") === '41'){
                        erreur +='Montant demandé cpt a => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "4041") === '20'){
                        erreur += 'Montant demandé cpt a => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant b ou montant demande b
                if(zones.find(z => z.zone === "4061") !== '00'){
                    if(zones.find(z => z.zone === "4061") === '11'){
                        erreur += 'Montant demandé cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4061") === '15'){
                        erreur +='Montant demandé cpt b => Zone # de 0 si l\'émetteur n\est pas une institution hospitalière - Zone signe # de «blanc» et émetteur de la facturation # d’une institution hospitalière<br>';
                    }else if(zones.find(z => z.zone === "4061") === '40'){
                        erreur +='Montant demandé cpt b => Erreur code signe (# de + ou -)';
                    }else if(zones.find(z => z.zone === "4061") === '41'){
                        erreur +='Montant demandé cpt b => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "4061") === '20'){
                        erreur +='Montant demandé cpt b => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant a + b ou montant demande a + b
                if(zones.find(z => z.zone === "4081") !== '00'){
                    if(zones.find(z => z.zone === "4081") === '11'){
                        erreur +='Total montant demandés cpt a + cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4081") === '20'){
                        erreur +='Total montant demandé cpt a + cpt b => Montant # somme des montants cpt a et cpt b<br>';
                    }else if(zones.find(z => z.zone === "4081") === '40'){
                        erreur +='Total montant demandé cpt a + cpt b => Erreur code signe (# de + ou -)<br>';
                    }
                }

                //Erreur sur le nb d'enreg
                if(zones.find(z => z.zone === "4091") !== '00'){
                    if(zones.find(z => z.zone === "4091") === '10'){
                        erreur += 'Nb de records détail => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4091") === '11'){
                        erreur +='Nb de records détail => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4091") === '20'){
                        erreur += 'Nb de records détail => Somme erronée<br>';
                    }
                }

                //Erreur sur le num de controle par mutualite si 95 ou num de controle de l'envoi si 96
                if(zones.find(z => z.zone === "4101") !== '00'){
                    if(zones.find(z => z.zone === "400") === '95'){
                        if(zones.find(z => z.zone === "4101") === '10'){
                            erreur += 'N° de contrôle par mutualité => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "4101") === '11'){
                            erreur +='N° de contrôle par mutualité => Erreur de format<br>';
                        }
                    }else if(zones.find(z => z.zone === "400") === '96'){
                        if(zones.find(z => z.zone === "4101") === '10'){
                            erreur += 'N° de contrôle de l\'envoi => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "4101") === '11'){
                            erreur +='N° de contrôle de l\'envoi => Erreur de format<br>';
                        }
                    }
                }

                return erreur;
            }

            SEG_getErrSegment_500(zones){
                var erreur = '';

                //Erreur sur le type de record
                if(zones.find(z => z.zone === "5001") !== '00'){
                    if(zones.find(z => z.zone === "5001") === '10'){
                        erreur +='Type de record => Zone obligatoire<br>';
                    }else if(zones.find(z => z.zone === "5001") === '11'){
                        erreur += 'Type de record => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5001") === '20'){
                        erreur += 'Type de record => Valeur non permise<br>';
                    }
                }

                //Erreur sur le num de mut
                if(zones.find(z => z.zone === "5011") !== '00'){
                    if(zones.find(z => z.zone === "5011") === '10'){
                        erreur += 'N° de mutualité => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5011") === '11'){
                        erreur +='N° de mutualité => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5011") === '20'){
                        erreur +='N° de mutualité => Numéro inconnu ou codification erronée<br>';
                    }else if(zones.find(z => z.zone === "5011") === '21'){
                        erreur += 'N° de mutualité => N° de mutualité non retrouvé dans le détail de la facturation<br>';
                    }
                }

                //Erreur sur le num fact
                if(zones.find(z => z.zone === "5021") !== '00'){
                    if(zones.find(z => z.zone === "5021") === '10'){
                        erreur +='N° de facture récapitulative => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5021") === '11'){
                        erreur += 'N° de facture récapitulative => Erreur de format<br>';
                    }
                }

                //Erreur sur le signe montant a ou montant demande a
                if(zones.find(z => z.zone === "5041") !== '00'){
                    if(zones.find(z => z.zone === "5041") === '11'){
                        erreur += 'Montant demandé cpt a => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5041") === '40'){
                        erreur += 'Montant demandé cpt a => Erreur code signe (# de + ou -)<br>';
                    }else if(zones.find(z => z.zone === "5041") === '41'){
                        erreur +='Montant demandé cpt a => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "5041") === '20'){
                        erreur += 'Montant demandé cpt a => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant b ou montant demande b
                if(zones.find(z => z.zone === "5061") !== '00'){
                    if(zones.find(z => z.zone === "5061") === '11'){
                        erreur += 'Montant demandé cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5061") === '15'){
                        erreur +='Montant demandé cpt b => Zone # de 0 si l\'émetteur n\est pas une institution hospitalière - Zone signe # de «blanc» et émetteur de la facturation # d’une institution hospitalière<br>';
                    }else if(zones.find(z => z.zone === "5061") === '40'){
                        erreur +='Montant demandé cpt b => Erreur code signe (# de + ou -)';
                    }else if(zones.find(z => z.zone === "5061") === '41'){
                        erreur +='Montant demandé cpt b => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "5061") === '20'){
                        erreur +='Montant demandé cpt b => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant a + b ou montant demande a + b
                if(zones.find(z => z.zone === "5081") !== '00'){
                    if(zones.find(z => z.zone === "5081") === '11'){
                        erreur +='Total montant demandés cpt a + cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5081") === '20'){
                        erreur +='Total montant demandé cpt a + cpt b => Montant # somme des montants cpt a et cpt b<br>';
                    }else if(zones.find(z => z.zone === "5081") === '40'){
                        erreur +='Total montant demandé cpt a + cpt b => Erreur code signe (# de + ou -)<br>';
                    }
                }

                //Erreur sur le nb d'enreg
                if(zones.find(z => z.zone === "5091") !== '00'){
                    if(zones.find(z => z.zone === "5091") === '10'){
                        erreur += 'Nb de records détail => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5091") === '11'){
                        erreur +='Nb de records détail => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5091") === '20'){
                        erreur += 'Nb de records détail => Somme erronée<br>';
                    }
                }

                //Erreur sur le num de controle par mutualite si 95 ou num de controle de l'envoi si 96
                if(zones.find(z => z.zone === "5101") !== '00'){
                    if(zones.find(z => z.zone === "500" === '95')){
                        if(zones.find(z => z.zone === "5101") === '10'){
                            erreur += 'N° de contrôle par mutualité => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "5101") === '11'){
                            erreur +='N° de contrôle par mutualité => Erreur de format<br>';
                        }
                    }else if(zones.find(z => z.zone === "500" === '96')){
                        if(zones.find(z => z.zone === "5101") === '10'){
                            erreur += 'N° de contrôle de l\'envoi => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "5101") === '11'){
                            erreur +='N° de contrôle de l\'envoi => Erreur de format<br>';
                        }
                    }
                }

                return erreur;
            }

            _toggleRightPanel(){
                this.shadowRoot.getElementById("rightPanel").classList.toggle("opened")
            }

            _showWarningMessageEarlyInvoicingListing() {
                return parseInt(moment().date()) > 5;
            }

            _showWarningMessageEarlyInvoicingDownload() {
                return parseInt(moment().date()) > 8;
            }

            _startOfPreviousMonth() {
                return moment().subtract(1, 'month').startOf('month').format('DD/MM/YYYY')
            }

            _endOfPreviousMonth() {
                return moment().subtract(1, 'month').endOf('month').format('DD/MM/YYYY')
            }

            _isEqual(a,b) {
                return a === b
            }

            _getInsuranceTitularyInfo(inputPatientsList=false) {
                return new Promise(resolve =>{
                    const insuranceTitularyIds = _.uniq(_.filter( (inputPatientsList?inputPatientsList:this.flatRateAllPatients), (i)=>{ return _.trim(_.get(i, "titularyId", "")) }).map(i=>i.titularyId) );
                    return !_.size(insuranceTitularyIds) ? resolve(null) : this.api.patient().getPatientsWithUser(this.user, new models.ListOfIdsDto({ ids: insuranceTitularyIds })).then(results => {
                        return resolve(
                            _.map((inputPatientsList?inputPatientsList:this.flatRateAllPatients), (i=>{
                                if(!_.trim(_.get(i,"titularyId", "" ))) return i
                                let titularyRecord = _.head(_.filter(results,(j=>{ return _.trim(j.id) === _.get(i,"titularyId", "" ) })))
                                i.titularyLabel = _.upperCase(_.get(titularyRecord, "firstName", "" )) + ' ' + _.upperCase(_.get(titularyRecord, "lastName", "" ))
                                return i
                            }))
                        )
                    })
                })
            }

            _getListingJ3(e) {

                this.set('_isLoading', true );
                this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_1',this.language), icon:"arrow-forward"});

                // Default values OR previous month (could be we had a rejection rate > 5%)
                this.reportMonthGap = _.trim(e.currentTarget.id) === "getListingJ3PreviousMonth" ? 2 : 1;
                this.reportCurrentDateMomentObject = _.trim(e.currentTarget.id) === "getListingJ3PreviousMonth" ? moment().subtract(1, 'month') : moment();

                // get my hcp children
                this._getMyHcps()
                    .then(myHcps => {
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_1_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_2',this.language), icon:"arrow-forward"});

                        let resolvedHcpPatients = 0;
                        let totalHcpPatientToResolve = _.size(myHcps);
                        if(!totalHcpPatientToResolve) {this.set('_isLoading', false ); return;}

                        // Get patients of child hcp
                        _.forEach(myHcps, (singleHcp) => {
                            this._getPatientsByHcp(singleHcp.id)
                                .then(hcpPat => {
                                    resolvedHcpPatients++;
                                    this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_3',this.language) + " " + (resolvedHcpPatients) + '/' + totalHcpPatientToResolve+"...", icon:"arrow-forward", updateLastMessage: true});
                                    if(!!hcpPat.length) _.forEach(hcpPat, ((singleHcpPat)=>this.flatRateAllPatients.push(singleHcpPat)));
                                    if(totalHcpPatientToResolve===resolvedHcpPatients){
                                        this.flatRateAllPatients = _.chain(this.flatRateAllPatients).uniqBy('ssin').sortBy(['lastName', 'firstName'],['asc','asc']).value();
                                        this._getInsuranceTitularyInfo().then( data => {
                                            this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_3_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                                            this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_4',this.language), icon:"arrow-forward"});
                                            this._getInsurancesData();
                                        })
                                    }
                                })
                                .catch(()=>{this.set('_isLoading', false );})
                        })
                    })
                    .catch(()=>{this.set('_isLoading', false );})
                ;

            }

            _setLoadingMessage( messageData ) {
                if( messageData.updateLastMessage ) { this._loadingMessages.pop(); }
                this._loadingMessages.push( messageData );

                let loadingContentTarget = this.shadowRoot.querySelectorAll('#loadingContent')[0];
                if(loadingContentTarget) { loadingContentTarget.innerHTML = ''; _.each(this._loadingMessages, (v)=>{ loadingContentTarget.innerHTML += "<p><iron-icon icon='"+v.icon+"' class='"+(v.done?"loadingIcon done":"loadingIcon")+"'></iron-icon>" + v.message + "</p>"; }); }
            }

            _resetLoadingMessage() {
                this._loadingMessages = [];
            }

            _getExportPageHeader(data) {

                return `
                    <article id="" class="page">

                        <table class="boderGrey bleft0 bright0">
                            <tbody>
                                <tr class="bleft0 bright0">
                                    <td width="33%" class="important colorBlue bleft0 bright0 italic">`+ this.localize('flatrateMonthlyInvoicing',this.language) +`</td>
                                    <td width="33%" class="important colorBlue bleft0 bright0 txt-center uppercase italic">`+ this.localize('month_' + parseInt(this.reportCurrentDateMomentObject.format('M')), this.language) + ` `+ this.reportCurrentDateMomentObject.format('YYYY')+`</td>
                                    <td width="33%" class="important colorBlue bleft0 bright0 txt-right small-txt italic lineHeight14px verticalAlignMiddle">`+ this.localize('day_' + parseInt(moment().day()), this.language) + ` ` + moment().format('DD') + ` `+ (this.localize('month_' + parseInt(moment().format('M')), this.language)).toLowerCase() + ` ` + moment().format('YYYY') + `</td>

                                </tr>
                            </tbody>
                        </table>

                        <table class="small-txt boderBottomGrey" cellspacing="0" cellpadding="0">
                            <tbody>
                                <tr class="">
                                    <td width="55%">
                                        <span class="bold uppercase">${_.get(this.user, "name", "")}</span><br />
                                        ${_.get(this.hcp, "addresses[0].street", "")} ${_.get(this.hcp, "addresses[0].houseNumber", "")}<br />
                                        ${_.get(this.hcp, "addresses[0].postalCode", "")} ${_.get(this.hcp, "addresses[0].city", "")}<br />
                                        ` + this.localize('inami',this.language) + `: &nbsp;&nbsp; ${_.get(this.hcp, "nihii", "")}<br />
                                        ` + this.localize('adm_ctc_per',this.language) + `: &nbsp;&nbsp; ${this.contactPerson} &nbsp;&nbsp; ${_.get(this.hcp, "addresses[0].telecoms[0].telecomNumber", "")}<br />
                                    </td>
                                    <td width="45%">
                                        <table class="borderOa"><tbody><tr><td class="fs11">
                                            <b>` +_.get(data, "code", "") + ` &nbsp;&nbsp; ` +_.get(data, "finalName", "") + `</b><br /><br />
                                            ` +_.get(data, "address", "") + `<br />
                                            ` +_.get(data, "city", "") + ` ` +_.get(data, "postalCode", "") + `<br />
                                        </td></tr></tbody></table>
                                    </td>
                                </tr>
                            </tbody>
                        </table> `;

            }

            _getExportListHeader(listIndex) {

                return `
                    <table id="documentHeader" class="boderBottomGrey" cellspacing="0" cellpadding="0">
                        <tbody>
                            <tr class="">
                                <td width="100%">
                                    <span class="bold uppercase colorBlue fs12">` + this.localize("flatrate_list_"+listIndex+"_header",this.language) + `</span><br />
                                    <span class="bold uppercase colorBlue fs10">` + this.localize("flatrate_list_"+listIndex+"_subheader",this.language) + `</span><br />
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;

            }

            _getExportListContent(listIndex,listEntries) {

                let contentToReturn = "";

                // Lists 1 & 2 don't require unsubscription infos
                if( parseInt(listIndex)<3 ) {

                    contentToReturn += `
                        <table id="contentBodyTable" class="mt10" cellspacing="0" cellpadding="0">
                            <thead>
                                <tr class="fs10 colorBlue italic bold txt-left pb10">
                                    <td class="contentBodyHeader" width="5%">` + this.localize("flatrate_column_1",this.language) + `</td>
                                    <td class="contentBodyHeader" width="30%">` + this.localize("flatrate_column_2",this.language) + `</td>
                                    <td class="contentBodyHeader" width="10%">` + this.localize("flatrate_column_3",this.language) + `</td>
                                    <td class="contentBodyHeader" width="10%">` + this.localize("flatrate_column_4",this.language) + `</td>
                                    <td class="contentBodyHeader" width="6%">` + this.localize("flatrate_column_5",this.language) + `</td>
                                    <td class="contentBodyHeader" width="11%">` + this.localize("flatrate_column_6",this.language) + `</td>
                                    <td class="contentBodyHeader" width="13%">` + this.localize("flatrate_column_7",this.language) + `</td>
                                    <td class="contentBodyHeader" width="5%">` + this.localize("flatrate_column_8",this.language) + `</td>
                                    <td class="contentBodyHeader" width="10%">` + this.localize("flatrate_column_9",this.language) + `</td>
                                </tr>
                            </thead>
                        <tbody>`

                    _.forEach(listEntries, (singleEntry)=>{
                        _.forEach(singleEntry, _.trim);
                            contentToReturn += `
                                <tr class="fs9 borderTopLightThinGrey pt2 pb2">
                                    <td width="5%" class="">`+_.get(singleEntry, "externalId", "")+`</td>
                                    <td width="30%" class="">`+_.get(singleEntry, "lastName", "")+` `+_.get(singleEntry, "firstName", "")+`</td>
                                    <td width="10%" class="">`+_.get(singleEntry, "dateOfBirth", "")+`</td>
                                    <td width="10%" class="bold">`+_.get(singleEntry, "ssin", "")+`</td>
                                    <td width="6%" class="">`+_.get(singleEntry, "finalInsurability.parameters.tc1", "")+``+_.get(singleEntry, "finalInsurability.parameters.tc2", "")+`</td>
                                    <td width="11%" class="">`+(parseInt(_.get(singleEntry, "medicalHouseContracts[0].startOfContract",0))?moment(_.get(singleEntry, "medicalHouseContracts[0].startOfContract",0)+"","YYYYMMDD").format("DD/MM/YYYY"):"")+`</td>
                                    <td width="13%" class="colorGreen">`+(parseInt(_.get(singleEntry, "medicalHouseContracts[0].startOfCoverage",0))?moment(_.get(singleEntry, "medicalHouseContracts[0].startOfCoverage",0)+"","YYYYMMDD").format("DD/MM/YYYY"):"")+`</td>
                                    <td width="5%" class="">`+_.get(singleEntry, "insurancePersonType", "")+`</td>
                                    <td width="10%" class="">`+_.get(singleEntry, "titularyLabel", "")+`</td>
                                </tr>`
                    })

                } else {

                    // We don't show flatrate_column_12 (reason) anymore as already in page header

                    contentToReturn += `
                        <table id="contentBodyTable" class="mt10" cellspacing="0" cellpadding="0">
                            <thead>
                                <tr class="fs10 colorBlue italic bold txt-left pb10">
                                    <td class="contentBodyHeader" width="4%">` + this.localize("flatrate_column_1",this.language) + `</td>
                                    <td class="contentBodyHeader" width="19%">` + this.localize("flatrate_column_2",this.language) + `</td>
                                    <td class="contentBodyHeader" width="9%">` + this.localize("flatrate_column_3",this.language) + `</td>
                                    <td class="contentBodyHeader" width="9%">` + this.localize("flatrate_column_4",this.language) + `</td>
                                    <td class="contentBodyHeader" width="6%">` + this.localize("flatrate_column_5",this.language) + `</td>
                                    <td class="contentBodyHeader" width="9%">` + this.localize("flatrate_column_6",this.language) + `</td>
                                    <td class="contentBodyHeader" width="9%">` + this.localize("flatrate_column_7",this.language) + `</td>
                                    <td class="contentBodyHeader" width="8%">` + this.localize("flatrate_column_10",this.language) + `</td>
                                    <td class="contentBodyHeader" width="8%">` + this.localize("flatrate_column_11",this.language) + `</td>
                                    <!--<td class="contentBodyHeader" width="6%">` + this.localize("flatrate_column_12",this.language) + `</td>-->
                                    <td class="contentBodyHeader" width="4%">` + this.localize("flatrate_column_8",this.language) + `</td>
                                    <td class="contentBodyHeader" width="15%">` + this.localize("flatrate_column_9",this.language) + `</td>
                                </tr>
                            </thead>
                        <tbody>`

                    _.forEach(listEntries, (singleEntry)=>{
                        _.forEach(singleEntry, _.trim);
                            contentToReturn += `
                                <tr class="fs9 borderTopLightThinGrey pt2 pb2">
                                    <td width="4%" class="">`+_.get(singleEntry, "externalId", "")+`</td>
                                    <td width="19%" class="">`+_.get(singleEntry, "lastName", "")+` `+_.get(singleEntry, "firstName", "")+`</td>
                                    <td width="9%" class="">`+_.get(singleEntry, "dateOfBirth", "")+`</td>
                                    <td width="9%" class="bold">`+_.get(singleEntry, "ssin", "")+`</td>
                                    <td width="6%" class="">`+_.get(singleEntry, "finalInsurability.parameters.tc1", "")+``+_.get(singleEntry, "finalInsurability.parameters.tc2", "")+`</td>
                                    <td width="9%" class="">`+(parseInt(_.get(singleEntry, "medicalHouseContracts[0].startOfContract",0))?moment(_.get(singleEntry, "medicalHouseContracts[0].startOfContract",0)+"","YYYYMMDD").format("DD/MM/YYYY"):"")+`</td>
                                    <td width="9%" class="colorGreen">`+(parseInt(_.get(singleEntry, "medicalHouseContracts[0].startOfCoverage",0))?moment(_.get(singleEntry, "medicalHouseContracts[0].startOfCoverage",0)+"","YYYYMMDD").format("DD/MM/YYYY"):"")+`</td>
                                    <td width="8%" class="colorRed">`+(parseInt(_.get(singleEntry, "medicalHouseContracts[0].endOfContract",0))?moment(_.get(singleEntry, "medicalHouseContracts[0].endOfContract",0)+"","YYYYMMDD").format("DD/MM/YYYY"):"")+`</td>
                                    <td width="8%" class="colorRed">`+(parseInt(_.get(singleEntry, "medicalHouseContracts[0].endOfCoverage",0))?moment(_.get(singleEntry, "medicalHouseContracts[0].endOfCoverage",0)+"","YYYYMMDD").format("DD/MM/YYYY"):"")+`</td>
                                    <!--<td width="6%" class="">`+_.get(singleEntry, "medicalHouseContracts[0].suspensionReason","")+`</td>-->
                                    <td width="4%" class="">`+_.get(singleEntry, "insurancePersonType", "")+`</td>
                                    <td width="15%" class="">`+_.get(singleEntry, "titularyLabel", "")+`</td>
                                </tr>`
                    })

                }

                contentToReturn += `</tbody></table>`

                return contentToReturn;

            }

            _getExportPageFooter(currentPage,totalPages,oaCode) {

                return `
                    </article>
                    <article class="footerContainer">
                        <table class="boderGreyTop pageFooter">
                            <tbody>
                                <tr class="fs9 bold">
                                    <td width="40%" class="colorBlue txt-left italic">`+ this.localize('flatrate_footer_reply_before',this.language) +`</td>
                                    <td width="20%" class="colorBlue txt-center italic underlined">`+ this.localize('month_' + parseInt(this.reportCurrentDateMomentObject.format('M')), this.language) + ` `+ this.reportCurrentDateMomentObject.format('YYYY')+`</td>
                                    <td width="40%" class="colorBlue txt-right italic">`+this.localize('page',this.language)+` `+currentPage+` `+this.localize('of',this.language)+` `+totalPages+` - Mut. `+oaCode+`</td>
                                </tr>
                            </tbody>
                        </table>
                    </article>
                `;
            }

            _getExportPdfFooter() {
                return "</body></html>";
            }

            _getExportPdfHeader() {

                // noinspection CssUnusedSymbol
                return `<html>
                            <head>
                                <style>

                                    body {margin: 0;}
                                    @page {size: A4; margin: 0; }

                                    article.page {
                                        width: 210mm;
                                        height: 283mm;
                                        padding: 20px;
                                        overflow:hidden;
                                    }
                                    article.footerContainer {
                                        width: 210mm;
                                        padding: 20px;
                                    }

                                    article.page:last-child { border-bottom: 0; }
                                    @media print { article.page { border-bottom: 0; } }

                                    table {
                                        display: table;
                                        box-sizing: border-box;
                                        border-spacing: 0;
                                        border-collapse: collapse;
                                        width: 100%;
                                        padding:0;
                                        margin:0;
                                    }

                                    table thead {font-size: 14px}
                                    table tr,
                                    table td {
                                        margin: 0;
                                        padding: 0;
                                        vertical-align: top;
                                    }
                                    table td {padding: 5px;}
                                    table.border,
                                    table.border tr,
                                    table.border td { border: 1px solid black; }
                                    table.boderGrey,
                                    table.boderGrey tr,
                                    table.boderGrey td {border: 2px solid #bbbbbb;}
                                    table.boderGreyTop,
                                    table.boderGreyTop tr,
                                    table.boderGreyTop td {border-top: 2px solid #bbbbbb;}
                                    .boderBottomGrey {border-bottom: 2px solid #bbbbbb;}
                                    *.half td {width: 50%;}
                                    *.no-border * {border: none !important;}

                                    #factBody {
                                        display: flex;
                                        flex-direction: column;
                                        flex: 1;
                                        border: 0px;
                                    }
                                    #factBody * {border: none;}
                                    #factBody > * {
                                        display: flex;
                                        flex-direction: column;
                                    }
                                    #factBody > * > tr.border > td {border-right: 0;}
                                    #factBody > * > tr.border > td:last-child {border-right: 0;            }
                                    #factBody .table-entry td {border: none; border-top: .3px solid lightgrey; margin-top:5px; }
                                    .factBody td {border: none; border-top: .3px solid lightgrey; margin-top:5px; }
                                    #factBody .row-total > td {text-align: right;}
                                    #factBody .row-total > td:first-child {text-align: left;}

                                    .txt-center {text-align: center;}
                                    .txt-right {text-align: right;}
                                    .txt-left tr td, .txt-left td, .txt-left {text-align: left;}
                                    .mt5 {margin-top: 5px!important;}
                                    .mt3 {margin-top: 3px!important;}
                                    .mb5 {margin-bottom: 5px!important;}
                                    .mt10 {margin-top: 10px!important;}
                                    .mt20 {margin-top: 20px!important;}
                                    .bleft0 {border-left:0!important;}
                                    .bright0 {border-right:0!important;}
                                    .bleft {border-left:1px solid black !important;}
                                    .bleft-light {border-left:1px solid lightgrey !important;}
                                    .bbottom-light {border-bottom:1px solid lightgrey !important;}
                                    .btop0 {border-top: 0!important;}
                                    .bbottom0 {border-bottom: 0 !important;}
                                    .nopad {padding: 0;}

                                    td.important { font-weight: bold; font-size: 1.1em; }
                                    td.indic {font-weight: 700;}
                                    .bold {font-weight: 700!important;}
                                    .bold td {font-weight: 700!important;}
                                    *.min-txt {font-size: 11px;}
                                    .small-txt {font-size: 11px!important;}
                                    .fs9 tr td, .fs9 td, .fs9 {font-size: 9px!important;}
                                    .fs10 tr td, .fs10 td, .fs10 {font-size: 10px!important;}
                                    .fs11 tr td, .fs11 td, .fs11 {font-size: 11px!important;}
                                    .fs12 tr td, .fs12 td, .fs12 {font-size: 12px!important;}
                                    .colorRed { color:#ff0000!important;}
                                    .colorGreen { color:#02a102!important;}
                                    .colorBlue { color:#101079!important;}
                                    .uppercase {text-transform:uppercase!important;}
                                    .italic {font-style:italic!important;}
                                    .underlined {text-decoration:underline!important;}
                                    .verticalAlignMiddle tr td, .verticalAlignMiddle {vertical-align: middle!important;}
                                    .borderOa tr td { border:3px solid #101079!important;}
                                    tr.bold td, .bold { font-weight:700!important;}
                                    .padding0, .padding0 td {padding:0;}
                                    .margin0, .margin td {margin:0;}

                                    #contentBodyTable, #contentBodyTable tr, #contentBodyTable tr { width:100%; margin:0; padding:0; border:0; vertical-align:top }
                                    #contentBodyTable tr td { padding:0; border:0; margin:0; vertical-align:top }
                                    .borderTopLightThinGrey td { border-top: .3px solid lightgrey!important; }
                                    .pt2, .pt2 td { padding-top:2px!important; }
                                    .pb2, .pb2 td { padding-bottom:2px!important; }
                                    .pb5, .pb5 td { padding-bottom:5px!important; }
                                    .pb10, .pb10 td { padding-bottom:10px!important; }

                                    .pageFooter {
                                        page-break-after: always;
                                    }

                                </style>
                                </head>
                                <body>`
                    }

            _getMyHcps() {

                return this.api.getRowsUsingPagination(
                    (key,docId) =>
                        this.api.hcparty().listHealthcareParties( key && JSON.stringify(key), docId, 1000)
                            .then(pl => {
                                pl.rows = _
                                    .chain(pl.rows)
                                    .filter((i)=>{return(
                                        !!i
                                        && !!i.nihii
                                        && !!i.ssin
                                        && i.parentId === this.user.healthcarePartyId
                                    )})
                                    .uniqBy( 'nihii' )
                                    .value()
                                ;
                                return {
                                    rows:pl.rows,
                                    nextKey: pl.nextKeyPair && pl.nextKeyPair.startKey,
                                    nextDocId: pl.nextKeyPair && pl.nextKeyPair.startKeyDocId,
                                    done: !pl.nextKeyPair
                                }
                            })
                            .catch(()=>{ return Promise.resolve(null); })
                )||[];

            }

            _getPatientsByHcp( hcpId ) {

                return this.api.getRowsUsingPagination(
                    (key,docId) =>
                        this.api.patient().listPatientsByHcPartyWithUser(this.user, hcpId, null, key && JSON.stringify(key), docId, 1000)
                            .then(pl => {
                                pl.rows = _
                                    .chain(pl.rows)
                                    .filter((i)=>{return(
                                        !!i
                                        && !!i.active
                                        && !!i.dateOfBirth
                                        && !!i.ssin
                                        && !!i.insurabilities.length
                                        && !!_.size(
                                            _.chain(i.insurabilities)
                                                .filter(i=>{return(
                                                    i
                                                    && i.identificationNumber
                                                    && i.insuranceId
                                                    && (
                                                        moment(_.get(i, "startDate"+"", 0), 'YYYYMMDD').isBefore(this.reportCurrentDateMomentObject, 'date') ||
                                                        moment(_.get(i, "startDate"+"", 0), 'YYYYMMDD').isSame(this.reportCurrentDateMomentObject, 'date') ||
                                                        !parseInt(_.get(i, "startDate", 0))
                                                    )
                                                    && (
                                                        moment(_.get(i, "endDate"+"", 0), 'YYYYMMDD').isAfter(this.reportCurrentDateMomentObject, 'date') ||
                                                        moment(_.get(i, "endDate"+"", 0), 'YYYYMMDD').isSame(this.reportCurrentDateMomentObject, 'date') ||
                                                        !parseInt(_.get(i, "endDate", 0))
                                                    )
                                                )})
                                            .value()
                                        )
                                        && parseInt( _.size( _.get(i, "medicalHouseContracts", [] ) ) )
                                        && parseInt( _.size( _.filter( _.get(i, "medicalHouseContracts", [] ), (i)=>{return i && i.hcpId === this.user.healthcarePartyId}) ) )
                                    )})
                                    .uniqBy( 'ssin' )
                                    .value()
                                    .map((i) => {
                                        i.lastName = (i.lastName||"").toUpperCase()
                                        i.firstName = (i.firstName||"").toUpperCase()
                                        i.dateOfBirth = (i.dateOfBirth?moment(i.dateOfBirth+"", "YYYYMMDD").format('DD/MM/YYYY'):"")
                                        i.finalInsurability = _.get(
                                            _.filter(
                                                i.insurabilities,
                                                (ins) => {
                                                    return ins &&
                                                    _.size(ins) &&
                                                    !!_.trim(_.get( ins, "insuranceId", "" ) ) &&
                                                    !!_.trim(_.get( ins, "identificationNumber", "" ) ) &&
                                                    (
                                                        moment(_.get(ins, "startDate"+"", 0), 'YYYYMMDD').isBefore(this.reportCurrentDateMomentObject, 'date') ||
                                                        moment(_.get(ins, "startDate"+"", 0), 'YYYYMMDD').isSame(this.reportCurrentDateMomentObject, 'date') ||
                                                        !parseInt(_.get(ins, "startDate", 0))
                                                    ) &&
                                                    (
                                                        moment(_.get(ins, "endDate"+"", 0), 'YYYYMMDD').isAfter(this.reportCurrentDateMomentObject, 'date') ||
                                                        moment(_.get(ins, "endDate"+"", 0), 'YYYYMMDD').isSame(this.reportCurrentDateMomentObject, 'date') ||
                                                        !parseInt(_.get(ins, "endDate", 0))
                                                    )
                                                }
                                            ), "[0]", {}
                                        )
                                        i.insurancePersonType = !_.trim( _.get( i, "finalInsurability.titularyId", "" )) ? "T" : ( moment().diff(moment(_.get(i, "dateOfBirth"+"", "0")+"", "DD/MM/YYYY"), 'years') < 18 ) ? "E" : "C"
                                        i.titularyId = _.trim( _.get( i, "finalInsurability.titularyId", "" ))
                                        return i
                                    })
                                ;
                                return {
                                    rows:pl.rows,
                                    nextKey: pl.nextKeyPair && pl.nextKeyPair.startKey,
                                    nextDocId: pl.nextKeyPair && pl.nextKeyPair.startKeyDocId,
                                    done: !pl.nextKeyPair
                                }
                            })
                            .catch(()=>{ return Promise.resolve(); })
                )||[];

            }

            _getInsurancesData() {

                this.api.insurance().getInsurances(new models.ListOfIdsDto({ids : _.chain(this.flatRateAllPatients).map((i)=>{return (i && i.insurabilities && i.insurabilities.length && i.insurabilities[0].insuranceId) ? i.insurabilities[0].insuranceId : false }).uniq().value()}))
                    .then((ins) => {
                        this.oaData = _
                          .chain(ins)
                          .map((i)=>{ i.finalName = (i && i.name && i.name[this.language]) ? i.name[this.language] : i.name[(this.language==='fr' ? 'nl' : 'fr')]; return i; })
                          .sortBy((i)=>{ return i.code; })
                          .value();
                        this._generateJ3FileAndDownload();
                    })
                    .catch(()=>{this.set('_isLoading', false );});

            }

            _getInsurancesDataByPatientsList(inputPatientsList) {
                return new Promise(resolve => {
                    this.api.insurance().getInsurances(new models.ListOfIdsDto({ids : _.chain(inputPatientsList).map(i=>_.trim(_.get(i, "insurabilities[0].insuranceId"))).uniq().compact().value()}))
                        .then(insurancesData => resolve(
                            _
                                .chain(insurancesData)
                                .map((i)=>{ i.finalName = (i && i.name && i.name[this.language]) ? i.name[this.language] : i.name[(this.language==='fr' ? 'nl' : 'fr')]; return i; })
                                .sortBy((i)=>{ return i.code; })
                            .value()
                        ))
                })
            }

            _generateJ3FileAndDownload() {

                this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_4_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_5',this.language), icon:"arrow-forward"});

                let pdfData = {};

                // Loop OA
                _.forEach( this.oaData, (oa,k)=> {

                    let OaPatients = _.filter(this.flatRateAllPatients, (i=>_.trim(_.get(i, "finalInsurability.insuranceId", "" )) === _.trim(oa.id)))

                    pdfData[oa.id] = {
                        oa: {
                            id: _.get(oa, "id", ""),
                            finalName: _.get(oa, "finalName", ""),
                            code: _.get(oa, "code", ""),
                            address: _.trim(_.compact([_.get(oa, "address.street", ""), _.get(oa, "address.houseNumber", ""), _.get(oa, "address.postboxNumber", "")]).join(' ')),
                            postalCode: _.get(oa, "address.postalCode", ""),
                            city: _.get(oa, "address.city", "")
                        },
                        entries: {

                            // 01 : Subscriptions WITHOUT try-out period
                            list1 :  _.compact(_.map(OaPatients, pat=>{
                                return parseInt(_.size(_.filter(_.get(pat, "medicalHouseContracts", []), mhc=>{return(
                                    moment( _.get(mhc, "startOfContract", 0), 'YYYYMMDD').startOf('month').isSame( moment().subtract(this.reportMonthGap, 'month').startOf('month') ) &&
                                    ( moment( _.get(mhc, "startOfContract", 0), 'YYYYMMDD').startOf('month').isSame( moment( _.get(mhc, "startOfCoverage", 0), 'YYYYMMDD').subtract(1,"month").startOf('month') ) || !parseInt(_.get(mhc, "startOfCoverage", 0)) )
                                )}))) ? pat : false
                            })),

                            // 02 : Subscriptions WITH try-out period
                            list2 : _.compact(_.map(OaPatients, pat=>{
                                return parseInt(_.size(_.filter(_.get(pat, "medicalHouseContracts", []), mhc=>{return(
                                    moment( _.get(mhc, "startOfContract", 0), 'YYYYMMDD').startOf('month').isSame( moment().subtract(this.reportMonthGap, 'month').startOf('month') ) &&
                                    moment( _.get(mhc, "startOfContract", 0), 'YYYYMMDD').startOf('month').isBefore( moment( _.get(mhc, "startOfCoverage", 0), 'YYYYMMDD').subtract(1,"month").startOf('month') )
                                )}))) ? pat : false
                            })),

                            // 03 : Unsubscriptions
                            list3 : _.compact(_.map(OaPatients, pat=>{ return parseInt(_.size(_.filter(_.get(pat, "medicalHouseContracts", []), mhc=>{ return moment( _.get(mhc, "endOfContract", 0), 'YYYYMMDD').startOf('month').isSame( moment().subtract(this.reportMonthGap, 'month').startOf('month') ) }))) ? pat : false })),

                            //  Suspensions
                            suspensions : _.compact(_.map(OaPatients, pat=>{
                                return parseInt(_.size(_.filter( _.get(pat, "medicalHouseContracts", []), mhc=>{return(
                                    !!_.trim( _.get(mhc,"suspensionReason","")) &&
                                    ( parseInt(_.get(mhc,"startOfSuspension",0)) && moment( _.get(mhc,"startOfSuspension",0)+"", "YYYYMMDD" ).isBefore( moment() ) ) &&
                                    ( !parseInt(_.get(mhc,"endOfSuspension",0)) || moment( _.get(mhc,"endOfSuspension",0)+"", "YYYYMMDD" ).isAfter( moment() ) )
                                )}))) ? pat : false
                            }))

                        }
                    };

                    // 04 : Invoicing suspended: Not insured
                    // 05 : Invoicing suspended: No reason given
                    // 06 : Invoicing suspended: Is hospitalized
                    // 07 : Invoicing suspended: Out of country
                    // 08 : This one doesn't exist (legitimately omitted)
                    // 09 : Invoicing suspended: change of mutuality
                    pdfData[oa.id].entries['list4'] = _.filter( _.get(pdfData[oa.id], "entries.suspensions", [] ), pat=> _.uniq( _.map( _.get( pat, "medicalHouseContracts", []), mhc=>_.trim(mhc.suspensionReason) ) ).indexOf("notInsured") > -1  )||[]
                    pdfData[oa.id].entries['list5'] = _.filter( _.get(pdfData[oa.id], "entries.suspensions", [] ), pat=> _.uniq( _.map( _.get( pat, "medicalHouseContracts", []), mhc=>_.trim(mhc.suspensionReason) ) ).indexOf("noReasonGiven") > -1  )||[]
                    pdfData[oa.id].entries['list6'] = _.filter( _.get(pdfData[oa.id], "entries.suspensions", [] ), pat=> _.uniq( _.map( _.get( pat, "medicalHouseContracts", []), mhc=>_.trim(mhc.suspensionReason) ) ).indexOf("isHospitalized") > -1  )||[]
                    pdfData[oa.id].entries['list7'] = _.filter( _.get(pdfData[oa.id], "entries.suspensions", [] ), pat=> _.uniq( _.map( _.get( pat, "medicalHouseContracts", []), mhc=>_.trim(mhc.suspensionReason) ) ).indexOf("outsideOfCountry") > -1  )||[]
                    pdfData[oa.id].entries['list9'] = _.filter( _.get(pdfData[oa.id], "entries.suspensions", [] ), pat=> _.uniq( _.map( _.get( pat, "medicalHouseContracts", []), mhc=>_.trim(mhc.suspensionReason) ) ).indexOf("changeOfMutuality") > -1  )||[]

                    delete pdfData[oa.id].entries.suspensions

                }); // Loop OA

                // NOT FOR PROD, just to test page breaks with large records amount
                // _(pdfData).forEach((oa)=>{_(oa.entries).forEach((entries)=>{if( !entries.length ) return;_.forEach(entries, (i)=>{ entries.push(i); })})});
                // _(pdfData).forEach((oa)=>{_(oa.entries).forEach((entries)=>{if( !entries.length ) return;_.forEach(entries, (i)=>{ entries.push(i); })})});
                // _(pdfData).forEach((oa)=>{_(oa.entries).forEach((entries)=>{if( !entries.length ) return;_.forEach(entries, (i)=>{ entries.push(i); })})});
                // _(pdfData).forEach((oa)=>{_(oa.entries).forEach((entries)=>{if( !entries.length ) return;_.forEach(entries, (i)=>{ entries.push(i); })})});
                // _(pdfData).forEach((oa)=>{_(oa.entries).forEach((entries)=>{if( !entries.length ) return;_.forEach(entries, (i)=>{ entries.push(i); })})});
                // _(pdfData).forEach((oa)=>{_(oa.entries).forEach((entries)=>{if( !entries.length ) return;_.forEach(entries, (i)=>{ entries.push(i); })})});

                // Namely for footer
                let totalPages = 0; let currentPage = 0;

                // Hardcoded, see PDF output
                const maxEntriesPerPage = 47;

                // Whole document headers
                let pdfTemplate = this._getExportPdfHeader();

                // Eval total pages
                _.forEach( pdfData, (oaData)=> { _.forEach( oaData.entries, (listEntries)=> { if(!parseInt(_.size(listEntries))) return; let pageBreakentriesChunks = _.chunk(listEntries, maxEntriesPerPage ); _.forEach(pageBreakentriesChunks, ()=>{ totalPages++; })})})

                // Build document pages
                _.forEach( pdfData, (oaData)=> {
                    _.forEach( oaData.entries, (listEntries, listKey)=> {
                        if(!parseInt(_.size(listEntries))) return;
                        let listIndex = parseInt(listKey.replace('list',''));
                        let pageBreakentriesChunks = _.chunk(listEntries, maxEntriesPerPage );
                        _.forEach(pageBreakentriesChunks, (entriesChunk)=>{
                            currentPage++;
                            pdfTemplate +=
                                this._getExportPageHeader(oaData.oa) +
                                this._getExportListHeader(listIndex) +
                                this._getExportListContent(listIndex,entriesChunk) +
                                this._getExportPageFooter(currentPage,totalPages,oaData.oa.code)
                        });
                    })
                })

                // Close document
                pdfTemplate += this._getExportPdfFooter();

                this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_5_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_6',this.language), icon:"arrow-forward"});

                this.downloadFileName = this.reportCurrentDateMomentObject.format('YYYY-MM-DD-HH[h]-mm[m]-ss[s]') + "-listing-patients" + ".pdf";

                // Generate, archive & download pdf report
                this.api.pdfReport(mustache.render(pdfTemplate, pdfData))
                    .then(({pdf:pdfFileContent, printed:printed}) =>{
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_6_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_7',this.language), icon:"arrow-forward"});

                        return this.api.message().newInstance(this.user)
                            .then(newMessageInstance => this.api.message().createMessage(
                                _.merge(newMessageInstance, {
                                    transportGuid: "MH:ARCHIVES:LISTING",
                                    recipients: [_.get(this.user, 'healthcarePartyId', _.trim(this.hcp.id))],
                                    metas: {totalPages: totalPages, filename: this.downloadFileName},
                                    toAddresses: [_.get(this.user, 'email', _.get(this.user, 'healthcarePartyId', _.trim(this.hcp.id)))],
                                    subject: "MH: Archive listing patients download - " + this.downloadFileName
                                }))
                            )
                            .then(createdMessage => this.api.document().newInstance(this.user, createdMessage, {
                                documentType: 'report',
                                mainUti: this.api.document().uti("application/pdf"),
                                name: this.downloadFileName
                            }))
                            .then(newDocumentInstance => this.api.document().createDocument(newDocumentInstance))
                            .then(createdDocument => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("encrypt", this.user.healthcarePartyId, createdDocument, pdfFileContent).then(encryptedFileContent => ({createdDocument, encryptedFileContent })))
                            .then(({createdDocument, encryptedFileContent}) => this.api.document().setAttachment(createdDocument.id, null, encryptedFileContent))
                            .then(() => !printed && this.api.triggerFileDownload( pdfFileContent, "application/pdf", this.downloadFileName ))
                    })
                    .then(() => {
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_7_done',this.language), icon:"check-circle", updateLastMessage: true, done:true})
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_8',this.language), icon:"arrow-forward"})
                    })
                    .catch((e)=> console.log(e))
                    .finally(() => this.set('_isLoading', false))

            }

            _getListingArchives() {

                this.archiveListingMessages = {}
                let dateRangeStart = _.trim(_.get(this.shadowRoot.getElementById("dateRangeStart"), "value", "" ));
                let dateRangeEnd = _.trim(_.get(this.shadowRoot.getElementById("dateRangeEnd"), "value", "" ));

                this.api.message().findMessagesByTransportGuid('MH:ARCHIVES:LISTING', null, null, null, 1000).then(m => {
                    this.archiveListingMessages = _
                        .chain(m.rows)
                            .filter((m)=>{return _.get(m,'fromHealthcarePartyId',false)===this.user.healthcarePartyId && (!dateRangeStart?true:(!moment(m.created).isBefore(moment(dateRangeStart, "YYYY-MM-DD")))) && (!dateRangeEnd?true:(moment(m.created).isBefore(moment(dateRangeEnd, "YYYY-MM-DD"))))})
                            .map((i)=>{
                                i.hrDate = moment(i.created).format('DD/MM/YYYY');
                                i.hrTime = moment(i.created).format("HH:mm:ss");
                                i.filename = _.get(i.metas,"filename", "listing-patients.pdf");
                                i.totalPages = _.get(i.metas,"totalPages",1);
                                return i;
                            })
                            .orderBy("created", "desc")
                        .value();
                });

            }

            _downloadListingArchive(e) {
                let messageId = _.get(_.head(_.chain(e.path).filter((i)=>{return _.get(_.get(i,"classList",[]), "value","").indexOf('downloadListingArchive')!==-1}).value()),"messageid",false);
                this.api.document().findByMessage(this.user.healthcarePartyId, _.chain(this.archiveListingMessages).filter({id:messageId}).head().value()).then(singleMessage => {
                    if(singleMessage && singleMessage[0] && singleMessage[0].id && singleMessage[0].attachmentId && singleMessage[0].secretForeignKeys) {
                        this.api.document().getAttachment(singleMessage[0].id, singleMessage[0].attachmentId, singleMessage[0].secretForeignKeys).then(attachmentResponse => {
                            if(attachmentResponse) {
                                this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("decrypt", this.user.healthcarePartyId, _.head(singleMessage), attachmentResponse).then(decryptedFileContent =>{
                                   this.api.triggerFileDownload(decryptedFileContent,"application/pdf",_.get( _.head(_.filter(this.archiveListingMessages, {"id":_.trim(messageId)})), "filename","listing-patients.pdf"));
                                }).catch(()=>{})
                            }
                        }).catch(()=>{})
                    }
                }).catch(()=>{})
            }

            _getExportMonthsList() {
                let toReturn = [];
                for(let i=1; i<=12; i++) toReturn.push({id: i, label: this.localize('month_'+i,this.language) })
                return toReturn
            }

            _getExportYearsList() {
                let toReturn = [];
                for(let i=(parseInt(moment().format('YYYY'))+1); i>=(parseInt(moment().format('YYYY'))-2); i--) toReturn.push({id: i, label: i })
                return toReturn
            }

            _getExportCurrentMonth() {
                return parseInt(moment().format('MM'))
            }

            _getExportCurrentYear() {
                return parseInt(moment().format('YYYY'))
            }

            _sleep (time) {
                return new Promise((resolve) => setTimeout(resolve, time));
            }            

            _createOrUpdateMedicalHousePatientsInvoices( inputData ) {
                return Promise.all(_.toPairs(this.flatRateInvoicingDataObject.listsData).map(list => {
                    const typeList = list[0]
                    const patientList = list[1]
                    const codesList = typeList === "list5" || typeList === "list6" ? _.concat(this.flatRateInvoicingDataObject.hcpValorisationsCurrentMonth, this.flatRateInvoicingDataObject.hcpValorisationsPreviousMonth) : this.flatRateInvoicingDataObject.hcpValorisationsCurrentMonth

                    return patientList.map(pat => _.assign(pat, {invoicingCodes: codesList.filter(code => (code.flatRateType === "physician" && pat.finalMedicalHouseContracts.gp === true) || (code.flatRateType === "nurse" && pat.finalMedicalHouseContracts.nurse === true) || (code.flatRateType === "physiotherapist" && pat.finalMedicalHouseContracts.kine === true)).map(val => ({
                                code: val.code,
                                tarificationId: "INAMI-RIZIV|" + val.code + "|1.0",
                                label: val.label[this.language],
                                totalAmount: Number(val.price),
                                reimbursement: Number(val.price),
                                patientIntervention: Number(0.00).toFixed(2),
                                doctorSupplement: Number(0.00).toFixed(2),
                                units: 1,
                                canceled: false,
                                accepted: false,
                                pending: false,
                                resent: false,
                                dateCode: moment().format('YYYYMMDD'),
                                id: this.api.crypto().randomUuid(),
                                logicalId: this.api.crypto().randomUuid()
                            }))}
                        ))
                    })
                ).then(pats => {
                    let prom = Promise.resolve([])

                    const allPats = _.flatten(pats)
                    const parentInsuranceIds = allPats.reduce((acc,pat) => { const parentId = this.flatRateInvoicingDataObject.insurancesData.find(ins => ins.id === pat.finalInsurability.insuranceId).parent; if (!acc.includes(parentId)) { acc.push(parentId) }; return acc}, [])

                    this.api.insurance().getInsurances(new models.ListOfIdsDto({ids : parentInsuranceIds})).then(
                        parentInsurances => {
                            allPats.forEach(pat => {
                                prom = prom.then(pats =>
                                    this.api.crypto().extractDelegationsSFKs(pat, this.user.healthcarePartyId)
                                        .then(secretForeignKeys => {
                                                const insParent = parentInsurances.find(i => i.id === this.flatRateInvoicingDataObject.insurancesData.find(ins => ins.id === pat.finalInsurability.insuranceId).parent)
                                                return this.api.invoice().appendCodes(this.user.id, "patient", "cdrom", (pat.finalInsurability && pat.finalInsurability.insuranceId ? pat.finalInsurability.insuranceId : ''), secretForeignKeys.extractedKeys.join(","), null, 0, pat.invoicingCodes)
                                                    .then(invoices =>
                                                        !invoices[0].id ? this.api.invoice().newInstance(this.user, pat, invoices[0])
                                                            .then(inv => this.api.invoice().createInvoice(inv, 'invoice:' + this.user.healthcarePartyId + ':' + (insParent && insParent.code ? insParent.code : '000') + ':'))
                                                            .then(inv => console.log(inv)) : resolve(invoices[0]))
                                                    .then(newInvoice => {
                                                        pat.invoices = [newInvoice]
                                                        return pats.concat([pat])
                                                    })
                                            }
                                        ))
                            })
                            return prom
                        }
                    )
                })
            }

            _exportFlatRateInvoicing() {
                this.set('_isLoading', true );
                this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_1',this.language), icon:"arrow-forward"});

                // Force refresh - could be new "valorisation" was just set
                if(_.size(_.get(this.api.hcparty().cache, _.get(this.user, "healthcarePartyId", "" )))) delete this.api.hcparty().cache[_.get(this.user, "healthcarePartyId", "" )];

                this.api.hcparty().getHealthcareParty(_.get(this.user, "healthcarePartyId", "" ))
                    .then(hcp => {

                        this.set("hcp",hcp);

                        this.flatRateInvoicingDataObject = {
                            hcpData: {
                                id: _.trim(_.get(this.hcp, "id")),
                                name: _.trim(_.get(this.hcp, "name", "")) || _.trim(_.trim(_.get(this.hcp, "firstName", "")) + " " + _.trim(_.get(this.hcp, "lastName", ""))) || _.trim(_.get(this.user, "name", "")),
                                address: _.chain(_.get(this.hcp,"addresses",{})).filter({addressType:"work"}).head().value() || _.chain(_.get(this.hcp,"addresses",{})).filter({addressType:"home"}).head().value() || _.chain(_.get(this.hcp,"addresses",{})).head().value() || {},
                                nihii: _.trim(_.get(this.hcp, "nihii", "")),
                                nihiiFormated: this.api.formatInamiNumber(_.trim(_.get(this.hcp, "nihii", ""))),
                                contactPersonHcpId: _.trim(_.get(this.hcp, "contactPersonHcpId", "")),
                                contactPerson: _.trim(_.get(this, "contactPerson", "")),
                                financialInfo: _.head( _.filter( _.get(this.hcp, "financialInstitutionInformation", []), i => { return !!i && _.trim(_.get(i, "bankAccount", "")) }) )
                            },
                            patientsData: [],
                            insurancesData: [],
                            listsData: [],
                            invoicesData: [],
                            exportDate: _.trim(
                                parseInt(_.get(this.shadowRoot.getElementById("exportedYear"), "value", this._getExportCurrentYear())) +
                                ( ( _.trim(_.get(this.shadowRoot.getElementById("exportedMonth"), "value", this._getExportCurrentMonth())).length === 1 ? "0" : "" ) + parseInt(_.get(this.shadowRoot.getElementById("exportedMonth"), "value", this._getExportCurrentMonth())) ) +
                                "01"
                            )
                        }

                        this.reportCurrentDateMomentObject = moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD")

                        this.flatRateInvoicingDataObject.hcpData = _.merge(this.flatRateInvoicingDataObject.hcpData,{
                            phone: _.trim(_.get(_.filter(this.flatRateInvoicingDataObject.hcpData.address.telecoms, {telecomType: "phone"}), "[0].telecomNumber", "")) || _.trim(_.get(_.filter(this.flatRateInvoicingDataObject.hcpData.address.telecoms, {telecomType: "mobile"}), "[0].telecomNumber", "")),
                            email: _.trim(_.get(_.filter(this.flatRateInvoicingDataObject.hcpData.address.telecoms, {telecomType: "email"}), "[0].telecomNumber", "")),
                            financialInfo: {
                                bankAccount: _.trim(_.get(this.flatRateInvoicingDataObject, "hcpData.financialInfo.bankAccount", "")),
                                bankAccountFormated: this.api.formatBankAccount( _.trim(_.get(this.flatRateInvoicingDataObject, "hcpData.financialInfo.bankAccount", "")) ),
                                bic: _.trim(_.get(this.flatRateInvoicingDataObject, "hcpData.financialInfo.bic", "")) || this.api.getBicByIban(_.trim(_.get(this.flatRateInvoicingDataObject, "hcpData.financialInfo.bankAccount", ""))),
                                name: _.trim(_.get(this.flatRateInvoicingDataObject, "hcpData.financialInfo.name", "")),
                            }
                        })

                        this.flatRateInvoicingDataObject.hcpValorisationsPreviousMonth = _.merge(
                            [
                                {code: "109616", price: 0.00, flatRateType: "physician"},  // Doctor
                                {code: "409614", price: 0.00, flatRateType: "nurse"},  // Nurse
                                {code: "509611", price: 0.00, flatRateType: "physiotherapist"}   // Kine
                            ],
                            _.compact(
                                _.chain(_.get(this.hcp, "flatRateTarifications", []))
                                    .map(singleNomenclature => {
                                        const valorisationPrice = parseFloat(
                                            _.get(
                                                _.head(
                                                    _.orderBy(
                                                        _
                                                            .chain(singleNomenclature.valorisations)
                                                            .filter(singleValorisation => {
                                                                return (
                                                                    !!singleValorisation
                                                                    && parseFloat(_.get(singleValorisation, "reimbursement", 0))
                                                                    && (
                                                                        (moment(_.trim(_.get(singleValorisation, "startOfValidity", "0")), "YYYYMMDD").startOf('month')).isBefore( moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD").startOf('month').subtract(1, 'month') ) ||
                                                                        (moment(_.trim(_.get(singleValorisation, "startOfValidity", "0")), "YYYYMMDD").startOf('month')).format("YYYYMMDD") === moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD").startOf('month').subtract(1, 'month').format("YYYYMMDD")
                                                                    )
                                                                )

                                                            })
                                                        .value(),
                                                        ["startOfValidity"],
                                                        ["desc"]
                                                    )
                                                ),
                                                "reimbursement"
                                            )
                                        )
                                        return parseFloat(valorisationPrice) ? {
                                            code: _.trim(_.get(singleNomenclature, "code")),
                                            label: _.get(singleNomenclature, "label"),
                                            flatRateType: _.trim(_.get(singleNomenclature, "flatRateType")),
                                            price: valorisationPrice
                                        } : false
                                    })
                                .value()
                            )
                        )

                        this.flatRateInvoicingDataObject.hcpValorisationsCurrentMonth = _.merge(
                            [
                                {code: "109616", price: 0.00, flatRateType: "physician"},  // Doctor
                                {code: "409614", price: 0.00, flatRateType: "nurse"},  // Nurse
                                {code: "509611", price: 0.00, flatRateType: "physiotherapist"}   // Kine
                            ],
                            _.compact(
                                _.chain(_.get(this.hcp, "flatRateTarifications", []))
                                    .map(singleNomenclature => {
                                        const valorisationPrice = parseFloat(
                                            _.get(
                                                _.head(
                                                    _.orderBy(
                                                        _
                                                            .chain(singleNomenclature.valorisations)
                                                            .filter(singleValorisation => {
                                                                return (
                                                                    !!singleValorisation
                                                                    && parseFloat(_.get(singleValorisation, "reimbursement", 0))
                                                                    && (
                                                                        (moment(_.trim(_.get(singleValorisation, "startOfValidity", "0")), "YYYYMMDD").startOf('month')).isBefore( moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD").startOf('month') ) ||
                                                                        (moment(_.trim(_.get(singleValorisation, "startOfValidity", "0")), "YYYYMMDD").startOf('month')).format("YYYYMMDD") === moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD").startOf('month').format("YYYYMMDD")
                                                                    )
                                                                )

                                                            })
                                                        .value(),
                                                        ["startOfValidity"],
                                                        ["desc"]
                                                    )
                                                ),
                                                "reimbursement"
                                            )
                                        )
                                        return parseFloat(valorisationPrice) ? {
                                            code: _.trim(_.get(singleNomenclature, "code")),
                                            label: _.get(singleNomenclature, "label"),
                                            flatRateType: _.trim(_.get(singleNomenclature, "flatRateType")),
                                            price: valorisationPrice
                                        } : false
                                    })
                                    .value()
                            )
                        )

                    })
                    .then(()=>{
                        this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_1_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_2',this.language), icon:"arrow-forward"});
                        return this._getPatientsByHcp(_.get(this.hcp, "id")).then(myPatients=>_.chain(myPatients).uniqBy('ssin').sortBy(['lastName', 'firstName'],['asc','asc']).value())
                    })
                    .then((myPatients)=>{

                        // Find valid MHContract or drop entry
                        myPatients = _.compact(
                            _.map( myPatients, pat => {
                                pat.finalMedicalHouseContracts = _.get(
                                    _.orderBy(
                                        _
                                            .chain(pat.medicalHouseContracts||[])
                                            .filter(mhc => {
                                                return (
                                                    !!mhc &&
                                                    !!_.size(mhc) &&

                                                    // Has to begin in the past
                                                    moment(_.trim(_.get(mhc, "startOfContract", 0)), "YYYYMMDD").startOf('month').isBefore(moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD")) &&
                                                    (
                                                        // Either end of contract is in the future or is not set
                                                        moment(_.trim(_.get(mhc, "endOfContract", "0")), "YYYYMMDD").endOf('month').isAfter(moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD")) ||
                                                        !parseInt(_.get(mhc, "endOfContract", 0))
                                                    ) &&
                                                    (
                                                        // Either start of coverage is before this month AND set OR
                                                        // Start of coverage isn't set and start of contract is two month in the past (start of coverage = start of contract + 1 month when no trial period)
                                                        (
                                                            parseInt(_.get(mhc, "startOfCoverage", 0)) &&
                                                            moment(_.trim(_.get(mhc, "startOfCoverage", "0")), "YYYYMMDD").endOf('month').isBefore(moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD"))
                                                        ) ||
                                                        (
                                                            !parseInt(_.get(mhc, "startOfCoverage", 0)) &&
                                                            moment(_.trim(_.get(mhc, "startOfContract", 0)), "YYYYMMDD").startOf('month').add(1, 'months').isBefore(moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD"))
                                                        )
                                                    )
                                                )
                                            })
                                            .value(),
                                        ["startOfContract"],
                                        ["desc"]
                                    ),
                                    "[0]", []
                                )
                                return _.size( pat.finalMedicalHouseContracts ) ? pat : false
                            })
                        )

                        _.map( myPatients, pat => {
                            pat.finalMedicalHouseContracts = parseInt(_.get(pat.finalMedicalHouseContracts, "startOfCoverage", 0)) ?
                                pat.finalMedicalHouseContracts :
                                _.merge(
                                    pat.finalMedicalHouseContracts,
                                    {startOfCoverage: parseInt(moment(_.trim(_.get(pat.finalMedicalHouseContracts, "startOfContract", 0)), "YYYYMMDD").startOf('month').add(1, 'months').format("YYYYMMDD"))}
                                )
                        })

                        this.flatRateInvoicingDataObject.patientsData = myPatients
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_3_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_3',this.language), icon:"arrow-forward"});
                        return this._getInsuranceTitularyInfo(myPatients).then(x=>x)
                    })
                    .then((myPatientsWithInsuranceTitularyInfo)=>{
                        this.flatRateInvoicingDataObject.patientsData = myPatientsWithInsuranceTitularyInfo
                        this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_3_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_4',this.language), icon:"arrow-forward"});
                        return this._getInsurancesDataByPatientsList(myPatientsWithInsuranceTitularyInfo).then(x=>x)
                    })
                    .then((insurancesData)=>{
                        this.flatRateInvoicingDataObject.insurancesData = insurancesData
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_4_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_5',this.language), icon:"arrow-forward"});
                        return {

                            // "Old" patients
                            // Start of month of start cover must be BEFORE (start of export month -1 month)
                            // Ie: start of coverage began 2+ month before exported month
                            list8: _.filter( this.flatRateInvoicingDataObject.patientsData, pat => { return(
                                !!moment(pat.finalMedicalHouseContracts.startOfCoverage, "YYYYMMDD").startOf("month").isBefore( moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD").startOf("month").subtract(1, 'month') )
                            )}),

                            // New patients WITHOUT tryout (double amounts / must appear twice)
                            // Start of month of start cover must be EQUAL TO (start of export month -1 month)
                            // AND Start of month of cover - 1 month === Start of month of contract
                            list5: _.filter( this.flatRateInvoicingDataObject.patientsData, pat => { return(
                                !!moment(pat.finalMedicalHouseContracts.startOfCoverage, "YYYYMMDD").startOf("month").isSame( moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD").startOf("month").subtract(1, 'month') ) &&
                                !!(moment(pat.finalMedicalHouseContracts.startOfCoverage, "YYYYMMDD").startOf("month").subtract(1, 'month')).isSame( moment(pat.finalMedicalHouseContracts.startOfContract, "YYYYMMDD").startOf("month") )
                            )}),

                            // New patients WITH tryout (double amounts / must appear twice)
                            // Start of month of start cover must be EQUAL TO (start of export month -1 month)
                            // AND Start of month of cover - 1 month > Start of month of contract
                            list6: _.filter( this.flatRateInvoicingDataObject.patientsData, pat => { return(
                                !!moment(pat.finalMedicalHouseContracts.startOfCoverage, "YYYYMMDD").startOf("month").isSame( moment(_.trim(this.flatRateInvoicingDataObject.exportDate), "YYYYMMDD").startOf("month").subtract(1, 'month') ) &&
                                !!(moment(pat.finalMedicalHouseContracts.startOfCoverage, "YYYYMMDD").startOf("month").subtract(1, 'month')).isAfter( moment(pat.finalMedicalHouseContracts.startOfContract, "YYYYMMDD").startOf("month") )
                            )}),
                        }

                    })
                    .then((listsData)=>{
                        this.flatRateInvoicingDataObject.listsData = listsData
                        this._setLoadingMessage({ message:this.localize('mhListing.spinner.step_5_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_4',this.language), icon:"arrow-forward"});
                        return this._createOrUpdateMedicalHousePatientsInvoices(this.flatRateInvoicingDataObject).then(x=>x)
                    })
                    .then(invoicesData=>{
                        this.flatRateInvoicingDataObject.invoicesData = invoicesData
                        this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_4_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                        this._setLoadingMessage({ message:this.localize('mhInvoicing.spinner.step_5',this.language), icon:"arrow-forward"});

                        console.log("Generate flat files + bordereaux + pdf here");
                        console.log(this.flatRateInvoicingDataObject)

                    })
                    .catch((e)=>{console.log(e)})
                    .finally(()=>{this.set('_isLoading', false );})


                // Flat files
                // Bordereaux
                // A4 files

                // var invoicingYear: Int = 0
                // var invoicingMonth: Int = 0
                // var fileRef: String? = null //13 alphanumeric internal reference. Typically, we use a base36 representation of the 16 first hex of the UUID id of the Message
                // var batchRef: String? = null //25 alphanumeric internal reference. Typically, we use a base36 representation of the UUID id of the Message
                // var ioFederationCode: String? = null //3 digits code of the IO federation
                // var uniqueSendNumber : Long? = null //3 digits number for batch (typically the number of the day * 2 + 1 if 306)
                // var sender:  InvoiceSender? = null
                // var numericalRef : Long? = null
                // var invoices: MutableList<Invoice> = LinkedList()

                // console.log(this.api.fhc().Efactcontroller().makeFlatFileTestUsingPOST(...));

            }

        }

        customElements.define(HtMsgFlatrateInvoice.is, HtMsgFlatrateInvoice);
    </script>
</dom-module>
