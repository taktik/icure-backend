<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter-mixin.html">
<link rel="import" href="../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<dom-module id="ht-msg-mycarenet">
    <template>
        <custom-style>
            <style include="shared-styles">

                :host {
                    display: block;
                    z-index:2;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                .invoice-panel {
                    height: 100%;
                    margin: 0;
                    grid-column: 2/2;
                    grid-row: 1/1;
                    padding: 0 24px;
                    display:flex;
                    flex-flow: column nowrap;
                    justify-content: space-between;
                }

                .grid-panel {
                    flex-basis: calc(100% - 60px);
                    height: calc(100% - 60px);
                    display: flex;
                    flex-flow: row nowrap;
                    box-sizing: border-box;
                    justify-content: space-between;
                }

                #messagesGrid {
                    flex-basis: 60%;
                    height: 100%;
                }

                #messagesGrid.no-detail {
                    flex-basis: 100%;
                }

                #detailGrid {
                    flex-basis: 40%;
                    height: 100%;
                }

                #detailGrid.no-detail {
                    flex-basis: 0;
                    display: none;
                }

                .invoice-panel .btns-container{
                    padding: 16px 0;
                    flex-basis: 60px;
                }

                .bottom-btn {
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                    background: var(--app-secondary-color);
                    color: var(--app-text-color);
                    font-weight: bold;
                    font-size: 12px;
                    height: 40px;
                    min-width: 100px;
                    @apply --shadow-elevation-2dp;
                    padding: 10px 1.2em;
                    text-transform: capitalize;
                }

            </style>
        </custom-style>
        <div class="invoice-panel">
            <div class="grid-panel">
                <vaadin-grid id="messagesGrid" class$="[[detailPanelClass(subMessages)]]" items="[[messages]]" active-item="{{activeItem}}">
                    <vaadin-grid-column class="recipient-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">Date</vaadin-grid-sorter>
                        </template>
                        <template>[[item.received]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column class="oa-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">Type</vaadin-grid-sorter>
                        </template>
                        <template>[[item.subject]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column class="oa-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">OA</vaadin-grid-sorter>
                        </template>
                        <template>[[item.fromAddress]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column class="ref-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">Patient</vaadin-grid-sorter>
                        </template>
                        <template>[[item.patient.lastName]] [[item.patient.firstName]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column class="invoice-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">Data</vaadin-grid-sorter>
                        </template>
                        <template>[[_displayMetas(item.metas)]]</template>
                    </vaadin-grid-column>
                </vaadin-grid>
                <vaadin-grid id="detailGrid" class$="[[detailPanelClass(subMessages)]]" items="[[subMessages]]">
                    <vaadin-grid-column class="recipient-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">Period</vaadin-grid-sorter>
                        </template>
                        <template>[[item.from]] - [[item.to]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column class="ref-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">Patient</vaadin-grid-sorter>
                        </template>
                        <template>[[item.lastName]] [[item.firstName]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column class="invoice-col">
                        <template class="header">
                            <vaadin-grid-sorter path="">Payments</vaadin-grid-sorter>
                        </template>
                        <template>[[_formatPayments(item.payments)]]</template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </div>
            <div class="btns-container">
                <paper-button class="bottom-btn" id="requestMessagesBtn" on-tap="requestMessages">[[localize('req_msg_lists','Request Messages Lists',language)]]
                </paper-button>
                <paper-button class="bottom-btn" id="getMessagesBtn" on-tap="getMessages">[[localize('get_msg','Get Messages',language)]]
                </paper-button>
            </div>
        </div>

    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'

        class HtMsgMycarenet extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-mycarenet';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    hcp:{
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    selectedMessages: {
                        type: Object,
                        notify: true
                    },
                    activeItem: {
                        type: Object,
                        observer: '_activeItemChanged'
                    },
                    messages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    subMessages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectList: {
                        type: Object
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        }
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(response =>{
                    this.set("hcp",response)
                    //this.getMessages()
                })
            }

            refresh() {
                this.api.message().findMessagesByTransportGuid('GMD:IN:*', null, null, 1000).then(msgsPl => {
                    const messages = msgsPl && msgsPl.rows || []

                    const ssins = _.uniq(_.compact((messages || []).map(msg => (msg.metas || {}).ssin)))
                    return (ssins.length ? this.api.patient().filterBy(undefined, undefined, 1000, 0, undefined, false,
                            {
                                filter: {
                                    $type: "PatientByHcPartyAndSsinsFilter",
                                    healthcarePartyId: user.healthcarePartyId,
                                    ssins: ssins
                                }
                            }
                        ) : Promise.resolve([])).then(patients => {
                            messages.forEach(msg => {
                                const ssin = (msg.metas || {}).ssin
                                if (ssin) {
                                    msg.patient = patients.find(p => p.ssin === ssin)
                                }
                            })
                            return messages
                        })
                }).then(messages =>  this.set('messages', messages || []))
            }

            _displayMetas() {
                return ''
            }

            _formatPayments(payments) {
                return payments && payments.map(p => `${p.date}: ${p.amount}${p.currency} [${p.ref}]`).join(', ')
            }

            detailPanelClass(subMessages) {
                return subMessages && subMessages.length ? '' : 'no-detail'
            }

            _activeItemChanged() {
                if (!this.activeItem) {
                    this.set('subMessages', [])
                    return
                }
                this.api.document().findByMessage(this.user.healthcarePartyId, this.activeItem).then(
                    docs => Promise.all(docs.map(d => this.api.document().getAttachment(d.id, d.attachmentId).then(a => {
                        try {
                            return JSON.parse(new Uint8Array(a).reduce((data, byte) => data + String.fromCharCode(byte), ''))
                        } catch (e) {
                            console.log(e)
                        }
                    }))).then( lists => {
                        const inscriptions = _.flatMap(_.compact(lists.map(l => l && l.inscriptions)))
                        const ssins =  _.uniq(_.compact(inscriptions.filter(i => !i.lastName && i.inss)))

                        ;(ssins.length ? this.api.patient().filterBy(undefined, undefined, 1000, 0, undefined, false,
                            {
                                filter: {
                                    $type: "PatientByHcPartyAndSsinsFilter",
                                    healthcarePartyId: user.healthcarePartyId,
                                    ssins: ssins
                                }
                            }
                        ) : Promise.resolve([])).then(patients => {
                            lists.forEach(l => {
                                l.inscriptions.forEach( i => {
                                const ssin = i.inss
                                if (ssin && !i.lastName) {
                                    const pat =  patients.find(p => p.ssin === ssin)
                                    i.firstName = pat.firstName
                                    i.lastName = pat.lastName
                                }
                                i.payments = (i.payment1Amount ? [
                                            {
                                                amount: i.payment1Amount,
                                                currency: i.payment1Currency,
                                                date: i.payment1Date,
                                                ref: i.payment1Ref
                                            }
                                        ]
                                        : []
                                ).concat(
                                    i.payment2Amount ? [
                                            {
                                                amount: i.payment2Amount,
                                                currency: i.payment2Currency,
                                                date: i.payment2Date,
                                                ref: i.payment2Ref
                                            }
                                        ]
                                        : []
                                )
                                })
                            })
                            this.set('subMessages', _.flatMap(lists,x => x.inscriptions))
                        })
                    })
                )
            }

            getMessages() {
                this.api.fhc().Dmgcontroller().getDmgMessagesUsingPOST(this.api.keystoreId,this.api.tokenId,this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName, "", [])
                    .then(list => this.api.message().processDmgMessagesList(this.user,this.hcp,list,this.api.document()))
                    .then(([ackHashes, dmgHashes]) => Promise.all([
                        this.api.fhc().Dmgcontroller().confirmAcksUsingPOST(this.api.keystoreId, this.api.tokenId,this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName, ackHashes),
                        this.api.fhc().Dmgcontroller().confirmDmgMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName, dmgHashes)
                    ]))
            }

            requestMessages(){
                this.api.fhc().Dmgcontroller().postDmgsListRequestUsingPOST(this.api.keystoreId,this.api.tokenId,this.api.credentials.ehpassword,this.hcp.nihii,this.hcp.ssin,this.hcp.firstName,this.hcp.lastName)
                    .then(response =>{
                        console.log(response)
                    })
            }

        }

        customElements.define(HtMsgMycarenet.is, HtMsgMycarenet);
    </script>
</dom-module>
