<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-tree-toggle.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-filter-mixin.html">
<link rel="import" href="../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">
<link rel="import" href="../../vaadin-icure-theme.html">
<link rel="import" href="../../spinner-style.html">
<dom-module id="ht-msg-invoice">
    <template>
        <custom-style>
            <style include="shared-styles vaadin-icure-theme spinner-style">

                :host {
                    display: block;
                    z-index:2;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                vaadin-grid {
                    /*height: calc(100% - 41px - 32px - 32px);*/
                    height: auto;
                    /*width: calc(100vw - 16%);*/
                    box-shadow: var(--app-shadow-elevation-1);
                    border: none;
                    box-sizing: border-box;
                }

                vaadin-grid.material {
                    outline: 0 !important;
                    font-family: Roboto, sans-serif;
                    background: rgba(0, 0, 0, 0);
                    border: none;
                    --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                    --vaadin-grid-cell: {
                        padding: 8px;
                    };

                    --vaadin-grid-header-cell: {
                        height: 48px;
                        padding: 11.2px;
                        color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                        font-size: 12px;
                        background: rgba(0, 0, 0, 0);
                        border-top: 0;
                    };

                    --vaadin-grid-body-cell: {
                        height: 48px;
                        color: rgba(0, 0, 0, var(--dark-primary-opacity));
                        font-size: 13px;
                    };

                    --vaadin-grid-body-row-hover-cell: {
                        background-color: var(--app-background-color-dark);
                    };

                    --vaadin-grid-body-row-selected-cell: {
                        background-color: var(--paper-grey-100);
                    };

                    --vaadin-grid-focused-cell: {
                        box-shadow: none;
                        font-weight: bold;
                    };

                }


                vaadin-grid.material .cell {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    height: 100%;
                }

                vaadin-grid.material .cell.last {
                    padding-right: 24px;
                    text-align: center;
                }

                vaadin-grid.material .cell.numeric {
                    text-align: right;
                }

                vaadin-grid.material paper-checkbox {
                    --primary-color: var(--paper-indigo-500);
                    margin: 0 24px;
                }

                vaadin-grid.material vaadin-grid-sorter {
                    --vaadin-grid-sorter-arrow: {
                        display: none !important;
                    };
                }

                vaadin-grid.material vaadin-grid-sorter .cell {
                    flex: 1;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                vaadin-grid.material vaadin-grid-sorter iron-icon {
                    transform: scale(0.8);
                }

                vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                    color: rgba(0, 0, 0, var(--dark-disabled-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction] {
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                    transform: scale(0.8) rotate(180deg);
                }

                vaadin-grid.material::slotted(div) {
                    outline: 0 !important;
                }

                .invoice-panel{
                    height: 100%;
                    width: 100%;
                    padding: 0 20px;
                    box-sizing: border-box;
                }

                .recipient-col{
                    width:  calc(100% / 11);
                }


                .oa-col{
                    min-width: 25px;
                }

                .ref-col{
                    min-width: 75px;
                }

                .invoice-col{
                    min-width: 40px;
                }

                .month-col{
                    min-width: 40px;
                }

                .invoiceDate-col{
                    min-width: 50px;
                }

                .invAmount-col{
                    min-width: 50px;
                }

                .accAmount-col{
                    min-width: 50px;
                }

                .refAmount-col{
                    min-width: 50px;
                }

                .stat-col{
                    min-width: 50px;
                }

                .reject-col{
                    min-width: 100px;
                }

                .payRef-col{
                    min-width: 50px;
                }

                .payDate-col{
                    min-width: 40px;
                }

                .payTot-col{
                    min-width: 40px;
                }

                .payBank-col{
                    min-width: 50px;
                }

                .payPaid-col{
                    min-width: 50px;
                }

                .facture-title {
                    padding: 15px;
                    font-size: 25px;
                    text-transform: capitalize;
                    margin: 0;
                    color: #212121;
                    height: 25px;
                    line-height: 25px;
                }


                @media screen and (max-width:1025px){
                    .invoice-panel {
                        left: 0;
                        width: 100%;
                    }
                }
                .gridContainer{
                    height: calc(100vh - 190px);
                    overflow-y: hidden;
                    overflow-x: hidden;
                    box-shadow: var(--app-shadow-elevation-1);
                }
                .gridContainer.grid-pending {
                    height: calc(100vh - 190px - 36px);
                }

                .invoice-status {
                    border-radius: 20px;
                    padding: 1px 12px 1px 8px;
                    width: auto;
                    font-size: 12px;
                    display: block;
                    width: fit-content;
                }

                .invoice-status--orangeStatus{
                    background: #fcdf354d;
                }

                .invoice-status--greenStatus{
                    background: #07f8804d;
                }

                .invoice-status--blueStatus {
                    background: #84c8ff;
                }

                .invoice-status--redStatus{
                    background: #ff4d4d4d;
                }

                .statusIcon{
                    height: 8px;
                    width: 8px;
                }
                .statusIcon.invoice-status--orangeStatus {
                    color: var(--app-status-color-pending);
                }
                .statusIcon.invoice-status--greenStatus {
                    color: var(--app-status-color-ok);
                }
                .statusIcon.invoice-status--blueStatus {
                    color: var(--paper-blue-400);
                }
                .statusIcon.invoice-status--redStatus {
                    color: var(--app-status-color-nok);
                }
                .statusIcon.invoice-status--orangeStatus,
                .statusIcon.invoice-status--greenStatus,
                .statusIcon.invoice-status--redStatus {
                    background: transparent !important;
                }

                *.txtcolor--orangeStatus {
                    color: var(--app-status-color-pending);
                }
                *.txtcolor--greenStatus {
                    color: var(--app-status-color-ok);
                }
                *.txtcolor--blueStatus {
                    color: var(--paper-blue-400);
                }
                *.txtcolor--redStatus {
                    color: var(--app-status-color-nok);
                }

                #pendingDetailDialog{
                    height: calc(100vh - 40px);
                    width: calc(85% - 40px);
                    z-index: 1100;
                    position: fixed;
                    top: 64px;
                }

                #pendingGridDetail{
                    height: calc(100% - 185px);
                    padding: 0;
                    width: 100%;
                }

                .batch-status {
                    font-size: 24px;
                    text-transform: capitalize;
                    padding-top: 5px;
                    display: flex;
                    flex-flow: row wrap;
                    align-items: center;
                    justify-content: flex-start;
                }

                .batch-status .spinner{
                    margin-left: 24px;
                }

                .unlockBtn {
                    height: 12px;
                    width: 12px;
                }

                .hidden {
                    display: none;
                }

                #messagesGridContainer {
                    overflow: hidden;
                }

                .invoiceContainer{
                    overflow-x: hidden;
                    overflow-y: hidden;
                    height: calc(100vh - 185px);
                    box-shadow: var(--app-shadow-elevation-1);
                }
                .invoiceSubContainerBig {
                   height: 100%;
                }

                .invoiceSubContainerMiddle {
                    /*height: 50%;*/
                    height: calc(100vh - 185px);
                    transition: all .5s ease;
                }
                .invoiceSubContainerMiddle vaadin-grid {
                    /*height: 100%;*/
                }
                .invoiceSubContainerMiddle.half {
                    height: 49%;
                }

                .invoiceDetailContainer {
                    height: 50%;
                    opacity: 0;
                    transition: all .75s ease-out;
                    overflow-y: auto;
                }
                .invoiceDetailContainer.open {
                    opacity: 1;
                    width: 100%;
                    height: 37%;
                }

                tr.hidden {
                    display: none !important;
                }

                .mb0 {
                    margin-bottom: 0;
                }

                #pendingDetailDialog {
                    max-height: 80vh;
                }

                .helpdeskIcon {
                    height: 12px;
                    width: 12px;
                    cursor: pointer;
                    opacity: 0.7;
                    transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
                }

                .helpdeskIcon:hover{
                    transform: scale(1.05);
                    opacity: 1;
                }

                iron-collapse-button #trigger{
                    height: 45px;
                    background: var(--app-background-color-dark);
                    display: initial;
                }

                #invoiceCollapser {
                    display: block;
                    background: white;
                    height: calc(100% - 75px);
                    overflow-y: auto;
                }

                h3.header {
                    margin: 0 auto
                }
                #collapse-grid .recipient-col {
                    background: grey;
                }

                .rejectionReason-col {
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    max-width: 100%;
                }

                .containScroll {
                    overflow: auto;
                    height: 100%;
                }

                .scrollBox {
                    width: 100%;
                    overflow: hidden;
                    height: 100%;
                }
                .scrollBox > #messagesGrid {
                    width: 100%;
                    height: 100%;
                }

                .flex-header{
                    width: 100%;
                    display: flex;
                    flex-flow: row nowrap;
                    justify-content: flex-start;
                    align-items: center;
                    height: 48px;
                }

                iron-collapse-button:hover{
                    background: var(--app-background-color-dark);
                }

                .flex-header span{
                    display:block;
                    font-size: 12px;
                    font-weight: 400;
                    padding: 4px 12px;
                    box-sizing:border-box;
                    cursor: pointer;
                    color: rgb(115,115,115);
                }

                .flex-header span.center{
                    text-align: center;
                }

                #invoiceGrid .footer{
                    background: red;
                }

                #helpdeskInfoDialog{
                    position: fixed;
                    width: 50%;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%);
                    max-width: none !important;
                    max-height: none !important;
                    overflow-y: auto;
                }

                .modal-title {
                    background: var(--app-background-color-dark);
                    margin-top: 0;
                    padding: 16px 24px;
                }

                .modal-content{
                    display: flex;
                    flex-flow: row wrap;
                    align-items: center;
                    justify-content: flex-start;
                }

                .modal-button{
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                    color: var(--app-text-color);
                    font-weight: 400;
                    font-size: 14px;
                    height: 40px;
                    min-width: 100px;
                    padding: 10px 1.2em;
                    text-transform: capitalize;
                }

                .modal-input{
                    margin: 0 12px;
                    flex-grow: 1;
                }

                paper-input{
                    --paper-input-container-focus-color: var(--app-primary-color);
                }

                .buttons {
                    position: absolute;
                    right: 0;
                    bottom: 0;
                    margin: 8px 16px;
                }

                .modal-button{
                    --paper-button-ink-color: var(--app-secondary-color);
                    background-color: var(--app-secondary-color);
                    color: var(--app-text-color);
                    font-weight: 700;
                    font-size: 14px;
                    height: 40px;
                    min-width: 100px;
                    padding: 10px 1.2em;
                    text-transform: capitalize;
                }

                .modal-button--close,
                .modal-button--cancel{
                    background: transparent;
                    color: var(--app-primary-color-dark);
                    font-weight: 400;
                }

                .modal-button--save{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-secondary-color);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;

                }

                @media screen and (max-width: 1024px) {
                    .hideOnMobile {display: none;opacity: 0;}
                }
            </style>
        </custom-style>
        <div class="invoice-panel">
            <div id="batchStatus" class="batch-status">
                [[_displayInvoiceStatus(invoicesStatus)]]
                <paper-spinner class="spinner" alt="Loading invoices" active=[[_isLoadingMessages]]></paper-spinner>
            </div>

            <template is="dom-if" if="[[statusPending]]">
                <paper-input id="filter" label="[[localize('sch','Rechercher',language)]]" value="{{filterInput}}" on-keyup="refreshFilter" param="invoiceGrid" where="pendings">></paper-input>
            </template>
            <template is="dom-if" if="[[!statusPending]]">
                <paper-input id="filter" label="[[localize('sch','Rechercher',language)]]" value="{{filterInputInvoices}}" on-keyup="refreshFilter" param="messagesGrid" where="notPendings"></paper-input>
            </template>

            <template is="dom-if" if="[[statusPending]]">
                <div class="gridContainer grid-pending">
                    <div class="containScroll">
                        <vaadin-grid id="noscroll" class="pendingTable" class="force-sizer" theme="force-sizer">
                            <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col" >
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.sentMediumType">Type</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="10%" class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="patient.insurance.code">Mutuelle</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.invoiceReference">N° facture</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="20%" class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.patient.firstName">Patient</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="patient.ssin">Niss</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.invoiceDate">Date facture</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column-group>
                                <!-- <template class="header hasBorder">Montants</template> -->
                                <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                    <template class="header border-left">
                                        <vaadin-grid-sorter path="invoice.reimbursement">OA</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column  flex-grow="0" width="7%" class="recipient-col">
                                    <template class="header">
                                        <vaadin-grid-sorter path="invoice.patientIntervention">Patient</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column  flex-grow="0" width="7%" class="recipient-col">
                                    <template class="header">
                                        <vaadin-grid-sorter path="invoice.doctorSupplement">Supplément</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column  flex-grow="0" width="7%" class="recipient-col border-right">
                                    <template class="header border-right">
                                        <vaadin-grid-sorter path="invoice.totalAmount">Total</vaadin-grid-sorter>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid-column-group>
                            <vaadin-grid-column  flex-grow="0" width="10%" class="recipient-col">
                                <template class="header">
                                    <vaadin-grid-sorter path="invoice.statut">Statut</vaadin-grid-sorter>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col">
                                <template class="header"></template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                        <template is="dom-repeat" items="[[toggledDatas]]">
                            <iron-collapse-button>
                                <div slot="collapse-trigger" class="flex-header">
                                    <span class="center hideOnMobile" style="width: 4%;">[[localize('grp','Groupe',language)]]</span>
                                    <span style="width: 54%;">OA: [[item.code]]</span>
                                    <span class="center" style="width: 7%;">[[_formatAmount(item.sum.oa)]]€</span>
                                    <span class="center" style="width: 7%;">[[_formatAmount(item.sum.pat)]]€</span>
                                    <span class="center" style="width: 7%;">[[_formatAmount(item.sum.sup)]]€</span>
                                    <span class="center" style="width: 7%;">[[_formatAmount(item.sum.tot)]]€</span>
                                </div>
                                <div slot="collapse-content">
                                    <vaadin-grid id="invoiceGrid" class="invoiceGrid" items="[[item.pat]]" multi-sort="[[multiSort]]" active-item="{{activeGridItem}}" on-tap="_showPendingDetail">
                                        <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col">
                                            <!--<template>[[item.invoice.sentMediumType]]</template>-->
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="10%" class="recipient-col">
                                            <template>
                                                <small>[[item.insuranceCode]]</small>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                            <template><small>[[item.invoiceReference]]</small></template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="20%" class="recipient-col">
                                            <template><small>[[item.patientName]]</small></template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                            <template><small>[[item.patientSsin]]</small></template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                            <template><small>[[formatDate(item.invoiceDate,'date')]]</small></template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                                <template class="border-left"><small><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.reimbursement)}}">[[_formatAmount(item.reimbursement)]]€</span></small></template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalReimbursement)]]€</template>-->
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                                <template><small><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.patientIntervention)}}">[[_formatAmount(item.patientIntervention)]]€</span></small></template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalPatientIntervention)]]€</template>-->
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                                <template><small><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.doctorSupplement)}}">[[_formatAmount(item.doctorSupplement)]]€</span></small></template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalDoctorSupplement)]]€</template>-->
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col border-right">
                                                <template class="border-right"><small><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.totalAmount)}}">[[_formatAmount(item.totalAmount)]]€</span></small></template>
                                                <!--<template class="footer">[[_formatAmount(totalPendingInvoices.totalAmount)]]€</template>-->
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column flex-grow="0" width="10%" class="recipient-col">
                                            <template>
                                                <!--<template is="dom-if" if="[[_isStatus(item.statut,'Pending')]]">-->
                                                    <!--<span class="invoice-status invoice-status&#45;&#45;pendingStatus"><iron-icon icon="vaadin:circle" class="statusIcon pendingStatus"></iron-icon>[[item.statut]]</span>-->
                                                <!--</template>-->
                                                <!--<template is="dom-if" if="[[_isStatus(item.statut,'Process')]]">-->
                                                    <!--<span class="invoice-status invoice-status&#45;&#45;okStatus"><iron-icon icon="vaadin:circle" class="statusIcon okStatus"></iron-icon>[[item.statut]]</span>-->
                                                <!--</template>-->
                                                <!--<template is="dom-if" if="[[!_isStatus(item.statut,'Pending')]]">-->
                                                    <!--<template is="dom-if" if="[[!_isStatus(item.statut,'Process')]]">-->
                                                        <!--<span class="invoice-status invoice-status&#45;&#45;nokStatus"><iron-icon icon="vaadin:circle" class="statusIcon nokStatus"></iron-icon>[[item.statut]]</span>-->
                                                    <!--</template>-->
                                                <!--</template>-->
                                                <span class$="invoice-status {{_getIconStatusClass(item.statut)}}"><iron-icon icon="vaadin:circle" class$="statusIcon {{_getIconStatusClass(item.statut)}}"></iron-icon> [[item.statut]]</span>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col">
                                            <template>
                                                <iron-icon icon="vaadin:unlock" class="unlockBtn" on-tap="_unlockInvoice" data-item$="[[item.invoice]]"></iron-icon>
                                            </template>
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                    <vaadin-grid items="toggledDatas">
                                        <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="10%" class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="20%" class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                            <template class="footer">[[localize('tot_sub','Sous-total',language)]] :</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                                <template class="footer"><b>[[_formatAmount(item.sum.oa)]]€</b></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                                <template class="footer"><b>[[_formatAmount(item.sum.pat)]]€</b></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                                <template class="footer"><b>[[_formatAmount(item.sum.sup)]]€</b></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col border-right">
                                                <template class="footer"><b>[[_formatAmount(item.sum.tot)]]€</b></template>
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column flex-grow="0" width="10%" class="recipient-col">
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col">
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                </div>
                            </iron-collapse-button>
                        </template>
                        <vaadin-grid>
                            <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="10%" class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="20%" class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                <template class="footer">[[localize('tot_global','Total',language)]] :</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column-group>
                                <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalReimbursement)]]€</template>
                                </vaadin-grid-column>
                                <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalPatientIntervention)]]€</template>
                                </vaadin-grid-column>
                                <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalDoctorSupplement)]]€</template>
                                </vaadin-grid-column>
                                <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col border-right">
                                    <template class="footer">[[_formatAmount(totalPendingInvoices.totalAmount)]]€</template>
                                </vaadin-grid-column>
                            </vaadin-grid-column-group>
                            <vaadin-grid-column flex-grow="0" width="10%" class="recipient-col">
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0" width="4%" class="recipient-col">
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                </div>
                <div class="buttons">
                    <paper-button on-tap="receiveInvoices" class="modal-button">Recevoir</paper-button>
                    <paper-button on-tap="sendInvoices" class="modal-button">Envoyer</paper-button>
                </div>
            </template>
            <template is="dom-if" if="[[!statusPending]]">
                    <div class="gridContainer">
                        <!--<paper-input id="filter" label="[[localize('fil','Filter',language)]]" value="{{filterInputInvoices}}" on-keyup="refreshFilter" param="messagesGrid"></paper-input>-->
                        <div class="invoiceContainer">
                            <div id="messagesGridContainer" class="invoiceSubContainerMiddle">
                                <template is="dom-if" if="[[isProcess(invoicesStatus.*)]]">
                                    <div class="scrollBox">
                                        <vaadin-grid id="messagesGrid" class="processTable" items="[[messagesByStatus(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]" active-item="{{activeGridItem}}" on-tap="_showDetail">
                                            <vaadin-grid-column flex-grow="0" width="14%" class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcp">Prestataire</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcp]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="4%" class="oa-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.oa">OA</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.oa]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="20%" class="ref-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcpReference]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="8%" class="invoice-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceNumber]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="8%" class="month-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                                </template>
                                                <template>[[formatDate(item.messageInfo.invoiceMonth,'month')]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="invoiceDate-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[formatDate(item.messageInfo.invoiceDate,'date')]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="8%" class="invAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant<br/>facturé</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</span></template>
                                                <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="8%" class="accAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant<br/>accepté</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.messageInfo.acceptedAmount)]]€</span></template>
                                                <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="8%" class="refAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant<br/>refusé</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.messageInfo.refusedAmount)]]€</span></template>
                                                <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="10%" class="stat-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                                </template>
                                                <template>
                                                    <!--<template is="dom-if" if="[[_isStatus(item.messageInfo.invoiceStatus,'Pending')]]">-->
                                                        <!--<span class="invoice-status invoice-status&#45;&#45;pendingStatus"><iron-icon icon="vaadin:circle" class="statusIcon pendingStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                    <!--</template>-->
                                                    <!--<template is="dom-if" if="[[_isStatus(item.messageInfo.invoiceStatus,'Process')]]">-->
                                                         <!--<span class="invoice-status invoice-status&#45;&#45;okStatus"><iron-icon icon="vaadin:circle" class="statusIcon okStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                    <!--</template>-->
                                                    <!--<template is="dom-if" if="[[!_isStatus(item.messageInfo.invoiceStatus,'Pending')]]">-->
                                                        <!--<template is="dom-if" if="[[!_isStatus(item.messageInfo.invoiceStatus,'Process')]]">-->
                                                             <!--<span class="invoice-status invoice-status&#45;&#45;nokStatus"><iron-icon icon="vaadin:circle" class="statusIcon nokStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                        <!--</template>-->
                                                    <!--</template>-->
                                                    <span class$="invoice-status {{_getIconStatusClass(item.messageInfo.invoiceStatus)}}"><iron-icon icon="vaadin:circle" class$="statusIcon {{_getIconStatusClass(item.messageInfo.invoiceStatus)}}"></iron-icon> [[item.messageInfo.invoiceStatus]]</span>
                                                </template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="3%" class="payPaid-col">
                                                <template class="header"></template>
                                                <template>
                                                    <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogSupp"></iron-icon>
                                                </template>
                                            </vaadin-grid-column>
                                        </vaadin-grid>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[isArchOrAcc(invoicesStatus.*)]]">
                                    <div class="scrollBox">
                                        <vaadin-grid id="messagesGrid" class="archiveAndAccepted" items="[[messagesByStatus(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]" active-item="{{activeGridItem}}" on-tap="_showDetail">
                                            <vaadin-grid-column flex-grow="0" width="12%" class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcp">Prestataire</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcp]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="4%" class="oa-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.oa">OA</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.oa]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="17%" class="ref-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcpReference]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="invoice-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceNumber]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="month-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                                </template>
                                                <template>[[formatDate(item.messageInfo.invoiceMonth,'month')]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="invoiceDate-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[formatDate(item.messageInfo.invoiceDate,'date')]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="invAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant facturé</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</span></template>
                                                <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="accAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant accepté</vaadin-grid-sorter>
                                                </template>
                                                <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.messageInfo.acceptedAmount)}}">[[_formatAmount(item.messageInfo.acceptedAmount)]]€</span></template>
                                                <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="refAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant refusé</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.messageInfo.refusedAmount)]]€</span></template>
                                                <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="10%" class="stat-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                                </template>
                                                <template>
                                                    <!--<template is="dom-if" if="[[_isStatus(item.messageInfo.invoiceStatus,'Pending')]]">-->
                                                        <!--<span class="invoice-status invoice-status&#45;&#45;pendingStatus"><iron-icon icon="vaadin:circle" class="statusIcon pendingStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                    <!--</template>-->
                                                    <!--<template is="dom-if" if="[[_isStatus(item.messageInfo.invoiceStatus,'Process')]]">-->
                                                        <!--<span class="invoice-status invoice-status&#45;&#45;okStatus"><iron-icon icon="vaadin:circle" class="statusIcon okStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                    <!--</template>-->
                                                    <!--<template is="dom-if" if="[[!_isStatus(item.messageInfo.invoiceStatus,'Pending')]]">-->
                                                        <!--<template is="dom-if" if="[[!_isStatus(item.messageInfo.invoiceStatus,'Process')]]">-->
                                                            <!--<span class="invoice-status invoice-status&#45;&#45;nokStatus"><iron-icon icon="vaadin:circle" class="statusIcon nokStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                        <!--</template>-->
                                                    <!--</template>-->
                                                    <span class$="invoice-status {{_getIconStatusClass(item.messageInfo.invoiceStatus)}}"><iron-icon icon="vaadin:circle" class$="statusIcon {{_getIconStatusClass(item.messageInfo.invoiceStatus)}}"></iron-icon> [[item.messageInfo.invoiceStatus]]</span>
                                                    <!--<iron-icon icon="vaadin:circle" class="statusIcon" on-load="_getIconStatusClass" data-item$="[[item.messageInfo.invoiceStatus]]"></iron-icon>-->
                                                </template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column-group>
                                               <template class="header hasBorder">Informations paiement</template>
                                                <vaadin-grid-column flex-grow="0" width="7%" class="reject-col">
                                                    <template class="header">
                                                        <vaadin-grid-sorter path="messageInfo.paymentReference">Réf</vaadin-grid-sorter>
                                                    </template>
                                                    <template>[[item.messageInfo.paymentReference]]</template>
                                                </vaadin-grid-column>
                                                <vaadin-grid-column flex-grow="0" width="7%" class="reject-col">
                                                    <template class="header">
                                                        <vaadin-grid-sorter path="messageInfo.paymentDate">Date</vaadin-grid-sorter>
                                                    </template>
                                                    <template>[[item.messageInfo.paymentDate]]</template>
                                                </vaadin-grid-column>
                                                <vaadin-grid-column flex-grow="0" width="7%" class="reject-col">
                                                    <template class="header">
                                                        <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant</vaadin-grid-sorter>
                                                    </template>
                                                    <template>[[_formatAmount(item.messageInfo.amountPaid)]]€</template>
                                                </vaadin-grid-column>
                                                <vaadin-grid-column flex-grow="0" width="7%" class="reject-col">
                                                    <template class="header">
                                                        <vaadin-grid-sorter path="messageInfo.paymentAccount">Compte bancaire</vaadin-grid-sorter>
                                                    </template>
                                                    <template>[[item.messageInfo.paymentAccount]]</template>
                                                </vaadin-grid-column>
                                                <vaadin-grid-column flex-grow="0" width="7%" class="reject-col">
                                                    <template class="header">
                                                        <vaadin-grid-sorter path="messageInfo.paymentReference">Payé</vaadin-grid-sorter>
                                                    </template>
                                                    <template>[[item.messageInfo.paid]]</template>
                                                </vaadin-grid-column>
                                                <vaadin-grid-column flex-grow="0" width="3%" class="payPaid-col">
                                                    <template class="header"></template>
                                                    <template>
                                                        <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogSupp"></iron-icon>
                                                    </template>
                                                </vaadin-grid-column>
                                            </vaadin-grid-column-group>
                                        </vaadin-grid>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[isReject(invoicesStatus.*)]]">
                                    <div class="scrollBox">
                                        <vaadin-grid id="messagesGrid" class="rejectedTable" items="[[messagesByStatus(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]" active-item="{{activeGridItem}}" on-tap="_showDetail">
                                            <vaadin-grid-column flex-grow="0" width="14%" class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcp">Prestataire</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcp]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="4%" class="oa-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.oa">OA</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.oa]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="20%" class="ref-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.hcpReference">Réf. du médecin</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.hcpReference]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="8%" class="invoice-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceNumber">N° envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.invoiceNumber]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="8%" class="month-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceMonth">Mois fact.</vaadin-grid-sorter>
                                                </template>
                                                <template>[[formatDate(item.messageInfo.invoiceMonth,'month')]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="9%" class="invoiceDate-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoiceDate">Date d'envoi</vaadin-grid-sorter>
                                                </template>
                                                <template>[[formatDate(item.messageInfo.invoiceDate,'date')]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="invAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.invoicedAmount"> Montant facturé</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.messageInfo.invoicedAmount)]]€</span></template>
                                                <template class="footer">[[_invoicedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="accAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.acceptedAmount">Montant accepté</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.messageInfo.acceptedAmount)]]€</span></template>
                                                <template class="footer">[[_acceptedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="refAmount-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Montant refusé</vaadin-grid-sorter>
                                                </template>
                                                <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.messageInfo.refusedAmount)}}">[[_formatAmount(item.messageInfo.refusedAmount)]]€</span></template>
                                                <template class="footer">[[_refusedAmount(invoicesStatus,messagesProcessed,messagesRejected,messagesAccepted)]]€</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="6%" class="stat-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.refusedAmount">Statut</vaadin-grid-sorter>
                                                </template>
                                                <template>
                                                    <!--<template is="dom-if" if="[[_isStatus(item.messageInfo.invoiceStatus,'Pending')]]">-->
                                                        <!--<span class="invoice-status invoice-status&#45;&#45;nokStatus"><iron-icon icon="vaadin:circle" class="statusIcon pendingStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                    <!--</template>-->
                                                    <!--<template is="dom-if" if="[[_isStatus(item.messageInfo.invoiceStatus,'Process')]]">-->
                                                        <!--<span class="invoice-status invoice-status&#45;&#45;nokStatus"><iron-icon icon="vaadin:circle" class="statusIcon okStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                    <!--</template>-->
                                                    <!--<template is="dom-if" if="[[!_isStatus(item.messageInfo.invoiceStatus,'Pending')]]">-->
                                                        <!--<template is="dom-if" if="[[!_isStatus(item.messageInfo.invoiceStatus,'Process')]]">-->
                                                            <!--<span class="invoice-status invoice-status&#45;&#45;nokStatus"><iron-icon icon="vaadin:circle" class="statusIcon nokStatus"></iron-icon>[[item.messageInfo.invoiceStatus]]</span>-->
                                                        <!--</template>-->
                                                    <!--</template>-->
                                                    <span class$="invoice-status {{_getIconStatusClass(item.messageInfo.invoiceStatus)}}"><iron-icon icon="vaadin:circle" class$="statusIcon {{_getIconStatusClass(item.messageInfo.invoiceStatus)}}"></iron-icon> [[item.messageInfo.invoiceStatus]]</span>
                                                    <!--<iron-icon icon="vaadin:circle" class="statusIcon" on-load="_getIconStatusClass" data-item$="[[item.messageInfo.invoiceStatus]]"></iron-icon>-->
                                                </template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="7%" class="reject-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="messageInfo.rejectionReason">Motif rejet</vaadin-grid-sorter>
                                                </template>
                                                <template>[[item.messageInfo.rejectionReason]]</template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="3%" class="payPaid-col">
                                                <template class="header"></template>
                                                <template>
                                                    <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogSupp"></iron-icon>
                                                </template>
                                            </vaadin-grid-column>
                                        </vaadin-grid>
                                    </div>
                                </template>
                            </div>
                            <template is="dom-if" if="[[ifInvoiceSelected]]">
                                <h4 class="mb0">Détail des envois selectionnés</h4>
                                <paper-input id="filter" label="[[localize('fil','Filter',language)]]" value="{{selectedInputDetail}}" on-keyup="refreshFilter" param="selectedInputDetail" where="invoiceSelected"></paper-input>
                                <div id="invoiceDetailContainer" class="invoiceDetailContainer">
                                    <vaadin-grid id="invoiceGridDetail" data-provider="[[_batchDetailDataProvider()]]">
                                        <vaadin-grid-column flex-grow="0" width="5%" class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="invoiceReference">N° fact.</vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <vaadin-grid-tree-toggle leaf="[[!item.invoicingCodes.length]]" expanded="{{expanded}}" level="[[level]]">
                                                    [[item.invoiceReference]]
                                                </vaadin-grid-tree-toggle>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="9%" class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="patientName">Patient</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.patient]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="8%" class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="ssin">Niss</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.ssin]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="5%" class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="invoicingCode">Nmcl</vaadin-grid-sorter>
                                            </template>
                                            <template>[[item.invoicingCode]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="invoiceDate">Date presta.</vaadin-grid-sorter>
                                            </template>
                                            <template>[[formatDate(item.invoiceDate,'date')]]</template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column-group>
                                            <vaadin-grid-column flex-grow="0" width="5%" class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="invoicedAmount">Montant<br/>Facturé</vaadin-grid-sorter>
                                                </template>
                                                <template><span>[[_formatAmount(item.invoicedAmount)]]€</span></template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="5%" class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="acceptedAmount">Montant<br/>Accepté</vaadin-grid-sorter>
                                                </template>
                                                <template is="dom-if" is="[[_isStatus(item.messageInfo.invoiceStatus,'Accepted')]]">
                                                    <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.acceptedAmount)}}">[[_formatAmount(item.acceptedAmount)]]€</span></template>
                                                </template>
                                                <template is="dom-if" is="[[!_isStatus(item.messageInfo.invoiceStatus,'Accepted')]]">
                                                    <template><span>[[_formatAmount(item.acceptedAmount)]]€</span></template>
                                                </template>
                                            </vaadin-grid-column>
                                            <vaadin-grid-column flex-grow="0" width="5%" class="recipient-col">
                                                <template class="header">
                                                    <vaadin-grid-sorter path="refusedAmount">Montant<br/>Refusé</vaadin-grid-sorter>
                                                </template>
                                                <template is="dom-if" is="[[_isStatus(item.messageInfo.invoiceStatus,'Refused')]]">
                                                    <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.refusedAmount)}}">[[_formatAmount(item.refusedAmount)]]€</span></template>
                                                </template>
                                                <template is="dom-if" is="[[!_isStatus(item.messageInfo.invoiceStatus,'Refused')]]">
                                                    <template><span>[[_formatAmount(item.refusedAmount)]]€</span></template>
                                                </template>
                                            </vaadin-grid-column>
                                        </vaadin-grid-column-group>
                                        <vaadin-grid-column flex-grow="0" width="36%" class="rejectionReason-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="rejectionReason">Motif de rejet</vaadin-grid-sorter>
                                            </template>
                                            <template style="align-self: flex-start;">
                                                <div class="rejectionReason-cell">[[item.rejectionReason]]</div>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="5%" class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="paid">Payé</vaadin-grid-sorter>
                                            </template>
                                            <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.paid)}}">[[_formatAmount(item.paid)]]€</span></template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="7%" class="recipient-col">
                                            <template class="header">
                                                <vaadin-grid-sorter path="status">Statut</vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <!--<template is="dom-if" if="[[_isStatus(item.statut,'Pending')]]">-->
                                                    <!--<span class="invoice-status invoice-status&#45;&#45;pendingStatus"><iron-icon icon="vaadin:circle" class="statusIcon pendingStatus"></iron-icon>[[item.statut]]</span>-->
                                                <!--</template>-->
                                                <!--<template is="dom-if" if="[[_isStatus(item.statut,'Process')]]">-->
                                                    <!--<span class="invoice-status invoice-status&#45;&#45;okStatus"><iron-icon icon="vaadin:circle" class="statusIcon okStatus"></iron-icon>[[item.statut]]</span>-->
                                                <!--</template>-->
                                                <!--<template is="dom-if" if="[[!_isStatus(item.statut,'Pending')]]">-->
                                                    <!--<template is="dom-if" if="[[!_isStatus(item.statut,'Process')]]">-->
                                                        <!--<span class="invoice-status invoice-status&#45;&#45;nokStatus"><iron-icon icon="vaadin:circle" class="statusIcon nokStatus"></iron-icon>[[item.statut]]</span>-->
                                                    <!--</template>-->
                                                <!--</template>-->
                                                <span class$="invoice-status {{_getIconStatusClass(item.messageInfo.invoiceStatus))}}"><iron-icon icon="vaadin:circle" class$="statusIcon {{_getIconStatusClass(item.messageInfo.invoiceStatus)}}"></iron-icon> [[item.messageInfo.invoiceStatus]]</span>
                                                <!--<iron-icon icon="vaadin:circle" class="statusIcon" on-load="_getIconStatusClass" data-item$="[[item.messageInfo.invoiceStatus]]"></iron-icon>-->
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column flex-grow="0" width="3%" class="recipient-col">
                                            <template class="header"></template>
                                            <template>
                                                <iron-icon icon="vaadin:info-circle" id="[[item.id]]" class="helpdeskIcon" data-item$="[[item]]" on-tap="_openHelpDeskDialogDet"></iron-icon>
                                            </template>
                                        </vaadin-grid-column>
                                    </vaadin-grid>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

            </div>

            <paper-dialog id="pendingDetailDialog">
                <div>
                    Details of invoice n° [[activeGridItem.invoice.invoiceReference]]
                    <paper-input label="Patient" value="[[activeGridItem.patient.firstName]] [[activeGridItem.patient.lastName]]"readonly></paper-input>
                    <paper-input label="Mutuelle" value="[[activeGridItem.insurance.code]]"readonly></paper-input>
                </div>
                    <vaadin-grid id="pendingGridDetail" items="[[activeGridItem.invoice.invoicingCodes]]">
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Date</template>
                            <template>[[formatDate(item.dateCode)]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Code</template>
                            <template>[[item.code]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Libellé</template>
                            <template>[[item.label]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">PR</template>
                            <template>[[item.relatedCode]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">Tp</template>
                            <template>[[item.insuranceJustification]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column class="recipient-col">
                            <template class="header">N° engagement</template>
                            <template>[[item.contract]]</template>
                        </vaadin-grid-column>
                        <vaadin-grid-column-group class="hasBorder">
                            <template class="header">Montants</template>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">OA</template>
                                <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.reimbursement)}}">[[_formatAmount(item.reimbursement)]]</span></template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">Patient</template>
                                <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.patientIntervention)}}">[[_formatAmount(item.patientIntervention)]]</span></template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">Supplément</template>
                                <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.doctorSupplement)}}">[[_formatAmount(item.doctorSupplement)]]</span></template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column class="recipient-col">
                                <template class="header">Total</template>
                                <template><span class$="{{_getTxtStatusColor(item.messageInfo.invoiceStatus,item.totalAmount)}}">[[_formatAmount(item.totalAmount)]]</span></template>
                                <template class="footer">0.00€</template>
                            </vaadin-grid-column>
                        </vaadin-grid-column-group>
                    </vaadin-grid>
            </paper-dialog>
        </div>

        <paper-dialog id="helpdeskInfoDialog">
            <h2 class="modal-title">Info Helpdesk</h2>
            <div class="modal-content">
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="OA" value="[[infoHelpdesk.messageInfo.oa]]" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Inami tiers facturant" value="[[hcp.nihii]]" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="N° envoi" value="[[infoHelpdesk.messageInfo.invoiceNumber]]" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Mois et année de facturation" value="[[infoHelpdesk.messageInfo.invoiceMonth]]" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Date d'envoi du fichier" value="[[_dateFormat(infoHelpdesk.message.sent)]]" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Date dernière réponse OA" value="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Type dernière réponse OA" value="" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Montant facturé" value="[[infoHelpdesk.messageInfo.invoicedAmount]]" readOnly><div slot="suffix">€</div></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Nom du soft" value="TOPAZ" readOnly></paper-input>
                <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="N° de tél de contact médecin" value="[[mobile]]" readOnly></paper-input>
                <template is="dom-if" if="[[isCompleteHelpDesk]]">
                    <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Patient" value="[[infoHelpdeskDet.patient]]" readOnly></paper-input>
                    <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Niss" value="[[infoHelpdeskDet.ssin]]" readOnly></paper-input>
                    <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Prestation" value="[[infoHelpdeskDet.invoiceDate]]" readOnly></paper-input>
                    <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Date de la prestation" value="[[_dateFormat(infoHelpdeskDet.invoiceDate)]]" readOnly></paper-input>
                    <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Montant facturé" value="[[infoHelpdeskDet.invoicedAmount]]" readOnly><div slot="suffix">€</div></paper-input>
                    <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Montant accepté" value="[[infoHelpdeskDet.acceptedAmount]]" readOnly><div slot="suffix">€</div></paper-input>
                    <paper-input class="flex-container-nmcl-row modal-input" always-float-label label="Montant refusé" value="[[infoHelpdeskDet.refusedAmount]]" readOnly><div slot="suffix">€</div></paper-input>
                    <paper-textarea class="flex-container-nmcl-row modal-input" always-float-label label="Motif(s) de rejet" value="[[infoHelpdeskDet.rejectionReason]]" readOnly></paper-textarea>
                </template>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" dialog-dismiss>[[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'

        class HtMsgInvoice extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-invoice';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    hcp: {
                        type : Object
                    },
                    selectedMessages: {
                        type: Object,
                        notify: true
                    },
                    activeItem: {
                        type: Object
                    },
                    messages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectList: {
                        type: Object
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        }
                    },
                    totalPendingInvoices:{
                        type: Object,
                        value : () => ({
                            totalReimbursement:          Number(0.00).toFixed(2),
                            totalAmount:                 Number(0.00).toFixed(2),
                            totalPatientIntervention:    Number(0.00).toFixed(2),
                            totalDoctorSupplement:       Number(0.00).toFixed(2)
                        })
                    },
                    invoicesStatus: {
                        type: String,
                        observer: '_invoicesStatusChanged'
                    },
                    statusPending:{
                        type: Boolean,
                        value: true
                    },
                    selectedPendingInvoices:{
                        type: Object,
                        value : () => ({})
                    },
                    selectedInvoicesByStatus:{
                        type: Object,
                        value : () => ({})
                    },
                    multiSort:{
                        type: Boolean,
                        value: true
                    },
                    activeGridItem:{
                        type: Object,
                        value: function () {
                            return [];
                        }
                    },
                    filterValue:{
                        type: String,
                        value: ""
                    },
                    filterPath:{
                        type:String,
                        value: "invoice.patient.firstName"
                    },
                    btnSelectionPatient: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    showInactive: {
                        type: Boolean,
                        value: false
                    },
                    ifInvoiceSelected: {
                        type: Boolean,
                        value: true
                    },
                    level :{
                        type : Number,
                        value : 0
                    },
                    expanded : {
                        type : Boolean,
                        value : true
                    },
                    invoicesFromBatch:{
                        type: Object,
                        value: function () {
                            return [];
                        }
                    },
                    infoHelpdesk:{
                        type : Object
                    },
                    isCompleteHelpDesk:{
                        type: Boolean
                    },
                    infoHelpdeskDet:{
                        type: Object
                    },
                    mobile :{
                        type: String
                    },
                    displayedYear: {
                        type: Number,
                        value: () => Number(moment().format('YYYY'))
                    },
                    processing:{
                        type: Boolean,
                        value: false
                    },
                    archOrAcc:{
                        type: Boolean,
                        value:false
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return ['_invoicesChange(invoices.*)', '_detailsChanged(invoicesFromBatch.*)'];
            }

            ready() {
                super.ready();
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(response =>{
                    this.set("hcp",response)
                })
            }

            _detailsChanged() {
                const igd = this.root.querySelector('#invoiceGridDetail')
                igd && igd.clearCache()
            }

            fetchPendingMessages(){

                this.api.invoice().listToInsurancesUnsent(this.user.id)
                    .then(invoices => Promise.all(invoices.filter(i => i.printedDate && i.sentMediumType === "efact").map(inv => this.api.crypto().extractCryptedFKs(inv, this.user.healthcarePartyId).then(ids => [inv, ids[0]]))))
                    .then(invAndIdsPat =>
                        this.api.patient().getPatients(new models.ListOfIdsDto({ids: _.uniq(invAndIdsPat.map(x => x[1]))})).then(pats => invAndIdsPat.map(it => [it[0], pats.find(p => p.id === it[1])]))
                    ).then(invAndPats =>
                        this.api.insurance().getInsurances(new models.ListOfIdsDto({ids : _.uniq(_.flatten(invAndPats).filter(i => i.insurabilities).map(i => i.insurabilities[0].insuranceId))})).then(ins => invAndPats.map(it => [it[0], it[1], ins.find(i => i.id === it[1].insurabilities[0].insuranceId)]))
                    ).then(invAndPatsAndInsurances => _.flatMap(invAndPatsAndInsurances, ([inv, pat, ins]) => {
                        return ({
                            patientName: pat.lastName+" "+pat.firstName,
                            invoiceId: inv.id,
                            sentMediumType: inv.sentMediumType,
                            insuranceCode: ins.code,
                            insuranceParent: ins.parent,
                            invoiceReference: inv.invoiceReference,
                            patientSsin: pat.ssin,
                            invoiceDate: inv.invoiceDate,
                            reimbursement: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.reimbursement), 0).toFixed(2) : 0.00,
                            patientIntervention: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.patientIntervention), 0).toFixed(2) : 0.00,
                            totalAmount: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.totalAmount), 0).toFixed(2) : 0.00 ,
                            doctorSupplement: inv.invoicingCodes ? inv.invoicingCodes.reduce((tot, m) => tot + Number(m.doctorSupplement), 0).toFixed(2) : 0.00,
                            statut : "Pending",
                            hasChildren : false,
                            uuid : inv.id,
                            parentUuid : ins.code.charAt(0),
                            patient: pat,
                            invoice: inv
                    })
                }))
                .then(invoiceStruct => {
                    this.set('selectedPendingInvoices', invoiceStruct)
                    this.set("totalPendingInvoices.totalPatientIntervention",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.patientIntervention), 0).toFixed(2) : 0.00)
                    this.set("totalPendingInvoices.totalDoctorSupplement",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.doctorSupplement), 0).toFixed(2) : 0.00)
                    this.set("totalPendingInvoices.totalReimbursement",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.reimbursement), 0).toFixed(2) : 0.00)
                    this.set("totalPendingInvoices.totalAmount",this.selectedPendingInvoices ? this.selectedPendingInvoices.reduce((tot, m) => tot + Number(m.totalAmount), 0).toFixed(2) : 0.00)
                    this._toggleDataProvider(this.selectedPendingInvoices)
                })


            }

            dispatchMessages() {
                this.set("messagesProcessed", this.allMessages.filter(m => (m.message.status & (1 << 15 | 1 << 16 | 1 << 17)) === 0))
                !!this.set("messagesAccepted", this.allMessages.filter( m => (m.message.status & (1 << 15 | 1 << 16 )) !== 0))
                !!this.set("messagesRejected", this.allMessages.filter( m => (m.message.status & (1 << 17)) !== 0))

                !!this.initializeBatchCounter(this.allMessages.filter(m => (m.message.status & (1 << 15 | 1 << 16 | 1 << 17)) === 0).length, this.allMessages.filter( m => (m.message.status & (1 << 15 | 1 << 16 )) !== 0).length, this.allMessages.filter( m => (m.message.status & (1 << 17)) !== 0).length)
            }

            fetchMessages() {
                this._isLoadingMessages = true
                this.api.message().findMessagesByTransportGuid("EFACT:BATCH:*")
                    .then(messages => {
                        const filteredMessages = messages.rows.filter(msg => msg.transportGuid && msg.responsible === this.hcp.id && msg.transportGuid.startsWith("EFACT:BATCH:" + this.displayedYear))
                        this.api.insurance().getInsurances(new models.ListOfIdsDto({ids: _.uniq(filteredMessages.map(m => m.recipients[0]))})).then(insurances => {
                            this.set('allMessages', filteredMessages.map(m => ({
                                message: m,
                                messageInfo: {
                                    messageType: m.subject,
                                    hcp: this.hcp.firstName + " " + this.hcp.lastName,
                                    oa: insurances && insurances.find(i => i.id === m.recipients[0])? insurances.find(i => i.id === m.recipients[0]).code : "",
                                    hcpReference: "",
                                    invoiceNumber: m.externalRef,
                                    invoiceMonth: "",
                                    invoiceDate: "",
                                    invoicedAmount: m.metas && m.metas.totalAmount ? Number(m.metas.totalAmount).toFixed(2) : "0.00",
                                    acceptedAmount: m.metas && m.metas.totalAcceptedAmount ? Number(m.metas.totalAcceptedAmount).toFixed(2) : "0.00",
                                    refusedAmount: m.metas && m.metas.totalRejectedAmount ? Number(m.metas.totalRejectedAmount).toFixed(2) : "0.00",
                                    invoiceStatus: "",
                                    rejectionReason: "",
                                    paymentReference: m.metas && m.metas.paymentReferenceAccount1 ? m.metas.paymentReferenceAccount1 : "",
                                    paymentDate: "",
                                    amountPaid: m.metas && m.metas.totalAcceptedAmount ? Number(m.metas.totalAcceptedAmount).toFixed(2) : "0.00"
                                }
                            })))

                            Promise.all( this.allMessages.map(mm =>
                                this.api.document().findByMessage(this.user.healthcarePartyId, mm.message)
                                    .then(docs => {
                                        const jsonDoc = docs.find(d => d.mainUti === "public.json" && _.endsWith(d.name, '_records'))

                                        return jsonDoc ? this.api.document().getAttachment(jsonDoc.id, jsonDoc.attachmentId, jsonDoc.secretForeignKeys).then(a => {

                                            if (typeof a === "string"){
                                                try { a = JSON.parse( this.cleanStringForJsonParsing(a) ) } catch (ignored) {}
                                            } else if (typeof a === "object") {
                                                try { a = JSON.parse( this.cleanStringForJsonParsing(new Uint8Array(a).reduce((data, byte) => data + String.fromCharCode(byte), ''))); } catch (ignored) {}
                                            }

                                            const zone200 = a && a.find(enr => enr.zones.find(z => z.zone == "200"))
                                            const zone300 = a && a.find(enr => enr.zones.find(z => z.zone == "300"))
                                            const zone400 = a && a.find(enr => enr.zones.find(z => z.zone == "400"))
                                            const zone500 = a && a.find(enr => enr.zones.find(z => z.zone == "500"))
                                            const enr10 = a && a.find(enr => enr.zones.find(z => z.zone == "1" && z.value == "10"))

                                            const st = mm.message.status

                                            const invoiceStatus = !!(st & (1 << 17))  ? this.localize('inv_err','Error',this.language):
                                                !!(st & (1 << 16)) ? this.localize('inv_par_acc','Partially accepted',this.language):
                                                !!(st & (1 << 16)) ? this.localize('inv_full_acc','Fully accepted',this.language):
                                                !!(st & (1 << 12)) ? this.localize('inv_rej','Rejected',this.language):
                                                !!(st & (1 << 11)) ? this.localize('inv_tre','Treated',this.language):
                                                !!(st & (1 << 10)) ? this.localize('inv_acc_tre','Accepted for treatment',this.language):
                                                !!(st & (1 << 9)) ?  this.localize('inv_succ_tra_oa','Successfully transmitted to OA',this.language):
                                                !!(st & (1 << 8)) ?  this.localize('inv_pen','Pending',this.language): ""


                                            const rejectionReason = !!(st & (1 << 17)) ? this.localize('inv_rej_5%','More than 5% error',this.language) :
                                                     !!(st & (1 << 12)) ? this.localize('inv_rej_block','Blocking error',this.language): ""

                                            return (zone200 && zone300) ?
                                                ({
                                                    message: mm && mm.message,
                                                    messageInfo: {
                                                        messageType:        zone200.zones && zone200.zones.find(z => z.zone === "200") ? zone200.zones.find(z => z.zone === "200").value : "",
                                                        hcp:                this.hcp.firstName + " " + this.hcp.lastName,
                                                        oa:                 zone500.zones && zone500.zones.find(z => z.zone === "501") ? (zone500.zones.find(z => z.zone === "501").value).charAt(0) + "00" : "",
                                                        hcpReference:       enr10.zones && enr10.zones.find(z => z.zone === "28") ? enr10.zones.find(z => z.zone === "28").value : "",
                                                        invoiceNumber:      zone300.zones && zone300.zones.find(z => z.zone === "301") ? zone300.zones.find(z => z.zone === "301").value : "",
                                                        invoiceMonth:       zone300.zones &&zone300.zones.find(z => z.zone === "300") ? zone300.zones.find(z => z.zone === "300").value : "",
                                                        invoiceDate:        zone300.zones && zone300.zones.find(z => z.zone === "302") ? zone300.zones.find(z => z.zone === "302").value : "",
                                                        invoicedAmount:     (mm && mm.messageInfo && mm.messageInfo.invoicedAmount) ? mm.messageInfo.invoicedAmount : "0.00",
                                                        acceptedAmount:     (mm && mm.messageInfo && mm.messageInfo.acceptedAmount) ? mm.messageInfo.acceptedAmount : "0.00",
                                                        refusedAmount:      (mm && mm.messageInfo && mm.messageInfo.refusedAmount) ? mm.messageInfo.refusedAmount : "0.00",
                                                        invoiceStatus:      invoiceStatus,
                                                        rejectionReason:    rejectionReason,
                                                        paymentReference:   (mm && mm.messageInfo && mm.messageInfo.paymentReference) ? mm.messageInfo.paymentReference : "",
                                                        paymentDate:        "",
                                                        amountPaid:         (mm && mm.messageInfo && mm.messageInfo.acceptedAmount) ? mm.messageInfo.acceptedAmount : "0.00",
                                                        paymentAccount:     enr10.zones && enr10.zones.find(z => z.zone === "36") ? enr10.zones.find(z => z.zone === "36").value : "",
                                                        paid: false
                                                    }
                                                }) : mm
                                        }) : mm
                                    }))).then(msgsStructs => {
                                                this._isLoadingMessages = false
                                                this.set('allMessages', msgsStructs)
                                                this.dispatchMessages()
                                        })

                        })
                    })
            }


            getMessage(){
                this.fetchPendingMessages()
                this.fetchMessages()
            }



            _toggleDataProvider(input) {
                //TODO rewrite lodash

                let inputList = input
                let mutGroups = []
                inputList.map(patient => {
                    const thisMutGrp = // set this pat insurance code grp
                        (patient.insuranceCode < 200) ? "100" :
                        (patient.insuranceCode < 300) ? "200" :
                        (patient.insuranceCode < 400) ? "300" :
                        (patient.insuranceCode < 500) ? "400" :
                        (patient.insuranceCode < 600) ? "500" :
                        (patient.insuranceCode < 700) ? "600" :
                        "900"
                    let grpExists = false
                    mutGroups.map(grp=> { if (grp.code === thisMutGrp) { // check if grp exists
                        grpExists = true
                    }})
                    if (!grpExists) { mutGroups.push({ // else create object
                        code: thisMutGrp,pat: [],sum:{oa:0,pat:0,sup:0,tot:0}
                    })}
                    mutGroups.map(grp=>{ if (grp.code === thisMutGrp) { // get into this grp
                        (grp.pat).push(patient) // add the patient
                    }})
                }) // inputList map end

                mutGroups.sort((a, b)=>{return a.code-b.code})
                this.set('toggledDatas', mutGroups ) // this.set
                for (let grp of mutGroups) {
                    console.log("grp",grp)
                    let totPat = 0
                    for (let pat of grp.pat){
                        console.log(">pat",pat)
                        grp.sum.oa += Number(pat.reimbursement)
                        grp.sum.pat += Number(pat.patientIntervention)
                        grp.sum.sup += Number(pat.doctorSupplement)
                        grp.sum.tot += Number(pat.totalAmount)
                        totPat++
                    }
                    // const totEntr = this.localize('entr','Entries',language)
                    // const totWord = this.localize('tot','Total',language)
                    // grp.code = `${grp.code} (${totPat} ${totEntr}), OA : ${grp.sum.oa}€ - Patient : ${grp.sum.pat}€ - Sup : ${grp.sum.sup}€ - ${totWord} : ${grp.sum.tot}€`
                }
            } // provider end

            calculateTotalPendingInvoices(){

                let total = {
                    totalReimbursement :          Number(0.00),
                    totalAmount :                 Number(0.00),
                    totalPatientIntervention :    Number(0.00),
                    totalDoctorSupplement :       Number(0.00),
                }

                this.selectedPendingInvoices.map(invoice => {
                    total.totalReimbursement          += Number(invoice.totalInvoice.reimbursement)
                    total.totalAmount                 += Number(invoice.totalInvoice.totalAmount)
                    total.totalPatientIntervention    += Number(invoice.totalInvoice.patientIntervention)
                    total.totalDoctorSupplement       += Number(invoice.totalInvoice.doctorSupplement)
                })

                this.set('totalPendingInvoices', total)

            }

            _invoicesStatusChanged(){
                this.invoicesStatus === "pending" ? this.set('statusPending', true) : this.set('statusPending', false)
                this.set('processing',this.isProcess())
                this.set('archOrAcc',!(this.isProcess()||this.isReject()))
            }

            messagesByStatus() {
                return this.invoicesStatus === "process" ? this.messagesProcessed :
                    this.invoicesStatus === "accept" ? this.messagesAccepted :
                        this.invoicesStatus === "reject" ? this.messagesRejected : []
            }

            _invoicedAmount() {
                return this.messagesByStatus() ? this._formatAmount( (this.messagesByStatus().reduce((tot, m) => tot + Number(m.messageInfo.invoicedAmount), 0).toFixed(2) ) ) :0
            }

            _acceptedAmount() {
                return this.messagesByStatus() ? this._formatAmount( (this.messagesByStatus().reduce((tot, m) => tot + Number(m.messageInfo.acceptedAmount), 0).toFixed(2) ) ): 0
            }

            _refusedAmount() {
                return this.messagesByStatus() ? this._formatAmount( (this.messagesByStatus().reduce((tot, m) => tot + Number(m.messageInfo.refusedAmount), 0).toFixed(2) ) ) : 0
            }

            _displayInvoiceStatus(status){

               return this.localize(status, this.language)

                //this.shadowRoot.getElementById("batchStatus").classList.add("")
            }

            formatDate(d,f) {
                const input = d.toString()
                const yyyy = input.slice(0,4), mm = input.slice(4,6), dd = input.slice(6,8)
                switch(f) {
                    case 'date' :
                        return `${dd}/${mm}/${yyyy}`;
                    case 'month' :
                        const monthStr =
                            (mm.toString() == '01') ? this.localize('Jan',this.language) :
                            (mm.toString() == '02') ? this.localize('Feb',this.language) :
                            (mm.toString() == '03') ? this.localize('Mar',this.language) :
                            (mm.toString() == '04') ? this.localize('Apr',this.language) :
                            (mm.toString() == '05') ? this.localize('May',this.language) :
                            (mm.toString() == '06') ? this.localize('Jun',this.language) :
                            (mm.toString() == '07') ? this.localize('Jul',this.language) :
                            (mm.toString() == '08') ? this.localize('Aug',this.language) :
                            (mm.toString() == '09') ? this.localize('Sep',this.language) :
                            (mm.toString() == '10') ? this.localize('Oct',this.language) :
                            (mm.toString() == '11') ? this.localize('Nov',this.language) :
                            this.localize('Dec',this.language)
                        return `${monthStr} ${yyyy}`
                }
            }

            _formatAmount(amount){
                return this.findAndReplace(((Number(amount).toFixed(2)).toString()),'.',',')
            }

            findAndReplace(string, target, replacement) {
                for (let i = 0; i < string.length; i++) { string = string.replace(target, replacement); }
                return string;
            }

            refreshFilter(e){
                const param = e.target.getAttribute('param')
                console.log("refresh, param",param)
                const where = this.invoicesStatus // pending, process, reject, accept, archive
                const str =
                    (param == "invoiceGrid") ? this.filterInput:
                    (param == "messagesGrid") ? this.filterInputInvoices :
                    this.selectedInputDetail
                setTimeout(function () {
                    let arrList =
                        (param == "invoiceGrid") ? this.shadowRoot.querySelectorAll("."+param) :
                        (param == "selectedInputDetail") ? this.shadowRoot.querySelectorAll("#invoiceDetailContainer #invoiceGridDetail") :
                        this.shadowRoot.querySelectorAll(".scrollBox")
                    console.log("arrList a",param,arrList)
                    if (param == "messagesGrid") {
                        let temp
                        const selected =
                            (where == "process") ? "processTable" :
                            (where == "reject") ? "rejectedTable" :
                            "archiveAndAccepted"
                        Array.prototype.slice.call(arrList).map(list=> {
                            console.log("list", list)
                            if (list.querySelector("."+selected) ) {
                                temp = list.querySelectorAll("."+selected)
                            }
                        })
                        arrList = temp
                    }
                    console.log("arrList b",param,arrList)
                    Array.prototype.slice.call(arrList).map(table=>{
                        console.log("before exec",str,table)
                        this.executeSearch(str,table)
                    })
                }.bind(this), 500)
            }

            executeSearch(str,param) {
                console.log("exec",str,param)
                const grid = param
                const tbody = grid.shadowRoot.querySelector("#scroller #table tbody")
                const trs = tbody.querySelectorAll("tr")
                console.log("tbody trs",tbody,trs)
                let input = (str.includes(":") ) ? this.treatQuery(str) : str
                input = (this.checkFilters(input)).toString().toLowerCase()
                if (trs.length){
                    let keepList = []
                    Array.prototype.slice.call(trs).map(row=>{
                        let cells = row.querySelectorAll("td"), toHide = true
                        cells.forEach(that=>{
                            const test = (that._content.innerText).toString().toLowerCase()
                            if (test.includes(input)) {
                                toHide = false
                            }
                        })
                        if (toHide) {
                            row.hidden = true
                        } else {
                            keepList.push(row)
                            row.hidden = false
                        }
                    })
                    let showCount = 0
                    keepList.map(showMe=>{
                        showMe.style.transform = "translateY("+ (showCount*48) +"px)"
                        showMe.style.height = "48px"
                        showMe.style.lineHeight = "24px"
                        showCount++
                    })
                } // endif
            }

            _batchDetailDataProvider() {
                return (params, callback) => {
                    const startIndex = params.page * params.pageSize
                    if (!params.parentItem) {
                        this.invoicesFromBatch ? callback(this.invoicesFromBatch.slice(startIndex, startIndex + params.pageSize), this.invoicesFromBatch.length) : callback([], 0)
                    } else {
                        callback(params.parentItem.invoicingCodes.slice(startIndex, startIndex + params.pageSize), params.parentItem.invoicingCodes.length)
                    }
                }
            }

            checkFilters(str) { // will (set the path type for vaadin filter and) format search output
                let searchType = "invoice.patient.firstName"
                let output = str
                if (str.length) {
                    if (!isNaN(str)) { // is a number
                        searchType =
                            (str.toString().length == 11) ? "patient.ssin" : // NISS (length must be 11)
                            (str.length == 8) ? "invoice.invoiceReference" : // bill number
                            (str >= 1930 && str <= (new Date().getFullYear() + 100)) ? "invoice.invoiceDate" : // year (from 1930 to now +100yr)
                            ((typeof str == "float") || str.includes(".")) ? "invoice.totalAmount" : // float amount
                            (str.length == 3 && (100 <= str && str <= 999) ) ? "patient.insurance.code" : // Insurance code
                            "invoice.invoiceReference"
                        // format output ->
                        if (searchType == "patient.ssin") { output = this.findAndReplace(output,'.',''); }
                        if (searchType == "invoice.totalAmount") { output = this.findAndReplace(output.toString(),'.',',') }
                    } else { // is a string
                        searchType =
                            (/(^([0-2][0-9]|(3)[0-1])[.\- /](((0)[0-9])|((1)[0-2]))[.\- /]\d{4}$)/.test(str) || /(^([0-2][0-9]|(3)[0-1])[.\- /](((0)[0-9])|((1)[0-2]))[.\- /]\d{2}$)/.test(str) ) ? "invoice.invoiceDate" :
                            (/(^[0-9]{2}[.\- /]{0,1}[0-9]{2}[.\- /]{0,1}[0-9]{2}[.\- /]{0,1}[0-9]{3}[.\- /]{0,1}[0-9]{2}$)/.test(str)) ? "patient.ssin" :
                            (str.includes(" ") ) ? "invoice.patient.firstName" :
                            (str.includes("€") || str.includes(".") || str.includes(",")) ? "invoice.totalAmount" :
                            "invoice.patient.firstName"
                        // format output ->
                        if (searchType == "invoice.totalAmount") { output = this.findAndReplace(output,'€',''); output = this.findAndReplace(output,'.',','); }
                        if (searchType == "patient.ssin") { output = this.findAndReplace(output,' ',''); output = this.findAndReplace(output,'-',''); output = this.findAndReplace(output,'/',''); output = this.findAndReplace(output,'.',''); }
                        if (searchType == "invoice.invoiceDate") { output = this.fourNumYears(output) }
                    }
                }
                return output
            }
            fourNumYears(input) {
                const aa = input.slice(0,2),bb = input.slice(3,5)
                let cccc = input.slice(6,11)
                cccc = (cccc.toString().length == 2) ? cccc = "20"+cccc : cccc
                return `${aa}/${bb}/${cccc}`
            }
            treatQuery(query) { // mainly used for numbers
                let search = (query.substr(query.indexOf(':')+1, query.length) ).toString()
                search =(search.includes(':')) ? this.findAndReplace(search,':',' ') : search
                return search
            }

            _invoicesChange(){
                this.calculateTotalPendingInvoices()
            }

            sendInvoices(){
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp=> {
                    let prom = Promise.resolve()
                    _.chain(this.selectedPendingInvoices)
                        .groupBy(fact => fact.insuranceParent)
                        .toPairs().value()
                        .forEach(([fedId,invoices]) => {
                            prom = prom.then(() => this.api.message().sendBatch(this.user, hcp, invoices.map(iv=>({invoiceDto:iv.invoice, patientDto:iv.patient})), this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.api.fhc().Efactcontroller()))
                                       .finally(() => this.getMessage())
                        })
                })
            }

            _showPendingDetail(){
                this.$.pendingDetailDialog.open()
            }

            _unlockInvoice(e){
                e.stopPropagation()

                if(e.target.dataset.item){
                    const invoice = JSON.parse(e.target.dataset.item)
                    delete(invoice.printedDate)

                    this.api.invoice().modifyInvoice(invoice).then(() => this.getMessage())
                }
            }

            SEG_getErrSegment_200(zones){
                var erreur = '';

                //Erreur sur le nom du message
                if(zones.find(z => z.zone === "2001") != '00'){
                    if(zones.find(z => z.zone === "2001") == '10'){
                        erreur += 'Nom du message => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2001") == '11'){
                        erreur += 'Nom du message => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "2001") == '20'){
                        erreur += 'Nom du message => Codification inconnue<br>';
                    }else if(zones.find(z => z.zone === "2001") == '21'){
                        erreur += 'Nom du message => Message non autorisé pour cet émetteur<br>';
                    }else if(zones.find(z => z.zone === "2001") == '22'){
                        erreur += 'Nom du message => # de 920000<br>';
                    }
                }

                //Erreur sur le n° de version du message
                if(zones.find(z => z.zone === "2011") != '00'){
                    if(zones.find(z => z.zone === "2011") == '10'){
                        erreur += 'N° version mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2011") == '11'){
                        erreur += 'N° version mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2011") == '20'){
                        erreur += 'N° version mess => N° de version n\'est plus d\'application<br>';
                    }else if(zones.find(z => z.zone === "2011") == '21'){
                        erreur += 'N° version mess => N° de version pas encore d\'application<br>';
                    }else if(zones.find(z => z.zone === "2011") == '30'){
                        erreur += 'N° version mess => N° de version non autorisé pour ce flux<br>';
                    }
                }

                //Erreur sur le type de message
                if(zones.find(z => z.zone === "2021") != '00'){
                    if(zones.find(z => z.zone === "2021") == '10'){
                        erreur += 'Type de mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2021") == '11'){
                        erreur += 'Type de mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2021") == '20'){
                        erreur += 'Type de mess => Valeur non permise<br>';
                    }else if(zones.find(z => z.zone === "2021") == '30'){
                        erreur += 'Type de mess => Message test dans un buffer de production (1er car zone 107 = P)<br>';
                    }else if(zones.find(z => z.zone === "2021") == '31'){
                        erreur += 'Type de mess => Message de production dans un buffer de test (1er car zone 107 = T)<br>';
                    }
                }

                //Erreur sur le statut du message
                if(zones.find(z => z.zone === "2031") != '00'){
                    if(zones.find(z => z.zone === "2031") == '10'){
                        erreur += 'Statut mess => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "2031") == '20'){
                        erreur += 'Statut mess => Valeur non permise<br>';
                    }
                }

                //Erreur sur la référence message institution ou prestataire de soins
                if(zones.find(z => z.zone === "2041") != '00'){
                    if(zones.find(z => z.zone === "2041") == '10'){
                        erreur += 'Réf mess => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2041") == '11'){
                        erreur += 'Réf mess => Erreur format<br>';
                    }
                }

                //Erreur sur la référence message O.A
                if(zones.find(z => z.zone === "2051") != '00'){
                    if(zones.find(z => z.zone === "2051") == '10'){
                        erreur += 'Réf mess OA => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "2051") == '11'){
                        erreur += 'Réf mess OA => Erreur format<br>';
                    }
                }

                return erreur;
            }

            SEG_getErrSegment_300(zones){
                var erreur = '';

                //Erreur sur l'année et le mois de facturation
                if(zones.find(z => z.zone === "3001") != '00'){
                    if(zones.find(z => z.zone === "3001") == '10'){
                        erreur += 'Année mois fact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3001") == '11'){
                        erreur += 'Année mois fact => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3001") == '20'){
                        erreur += 'Année mois fact => Valeur non permise<br>';
                    }
                }

                //Erreur sur le n° d'envoi
                if(zones.find(z => z.zone === "3011") != '00'){
                    if(zones.find(z => z.zone === "3011") == '10'){
                        erreur += 'N° envoi => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3011") == '11'){
                        erreur += 'N° envoi => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3011") == '40'){
                        erreur += 'N° envoi => Signalisation de double fichier de facturation transmis<br>';
                    }
                }

                //Erreur sur la date de création de la facture
                if(zones.find(z => z.zone === "3021") != '00'){
                    if(zones.find(z => z.zone === "3021") == '10'){
                        erreur += 'Date création facture => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3021") == '11'){
                        erreur += 'Date création facture => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3021") == '20'){
                        erreur += 'Date création facture => Date > date du jour<br>';
                    }else if(zones.find(z => z.zone === "3021") == '21'){
                        erreur += 'Date création facture => Date invraisemblable ( date < 01/01/2002)<br>';
                    }
                }


                //Erreur sur le n° de version des instruction
                if(zones.find(z => z.zone === "3041") != '00'){
                    if(zones.find(z => z.zone === "3041") == '10'){
                        erreur += 'N° version instruction => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3041") == '11'){
                        erreur += 'N° version instruction => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3041") == '20'){
                        erreur += 'N° version instruction => Valeur non permise<br>';
                    }else if(zones.find(z => z.zone === "3041") == '21'){
                        erreur += 'N° version instruction => Incompatibilité avec valeur reprise en zone 202<br>';
                    }
                }

                //Erreur sur le nom de la personne de contact
                if(zones.find(z => z.zone === "3051") != '00'){
                    if(zones.find(z => z.zone === "3051") == '10'){
                        erreur += 'Nom personne de contact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3051") == '11'){
                        erreur += 'Nom personne de contact => Erreur format<br>';
                    }
                }

                //Erreur sur le prenom de la personne de contact
                if(zones.find(z => z.zone === "3061") != '00'){
                    if(zones.find(z => z.zone === "3061") == '10'){
                        erreur += 'Prénom personne de contact => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3061") == '11'){
                        erreur += 'Prénom personne de contact => Erreur format<br>';
                    }
                }

                //Erreru sur le n° de tel de contact
                if(zones.find(z => z.zone === "3071") != '00'){
                    if(zones.find(z => z.zone === "3071") == '10'){
                        erreur += 'N° téléphone => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3071") == '11'){
                        erreur += 'N° téléphone => Erreur format<br>';
                    }
                }

                //Erreur sur le type de la facture
                if(zones.find(z => z.zone === "3081") != '00'){
                    if(zones.find(z => z.zone === "3081") == '10'){
                        erreur += 'Type de la facture => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3081") == '11'){
                        erreur += 'Type de la facture => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3081") == '20'){
                        erreur += 'Type de la facture => Valeur non permise en fonction du secteur qui émet la facturation';
                    }
                }

                //Erreur sur le type de facturation
                if(zones.find(z => z.zone === "3091") != '00'){
                    if(zones.find(z => z.zone === "3091") == '10'){
                        erreur += 'Type de facturation => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "3091") == '11'){
                        erreur += 'Type de facturation => Erreur format<br>';
                    }else if(zones.find(z => z.zone === "3091") == '20'){
                        erreur += 'Type de facturation => Valeur non permise en fonction du secteur qui émet la facturation';
                    }else if(zones.find(z => z.zone === "3091") == '30'){
                        erreur += 'Type de facturation => Valeur # de 1 ou 2 alors que la zone 308 = 3';
                    }
                }

                return erreur;

            }

            SEG_getErrSegment_400(zones){
                var erreur = '';

                //Erreur sur le type de record
                if(zones.find(z => z.zone === "4001") != '00'){
                    if(zones.find(z => z.zone === "4001") == '10'){
                        erreur +='Type de record => Zone obligatoire<br>';
                    }else if(zones.find(z => z.zone === "4001") == '11'){
                        erreur += 'Type de record => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4001") == '20'){
                        erreur += 'Type de record => Valeur non permise<br>';
                    }
                }

                //Erreur sur le num de mut
                if(zones.find(z => z.zone === "4011") != '00'){
                    if(zones.find(z => z.zone === "4011") == '10'){
                        erreur += 'N° de mutualité => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4011") == '11'){
                        erreur +='N° de mutualité => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4011") == '20'){
                        erreur +='N° de mutualité => Numéro inconnu ou codification erronée<br>';
                    }else if(zones.find(z => z.zone === "4011") == '21'){
                        erreur += 'N° de mutualité => N° de mutualité non retrouvé dans le détail de la facturation<br>';
                    }
                }

                //Erreur sur le num fact
                if(zones.find(z => z.zone === "4021") != '00'){
                    if(zones.find(z => z.zone === "4021") == '10'){
                        erreur +='N° de facture récapitulative => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4021") == '11'){
                        erreur += 'N° de facture récapitulative => Erreur de format<br>';
                    }
                }

                //Erreur sur le signe montant a ou montant demande a
                if(zones.find(z => z.zone === "4041") != '00'){
                    if(zones.find(z => z.zone === "4041") == '11'){
                        erreur += 'Montant demandé cpt a => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4041") == '40'){
                        erreur += 'Montant demandé cpt a => Erreur code signe (# de + ou -)<br>';
                    }else if(zones.find(z => z.zone === "4041") == '41'){
                        erreur +='Montant demandé cpt a => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "4041") == '20'){
                        erreur += 'Montant demandé cpt a => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant b ou montant demande b
                if(zones.find(z => z.zone === "4061") != '00'){
                    if(zones.find(z => z.zone === "4061") == '11'){
                        erreur += 'Montant demandé cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4061") == '15'){
                        erreur +='Montant demandé cpt b => Zone # de 0 si l\'émetteur n\est pas une institution hospitalière - Zone signe # de «blanc» et émetteur de la facturation # d’une institution hospitalière<br>';
                    }else if(zones.find(z => z.zone === "4061") == '40'){
                        erreur +='Montant demandé cpt b => Erreur code signe (# de + ou -)';
                    }else if(zones.find(z => z.zone === "4061") == '41'){
                        erreur +='Montant demandé cpt b => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "4061") == '20'){
                        erreur +='Montant demandé cpt b => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant a + b ou montant demande a + b
                if(zones.find(z => z.zone === "4081") != '00'){
                    if(zones.find(z => z.zone === "4081") == '11'){
                        erreur +='Total montant demandés cpt a + cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4081") == '20'){
                        erreur +='Total montant demandé cpt a + cpt b => Montant # somme des montants cpt a et cpt b<br>';
                    }else if(zones.find(z => z.zone === "4081") == '40'){
                        erreur +='Total montant demandé cpt a + cpt b => Erreur code signe (# de + ou -)<br>';
                    }
                }

                //Erreur sur le nb d'enreg
                if(zones.find(z => z.zone === "4091") != '00'){
                    if(zones.find(z => z.zone === "4091") == '10'){
                        erreur += 'Nb de records détail => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "4091") == '11'){
                        erreur +='Nb de records détail => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "4091") == '20'){
                        erreur += 'Nb de records détail => Somme erronée<br>';
                    }
                }

                //Erreur sur le num de controle par mutualite si 95 ou num de controle de l'envoi si 96
                if(zones.find(z => z.zone === "4101") != '00'){
                    if(zones.find(z => z.zone === "400") == '95'){
                        if(zones.find(z => z.zone === "4101") == '10'){
                            erreur += 'N° de contrôle par mutualité => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "4101") == '11'){
                            erreur +='N° de contrôle par mutualité => Erreur de format<br>';
                        }
                    }else if(zones.find(z => z.zone === "400") == '96'){
                        if(zones.find(z => z.zone === "4101") == '10'){
                            erreur += 'N° de contrôle de l\'envoi => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "4101") == '11'){
                            erreur +='N° de contrôle de l\'envoi => Erreur de format<br>';
                        }
                    }
                }

                return erreur;
            }

            SEG_getErrSegment_500(zones){
                var erreur = '';

                //Erreur sur le type de record
                if(zones.find(z => z.zone === "5001") != '00'){
                    if(zones.find(z => z.zone === "5001") == '10'){
                        erreur +='Type de record => Zone obligatoire<br>';
                    }else if(zones.find(z => z.zone === "5001") == '11'){
                        erreur += 'Type de record => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5001") == '20'){
                        erreur += 'Type de record => Valeur non permise<br>';
                    }
                }

                //Erreur sur le num de mut
                if(zones.find(z => z.zone === "5011") != '00'){
                    if(zones.find(z => z.zone === "5011") == '10'){
                        erreur += 'N° de mutualité => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5011") == '11'){
                        erreur +='N° de mutualité => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5011") == '20'){
                        erreur +='N° de mutualité => Numéro inconnu ou codification erronée<br>';
                    }else if(zones.find(z => z.zone === "5011") == '21'){
                        erreur += 'N° de mutualité => N° de mutualité non retrouvé dans le détail de la facturation<br>';
                    }
                }

                //Erreur sur le num fact
                if(zones.find(z => z.zone === "5021") != '00'){
                    if(zones.find(z => z.zone === "5021") == '10'){
                        erreur +='N° de facture récapitulative => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5021") == '11'){
                        erreur += 'N° de facture récapitulative => Erreur de format<br>';
                    }
                }

                //Erreur sur le signe montant a ou montant demande a
                if(zones.find(z => z.zone === "5041") != '00'){
                    if(zones.find(z => z.zone === "5041") == '11'){
                        erreur += 'Montant demandé cpt a => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5041") == '40'){
                        erreur += 'Montant demandé cpt a => Erreur code signe (# de + ou -)<br>';
                    }else if(zones.find(z => z.zone === "5041") == '41'){
                        erreur +='Montant demandé cpt a => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "5041") == '20'){
                        erreur += 'Montant demandé cpt a => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant b ou montant demande b
                if(zones.find(z => z.zone === "5061") != '00'){
                    if(zones.find(z => z.zone === "5061") == '11'){
                        erreur += 'Montant demandé cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5061") == '15'){
                        erreur +='Montant demandé cpt b => Zone # de 0 si l\'émetteur n\est pas une institution hospitalière - Zone signe # de «blanc» et émetteur de la facturation # d’une institution hospitalière<br>';
                    }else if(zones.find(z => z.zone === "5061") == '40'){
                        erreur +='Montant demandé cpt b => Erreur code signe (# de + ou -)';
                    }else if(zones.find(z => z.zone === "5061") == '41'){
                        erreur +='Montant demandé cpt b => Discordance entre montant ci-mentionné et total du fichier facturation pour la mutualité<br>';
                    }else if(zones.find(z => z.zone === "5061") == '20'){
                        erreur +='Montant demandé cpt b => Somme erronée<br>';
                    }
                }

                //Erreur sur le signe montant a + b ou montant demande a + b
                if(zones.find(z => z.zone === "5081") != '00'){
                    if(zones.find(z => z.zone === "5081") == '11'){
                        erreur +='Total montant demandés cpt a + cpt b => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5081") == '20'){
                        erreur +='Total montant demandé cpt a + cpt b => Montant # somme des montants cpt a et cpt b<br>';
                    }else if(zones.find(z => z.zone === "5081") == '40'){
                        erreur +='Total montant demandé cpt a + cpt b => Erreur code signe (# de + ou -)<br>';
                    }
                }

                //Erreur sur le nb d'enreg
                if(zones.find(z => z.zone === "5091") != '00'){
                    if(zones.find(z => z.zone === "5091") == '10'){
                        erreur += 'Nb de records détail => Zone obligatoire non complétée<br>';
                    }else if(zones.find(z => z.zone === "5091") == '11'){
                        erreur +='Nb de records détail => Erreur de format<br>';
                    }else if(zones.find(z => z.zone === "5091") == '20'){
                        erreur += 'Nb de records détail => Somme erronée<br>';
                    }
                }

                //Erreur sur le num de controle par mutualite si 95 ou num de controle de l'envoi si 96
                if(zones.find(z => z.zone === "5101") != '00'){
                    if(zones.find(z => z.zone === "500" === '95')){
                        if(zones.find(z => z.zone === "5101") == '10'){
                            erreur += 'N° de contrôle par mutualité => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "5101") == '11'){
                            erreur +='N° de contrôle par mutualité => Erreur de format<br>';
                        }
                    }else if(zones.find(z => z.zone === "500" === '96')){
                        if(zones.find(z => z.zone === "5101") == '10'){
                            erreur += 'N° de contrôle de l\'envoi => zone obligaoire non complétée<br>';
                        }else if(zones.find(z => z.zone === "5101") == '11'){
                            erreur +='N° de contrôle de l\'envoi => Erreur de format<br>';
                        }
                    }
                }

                return erreur;
            }


            _showDetail() {

                if (this.activeGridItem && this.activeGridItem.message){
                    this.shadowRoot.getElementById("messagesGridContainer").classList.add("half")
                    this.shadowRoot.getElementById("invoiceDetailContainer").classList.add("open")

                    const invoiceIds = this.activeGridItem.message.invoiceIds

                    this.api.invoice().getInvoices(new models.ListOfIdsDto({ids: invoiceIds.map(i => i)}))
                        .then(invoices => Promise.all(invoices.map(inv => this.api.crypto().extractCryptedFKs(inv, this.user.healthcarePartyId).then(ids => [inv, ids[0]]))))
                        .then(invAndIdsPat =>
                            this.api.patient().getPatients(new models.ListOfIdsDto({ids: _.uniq(invAndIdsPat.map(x => x[1]))})).then(pats => invAndIdsPat.map(it => [it[0], pats.find(p => p.id === it[1])]))
                        )
                        .then(invAndPats => invAndPats.map( ([inv, pat]) => ({
                            invoiceReference: inv.invoiceReference,
                            patient: pat.lastName + " " + pat.firstName,
                            ssin: pat.ssin,
                            invoiceDate: inv.invoiceDate,
                            invoicedAmount: inv.invoicingCodes.reduce((t,c) => t + (c.reimbursement || 0), 0),
                            acceptedAmount: inv.invoicingCodes.reduce((t,c) => t + (c.reimbursement || 0), 0),
                            refusedAmount: 0.00,
                            rejectionReason: inv.error,
                            paid: false,
                            status: "",
                            invoice: inv,
                            invoicingCodes: inv.invoicingCodes.map(code => ({
                                invoicingCode: code.code,
                                invoiceDate: code.dateCode,
                                invoicedAmount: code.reimbursement,
                                acceptedAmount: code.reimbursement,
                                refusedAmount: 0.00,
                                rejectionReason: code.error,
                                paid: false,
                                status: ""
                            }))
                        })))
                        .then(infos => this.set('invoicesFromBatch', infos))
                        .then(() => this.api.message().getChildren(this.activeGridItem.message.id))
                        .then((msgs) => Promise.all(_.map(msgs.filter(m => m.subject && ['920999','920099', '920098', '920900'].includes(m.subject.substr(0,6))), (msg => this.api.document().findByMessage(this.user.healthcarePartyId, msg)))))
                        .then((docs) => Promise.all(_.flatMap(docs).filter(d => !_.endsWith(d.name, '_parsed_records') && _.endsWith(d.name, '_records') && d.mainUti === "public.json").map(d => this.api.document().getAttachment(d.id, d.attachmentId))))
                        .then((attachs) => {
                            attachs.forEach( a => {

                                if (typeof a === "string"){
                                    try { a = JSON.parse( this.cleanStringForJsonParsing(a) ) } catch (ignored) {}
                                } else if (typeof a === "object") {
                                    try { a = JSON.parse( this.cleanStringForJsonParsing(new Uint8Array(a).reduce((data, byte) => data + String.fromCharCode(byte), ''))); } catch (ignored) {}
                                }

                                const zone200 = a.message && a.message.find(enr => enr.zones.find(z => z.zone == "200"))
                                const zone300 = a.message && a.message.find(enr => enr.zones.find(z => z.zone == "300"))
                                const zone400 = a.message && a.message.find(enr => enr.zones.find(z => z.zone == "400"))
                                const zone500 = a.message && a.message.find(enr => enr.zones.find(z => z.zone == "500"))

                                let globalError = _.uniq([zone200 && this.SEG_getErrSegment_200(zone200.zones || []),
                                    zone300 && this.SEG_getErrSegment_300(zone300.zones || []),
                                    zone400 && this.SEG_getErrSegment_400(zone400.zones || []),
                                    zone500 && this.SEG_getErrSegment_500(zone500.zones || [])])

                            })
                        })

                } else {
                    this.shadowRoot.getElementById("messagesGridContainer").classList.remove("half")
                    this.shadowRoot.getElementById("invoiceDetailContainer").classList.remove("open")
                }
            }

            _openHelpDeskDialogSupp(e){
                e.stopPropagation();
                this.set("infoHelpdesk",JSON.parse(e.target.dataset.item))
                this.set("isCompleteHelpDesk",false)
                this.set("mobile",this.hcp.addresses[0].telecoms.find(tel => tel.telecomType==='mobile').telecomNumber)

                this.$["helpdeskInfoDialog"].open()
            }

            _openHelpDeskDialogDet(e){
                e.stopPropagation();
                this.set("infoHelpdesk", this.activeGridItem)
                this.set("isCompleteHelpDesk",true)
                this.set("infoHelpdeskDet",JSON.parse(e.target.dataset.item))
                this.set("mobile",this.hcp.addresses[0].telecoms.find(tel => tel.telecomType==='mobile').telecomNumber)

                this.$["helpdeskInfoDialog"].open()
            }

            receiveInvoices() {
                this.api.fhc().Efactcontroller().loadMessagesUsingGET(this.hcp.nihii, this.language, this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.hcp.ssin, this.hcp.firstName, this.hcp.lastName).then( x => this.api.logMcn(x, this.user, this.hcp.id, "eFact", "loadMessages") ).then(response => {
                    let prom = Promise.resolve()
                    response.forEach(message => {
                        // console.log(message)

                        prom = prom.then(() =>
                            new Promise((resolve) => {
                                if (message.detail) {
                                    this.api.message().processEfactMessage(this.user, this.hcp, message, this.api.document())
                                        .then(msg => msg ? resolve(message) : resolve())
                                        .catch(e => {
                                            // console.log(e)
                                            resolve()
                                        })
                                } else if (message.tack) {
                                    this.api.message().processTack(this.user, this.hcp, message)
                                        .then(rcpt => rcpt ? resolve(message) : resolve())
                                        .catch(e => {
                                            // console.log(e)
                                            resolve()
                                        })
                                }
                            })
                        )
                    })
/*
                    prom = prom.then(treatedMessages => {
                        let sprom = Promise.resolve()
                        _.chunk(treatedMessages, 20).forEach(chunk => {
                            const tacks = chunk.filter(x => x && x.tack)
                            const responses = chunk.filter(x => x && x.detail)

                            sprom = sprom
                                .then(() =>this.api.fhc().Efactcontroller().confirmAcksUsingPUT(this.hcp.nihii, this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.hcp.ssin, this.hcp.firstName, this.hcp.lastName, tacks.map(t => t.hashValue)))
                                .then(() => this.api.fhc().Efactcontroller().confirmMessagesUsingPUT(this.hcp.nihii, this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, this.hcp.ssin, this.hcp.firstName, this.hcp.lastName, responses.map(t => t.hashValue)))
                        })
                        return sprom
                    })*/
                }).finally(() => this.getMessage())
            }

            _dateFormat(date) {
                return date ? this.api.moment(date).format('DD/MM/YYYY') : '';
            }

            isProcess(){
                return this.invoicesStatus === "process"
            }

            isReject(){
                return this.invoicesStatus === "reject"
            }

            isArchOrAcc(){
                return !(this.invoicesStatus === "reject" || this.invoicesStatus === "process")

            }

            initializeBatchCounter(processedCounter, accpetedCounter, rejectedCounter){
                this.dispatchEvent(new CustomEvent('initialize-batch-counter', { bubbles: true, composed: true, detail: { pending: this.selectedPendingInvoices.length ? this.selectedPendingInvoices.length : 0, processing: processedCounter, rejected: rejectedCounter, accepted: accpetedCounter, archived: 0} }));
            }

            _getIconStatusClass(status) {
                console.log("geticonstatus",status)
                return (status == this.localize('inv_acc_tre','Accepted for treatment',this.language)) ? "invoice-status--blueStatus" :
                    (status == this.localize('inv_pen','Pending',this.language)) ? (!this.statusPending)  ? "invoice-status--blueStatus" : "invoice-status--orangeStatus" :
                    (status == this.localize('inv_par_acc','Partially accepted',this.language)) ? "invoice-status--orangeStatus" :
                    (status == this.localize('inv_full_acc','Fully accepted',this.language)) ? "invoice-status--greenStatus" :
                    (status == this.localize('inv_tre','Treated',this.language)) ? "invoice-status--greenStatus" :
                    (status == this.localize('inv_acc_tre','Accepted for treatment',this.language)) ? "invoice-status--blueStatus" :
                    (status == this.localize('inv_err','Error',this.language)) ? "invoice-status--redStatus" :
                    ""
            }
            _getTxtStatusColor(status,amount) {
                console.log("gettxtstatus",status,amount)
                if (amount > 0) {
                    return (status == this.localize('inv_par_acc','Partially accepted',this.language)) ? "txtcolor--orangeStatus" :
                    (status == this.localize('inv_full_acc','Fully accepted',this.language)) ? "txtcolor--greenStatus" :
                    (status == this.localize('inv_acc_tre','Accepted for treatment',this.language)) ? "txtcolor--blueStatus" :
                    (status == this.localize('inv_tre','Treated',this.language)) ? "txtcolor--greenStatus" :
                    (status == this.localize('inv_err','Error',this.language)) ? "txtcolor--redStatus" :
                    ""
                }
            }

            _isStatus(status,test) {
                return status == test
            }

            cleanStringForJsonParsing(inputValue) {
                return inputValue
                    .replace(/\\n/g, "\\n")
                    .replace(/\\'/g, "\\'")
                    .replace(/\\"/g, '\\"')
                    .replace(/\\&/g, "\\&")
                    .replace(/\\r/g, "\\r")
                    .replace(/\\t/g, "\\t")
                    .replace(/\\b/g, "\\b")
                    .replace(/\\f/g, "\\f")
                    .replace(/[\u0000-\u0019]+/g,"")
            }

        }

        customElements.define(HtMsgInvoice.is, HtMsgInvoice);
    </script>
</dom-module>
