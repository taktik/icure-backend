<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">



<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">


<link rel="import" href="../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../filter-panel/filter-panel.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="../dynamic-form/dynamic-doc.html">
<link rel="import" href="../dynamic-form/entity-selector.html">



<dom-module id="ht-msg-detail">
	<template>
		<style>
			.notification-panel {
				position: fixed;
				top:50%;
				right: 0;
				z-index:1000;
				color: white;
				font-size: 13px;
				background: rgba(255, 0, 0, 0.55);
				height: 96px;
				padding: 0 8px 0 12px;
				border-radius: 3px 0 0 3px;
				overflow: hidden;
				white-space: nowrap;
				width: 0;
				opacity: 0;
			}

			.notification {
				animation: notificationAnim 7.5s ease-in;
			}

			@keyframes notificationAnim {
				0%{
					width: 0;
					opacity: 0;
				}
				5%{
					width: 440px;
					opacity: 1;
				}
				7%{
					width: 420px;
					opacity: 1;
				}
				95%{
					width: 420px;
					opacity: 1;
				}
				100%{
					width: 0;
					opacity: 0;
				}
			}

			.prescription-progress-bar {
				width: calc( 100% - 40px );
			}

			.details-panel {
				box-sizing: border-box;
				grid-column: 3 / span 1;
				grid-row: 1 / span 1;
				background:var(--app-background-color-light);
				float:left;
				padding:5px;
				display:flex;
				flex-flow: column nowrap;
				align-items: flex-start;
				z-index:0;
				height: 100%;
				width: 100%;
			}

			.contact-title{
				display:block;
				@apply --paper-font-body2;
				@apply --padding-32;
				padding-bottom:8px;
				padding-top: 32px;
			}
			/*.contact-title:first-child{
				padding-top:0;
			}*/
			.pat-details-card > .card-content {
				padding: 16px 16px 32px !important;
			}

			.pat-details-card {
				width: 100%;
				padding: 10px 15px;
				height: 100%;
			}

			.horizontal {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				flex-basis: 100%;
			}

			.justified {
				justify-content: space-between;
			}

			.pat-details-input {
				flex-grow: 1;
				margin: 16px;
			}

			input {
				border: none;
				width: 100%;
			}

			paper-dialog {
				margin: 0;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

			paper-dialog {
				min-width:30%;
			}

			.extra-info{
				color:var(--app-text-color-disabled);
				font-style: italic;
				font-size: 80%;
			}

			vaadin-upload{
				margin:16px;
				min-height:280px;
				background: var(--app-background-color);
				--vaadin-upload-buttons-primary: {
					padding:16px;
				};
				--vaadin-upload-button-add: {
					background: var(--app-secondary-color);
					color:var(--app-text-color);
				};
				--vaadin-upload-file-progress: {
					--paper-progress-active-color:var(--app-secondary-color);
				};
				--vaadin-upload-file-commands: {
					color: var(--app-primary-color);
				}

			}

			.close-button-icon{
				position: absolute;
				top: 0;
				right: 0;
				margin: 0;
				transform: translate(50%, -50%);
				height: 32px;
				width: 32px;
				padding: 8px;
				background: var(--app-primary-color);
			}

			paper-dialog {
				width: 80%;
			}

			vaadin-grid {
				height:100%;
				--vaadin-grid-body-row-hover-cell: {
					/* background-color: var(--app-primary-color); */
					color: white;
				};
				--vaadin-grid-body-row-selected-cell: {
					background-color: var(--app-primary-color);
					color: white;
				};
			}

			paper-input{
				--paper-input-container-focus-color: var(--app-primary-color);
			}

			.modal-title{
				background:  var(--app-background-color-dark);
				margin-top: 0;
				padding: 16px 24px;
			}

			.modal-subtitle{
				display: inline-flex;
				margin-top: 16px;
			}

			.modal-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				color: var(--app-text-color);
				font-weight: 400;
				font-size: 14px;
				height: 40px;
				min-width: 100px;
				padding: 10px 1.2em;
			}

			.modal-button--save{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-secondary-color);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}

			.modal-button--delete{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-background-color-light);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}

			filter-panel{
				flex-grow: 9;
				/* --panel-width: 60%; */
			}

			.layout-bar{
				flex-grow: 1;
				display: inline-flex;
				flex-flow: row nowrap;
				align-items: center;
				justify-content: space-around;
				height:48px;
				background: var(--app-secondary-color);
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.layout-bar .list, .layout-bar .graphique, .layout-bar .doc{
				height: 32px;
				width: 32px;
				padding: 5px;
				color: var(--app-primary-color-dark);
			}

			.layout-bar .table{
				height: 30px;
				width: 30px;
				padding: 0;
				color: var(--app-primary-color-dark);
			}

			.floating-action-bar{
				display: flex;
				position: absolute;
				height: 40px;
				bottom: 16px;
				background: var(--app-secondary-color);
				border-radius: 3px;
				grid-column: 3/3;
				grid-row: 1/1;
				z-index: 1000;
				left: 50%;
				transform: translate(-50%, 0);
				box-shadow: var(--app-shadow-elevation-2);
			}

			.add-forms-container {
				position: absolute;
				bottom: 48px;
				left: 0;
				background-color: var(--app-background-color-light);
				opacity: .8;
				padding: 8px 0;
				border-radius: 2px;
				max-width: 253px;
			}
			.floating-action-bar paper-fab-speed-dial-action {
				--paper-fab-speed-dial-action-label-background: transparent;
				--paper-fab-iron-icon: {
					transform: scale(0.8);

				};
				--paper-fab: {
					background: var(--app-primary-color-dark);
				}
			}

			.floating-action-bar paper-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				background: var(--app-secondary-color);
				color: var(--app-text-color);
				font-weight: bold;
				font-size: 12px;
				height: 40px;
				min-width: 130px;
				padding: 10px 1.2em;
				border-radius: 0;
				margin:0;
			}

			.floating-action-bar paper-button:hover{
				background: var(--app-dark-color-faded);
    			transition: var(--transition_-_transition);
			}

			.floating-action-bar paper-button:not(:first-child){
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.close-add-forms-btn{
				background: var(--app-secondary-color-dark) !important;
			}

			.floating-action-bar iron-icon{
				box-sizing: border-box;
				padding: 2px;
				margin-right: 8px;
			}

			.horizontal{
				flex-flow: row nowrap;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

			.del-button {
				height: 5vh;
				margin-top: 15px;
			}

		</style>
		<template is="dom-if" if="[[messages]]">
			<div class="details-panel" on-dragover="_onDrag">
					<template is="dom-repeat" items="[[messages]]" as="msg">
						<div class="details-panel" style=" overflow:auto;">
							<paper-card class="pat-details-card" >
								<paper-input readonly value="From : [[msg.fromAddress]]"></paper-input>
								<paper-input readonly value="To : [[msg.toAddresses]]"></paper-input>
								<paper-input readonly value="Subject: [[msg.subject]]"></paper-input>
                                <paper-input readonly value="Date: [[_timeFormat(msg.received)]]"></paper-input>

								<template is="dom-if" if="[[msg.body]]">
									<iron-autogrow-textarea style="min-height: 80px; width: 100%;" readonly placeholder="no content" value="[[msg.body]]"></iron-autogrow-textarea>
								</template>

								<template is="dom-repeat" items="[[selectedDocuments]]">
									<template is="dom-if" if="[[!_isEqualTo(item.documentLocation,'body')]]">
									<paper-card>
											<span>[[item.name]]</span>
											<a href="[[item.dataUrl]]" target="_blank">[[localize('dl','Download',language)]]</a>
											<template is="dom-if" if="[[_imageMimeType(item.mainUti, item.otherUtis.*, item.dataUrl)]]" >
												<div class="img-container">
													<img src$="[[item.dataUrl]]">
												</div>
											</template>
											<template is="dom-if" if="[[_pdfMimeType(item.mainUti, item.otherUtis.*, item.dataUrl)]]">
												<pdf-element src="[[item.dataUrl]]" elevation="5" downloadable height="900" fit-width enable-text-selection></pdf-element>
											</template>
											<template is="dom-if" if="[[_xmlMimeType(item.mainUti, item.otherUtis.*, item.dataUrl)]]">
												<span> <iron-icon class="iron-icon" icon="home"></iron-icon> [[item.name]] [[mimeType(item.mainUti)]] [[type]]</span>
												<vaadin-button id="todayButton" part="today-button" on-tap="_getAttachment">details</vaadin-button>
												<vaadin-button id="todayButton" part="today-button" on-tap="importPatient">import</vaadin-button>
											</template>
									</paper-card>
									</template>
								</template>

								<!--<template is="dom-if" if="[[msg.annex.length]]">-->
									<!--<vaadin-grid id="msgAnnexesList" items="[[msg.annex]]">-->
										<!--<vaadin-grid-column>-->
											<!--<template class="header">-->
												<!--<div>Name</div>-->
											<!--</template>-->
											<!--<template>-->
												<!--<div class="cell frozen">[[item.name]]</div>-->
											<!--</template>-->
										<!--</vaadin-grid-column>-->
									<!--</vaadin-grid>-->
								<!--</template>-->

								<div class="del-button">
									<div>
										<paper-button class="modal-button--delete" on-tap="_removeMsg"><iron-icon icon="delete-forever"></iron-icon>[[localize('del','Delete',language)]]</paper-button>
									</div>
								</div>
							</paper-card>
						</div>
					</template>
			</div>
		</template>

	</template>
	<script>

import jsPDF from 'jspdf/dist/jspdf.min';
import _ from 'lodash/lodash';
import JsBarcode from 'JsBarcode';
import moment from 'moment/src/moment';
import XML from 'parse-xml/dist/parse-xml';

class HtMsgDetail extends Polymer.TkLocalizerMixin(Polymer.Element) {
	static get is() {
		return 'ht-msg-detail';
	}

	static get properties() {
		return {
			contacts: {
				type: Array,
				value: function () {
					return [];
				}
			},
			api: {
				type: Object
			},
			user: {
				type: Object
			},
			credentials:{
				type: Object
			},
			currentContact: {
				type: Object,
				value: null
			},
            selectMessage: {
			    type: Object
			},
			messages: {
			    type: Object,
				value: null
			},
			newMessage:{
				type:Object,
				value: null
			},
			msgAnnexes:{
				type:Array,
				value: []
			},
			selectedDocuments:{
				type: Object
			},
			searchValue:{
				type: String,
				value: '',
				observer: '_FindParty'
			},
			test:{
				type: Array,
				value: []
			},
			msgBodyFile:{
				type:Object
			},
			dataUrls:{
				type: [],
				value: []
			},
			types:{
				type:[],
				value: []
			}
		};
	}

	static get observers() {
		return ['_focusChanged(selectMessage, selectMessage.*)'];
	}

	constructor() {
		super();
	}

	ready(){
		super.ready();
	}

    _focusChanged(){
	    if(this.selectMessage.selection.item){
            this.selectMessage.selection.item.body = [];
	        let tempSelect = this.selectMessage.selection.item;
        	this.api.document().findByMessage(this.user.healthcarePartyId, tempSelect)
				.then(docs => {
				if(docs.length) {
					return docs.filter(doc => doc.id && doc.attachmentId && doc.secretForeignKeys).map(doc =>
						this.api.document().getAttachment(doc.id, doc.attachmentId, doc.secretForeignKeys).then(a =>
							this.getDataUrls(doc)
								.then(dataUrl => {
									doc.dataUrl = dataUrl;
									if(this._isEqualTo(doc.documentLocation,'body')) tempSelect.body = a;
									return doc
								})
						)
					)
				}

	    	}).then(docs =>{
	    		if(docs && docs.length){
                    Promise.all(docs).then(docs=>{
                        this.set('messages', [tempSelect])
                        this.set("selectedDocuments", docs);
                        this.getChildren(tempSelect.id)
                    })
				}
				else{
					this.set('messages', [tempSelect])
					this.set("selectedDocuments", []);
					this.getChildren(tempSelect.id)
                }
            })
	    }else{
			this.set('messages', null);
		}
	}

	getChildren(item){
        this.api.message().getChildren(item).then(function(m) {
			if(m.length){
                m.map(r => r.body = []);
                this.api.document().findByMessage(this.user.healthcarePartyId, m).then(docs => {
                    docs.length?
                    	docs.map(doc => this.api.document().getAttachment(doc.id,doc.attachmentId, doc.secretForeignKeys).then(a => {m.map(r => {r.body.push(a);this.messages.push(r)});}))
						:m.map(r => this.messages.push(r));
                    this.set('messages',this.messages)
                    m.map(r => this.getChildren(r));
                })
			}
        }.bind(this))
	}

	getDataUrls(doc){
		return this.api.crypto().decryptAndImportAesHcPartyKeysInDelegations(this.user.healthcarePartyId, doc.encryptionKeys && Object.keys(doc.encryptionKeys).length ? doc.encryptionKeys : doc.delegations)
					.then(decryptedAndImportedAesHcPartyKeys => {
						let collatedAesKeys = {};
						decryptedAndImportedAesHcPartyKeys.forEach(k => collatedAesKeys[k.delegatorId] = k.key);
						return this.api.crypto().decryptDelegationsSFKs((doc.encryptionKeys && Object.keys(doc.encryptionKeys).length? doc.encryptionKeys: doc.delegations)[this.user.healthcarePartyId], collatedAesKeys, doc.id)
							.then(enckeys =>
								this._xmlMimeType(doc.mainUti, doc.otherUtis, this.dataUrl)?
									this.api.document().getAttachment(doc.id, doc.attachmentId, enckeys).then(att => {
										let xml = XML.parseXml(att);
										if(xml.kmehrmessage){this.set("type",xml.kmehrmessage.header.standard.specialisation.cd.S);}else{this.set("type","Non Valid Type")}
									})
									: (doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, enckeys))
							);
					})
	}

	msgAnnexesFileInputSelected() {

		let msgAnnexesFileInput = this.shadowRoot.querySelector('#msgAnnexesFileInput');

		if( msgAnnexesFileInput.inputElement && msgAnnexesFileInput.inputElement.inputElement){
			Object.values(msgAnnexesFileInput.inputElement.inputElement.files).forEach( item => this.push('msgAnnexes',item))
		}

		//Clear control
		msgAnnexesFileInput.value = '';

		console.log(this.msgAnnexes);
	}

	_removeMsgAnnexe(e){

		let index = e.target.getAttribute('indexed');
		this.msgAnnexes.splice(index,1);

		let msgAnnexesList = this.shadowRoot.querySelector('#msgAnnexesList')
		msgAnnexesList.clearCache();
	}

	_removeMsg(e){
		let msgId = e.target.getAttribute('msgId');
		console.log(msgId);

		this.set('messages', null);

		this.api.message().deleteMessages(msgId)
			.then(x =>
				this.dispatchEvent(new CustomEvent('refresh-list', { detail: { selection: { item: "Refresh" } } }))
			)
	}

	// _FindParty() {
	// 	this.set("test", this.api.hcparty().findByName("cÃ©dr", keyPair.startKey || null, keyPair.startKeyDocId || null, count, desc).map(x=>x.nihi));
	// 	console.log(this.test);
	// }

	_SendNewMessage(){

	}

	_imageMimeType(uti, utis, dataUrl) {
		console.log(uti + " " + utis + " " + dataUrl);
		return dataUrl && (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m && (m.startsWith('image/') || m === 'public/jpeg'));
	}

	_pdfMimeType(uti, utis, dataUrl) {
		return dataUrl && (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'application/pdf');
	}

	_xmlMimeType(uti, utis) {
		return (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.mimeType(u)).find(m => m === 'text/xml' || m === 'application/xml');
	}

	_isEqualTo(title, string) {
		return title == string;
	}

	mimeType(u){
		return this.api.document().mimeType(u)
	}

	_timeFormat(date) {
		return date && this.api.moment(date).format('DD/MM/YYYY') || '';
	}
}

customElements.define(HtMsgDetail.is, HtMsgDetail);
</script>
</dom-module>
