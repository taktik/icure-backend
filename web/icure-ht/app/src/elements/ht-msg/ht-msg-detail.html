<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">



<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">


<link rel="import" href="../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<!--<link rel="import" href="../../../bower_components/vaadin-radio-button/vaadin-radio-button.html">-->

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../filter-panel/filter-panel.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="../dynamic-form/entity-selector.html">
<link rel="import" href="../../spinner-style.html">
<link rel="import" href="../dynamic-form/dynamic-doc.html">

<link rel="import" href="../pdf-element/pdf-element.html">

<!--<link rel="import" href="../ht-lab/ht-lab-details.html">-->



<dom-module id="ht-msg-detail">
	<template>
		<style include="shared-style spinner-style">
			:host{
				position: relative;
				background: var(--app-background-color-light);
				overflow-y: auto;
			}
			.notification-panel {
				position: fixed;
				top:50%;
				right: 0;
				z-index:1000;
				color: white;
				font-size: 13px;
				background: rgba(255, 0, 0, 0.55);
				height: 96px;
				padding: 0 8px 0 12px;
				border-radius: 3px 0 0 3px;
				overflow: hidden;
				white-space: nowrap;
				width: 0;
				opacity: 0;
			}

			.notification {
				animation: notificationAnim 7.5s ease-in;
			}

			@keyframes notificationAnim {
				0%{
					width: 0;
					opacity: 0;
				}
				5%{
					width: 440px;
					opacity: 1;
				}
				7%{
					width: 420px;
					opacity: 1;
				}
				95%{
					width: 420px;
					opacity: 1;
				}
				100%{
					width: 0;
					opacity: 0;
				}
			}

			.prescription-progress-bar {
				width: calc( 100% - 40px );
			}

			.details-panel {
				box-sizing: border-box;
				grid-column: 3 / span 1;
				grid-row: 1 / span 1;
				background: var(--app-background-color-light);
				display: flex;
				overflow-y: auto;
				flex-flow: column nowrap;
				align-items: flex-start;
				z-index: 0;
				width: 100%;
                flex: 1;
			}

			.contact-title{
				display:block;
				@apply --paper-font-body2;
				@apply --padding-32;
				padding-bottom:8px;
				padding-top: 32px;
			}
			/*.contact-title:first-child{
				padding-top:0;
			}*/
			.msg-detail-card > .card-content {
				padding: 16px 16px 32px !important;
			}

			.msg-detail-card {
				width: 100%;
                padding: 0 16px;
				display: block;
				background: transparent;
				box-shadow: none;
                flex-grow: 0;
			}

			.horizontal {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				flex-basis: 100%;
			}

			.justified {
				justify-content: space-between;
			}

			.pat-details-input {
				flex-grow: 1;
				margin: 16px;
			}

			input {
				border: none;
				width: 100%;
			}

			paper-dialog {
				margin: 0;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

			paper-dialog {
				min-width:30%;
			}

			.extra-info{
				color:var(--app-text-color-disabled);
				font-style: italic;
				font-size: 80%;
			}

			vaadin-upload{
				margin:16px;
				min-height:280px;
				background: var(--app-background-color);
				--vaadin-upload-buttons-primary: {
					padding:16px;
				};
				--vaadin-upload-button-add: {
					background: var(--app-secondary-color);
					color:var(--app-text-color);
				};
				--vaadin-upload-file-progress: {
					--paper-progress-active-color:var(--app-secondary-color);
				};
				--vaadin-upload-file-commands: {
					color: var(--app-primary-color);
				}

			}

			.close-button-icon{
				position: absolute;
				top: 0;
				right: 0;
				margin: 0;
				transform: translate(50%, -50%);
				height: 32px;
				width: 32px;
				padding: 8px;
				background: var(--app-primary-color);
			}

			paper-dialog {
				width: 80%;
			}

			vaadin-grid {
				height:100%;
				--vaadin-grid-body-row-hover-cell: {
					/* background-color: var(--app-primary-color); */
					color: white;
				};
				--vaadin-grid-body-row-selected-cell: {
					background-color: var(--app-primary-color);
					color: white;
				};
			}

			paper-input{
				--paper-input-container-focus-color: var(--app-primary-color);
			}

			.modal-title{
				background:  var(--app-background-color-dark);
				margin-top: 0;
				padding: 16px 24px;
			}

			.modal-subtitle{
				display: inline-flex;
				margin-top: 16px;
			}

			.modal-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				color: var(--app-text-color);
				font-weight: 400;
				font-size: 14px;
				height: 40px;
				min-width: 100px;
				padding: 10px 1.2em;
				text-transform: capitalize;
			}
            @media screen and (max-width: 1314px) {
                .modal-button {
                    margin: 0;
                }
            }

			.modal-button--save{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-secondary-color);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}

			.modal-button--delete{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-background-color-light);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}
            @media screen and (max-width: 1200px) {
                .modal-button--delete.remove {
                    display: none;
                }
            }

			filter-panel{
				flex-grow: 9;
				/* --panel-width: 60%; */
			}

			.layout-bar{
				flex-grow: 1;
				display: inline-flex;
				flex-flow: row nowrap;
				align-items: center;
				justify-content: space-around;
				height:48px;
				background: var(--app-secondary-color);
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.layout-bar .list, .layout-bar .graphique, .layout-bar .doc{
				height: 32px;
				width: 32px;
				padding: 5px;
				color: var(--app-primary-color-dark);
			}

			.layout-bar .table{
				height: 30px;
				width: 30px;
				padding: 0;
				color: var(--app-primary-color-dark);
			}

			.floating-action-bar{
				display: flex;
				position: absolute;
				height: 40px;
				bottom: 16px;
				background: var(--app-secondary-color);
				border-radius: 3px;
				grid-column: 3/3;
				grid-row: 1/1;
				z-index: 1000;
				left: 50%;
				transform: translate(-50%, 0);
				box-shadow: var(--app-shadow-elevation-2);
			}

			.add-forms-container {
				position: absolute;
				bottom: 48px;
				left: 0;
				background-color: var(--app-background-color-light);
				opacity: .8;
				padding: 8px 0;
				border-radius: 2px;
				max-width: 253px;
			}
			.floating-action-bar paper-fab-speed-dial-action {
				--paper-fab-speed-dial-action-label-background: transparent;
				--paper-fab-iron-icon: {
					transform: scale(0.8);

				};
				--paper-fab: {
					background: var(--app-primary-color-dark);
				}
			}

			.floating-action-bar paper-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				background: var(--app-secondary-color);
				color: var(--app-text-color);
				font-weight: bold;
				font-size: 12px;
				height: 40px;
				min-width: 130px;
				padding: 10px 1.2em;
				border-radius: 0;
				margin:0;
			}

			.floating-action-bar paper-button:hover{
				background: var(--app-dark-color-faded);
    			transition: var(--transition_-_transition);
			}

			.floating-action-bar paper-button:not(:first-child){
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.close-add-forms-btn{
				background: var(--app-secondary-color-dark) !important;
			}

			.floating-action-bar iron-icon{
				box-sizing: border-box;
				padding: 2px;
				margin-right: 8px;
			}

			.horizontal{
				flex-flow: row nowrap;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

            dynamic-doc {
                overflow-x: hidden;
                overflow-y: auto;
                margin-top: 16px;
                word-break: break-all;
                hyphens: auto;
            }

			.annexe-card{
                width: 100%;
                box-sizing: border-box;
				background: var(--app-background-color)
			}

			.annexe-card:first-of-type{
				margin-left:0;
			}

			.annexe-card--header{
				background-color: white;
    			padding: 0 8px;
				flex-flow: row nowrap!important;
                overflow: hidden;
                text-overflow: ellipsis;
			}

			.annexe-card--header span{
				flex-grow: 1;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			.annexe-card--header paper-icon-button{
				height: 32px;
				width: 32px;
				min-width: 32px;
				min-height: 32px;
				padding: 4px;
				opacity: .7;
				color: var(--app-text-color);
			}

			.annexe-card--content{
    			padding: 0 8px;
			}

			.annexe-card--action-button{
				font-size: 14px;
				font-weight: 400;
				text-transform: capitalize;
                margin: 0 auto;
			}

			.annexe-card--action-button:hover{
				background-color: var(--app-background-color-dark);
				font-weight: 500;
			}

			.img-container img{
				max-width: 100%;
				height: auto;
			}

            .action-buttons {
                width: 100%;
                padding: 0;
				border-bottom: 1px solid var(--app-background-color-dark);
				height: 56px;
                z-index: 10;
                padding: 8px;
                box-sizing: border-box;
            }
            .action-buttons > .buttons {
                float: left;
            }
            .action-buttons > .del-button {
                float: right;
            }

            .clearb {
                clear: both;
            }
            .flexbox {
                display: flex;
                flex-direction: row;
            }
            .flexbox.read {
                width: 100%;
            }
            .inlined {
                flex: 1;
                float: left;
                width: 30%;
                margin: 0 1%;
            }

            .read-txt {
                width: 100%;
                max-height: 50vh;
                overflow-y: auto;
				flex-grow: 1;
				border-top: 1px solid var(--app-background-color-dark);
                padding: 0 10px;
                box-sizing: border-box;
            }

			.read-txt p{
				font-size: 14px;
			}

            .attached {
                width: 100%;
                max-height: 176px;
                padding: 10px;
                overflow-y: auto;
                border-top: 1px solid var(--app-background-color-dark);
                box-sizing: border-box;
				display: flex;
				flex-flow: row wrap;
				justify-content: flex-start;
				align-items: flex-start;
            }
            .attached paper-button {
                margin: 0;
            }

            paper-button.close {
                border: 1px solid var(--app-background-color-darker);
                transition: .5s ease;
                box-sizing: border-box;
            }
            paper-button.close:hover {
                border: 1px solid var(--app-secondary-color);
            }

			.attached h3{
				width: 100%;
				margin: 0;
				color: var(--app-text-color);
				font-size: 1em;
				padding-left:4px;
			}

			.msg-detail-btn{
				font-size: 14px;
				font-weight: 400;
				color: var(--app-text-color);
				text-transform: capitalize;
				transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
				margin-bottom: 8px;
				height: 40px;
			}

			.msg-detail-btn:hover{
				background-color: var(--app-background-color-dark);
				color: var(--app-text-color);
			}

			.msg-detail-btn iron-icon{
				height: 20px;
				width: 20px;
				padding: 4px;
				opacity: .7;
				color: var(--app-text-color);
			}

			.layout-horizontal{
				display:flex;
				flex-flow: row wrap;
				align-items: center;
				justify-content: flex-start;
			}

			.layout-horizontal--nowrap{
				flex-flow: row nowrap;
			}

            .justify-content {
                justify-content: space-between;
                flex-flow: initial;
            }
			.space-between{
				justify-content: space-between;
                height: 80px;
			}

			.layout-horizontal--flex-end{
				justify-content: flex-end;
			}

			.msg-header-grid{
				display: grid;
				grid-template-columns: 50px 1fr;
				grid-template-rows: 25px 25px;
				grid-row-gap: 0;
				grid-column-gap: 8px;
			}

			.initials-avatar{
				grid-column: 1 / 1;
				grid-row: 1 / 2;
				display: inline-flex;
				flex-flow: row wrap;
				align-items: center;
				justify-content: center;
				background: var(--app-secondary-color-dark);
				border-radius: 50%;
				height: 50px;
				width: 50px;
				color: white;
				font-size: 1.2em;
				text-transform: uppercase;
			}

			.from{
				-webkit-font-smoothing: antialiased;
				font-family: Roboto,RobotoDraft,Helvetica,Arial,sans-serif;
				font-size: 1rem;
				letter-spacing: .2px;
				color: var(--app-text-color);
				line-height: 20px;
				font-weight: 500;
				grid-column: 2 / 2;
				grid-row: 1 / 1;
				place-self: end start;
			}

			.to{
				-webkit-font-smoothing: auto;
				font-family: Roboto,RobotoDraft,Helvetica,Arial,sans-serif;
				font-size: 13px;
				letter-spacing: .3px;
				color: var(--app-text-color-disabled);
				line-height: 20px;
				grid-column: 2 / 2;
				grid-row: 2 / 2;
				place-self: start start;
			}

			paper-icon-button{
				color: var(--app-text-color);
				height: 32px;
				width: 32px;
				padding: 4px;
				margin: 4px;
				transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
				opacity: .7;
			}

			paper-icon-button:hover{
				border-radius: 50%;
				background-color: var(--app-background-color-dark);
				color: var(--app-text-color);
				opacity: 1;
			}

			.date{
				font-size: 13px;
				background-color: var(--app-background-color-dark);
				padding: 0 12px;
				border-radius: 12px;
				color: var(--app-text-color);
			}

			ht-spinner {
                position: absolute;
                top: 50%;
                left: 50%;
                z-index: 150;
                transform: translate(-50%,-50%);
				height: 42px;
				width: 42px;
            }
			paper-spinner.patlist-spinner {
                position: relative;
                top: 12px;
                left: 8px;
                transform: none;
            }

            .close-panel {
                width: 100%;
                text-align: center;
                padding: 4px 16px;
                box-sizing: border-box;
                background: var(--app-background-color-darker);
                cursor: pointer;
                border-top: 1px solid black;
            }

            #main-details-panel {
                flex: 1;
            }

            ht-msg-list.selected .col-right {
                width: 100%;
            }

            div.subject {
                flex-grow: 1;
                overflow: hidden;
                max-height: 88px;
            }

            h2.subject {
                margin: 24px 0;
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
            }

            .message-box {
                padding: 4px;
                width: 100%;
                box-sizing: border-box;
                flex: 1;
            }

            .mobileOnly {display: none;}

            .doc-container {
                max-width: 50%;
            }

            .confirmPats {
                background: var(--app-secondary-color);
                position: relative;
                padding: 4px 8px;
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                border-radius: 4px;
                font-size: .8em;
                text-align: center;
                width: auto;
                box-shadow: var(--app-shadow-elevation-1);
                cursor: pointer;
            }

            #import-suggest {
                position: fixed;
                display: flex;
                top: calc(50vh + 97px);
                left: calc(16% + 20px);
                width: calc(80vw - 12px);
                height: auto;
                max-height: calc(100vh - 97px);
                transform: translateY(calc(-50% - 64px));
                justify-content: flex-end;
                background: #fff;
                padding: 8px;
                border: 1px solid var(--app-background-color-dark);
                box-shadow: var(--app-shadow-elevation-2);
                border-radius: 4px;
                z-index: 999;
                flex-direction: column;
                margin: 0 auto;
            }

            #import-suggest .twocol {
                display: grid;
                grid-template-columns: 50% 50%;
            }

            #import-suggest h5 {
                margin: 0 auto 4px auto;
                text-align: center;
            }

            #import-suggest .lab-details {
                flex-grow: 1;
                flex-direction: column !important;
                margin-bottom: 8px;
            }
            #import-suggest .lab-details .sheet {
                overflow-y: auto;
                background: var(--app-background-color-dark);
                border-radius: 4px;
                flex-grow: 1;
            }

            #import-suggest .scrollbox {
                height: 40vh; /* TODO : when labresult is done, "128px" */
                overflow-y: auto;
                background: var(--app-background-color-dark);
                border-radius: 4px;
                padding: 4px;
                display: flex;
                flex-direction: column;
                margin-bottom: 8px;
                box-sizing: border-box;
            }
            .scrollbox.labolist {
                margin-right: 8px; /* TODO : 8px when labresult done*/
                padding: 0 !important;
            }
            .scrollbox.patlist .checkbox-item {
                border-bottom: 1px solid var(--app-background-color-darker);
                padding: 4px;
            }
            .scrollbox.patlist .checkbox-item * div#checkbox.checked {
                background-color: var(--app-secondary-color-dark);
                border-color: var(--app-secondary-color-dark);
            }

            #import-suggest .line {
                display: flex;
                flex-direction: row;
                justify-content: flex-start;
                width: 100%;
            }
            #import-suggest .line > div.icon {
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                width: 32px;
            }
            #import-suggest .line > div.grow {
                flex-grow: 1;
            }
            #import-suggest .save-line {
                justify-content: flex-end;
                min-height: 48px;
            }

            paper-listbox {
                background: transparent !important;
                padding: 0;
            }

            dynamic-doc {
                width: 100%;
            }

            .labolist .unassigned {
                line-height: 100%;
                display: flex;
                flex-direction: column;
                border-top: 1px solid var(--app-background-color-darker);
                text-align: left;
                padding: 8px;
            }
            .labolist .unassigned:first-child {
                border: none;
            }

            .labolist .unassigned .pat-name {
                font-weight: bold;
            }
            .labolist .unassigned iron-icon {
                width: 18px;
                margin-left: 4px;
            }
            .labolist .unassigned small {
                width: 100%;
                display: block;
            }
            .labolist .unassigned .labo-info {
                margin: 4px 0;
            }
            .labo-info .labo-name {}
            .labolist .unassigned .demand-date {
                text-align: right;
                font-size: .75em;
            }

            .pointer:hover,
            .pointer:focus,
            .pointer.iron-selected {
                background: var(--app-secondary-color);
                cursor: pointer;
                color: white;
                font-weight: initial;
            }
            .pointer.iron-selected {
                background: var(--app-secondary-color-dark);
            }

            paper-button.search-patients{
                background: var(--app-background-color-darker);
                margin: 4px;
            }
            paper-input.search-patients {
                flex-grow: 1;
            }
            iron-icon.search-patients {
                padding-top: 16px;
            }

            .wide-only {
                display: none;
            }

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }
            
            @media screen and (max-width: 1336px) {
                .nomobile-wide {
                    display: none;
                }
                .wide-only {
                    display: block;
                }
                .msg-detail-btn {
                    min-width: 0;
                }
            }

            @media screen and (max-width: 1025px) {
                .mobileOnly {display: block;}
                .attached {
                    max-height: 25vh;
                    width: 100%;
                    overflow-y: auto;
                }

                #import-suggest {
                    left: 50vw;
                    transform: translateY(calc(-50% - 64px)) translateX(-50%);
                    width: 90vw;
                }

                .read-txt {
                    height: auto;
                    overflow-y: hidden;
                    min-height: 80px;
                }

                .action-buttons {
                    padding-left: 36px;
                }
            }

            @media screen and (max-width: 650px) {
                .noPortable {display: none !important;}
                #import-suggest {
                    max-height: 50vh;
                }

                #import-suggest .twocol {
                    display: flex;
                    flex-direction: column;
                }

                #import-suggest .scrollbox {
                    height: 128px;
                }

                #import-suggest .labolist {margin-right: 0;}
            }

		</style>
		<ht-spinner class="center spinner" active="[[isLoadingMessage]]"></ht-spinner>
		<template is="dom-if" if="[[messages]]">
			<div id="main-details-panel" class="details-panel" on-dragover="_onDrag">
                <div class="action-buttons">
                    <div class="buttons">
                        <template is="dom-if" if="[[ehealthSession]]">
                            <template is="dom-if" if="[[!isSentbox]]">
                                <paper-button class="msg-detail-btn" on-tap="_replyMsgs" msgId$='[[msg.id]]'><iron-icon id="reply-msg" icon="reply"></iron-icon>
                                    <span class="nomobile-wide">[[localize('reply','Reply',language)]]</span>
                                    <paper-tooltip class="wide-only" for="reply-msg">[[localize('reply','Reply',language)]]</paper-tooltip>
                                </paper-button>
                            </template>
                            <!--<paper-button class="msg-detail-btn" on-tap="_forwardMsgs"  msgId$='[[msg.id]]'><iron-icon id="forward-msg" icon="forward"></iron-icon>-->
                                <!--<span class="nomobile-wide">[[localize('fw','Forward',language)]]</span>-->
                                <!--<paper-tooltip class="wide-only" for="forward-msg">[[localize('fw','Forward',language)]]</paper-tooltip>-->
                            <!--</paper-button>-->
                        </template>
                        <template is="dom-if" if="[[isHidden]]">
                            <paper-button class="msg-detail-btn" on-tap="_restoreMsgs"><iron-icon id="visibility-msg" icon="visibility"></iron-icon>
                                <span class="nomobile-wide">[[localize('restore','Restore',language)]]</span>
                                <paper-tooltip class="wide-only" for="visibility-msg">[[localize('restore','Restore',language)]]</paper-tooltip>
                            </paper-button>
                        </template>
                        <template is="dom-if" if="[[!isHidden]]">
                            <template is="dom-if" if="[[!isDeleted]]">
                                <paper-button class="msg-detail-btn" on-tap="_hideMsg"><iron-icon id="visibility-off-msg" icon="visibility-off"></iron-icon>
                                    <span class="nomobile-wide">[[localize('hid_msg','Hide message',language)]]</span>
                                    <paper-tooltip class="wide-only" for="visibility-off-msg">[[localize('hid_msg','Hide message',language)]]</paper-tooltip>
                                </paper-button>
                            </template>
                        </template>
                    </div>
                    <div class="del-button">
                        <template is="dom-if" if="[[isDeleted]]">
                            <paper-button class="msg-detail-btn" on-tap="_restoreMsgs"><iron-icon id="undo-msg" icon="undo"></iron-icon>
                                <span class="nomobile-wide">[[localize('restore','Restore',language)]]</span>
                                <paper-tooltip class="wide-only" for="undo-msg">[[localize('restore','Restore',language)]]</paper-tooltip>
                            </paper-button>
                            <!--<paper-button class="msg-detail-btn" on-tap="_deleteMsgForever"  msgId$='[[msg.id]]' ><iron-icon icon="delete-forever"></iron-icon>[[localize('del','Delete',language)]]</paper-button>-->
                        </template>
                        <template is="dom-if" if="[[!isDeleted]]">
                                <!--<paper-button class="msg-detail-btn" on-tap="_hideMsg"  msgId$='[[msg.id]]' ><iron-icon icon="visibility-off"></iron-icon>[[localize('del','Delete',language)]]</paper-button>-->
                            <paper-button class="msg-detail-btn" on-tap="_msgToBin"  msgId$='[[msg.id]]' ><iron-icon id="delete-msg" icon="delete"></iron-icon>
                                <span class="nomobile-wide">[[localize('del','Delete',language)]]</span>
                                <paper-tooltip class="wide-only" for="delete-msg">[[localize('del','Delete',language)]]</paper-tooltip>
                            </paper-button>
                        </template>
                    </div>
                </div>

                <template is="dom-repeat" items="[[messages]]" as="msg">
                    <paper-card class="msg-detail-card" >
                        <div class="layout-horizontal justify-content">
                            <div class="subject">
                                <h2 class="subject">[[msg.subject]]</h2>
                            </div>
                            <div class="layout-horizontal layout-horizontal--flex-end">
                                <paper-button class="close pointer" on-tap="close">
                                    <iron-icon icon="clear"></iron-icon> [[localize('clo','Close',language)]]
                                </paper-button>
                            </div>
                        </div>
                        <div class="layout-horizontal space-between">
                            <div class="msg-header-grid">
                                <div class="initials-avatar"><span>[[_getInitials(msg.fromAddress)]]</span></div>
                                <div class="from">[[msg.fromAddress]]</div>
                                <div class="to">[[localize('to','To',language)]] [[msg.toAddresses]]</div>
                            </div>
                            <div class="layout-horizontal layout-horizontal--flex-end">
                                <div class="date">[[_timeFormat(msg.received)]]</div>
                            </div>
                        </div>
                        <template is="dom-if" if="[[msg.patientInss]]">
                            <div class="patient">[[localize('inv_pat','Patient',language)]] : [[_getPatientDataByInss(msg.patientInss)]]</div>
                        </template>
                    </paper-card>
                </template>

                <template is="dom-repeat" items="[[_sorted(selectedDocuments)]]">
                    <template is="dom-if" if="[[_isEqualTo(item.documentLocation,'body')]]">
                        <div class="layout-vertical annexe-card">
                        <dynamic-doc api="[[api]]" user="[[user]]" patient="[[patient]]" preview="true" document-id="[[item.id]]" i18n="[[i18n]]" language="[[language]]"
                                     resources="[[resources]]" title="[[localize('doc_body','Message Body')]]" mailbody="true" downloadable="false"></dynamic-doc>
                        </div>
                    </template>
                    <template is="dom-if" if="[[!_isEqualTo(item.documentLocation,'body')]]">
                        <div class="layout-vertical annexe-card">
                            <dynamic-doc id="[[item.id]]" api="[[api]]" user="[[user]]" patient="[[patient]]" document-id="[[item.id]]" i18n="[[i18n]]" language="[[language]]"
                                         resources="[[resources]]" title="[[item.label]]" downloadable="true" on-open-suggestions="openSuggestions" unassigned="[[item.unimportedPats]]"></dynamic-doc>
                        </div>
                    </template>
                </template>

                <template is="dom-if" if="[[assignModal]]">
                    <div id="import-suggest">
                        <div class="line">
                            <h4>[[localize('set_attach','Set attachment',language)]]</h4> <ht-spinner class="patlist-spinner" active="[[isLoadingPatsSuggest]]"></ht-spinner>
                        </div>
                        <template is="dom-if" if="[[documentBeingAssigned.unimportedPats.length]]">
                        <div class="twocol">
                            <div>
                                <h5>[[localize('un_attachs','Unassigned results',language)]]</h5>
                                <div class="scrollbox labolist">
                                    <paper-listbox selected="{{selectedProtocol}}">
                                        <template is="dom-repeat" items="[[documentBeingAssigned.unimportedPats]]">
                                            <paper-item class="unassigned pointer">
                                                <div class="line">
                                                    <div class="icon">
                                                        <iron-icon icon="assignment" width="18px"></iron-icon>
                                                    </div>
                                                    <div class="grow">
                                                        <div class="pat-name">[[item.lastName]] [[item.firstName]] [[item.dateOfBirtth]]</div>
                                                        <small class="labo-info labo-name"><b>[[item.labo]]</b></small>
                                                        <small>[[localize('prot','Protocol',language)]]: [[item.protocol]]</small>
                                                        <small>[[localize('date','Date',language)]] : [[item.formatedDemandDate]]</small>
                                                    </div>
                                                </div>
                                            </paper-item>
                                        </template>
                                    </paper-listbox>
                                </div>
                            </div>
                            <div>
                                <h5>[[patsLng]] [[localize('found_matches','Found matches',language)]] [[selectName]]</h5>
                                <div class="scrollbox patlist">
                                    <template is="dom-if" if="[[!manualAssign]]">
                                        <paper-button class="search-patients" on-tap="toggleManualAssign"><iron-icon icon="perm-identity"></iron-icon> [[localize('sch_pats','Search patients',language)]]</paper-button>
                                    </template>
                                    <template is="dom-if" if="[[manualAssign]]">
                                        <div>
                                            <div class="line">
                                                <paper-input class="search-patients" value="{{searchPatValue}}" label="[[localize('pati','Patient',language)]]"></paper-input><iron-icon class="search-patients"  icon="close" on-tap="toggleManualAssign"></iron-icon>
                                            </div>
                                        </div>
                                    </template>
                                    <template is="dom-repeat" items="[[toImportPatsSuggestions]]">
                                        <paper-checkbox class="checkbox-item" on-iron-change="_getPatsFromCheckbox" data-item$="[[item]]"><b>[[item.lastName]] [[item.firstName]]</b><br/>[[localize('dat_of_bir','Date of birth',language)]]: [[item.dateOfBirth]]<br/>SSIN: [[item.ssin]]</paper-checkbox>
                                    </template>
                                    <template is="dom-if" if="[[toImportPatsSearch.length]]">
                                        <template is="dom-repeat" items="[[toImportPatsSearch]]">
                                            <paper-checkbox class="checkbox-item" on-iron-change="_getPatsFromCheckbox" data-item$="[[item]]"><b>[[item.lastName]] [[item.firstName]]</b><br/>[[localize('dat_of_bir','Date of birth',language)]]: [[item.dateOfBirth]]<br/>SSIN: [[item.ssin]]</paper-checkbox>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </div>
                        </template>
                        <template is="dom-if" if="[[!documentBeingAssigned.unimportedPats.length]]">
                        <div>
                            <h5>[[patsLng]] [[localize('poss_matches','Possible matches',language)]] [[selectName]]</h5>
                            <div class="scrollbox patlist">
                                <template is="dom-if" if="[[!manualAssign]]">
                                    <paper-button class="search-patients" on-tap="toggleManualAssign"><iron-icon icon="perm-identity"></iron-icon> [[localize('sch_pats','Search patients',language)]]</paper-button>
                                </template>
                                <template is="dom-if" if="[[manualAssign]]">
                                    <div>
                                        <div class="line">
                                            <paper-input class="search-patients" value="{{searchPatValue}}" label="[[localize('pati','Patient',language)]]"></paper-input><iron-icon class="search-patients" icon="close" on-tap="toggleManualAssign" disabled="[[isLoadingPatsSuggest]]"></iron-icon>
                                        </div>
                                    </div>
                                </template>
                                <template is="dom-repeat" items="[[toImportPatsSuggestions]]">
                                    <paper-checkbox class="checkbox-item" on-iron-change="_getPatsFromCheckbox" data-item$="[[item]]"><b>[[item.lastName]] [[item.firstName]]</b><br/>[[localize('dat_of_bir','Date of birth',language)]]: [[item.dateOfBirth]]<br/>SSIN: [[item.ssin]]</paper-checkbox>
                                </template>
                                <template is="dom-if" if="[[toImportPatsSearch.length]]">
                                    <template is="dom-repeat" items="[[toImportPatsSearch]]">
                                        <paper-checkbox class="checkbox-item" on-iron-change="_getPatsFromCheckbox" data-item$="[[item]]"><b>[[item.lastName]] [[item.firstName]]</b><br/>[[localize('dat_of_bir','Date of birth',language)]]: [[item.dateOfBirth]]<br/>SSIN: [[item.ssin]]</paper-checkbox>
                                    </template>
                                </template>
                            </div>
                        </div>
                        </template>
                        <!--TODO : Get lab result -->
                        <!--<template is="dom-if" if="[[toImportPatsSuggestions.length]]">-->
                        <!--<div class="line lab-details noPortable">-->
                        <!--<h4>Lab result</h4>-->
                        <!--<div class="sheet">-->
                        <!--<h5>[[docInfo.labo]]</h5>-->
                        <!--<p><b>[[docInfo.lastName]] [[docInfo.firstName]] [[docInfo.sex]]</b></p>-->
                        <!--<p>[[docInfo.documentId]] - [[docInfo.formatedDemandDate]] - [[docInfo.protocol]]</p>-->
                        <!--<p><small>[[docInfo.engine]]</small></p>-->
                        <!--<p>[[docInfo]]</p>-->
                        <!--<p>[[thisDocument]]</p>-->
                        <!--</div>-->
                        <!--</div>-->
                        <!--</template>-->
                        <div class="line save-line">
                            <paper-button class="modal-button--cancel" on-tap="closeSuggestions">
                                [[localize('can','Cancel',language)]]
                            </paper-button>
                            <template is="dom-if" if="[[canAssign]]">
                                <paper-button id="patients-importBtn" class="confirmPats" on-tap="_assignToPat">
                                    [[localize('set','Assign',language)]] <iron-icon id="patients-icon" icon="check"></iron-icon>
                                </paper-button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

		</template>
	</template>
	<script>

import _ from 'lodash/lodash';
import moment from 'moment/src/moment';
import XML from 'parse-xml/dist/parse-xml';

class HtMsgDetail extends Polymer.TkLocalizerMixin(Polymer.Element) {
	static get is() {
		return 'ht-msg-detail';
	}

	static get properties() {
		return {
			contacts: {
				type: Array,
				value: function () {
					return [];
				}
			},
			api: {
				type: Object
			},
			user: {
				type: Object
			},
			credentials:{
				type: Object
			},
			currentContact: {
				type: Object,
				value: null
			},
            selectedMessage: {
			    type: Object
			},
			messages: {
			    type: Object,
				value: null
			},
			selectedDocuments:{
				type: Object
			},
			documentAttachment:{
				type: String,
				value: null
			},
			showDetail:{
				type: Boolean,
				value: false
			},
			isLoadingMessage: {
				type: Boolean,
				value: false
			},
            isDeleted: {
			    type: Boolean,
                value: false
            },
            isHidden: {
			    type: Boolean,
                value: false
            },
            attachmentQuantity: {
			    type: Number,
                value: 0
            },
            hasUnassignedResults: {
			    type: Boolean,
                value: false
            },
            unassignedResults: {
			    type: Array,
                value: []
            },
            assignedResults: {
			    type: Array,
                value: []
            },
            unimportedPats: {
			    type: Array,
                value: []
            },
            thisDocument: {
			    type: Object,
                value: null
            },
            toImportPatsSuggestions: {
			    type: Array,
                value: []
            },
            selectedProtocol: {
			    type: Number,
                value: -1
            },
            assignModal: {
			    type: Boolean,
                value: false
            },
            selectedPats: {
			    type: Array,
                value: []
            },
            targetPats: {
                type: Array,
                value: []
            },
            isLoadingPatsSuggest: {
			    type: Boolean,
                value: false
            },
            selectName: {
			    type: String,
                value: ''
            },
            docInfo: {
			    type: Object,
                value: null
            },
            canAssign: {
			    type: Boolean,
                value: false
            },
            searchPatValue: {
			    type: String,
                value: ''
            },
            manualAssign: {
			    type: Boolean,
                value: false
            },
            toImportPatsSearch: {
			    type: Array,
                value: []
            },
            patsLng: {
			    type: Number,
                value: 0
            },
            hasLabResult: {
			    type: Boolean
            },
            docTxt: {
			    type: Object,
                value: null
            },
            ehealthSession: {
                type: Boolean
            }
		};
	}

	static get observers() {
		return ['_focusChanged(selectedMessage)','_hasLabResult(selectedMessage)','_updateSuggestions(selectedProtocol)',
            '_updatePatSearch(searchPatValue)','_patsLngChanged(toImportPatsSuggestions,toImportPatsSearch)',
            '_isConnectedToEhbox(api.tokenId)','_isSentbox(selectedMessage)'];
	}

	constructor() {
		super();
	}

	ready(){
		super.ready();

        // this.shadowRoot.getElementById('import-suggest').onkeydown = (e) => {
        this.onkeydown = (e) => {
            if(e.key === "Escape") {this.closeSuggestions()}
        }
	}

    _isConnectedToEhbox() {
        this.set("ehealthSession", this.api.tokenId ? true : false)
    }

	close() {
	    this.set('selectedMessage',null)
        this._focusChanged()
        this.classList.remove('selected')
        this.parentElement.children[0].classList.remove('selected')
        this.dispatchEvent(new CustomEvent('msg-detail-closed'))
    }

	_getInitials(fromAddress){
		var names = fromAddress.split(' ')
		var	initials = names[0].substring(0, 1)

		return names.length > 1 ?  initials += names[names.length -1].substring(0, 1) : initials
	}

	_displayLengthOrEmpty(msgBody){
        return msgBody.body != '' ? msgBody.body : this.localize('no_msg_content','No message',this.language)
	}

	_uncheckBoxes() {
        const checkboxes = this.shadowRoot.querySelectorAll('.checkbox-item') || []
        checkboxes.forEach(c=>c.checked = false)
    }

    toggleManualAssign() {
	    if (!this.isLoadingPatsSuggest) {
            this.set('searchPatValue','')
            this.set('manualAssign',!this.manualAssign)
            if(!this.manualAssign) this.set('toImportPatsSearch',[])
        }
    }
    _updatePatSearch() {
        this.set('canAssign',false)
	    if (this.searchPatValue.length >= 2) {
            this.set('isLoadingPatsSuggest',true)
            console.log('updatePatSearch',this.searchPatValue)
            setTimeout(() =>{
                this.api.patient().findByNameBirthSsinAutoWithUser(this.user, this.user.healthcarePartyId, this.searchPatValue, null, null, 100, "asc").then(pats=>{
                    console.log('pats',pats)
                    this.set('toImportPatsSearch',pats.rows || [])
                    this.set('isLoadingPatsSuggest',false)
                    this._uncheckBoxes()
                })
            },2000)
        } else {
            this.set('toImportPatsSearch',[])
            this.set('isLoadingPatsSuggest',false)
        }
    }
    _patsLngChanged() {
	    this.set('patsLng',this.toImportPatsSuggestions.length + this.toImportPatsSearch.length)
    }

    _hasLabResult() {
	    if (this.selectedMessage) {
            const m = this.selectedMessage
            if (m && m.assignedResults && m.unassignedResults) {
                this.set('hasLabResult', (Object.keys(m.assignedResults).length || m.unassignedResults.length) ? true : false)
            } else {
                this.set('hasLabResult', false)
            }
        } else {
            this.set('hasLabResult', false)
        }
    }

    _isDeleted() {
	    return this.messages[0].transportGuid.startsWith("BIN")
    }
    _isHidden() {
        return this.messages && this.messages[0] && this.messages[0].status && ((this.messages[0].status & 1<<14) !== 0)
    }

    _sorted(docs) {
	    return _.sortBy(docs, (d) => d.documentLocation === 'body' ? '' : d.id)
    }

    _focusChanged(){
	    if(this.selectedMessage){
	        let selMsg = this.selectedMessage;
	        // needed vars
            this.set('toImportPatsSuggestions', [])
            this.set('selectedProtocol',-1)
            this.set('selectedPats',[])
            this.set('targetPats',[])
			this.set('isLoadingMessage',true)
			this.set('manualAssign',false)
            this.set('selectName','')
            this.set('toImportPatsSearch',[])
            this.set('isDeleted',this.selectedMessage && this.selectedMessage.transportGuid && this.selectedMessage.transportGuid.startsWith("BIN"))
            this.set('isHidden',this.selectedMessage && this.selectedMessage.status && ((this.selectedMessage.status & 1<<14) !== 0))
            this.set('unassignedResults',selMsg.unassignedResults)
            this.set('assignedResults',selMsg.assignedResults)
			this.set('hasUnassignedResults',selMsg.unassignedResults ? selMsg.unassignedResults.length ? true : false : false)
            this.set('thisDocument',selMsg)
            this.set('bodyDocument',{})
            this.set('svcToDisplay',[])
            if (selMsg.status) { // mark as read
                const tempBytes = selMsg.status.toString(2), len = selMsg.status.toString(2).length
                const a = tempBytes.substring(0,len-2), b = tempBytes.substring(len-1,len)
                if (this.isUnread(selMsg)) { // if message was not read, else do nothing
                    selMsg.status = parseInt(a+'0'+b,2)
                    this.api.message().modifyMessage(selMsg).then(msg=>_.assign(selMsg, msg))
                }
            }
            // treatment
	        console.log('this message',selMsg)
        	this.api.document().findByMessage(this.user.healthcarePartyId, selMsg)
				.then(docs => docs.filter(doc => doc.id && doc.attachmentId && doc.secretForeignKeys))
                .then(docs => Promise.all(docs.map(d => this._getPatsFromDoc(d))))
                .then(docs =>{
                    if (docs && docs.length) {
                        this.set('isLoadingMessage', false)
                        this.set('messages', [selMsg])
                        this.set("selectedDocuments", docs)
                        this.set('attachmentQuantity', this.selectedDocuments.length - 1)
                        this._getMsgTxt()
                    } else {
                        this.set('isLoadingMessage', false)
                        this.set('messages', [selMsg])
                        this.set("selectedDocuments", [])
                        this.set('attachmentQuantity', 0)
                        this.set('hasUnassignedResults', false)
                    }
                })
        } else {
            this.set('isLoadingMessage', false)
            this.set('messages', null)
            this.set('hasUnassignedResults', false)
            this.set('thisDocument', null)
        }
	}

    openSuggestions(e) {
        if(!this.assignModal) {
            this.set('documentBeingAssigned', this.selectedDocuments.find(d => d.id === e.detail.documentId))
            this.set('assignModal',true)
            this.set('targetPats',[])
            this.set('manualAssign',false)
            this.set('searchPatValue','')
            this.set('toImportPatsSearch',[])
            this.set('isLoadingPatsSuggest',false)
            this.set('selectedProtocol',0)
        }
    }

	closeSuggestions() {
        this.set('documentBeingAssigned', null)
        this.set('targetPats',[])
        this.set('canAssign',false)
        this.set('toImportPatsSuggestions', [])
        this.set('assignModal',false)
        this.set('selectName','')
        this.set('selectedProtocol',-1)
    }

    _getAssignedPats(m) {
        if(m.assignedResults && m.assignedResults.length) {
            Promise.all(Object.keys(m.assignedResults).forEach(key=>this.api.patient().getPatient(key)))
                .then(pats=>{
                    return pats
                })
        } else {
            return []
        }
    }

    _getPatsFromDoc(document) {
	    if(document.documentLocation === "body") return document
        console.log('_getPatsFromDoc')
        const unassigned = this.unassignedResults || []
        this.set('toImportPatsSuggestions', [])
        return this.api.crypto()
            .extractKeysFromDelegationsForHcpHierarchy(this.user.healthcarePartyId, document.id, _.size(document.encryptionKeys) ? document.encryptionKeys : document.delegations)
            .then(({extractedKeys: enckeys}) =>
                this.api.beresultimport().canHandle(document.id, enckeys.join(','))
                .then(isResult => isResult && this.api.beresultimport().getInfos(document.id, false, null, enckeys.join(',')))
            )
            .then(resultInfo => {
                if (resultInfo && resultInfo.length && unassigned.length) {
                    resultInfo.forEach(res => {
                        document.docInfo = res
                        unassigned.forEach(u => {
                            if (u === res.protocol) {
                                //res.formatedDemandDate = this.api.moment(res.demandDate).format('DD/MM/YYYY')
                                (document.unimportedPats || (document.unimportedPats = [])).push(res)
                            }
                        })
                    })
                    document.unimportedPats = _.orderBy(document.unimportedPats || [], 'demandDate', "desc")
                }
            })
            .then(() => document)
            .catch(() => document)
    }

    _updateSuggestions() {
        console.log('_updateSuggestions')
        if (this.selectedProtocol > 0) {
            this.set('isLoadingPatsSuggest',true)
            const unimportedPats = this.documentBeingAssigned && this.documentBeingAssigned.unimportedPats || []
            const index = this.selectedProtocol
            this.set('selectName', unimportedPats[index] ? `(${unimportedPats[index].lastName})` : '')
            this.set('docInfo', this.documentBeingAssigned && this.documentBeingAssigned.docInfo)
            this.set('toImportPatsSuggestions',[])
            this.set('selectedPats',[])
            this.set('targetPats',[])
            this.set('canAssign',false)
            this.api.patient().findByNameBirthSsinAutoWithUser(this.user, this.user.healthcarePartyId, unimportedPats[index].lastName, null, null, 100, "asc")
                .then(patients => {
                    this.set('isLoadingPatsSuggest',false)
                    if (patients && patients.rows.length) patients.rows.map(pat => {
                        if (pat.lastName.toUpperCase() === unimportedPats[index].lastName.toUpperCase()) {
                            pat.dateOfBirth = this.api.moment(pat.dateOfBirth).format('DD/MM/YYYY')
                            this.push('toImportPatsSuggestions', pat)
                            this._uncheckBoxes()
                        }
                    })
                })
        }
    }

    _getPatsFromCheckbox(e) {
        const elem = JSON.parse(e.target.dataset.item)
        const checked = e.target.checked
        let arr = this.targetPats ? this.targetPats : []
        if (checked) {
            arr.push(elem)
        } else {
            arr.splice(arr.indexOf(elem))
        }
        this.set('canAssign',this.targetPats.length)
        this.set('targetPats',arr)
        // console.log('_getPatsFromCheckbox',elem,'checked:'+checked,arr)
    }

    _assignResultToSelected(selMsg,targets,document,docInfo) {
        if (docInfo && docInfo.formatedDemandDate) delete docInfo.formatedDemandDate
        if (selMsg && selMsg.unassignedResults && selMsg.unassignedResults.length && targets && docInfo && document) {
            targets.map(thisPat=>{
                // console.log('_assignResultToSelected',selMsg, targets, docInfo, document,thisPat)
                this.api.contact().newInstance(this.user, thisPat, {
                    created: new Date().getTime(),
                    modified: new Date().getTime() ,
                    author: this.user.id,
                    responsible: this.user.healthcarePartyId,
                    openingDate: moment(docInfo.demandDate).format('YYYYMMDDHHmmss') || '',
                    closingDate: moment().format('YYYYMMDDHHmmss') || '',
                    encounterType: {type: docInfo.codes.type, version: docInfo.codes.version, code: docInfo.codes.code},
                    descr: docInfo.labo,
                    subContacts: []
                }).then(c => {
                    c.services.push({
                        id: this.api.crypto().randomUuid(),
                        label: 'labResult',
                        valueDate: parseInt(moment().format('YYYYMMDDHHmmss')),
                        content: _.fromPairs([[this.language, {stringValue:docInfo.labo}]]),
                        tags:[{type:'CD-TRANSACTION', code:'labresult'}]
                    })
                    return this.api.contact().createContactWithUser(this.user, c)
                }).then(c => {
                    return this.api.form().newInstance(this.user, thisPat, {
                        contactId: c.id,
                        // cryptedForeignKeys: thisPat.cryptedForeignKeys,
                        descr: "Lab " + new Date().getTime(),
                    }).then(f => {
                        console.log('should do Import',f)
                        return this.api.form().createForm(f).then(f =>
                            this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
                                this.api.crypto()
                                    .extractKeysFromDelegationsForHcpHierarchy(hcp.id, document.id, _.size(document.encryptionKeys) ? document.encryptionKeys : document.delegations)
                                    .then(({extractedKeys: enckeys}) => this.api.beresultimport().doImport(document.id, hcp.id, hcp.languages.find(e => !!e) || "en", docInfo.protocol, f.id, null, enckeys.join(','), c))
                            )
                        )
                    })
                }).then(c => {
                    const idx = (this.unassignedResults || []).indexOf(docInfo.protocol)
                    this.splice('unassignedResults', idx)

                    let tempAssign = _.clone(this.assignedResults)
                    tempAssign[c.id] = docInfo.protocol
                    this.set('assignedResults',tempAssign)

                    selMsg.unassignedResults = this.unassignedResults
                    selMsg.assignedResults = tempAssign

                    return selMsg
                }).then(selMsg=>{
                    return this.api.message().modifyMessage(selMsg).then(msg => {
                        _.assign(this.selectedMessage, msg)
                        if (msg.unassignedResults.length === 0) {
                            this.closeSuggestions()
                        } else {
                            this._focusChanged()
                        }
                        return Promise.resolve()
                    });
                })
                .catch(err => {
                    console.warn("error:" + err)
                })
            }) // map end
        } else {
            console.warn('_assignResultToSelected missing attribute',selMsg,targets,document,docInfo)
        }
    }

    _assignToPat() {
        if (this.selectedMessage && this.selectedMessage.unassignedResults && this.selectedMessage.unassignedResults.length &&
            this.documentBeingAssigned && this.documentBeingAssigned.docInfo &&
            this.targetPats && this.targetPats.length) { // if has unassigned results && docinfo && targetPats
            const selMsg = this.selectedMessage
            const targets = this.targetPats || []
            const document = this.documentBeingAssigned
            const docInfo = this.documentBeingAssigned.docInfo || null
            this._assignResultToSelected(selMsg,targets,document,docInfo)
        } else {
            // console.log("assignToPat",this.targetPats)
            if (this.targetPats && this.targetPats.length) { // if no unassigned && no docinfo && no targetPats
                this.targetPats.map(thisPat=>{
                    this.api.contact().newInstance(this.user, thisPat, {
                        created: new Date().getTime() ,
                        modified: new Date().getTime() ,
                        author: this.user.id,
                        responsible: this.user.healthcarePartyId,
                        subContacts: []
                    }).then(ctc=>{
                        const doc = this.selectedDocuments.find(d=>d.documentLocation === 'annex')
                        if (doc && doc.id && doc.id.length) {
                            const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: doc.id, stringValue: doc.name || 'annex-'+this.api.moment(Date.now()).format('YYYYMMDD') }]]), label: 'document' });
                            ctc.services.push(svc);
                            ctc.subContacts = [{ status: 64, services: [{serviceId: svc.id }]}]
                            this.api.contact().createContactWithUser(this.user, ctc).then(c=>{
                                this.api.register(c,'contact')
                                this.closeSuggestions()
                            })
                        }
                    })
                })
            }
        } // else end
    }

    textType(uti, utis) {
        return (uti && [uti] || []).concat(utis && utis.value || []).map(u => this.api.document().mimeType(u)).find(m => m === 'text/plain');
    }

    _getPatientDataByInss(inss){
        if(inss && inss.length > 1) {
            this.api.patient().findByNameBirthSsinAutoWithUser(this.user,this.user.healthcarePartyId, inss, null, null, 100, "asc")
                .then(patients => {
                    console.log(patients);
                    const newPat = patients.rows[0]
                    return `${newPat.firstName} ${newPat.lastName} (INSS:${newPat.ssin})`;
                })
        }
        else{
            this.set("patientList", [])
        }
    }

	_forwardMsgs(e) {
        if (this.docTxt != null) {
            const origMsg = this.messages[0]
            const msgToFw = {
                destinations: [],
                patientInss: origMsg.patientINSS,
                annex: this.selectedDocuments.filter(doc=>doc.documentLocation !== "body"),
                document: {
                    title: 'Fw: '+origMsg.subject,
                    textContent: this.docTxt != undefined && this.docTxt.length ? this.docTxt : this.localize('no_msg_content','No message',this.language)
                },
                customMetas: origMsg.metas,
                type: 'fwd'
            }
            const target = this.parentElement.parentNode.querySelector('ht-msg-menu')
            target.dispatchEvent(new CustomEvent('fw-msg', {detail: {bubbles: true, composed: true, params:msgToFw}}))
        } else setTimeout(()=>{this._forwardMsgs()},2500)
    }

    _replyMsgs(e) {
	    if (this.docTxt != null) {
            const origMsg = this.messages[0]
            let dest = []
            this.api.hcparty().findBySsinOrNihii(origMsg.fromHealthcarePartyId)
                .then(paginated=>{
                    if(paginated.rows && paginated.rows[0]) {
                        let hcp = paginated.rows[0]
                        if (hcp.name && !hcp.name.startsWith('Noreply') || hcp.ssin !== "12345678912") {
                            hcp.type = 'NIHII'
                            hcp.displayName = `${hcp.firstName} ${hcp.lastName} [${hcp.nihii}]`
                            // this.api.contact().getContactWithUser(this.user, origMsg.author).then(c=>dest=c)
                            dest.push(hcp)
                            console.log('hcp to re',hcp)
                            const msgToRe = {
                                // delegations: origMsg.delegations,
                                destinations: dest,
                                received: this.api.moment(origMsg.received).format('DD/MM/YYYY hh:mm'),
                                patientInss: origMsg.patientInss,
                                annex: undefined,
                                document: {
                                    title: 'Re: ' + origMsg.subject,
                                    textContent: this.docTxt != undefined && this.docTxt.length ? this.docTxt : this.localize('no_msg_content','No message',this.language)
                                },
                                customMetas: origMsg.metas,
                                type: 'replyto'
                            }
                            const target = this.parentElement.parentNode.querySelector('ht-msg-menu')
                            target.dispatchEvent(new CustomEvent('re-msg', {detail: {bubbles: true,composed: true,params: msgToRe}}))
                        } else console.log('cannot reply to Noreply : '+origMsg.fromHealthcarePartyId)
                    } else console.log('cannot find ssin or nihii : '+origMsg.fromHealthcarePartyId)
                }).catch(e=>console.log(e))
        } else setTimeout(()=>{this._replyMsgs()},2500)
    }

    _hideMsg() {
        let msg = this.messages[0]
        if (msg) {
            if ((msg.status&(1<<14)) !== 0){ // if hidden
                msg.status = msg.status & 0<<14 // unhide
            } else {
                msg.status = msg.status | 1<<14 // else hide
            }
            this.api.message().modifyMessage(msg).then((m)=>{_.assign(msg,m);this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } }))})
        }
    }

    _getMsgTxt() { // TODO : make it async
	    if (this.selectedDocuments && this.selectedDocuments.length) {
	        const doc = this.selectedDocuments.find(d=>d.documentLocation === 'body') || {}
            this.api.crypto()
                .extractKeysFromDelegationsForHcpHierarchy(this.user.healthcarePartyId,doc.id,_.size(doc.encryptionKeys) ? doc.encryptionKeys : doc.delegations)
                .then(({extractedKeys: enckeys}) =>this.api.beresultimport().canHandle(doc.id, enckeys.join(',')).then(()=> {
                    const dataUrl = doc && this.api.document().getAttachmentUrl(doc.id, doc.attachmentId, enckeys, this.api.sessionId)
                    this.api.shortLivedCache(dataUrl, () => fetch(dataUrl, {credentials: 'include'})
                        .then(response => response.text())).then(text =>this.set('docTxt',text))
                }))
        }
    }

    _msgToBin(param){
        let msg = this.messages[0]
        if (msg) {
            const id = msg.transportGuid.substring(msg.transportGuid.indexOf(':') + 1)
            if (msg.transportGuid.includes('INBOX')) msg.transportGuid = 'BININBOX:'+id
            if (msg.transportGuid.includes('SENTBOX')) msg.transportGuid = 'BINSENTBOX:'+id
            this.api.message().modifyMessage(msg).then((m)=>{_.assign(msg,m);this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } }))})
        }
    }

    _restoreMsgs(){
        let msg = this.messages[0]
        if (msg && msg.transportGuid && msg.status) {
            const id = msg.transportGuid.substring(msg.transportGuid.indexOf(':') + 1)
            if (msg.transportGuid.includes('INBOX')) msg.transportGuid = 'INBOX:'+id // legacy
            if (msg.transportGuid.includes('SENTBOX')) msg.transportGuid = 'SENTBOX:'+id // legacy
            msg.status = msg.status&0<<14 // unhide
            this.api.message().modifyMessage(msg).then((m)=>{_.assign(msg,m);this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } }))})
        }
    }

    _deleteMsgForever() {
        let msg = this.messages[0]
        if (msg) {
            const id = msg.transportGuid.substring(msg.transportGuid.indexOf(':')+1)

            if (msg.transportGuid.includes('INBOX')) this.api.fhc().Ehboxcontroller().moveMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [id], 'INBOX', 'BININBOX').then(()=>{
                this.api.fhc().Ehboxcontroller().deleteMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [id], 'BININBOX')
                    .then(()=>this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } })))
            })
            if (msg.transportGuid.includes('SENTBOX')) this.api.fhc().Ehboxcontroller().moveMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [id], 'SENTBOX', 'BINSENTBOX').then(()=>{
                this.api.fhc().Ehboxcontroller().deleteMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [id], 'BINSENTBOX')
                    .then(()=>this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } })))
            })

        }
    }

    _isSentbox(msg) {
	    this.set('isSentbox',msg && msg.transportGuid && msg.transportGuid.startsWith('SENT'))
    }

	_isEqualTo(title, string) {
		return title == string;
	}

	_timeFormat(date) {
		return date && this.api.moment(date).format('DD/MM/YYYY') || '';
	}

    _base64(data) {
        return base64js.fromByteArray(data);
    }

    isUnread(m) {
        return (m.status & (1 << 1)) !== 0 ? true : false
    }
}

customElements.define(HtMsgDetail.is, HtMsgDetail);
</script>
</dom-module>
