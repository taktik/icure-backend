<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<dom-module id="ht-msg-list">
    <template>
        <custom-style>
            <style include="shared-styles">
                :host {
                    display: block;
                    z-index:2;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                .new-msg-btn {
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: 80%;
                        margin: 0 auto;
                        height: 48px;
                        text-transform: capitalize;
                    };
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                }

                .boxes-list {
                    margin: 20px auto;
                    padding: 0;
                    min-width: 80%;
                }

                .col-right {
                    box-sizing: border-box;
                    grid-column: 2 / span 1;
                    grid-row: 1 / span 1;
                    background:var(--app-background-color);
                    float:left;
                    @apply --shadow-elevation-2dp;
                    padding:20px;
                    display:flex;
                    flex-flow: column nowrap;
                    align-items: flex-start;
                    height: 100%;
                    width: 100%;
                }

                .card-title-container{
                    padding: 8px 0;
                    height: 34px;
                }

                .card-title{
                    margin: 0;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    -webkit-font-smoothing: antialiased;
                    font-family: 'Roboto',Helvetica,Arial,sans-serif;
                    font-size: 14px;
                    letter-spacing: .15px;
                    color: var(--app-text-color);
                    font-weight: 500;
                    letter-spacing: 0;
                    line-height: 16px;
                    -webkit-box-ordinal-group: 0;
                    -webkit-order: 0;
                    order: 0;
                }

                .card-title iron-icon{
                    width:16px;
                    width: 16px;
                    color: var(--app-text-color-disabled);
                }

                .has-unread {
                    font-weight: bold;
                }

                paper-item {
                    outline: 0;
                    cursor: pointer;
                    --paper-item: {
                        margin: 0;
                    };
                    --paper-item-selected: {
                        background: rgba(0, 0, 0, 0);
                        color: var(--app-secondary-color);
                    };
                    --paper-item-focused: {
                        background: rgba(0, 0, 0, 0);
                        color: var(--app-secondary-color);
                    };
                    --paper-item-focused-before: {
                        background: rgba(0, 0, 0, 0);
                    }
                }

                paper-listbox:focus {
                    outline: 0;
                }

                .sublist {
                    padding-left: 20px;
                    outline: 0;

                }

                .sublist paper-item {
                    --paper-item-min-height: 28px;
                }

                vaadin-grid {
                    height: calc(100% - 16px - 32px - 50px);
                    width: 100%;
                    box-shadow: var(--app-shadow-elevation-1);
                    border: none;
                    box-sizing: border-box;
                }

                vaadin-grid.material {
                    outline: 0 !important;
                    font-family: Roboto, sans-serif;
                    background: rgba(0, 0, 0, 0);
                    border: none;
                    --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                    --vaadin-grid-cell: {
                        padding: 8px;
                    };

                    --vaadin-grid-header-cell: {
                        height: 48px;
                        padding: 11.2px;
                        color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                        font-size: 12px;
                        background: rgba(0, 0, 0, 0);
                        border-top: 0;
                    };

                    --vaadin-grid-body-cell: {
                        height: 48px;
                        color: rgba(0, 0, 0, var(--dark-primary-opacity));
                        font-size: 13px;
                    };

                    --vaadin-grid-body-row-hover-cell: {
                        background-color: var(--paper-grey-200);
                    };

                    --vaadin-grid-body-row-selected-cell: {
                        background-color: var(--paper-grey-100);
                    };

                    --vaadin-grid-focused-cell: {
                        box-shadow: none;
                        font-weight: bold;
                    };

                }

                vaadin-grid.material .cell {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding-right: 8px;
                }

                vaadin-grid.material .cell.last {
                    padding-right: 8px;
                }

                vaadin-grid.material .cell.numeric {
                    text-align: right;
                }

                vaadin-grid.material paper-checkbox {
                    --primary-color: var(--paper-indigo-500);
                    margin: 0 24px;
                }

                vaadin-grid.material vaadin-grid-sorter {
                    --vaadin-grid-sorter-arrow: {
                        display: none !important;
                    };
                }

                vaadin-grid.material vaadin-grid-sorter .cell {
                    flex: 1;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                vaadin-grid.material vaadin-grid-sorter iron-icon {
                    transform: scale(0.8);
                }

                vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                    color: rgba(0, 0, 0, var(--dark-disabled-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction] {
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                    transform: scale(0.8) rotate(180deg);
                }

                vaadin-grid.material::slotted(div) {
                    outline: 0 !important;
                    background: red;
                }

                paper-checkbox {
                    --paper-checkbox-unchecked-color: var(--app-text-color);
                    --paper-checkbox-label-color: var(--app-text-color);
                    --paper-checkbox-checked-color: var(--app-secondary-color);
                    --paper-checkbox-checked-ink-color: var(--app-secondary-color-dark);
                }

                .buttons{
                    padding-bottom: 10px;
                }

                .modal-button--delete{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-background-color-light);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;
                }

                .modal-button{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-background-color-light);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;
                }

                #del-button {
                    position: absolute;
                    left: 51%;
                    top: 30px;
                    z-index: 1;
                    height: 35px;
                }

                #restore-button {
                    position: absolute;
                    left: 53%;
                    top: 30px;
                    z-index: 1;
                    height: 35px;
                }

                #mail-list {
                    padding-right: 0;
                    margin-right: 0;
                    height: 100%;
                }

                .get-msg-btn{
                    margin-bottom: 16px;
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: 100%;
                        margin: 0 auto;
                        font-size: 14px;
                        font-weight: bold;
                        text-transform: capitalize;
                    };
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                }
                paper-spinner.center {
                    z-index: 999999;
                    position: fixed;
                    left: 33vw;
                    top: 150px;
                }
                @media screen and (max-width:1025px) {
                    .col-right {
                        width: 100vw;
                    }
                }

            </style>
        </custom-style>
        <template is="dom-if" if="[[selectList]]">
            <div class="second-panel col-right">
                <paper-spinner class="center" active="[[isLoadingMailList]]"></paper-spinner>

                <paper-icon-button id="del-button" icon="delete" on-tap="_removeMsgs"></paper-icon-button>
                <paper-tooltip for="del-button">[[localize('del','Delete',language)]]</paper-tooltip>
                <paper-icon-button id="restore-button" icon="icons:undo" on-tap="_restoreMsgs" hidden></paper-icon-button>


                <vaadin-grid id="mail-list" class="material" multi-sort="[[multiSort]]" active-item="{{activeItem}}" items="[[messages]]" on-tap="click" selection-mode="multi" width="100%">
                    <vaadin-grid-selection-column id="mail-list-selection-column"></vaadin-grid-selection-column>
                    <template is="dom-if" if="[[selectList.selection.item]] != 'sentbox'">
                        <vaadin-grid-column flex-grow="2">
                            <template class="header">
                                <vaadin-grid-sorter path="fromAddress">[[localize('sen','Sender',language)]]
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell frozen">[[item.fromAddress]]</div>
                            </template>
                        </vaadin-grid-column>
                    </template>
                    <vaadin-grid-column flex-grow="1">
                        <template class="header">
                            <div>[[localize('dat','Date',language)]]</div>
                        </template>
                        <template>
                            <div class="cell frozen">[[_timeFormat(item.received)]]</div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="3">
                        <template class="header">
                            <vaadin-grid-sorter class="cell frozen" path="subject">
                                [[localize('sub','Subject',language)]]
                            </vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class="cell frozen">[[item.subject]]</div>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </div>
        </template>
    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import filterExParser from '../../../scripts/filterExParser';

        class HtMsgList extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-list';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    selectedMessages: {
                        type: Object,
                        notify: true
                    },
                    activeItem: {
                        type: Object,
                        observer: '_activeItemChanged'
                    },
                    messages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectList: {
                        type: Object
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        }
                    },
                    listTitle:{
                    	type: String
                    },
                    isLoadingMailList: {
                        type: Boolean,
                        value: false
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return ['_refresh(selectList,selectList.*)'];
            }

            ready() {
                super.ready();
            }

			_newMsg(){
				this.dispatchEvent(new CustomEvent('selection-messages-change', { detail: { selection: { item: null } } }));
				this.findMessagesByTransportGUID('SENTBOX:*').then(messages => this.set('messages', messages || []));
			}

            getInbox() {
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    return this.sortByDatesAndGUID(messages.rows);
                }).then(messages => this.set('messages', messages || []));
            }

            getUnreadEmail() {
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (!(m.status && 1 << 1 == 0)) {//status unread
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg);
                }).then(messages => this.set('messages', messages || []));
            }

            getSentMessages() {
                this.api.message().findMessagesByToAddress('SENTBOX', null, null, 1000).then(messages => {
                    return this.sortByDates(messages.rows);
                }).then(messages => this.set('messages', messages || []));
            }

            getSubmitMessages(){
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (!(m.status && 1 << 8 == 0)) {//status STATUS_SUBMITTED
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg);
                }).then(messages => this.set('messages', messages || []));
            }

            getLabResult(){
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (!(m.status && 1 << 0 == 0)) {//status labResult
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg);
                }).then(messages => this.set('messages', messages || []));
            }

            getReport(){
                this.findMessagesByTransportGUID('REPORT:OUT:*').then(messages => this.set('messages', messages || []));

            }

            getEInv(){
                console.log(this.messages)
                this.api.message().findMessagesByTransportGuid('EFACT:OUT:*', null, null, 1000).then(messages => {
                    console.log(messages.rows)
                    return this.sortByDates(messages.rows);
                }).then(messages => this.set('messages', messages || []));
            }

            getReportIn(){
                this.findMessagesByTransportGUID('REPORT:IN:*').then(messages => this.set('messages', messages || []));
            }

            getMycarenetIn() {
                this.findMessagesByTransportGUID('GMD:IN:*').then(messages => this.set('messages', messages || []));
            }

            getEInvIn(){
                this.findMessagesByTransportGUID('EFACT:IN:*').then(messages => this.set('messages', messages || []));
            }

            getEheIn(){
                this.findMessagesByTransportGUID('INBOX:*').then(messages => this.set('messages', messages || []));
            }

			getChap4In(){
				this.findMessagesByTransportGUID('CHAP4IN:*').then(messages => this.set('messages', messages || []));
			}

            getProtIn(){
                this.findMessagesByTransportGUID('BININBOX:*').then(messages => this.set('messages', messages || []));
            }

            getEheOut(){
                this.findMessagesByTransportGUID('SENTBOX:*').then(messages => this.set('messages', messages || []));
            }

			getChap4Out(){
				this.findMessagesByTransportGUID('CHAP4OUT:*').then(messages => this.set('messages', messages || []));
			}

            getProtOut(){
                this.findMessagesByTransportGUID('BINSENTBOX:*').then(messages => this.set('messages', messages || []));
            }

            getEFactBatch(){
                this.findMessagesByTransportGUID('EFACT:BATCH:*').then(messages => this.set('messages', messages || []));
            }

            getGMD(){
                this.findMessagesByTransportGUID('GMD:IN:*').then(messages => this.set('messages', messages || []));
            }

            getEhealthMessages(){
				// return this.findMessagesByTransportGUID('SENTBOX:*', null, null, 1000)
                //     .then(messages => this.set('messages', messages || []));

				this.api.message().findMessagesByTransportGuid('SENTBOX:*', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (!(m.status && 1 << 8 == 0)) {//status STATUS_SUBMITTED
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg);
                }).then(messages => this.set('messages', messages || []));
            }

            getTrash(){
				return this.findMessagesByTransportGUIDs(['BININBOX:*','BINSENTBOX:*'], null, null, 1000)
					.then(messages => this.set('messages', messages || []));
            }

            findMessagesByTransportGUID(guid){
                return this.api.message().findMessagesByTransportGuid(guid, null, null, 1000).then(messages => {
                    return this.sortByDatesAndGUID(messages.rows);
                })
            }

            findMessagesByTransportGUIDs(guids){
				let p = []
				guids.forEach(guid => {
					p.push(this.findMessagesByTransportGUID(guid))
				});
                return Promise.all(p).then(items =>{
                	let results = [];
                	items.forEach(item => results = results.concat(item));
                    return results;
                });
            }

            _refresh() {
                if (this.selectList && this.selectList.selection) {
                    this.set('isLoadingMailList', true)
                	let item = this.selectList.selection.item
					if(!['newMsg','Refresh'].includes(item)) this.setListTitle(item);
					let restoreButton = this.shadowRoot.querySelector('#restore-button');
					restoreButton && (restoreButton.hidden = true);
                    switch (item) {
                        case 'newMsg':
                        	this._newMsg();
                        	break;
                        case 'inbox' :
                            this.getInbox();
                            break;
                        case 'unread' :
                            this.getUnreadEmail();
                            break;
                        case 'sentbox' :
                            this.getSentMessages();
                            break;
                        case 'submit' :
                            this.getSubmitMessages();
                            break;
                        case 'labResult' :
                            this.getLabResult();
                            break;
                        case 'reportOut' :
                            this.getReport();
                            break;
                        case 'e_invOut' :
                            this.getEInv();
                            break;
                        case 'ehealthMessages' :
                            this.getEhealthMessages();
                            break;
                        case 'e_invIn' :
                            this.getEInvIn();
                            break;
                        case 'reportIn' :
                            this.getReportIn();
                            break;
                        case 'eheIn' :
                            this.getEheIn();
                            break;
                        case 'mycarenet' :
                            this.getMycarenetIn();
                            break;
                        case 'Chap4In' :
                        	this.getChap4In();
                        	break;
                        case 'protIn' :
                            this.getProtIn();
                            break;
                        case 'eheOut' :
                            this.getEheOut();
                            break;
                        case 'protOut' :
                            this.getProtOut();
                            break;
                        case 'EFactBatch' :
                            this.getEFactBatch();
                            break;
                        case 'GMD' :
                            this.getGMD();
                            break;
                        case 'trash' :
							restoreButton && (restoreButton.hidden = false);
                        	this.getTrash();
                        	break;
                        case 'Refresh':
                        	// Fake selection to refresh binding
                        	break;
                    }
                }
            }

            sortByDates(messages){
                this.set('isLoadingMailList', false)
				return messages.sort(function (a, b) {
					return b.received - a.received ;
				});
			}

			sortByDatesAndGUID(messages){
                this.set('isLoadingMailList', false)
				return messages.sort(function (a, b) {
					if(b.received === a.received){
						let bGuid = b.transportGuid.split(":")[1] || "";
						let aGuid = a.transportGuid.split(":")[1] || "";
						return bGuid > aGuid? 1: -1;
                    }
                    else{
                    	return b.received - a.received;
                    }
                });
			}

            getToAddresses(item){
                return item.toAddresses.reduce((acc, i) =>{return acc + ", " + i}, "" )
            }

            click(e) {
                const selected = this.activeItem;
                this.set('selectedMessages', selected);
                this.dispatchEvent(new CustomEvent('selection-messages-change', { detail: { selection: { item: this.selectedMessages } } }));
            }

			_removeMsgs(){
				let mailListSelectionColumn = this.shadowRoot.querySelector('#mail-list-selection-column');
				let mailList = this.shadowRoot.querySelector('#mail-list');
				let msgs = mailList.selectedItems;
				if(msgs) {
                    msgs.forEach(msg =>{
                            if(msg.transportGuid.startsWith("BIN")){
                                this.api.message().deleteMessages(msg.id)
                                    .then(() => {
										this._refresh();
                                    	this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } }))
									});
                            } else {
								msg.transportGuid = "BIN" + msg.transportGuid;
                                this.api.message().modifyMessage(msg)
                                    .then(() => {
										this._refresh();
                                    	this.dispatchEvent(new CustomEvent('item-delete', {detail: {selection: {item: "Refresh"}}}))
									});
                            }
                    });
					mailListSelectionColumn.selectAll = false;
				}
            }

			_restoreMsgs(){
				let mailList = this.shadowRoot.querySelector('#mail-list');
				let msgs = mailList.selectedItems;
				console.log(msgs);
				if(msgs) {
					msgs.forEach(msg =>{
						while(msg.transportGuid.startsWith("BIN")){
							msg.transportGuid = msg.transportGuid.substring(3);
						}
						this.api.message().modifyMessage(msg)
                            .then(()=> this._refresh());
                    })
				}
			}

            _timeFormat(date) {
                return date && this.api.moment(date).format('DD/MM/YYYY') || '';
            }

			_activeItemChanged(item){
                let mailList = this.shadowRoot.querySelector('#mail-list');
                if(mailList) mailList.selectedItems = item ? [item] : [];
            }

            setListTitle(title){
            	this.set("listTitle",this.localize("boxtitle." + title,'List',this.language))
            }

            _displayRestoreButton(){
                return (this.selectList.selection.item == 'trash')
            }

		}

        customElements.define(HtMsgList.is, HtMsgList);
    </script>
</dom-module>
