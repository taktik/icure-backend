<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<link rel="import" href="../ht-spinner/ht-spinner.html">

<dom-module id="ht-msg-list">
    <template>
        <custom-style>
            <style include="shared-styles">
                :host {
                    display: flex;
                    flex-direction: column;
                    z-index:0;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                .new-msg-btn {
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: 80%;
                        margin: 0 auto;
                        height: 48px;
                        text-transform: capitalize;
                    };
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                }

                .boxes-list {
                    margin: 20px auto;
                    padding: 0;
                    min-width: 80%;
                }

                .col-right {
                    position: relative;
                    box-sizing: border-box;
                    grid-column: 2 / span 1;
                    grid-row: 1 / span 1;
                    background:var(--app-background-color);
                    float:left;
                    padding: 12px 20px;
                    padding-top: 0;
                    display:flex;
                    flex-flow: column nowrap;
                    align-items: flex-start;
                    height: calc(100% - 56px);
                    width: calc(100vw - 38%)
                }

                .card-title-container{
                    padding: 8px 0;
                    height: 34px;
                }

                .card-title{
                    margin: 0;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    -webkit-font-smoothing: antialiased;
                    font-family: 'Roboto',Helvetica,Arial,sans-serif;
                    font-size: 14px;
                    letter-spacing: .15px;
                    color: var(--app-text-color);
                    font-weight: 500;
                    letter-spacing: 0;
                    line-height: 16px;
                    -webkit-box-ordinal-group: 0;
                    -webkit-order: 0;
                    order: 0;
                }

                .card-title iron-icon{
                    width:16px;
                    width: 16px;
                    color: var(--app-text-color-disabled);
                }

                .has-unread {
                    font-weight: bold;
                }

                paper-item {
                    outline: 0;
                    cursor: pointer;
                    --paper-item: {
                        margin: 0;
                    };
                    --paper-item-selected: {
                        background: rgba(0, 0, 0, 0);
                        color: var(--app-secondary-color);
                    };
                    --paper-item-focused: {
                        background: rgba(0, 0, 0, 0);
                        color: var(--app-secondary-color);
                    };
                    --paper-item-focused-before: {
                        background: rgba(0, 0, 0, 0);
                    }
                }

                paper-listbox:focus {
                    outline: 0;
                }

                .sublist {
                    padding-left: 20px;
                    outline: 0;

                }

                .sublist paper-item {
                    --paper-item-min-height: 28px;
                }

                vaadin-grid {
                    height: calc(100% - 16px - 32px - 50px);
                    width: 100%;
                    box-shadow: var(--app-shadow-elevation-1);
                    border: none;
                    box-sizing: border-box;
                }

                vaadin-grid.material {
                    outline: 0 !important;
                    font-family: Roboto, sans-serif;
                    background: rgba(0, 0, 0, 0);
                    border: none;
                    --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                    --vaadin-grid-cell: {
                        padding: 8px;
                    };

                    --vaadin-grid-header-cell: {
                        height: 48px;
                        padding: 11.2px;
                        color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                        font-size: 12px;
                        background: rgba(0, 0, 0, 0);
                        border-top: 0;
                    };

                    --vaadin-grid-body-cell: {
                        height: 48px;
                        color: rgba(0, 0, 0, var(--dark-primary-opacity));
                        font-size: 13px;
                    };

                    --vaadin-grid-body-row-hover-cell: {
                        background-color: var(--paper-grey-200);
                    };

                    --vaadin-grid-body-row-selected-cell: {
                        background-color: var(--paper-grey-100);
                    };

                    --vaadin-grid-focused-cell: {
                        box-shadow: none;
                        font-weight: bold;
                    };

                }

                vaadin-grid.material .cell {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding-right: 8px;
                }

                vaadin-grid.material .cell.last {
                    padding-right: 8px;
                }

                vaadin-grid.material .cell.numeric {
                    text-align: right;
                }

                vaadin-grid.material paper-checkbox {
                    --primary-color: var(--paper-indigo-500);
                    margin: 0 24px;
                }

                vaadin-grid.material vaadin-grid-sorter {
                    --vaadin-grid-sorter-arrow: {
                        display: none !important;
                    };
                }

                vaadin-grid.material vaadin-grid-sorter .cell {
                    flex: 1;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                vaadin-grid.material vaadin-grid-sorter iron-icon {
                    transform: scale(0.8);
                }

                vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                    color: rgba(0, 0, 0, var(--dark-disabled-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction] {
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                    transform: scale(0.8) rotate(180deg);
                }

                vaadin-grid.material::slotted(div) {
                    outline: 0 !important;
                    background: red;
                }

                paper-checkbox {
                    --paper-checkbox-unchecked-color: var(--app-text-color);
                    --paper-checkbox-label-color: var(--app-text-color);
                    --paper-checkbox-checked-color: var(--app-secondary-color);
                    --paper-checkbox-checked-ink-color: var(--app-secondary-color-dark);
                }

                .buttons{
                    padding-bottom: 10px;
                }

                .modal-button--delete{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-background-color-light);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;
                }

                .modal-button{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-background-color-light);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;
                }

                .table-top {
                    width: calc(100vw - 38%);
                    min-height: 56px;
                    display: flex;
                    flex-direction: row;
                    justify-content: flex-end;
                }
                .table-top > .checkbox {
                    width: 16px;
                    margin-left: 20px;
                    display: flex;
                    justify-content: space-around;
                    padding-left: 12px;
                    flex-direction: column;
                }
                .table-top > div {
                    display: flex;
                    flex-direction: row;
                    z-index: 1;
                }
                .table-top > div > div {
                    text-align: center;
                }
                .table-top > div.indicators {
                    justify-content: flex-end;
                    padding-right: 24px;
                }
                .table-top > div.indicators > div {
                    display: flex;
                    flex-direction: column;
                    padding: 8px;
                }
                .table-top > div.indicators > div > * {
                    margin: 0 auto;
                }
                .table-top > div.indicators > div#stamp-indicator.hasNew span {color: var(--app-secondary-color);}
                .table-top > div.indicators > div#capacity-indicator > * {
                    display: inline-block;
                }
                .table-top > div.actions {
                    flex-grow: 1;
                    margin: 0 16px;
                }
                .table-top paper-dropdown-menu#filterLabresult {
                    min-width: 256px;
                    margin-left: 22%;
                }

                .table-top > div.actions paper-icon-button {
                    margin: 8px 0;
                }

                .mb4 {
                    margin-bottom: 4px !important;
                }

                .mb4 iron-icon{
                    opacity: 0.7;
                    margin-right: 4px;
                }

                .mb4 span{
                    font-size: 12px;
                    font-weight: 400;
                }

                paper-progress {
                    --paper-progress-active-color: var(--app-secondary-color);
                }

                paper-progress.full {
                    --paper-progress-active-color: var(--app-error-color);
                }

                #actions-spinner {
                    position: absolute;
                    right: 148px;
                    top: 30px;
                    z-index: 1;
                    height: 35px;
                }

                #mail-list {
                    padding-right: 0;
                    margin-right: 0;
                    flex-grow: 1;
                    margin-bottom: 16px;
                    transition: opacity .25s ease;
                }

                #mail-list iron-icon{
                    color: var(--app-text-color);
                    height: 18px;
                    width: 18px;
                    padding: 4px;
                }

                .labicon {
                    content: '';
                    display: block;
                    height: 8px;
                    width: 8px;
                    margin: 0 auto;
                    border-radius: 50%;
                    background: var(--app-status-color-ok);
                }
                .labicon.unassigned-true {
                    background: var(--app-status-color-nok);
                }
                .actions .labicon {
                    margin: 8px;
                }

                .get-msg-btn{
                    margin-bottom: 16px;
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: 100%;
                        margin: 0 auto;
                        font-size: 14px;
                        font-weight: bold;
                        text-transform: capitalize;
                    };
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                }
                ht-spinner.center {
                    z-index: 999999;
                    position: fixed;
                    height: 42px;
                    width: 42px;
                    margin: 6px;
                }

                paper-button.change-page {
                    cursor: pointer;
                    width: 36px;
                    height: 28px;
                    min-width: 0;
                    border: 1px solid var(--app-background-color-darker);
                }
                .selector {
                    overflow-x: auto;
                    overflow-y: hidden;
                    white-space: nowrap;
                    max-width: 360px;
                }

                paper-button.page-number {
                    margin: 0 4px;
                    background: var(--app-background-color-dark);
                    border: 0;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    text-align: center;
                    box-sizing: border-box;
                    padding: 0 !important;
                    cursor: pointer;
                    min-width: 0;
                }
                paper-button.page-number[selected] {
                    background: var(--app-secondary-color);
                }

                div.bottom-commands {
                    display: flex;
                    width: 100%;
                    justify-content: flex-end;
                }

                div.bottom-commands > div.grid-size-indicator {
                    border-left: 1px solid var(--app-background-color-darker);
                    max-width: 208px;
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                }

                div.bottom-commands > * {
                    margin-left: 8px;
                    padding-left: 4px;
                }

                .scroll-top {
                    background: var(--app-secondary-color);
                    padding: 0 4px !important;
                    height: 24px;
                    width: 24px;
                    box-sizing: border-box;
                    border-radius: 50%;
                }

                @media screen and (max-width:1696px) {
                    .table-top paper-dropdown-menu#filterLabresult {
                        margin-left: 0;
                    }
                }

                @media screen and (max-width:1025px) {
                    .col-right {
                        width: 100vw;
                        transition: all .5s ease;
                        box-shadow: none;
                    }

                    ht-spinner.center {
                        left: 50vw;
                    }
                }

                @media screen and (max-width: 800px) {
                    .table-top paper-dropdown-menu#filterLabresult {
                        min-width: 0;
                        margin-left: initial;
                    }
                    .mb4 span {
                        display: none;
                    }
                    
                    #capacity-indicator paper-progress {
                        width: 64px;
                    }

                    .table-top paper-dropdown-menu#filterLabresult {
                        min-width: 0;
                        margin-left: initial;
                    }
                }

            </style>
        </custom-style>
        <template is="dom-if" if="[[selectList]]">
            <div class="table-top">
                <div class="checkbox">
                    <vaadin-checkbox id="checkerAll" on-tap="_toggleSelectAll" checked$="[[allSelected]]"></vaadin-checkbox>
                </div>

                <div class="actions">
                    <template is="dom-if" if="[[!checkedMessages.length]]">
                        <template is="dom-if" if="[[refreshAllowed]]">
                            <paper-icon-button id="refresh-button" icon="icons:refresh" on-tap="_refresh" disabled="[[!refreshAllowed]]"></paper-icon-button>
                            <paper-tooltip for="refresh-button" offset="2">[[localize('refresh','Refresh',language)]]</paper-tooltip>
                        </template>
                        <!--<template is="dom-if" if="[[!refreshAllowed]]">[[localize('refresh_delay','Refresh delay',language)]]: 10min</template>-->
                    </template>
                    <template is="dom-if" if="[[checkedMessages.length]]">
                        <template is="dom-if" if="[[!_isEqual(selectList.selection.item,'trash')]]">
                            <template is="dom-if" if="[[!_isEqual(selectList.selection.item,'hidden')]]">
                                <paper-icon-button id="hide-button" icon="visibility-off" on-tap="_hideMsg"></paper-icon-button>
                                <paper-tooltip for="hide-button" offset="2">[[localize('hide_sel','Hide selected',language)]]</paper-tooltip>
                            </template>
                        </template>
                        <template is="dom-if" if="[[_isEqual(selectList.selection.item,'hidden')]]">
                            <paper-icon-button id="show-button" icon="undo" on-tap="_restoreMsgs"></paper-icon-button>
                            <paper-tooltip for="show-button" offset="2">[[localize('restore','Restore',language)]]</paper-tooltip>
                        </template>
                        <template is="dom-if" if="[[!_isEqual(selectList.selection.item,'trash')]]">
                            <paper-icon-button id="del-button" icon="delete" on-tap="_msgToBin"></paper-icon-button>
                            <paper-tooltip for="del-button" offset="2">[[localize('del_sel','Delete selected',language)]]</paper-tooltip>
                        </template>
                        <template is="dom-if" if="[[_isEqual(selectList.selection.item,'trash')]]">
                            <paper-icon-button id="restore-button" icon="undo" on-tap="_outOfBin"></paper-icon-button>
                            <paper-tooltip for="restore-button" offset="2">[[localize('restore','Restore',language)]]</paper-tooltip>
                            <paper-icon-button id="del-for-button" icon="delete-forever" on-tap="_deleteMsgsForever"></paper-icon-button>
                            <paper-tooltip for="del-for-button" offset="2">[[localize('del_forever','Delete forever',language)]]</paper-tooltip>
                        </template>
                    </template>
                    <template is="dom-if" if="[[isLabresultBox]]">
                        <paper-dropdown-menu id="filterLabresult" label="[[localize('filter','Filter',language)]]">
                            <paper-listbox selected="{{selectedLabFilter}}" slot="dropdown-content">
                                <paper-item class="link" on-tap="getLabResult">[[localize('show_all','Show all',language)]]</paper-item>
                                <paper-item class="link" on-tap="getUnassigned"><div class="labicon unassigned-true" id="show-unassigned"></div> [[localize('unassigned_labresults','unassigned lab results',language)]]</paper-item>
                                <paper-item class="link" on-tap="getAssigned"><div class="labicon unassigned-false" id="show-assigned"></div> [[localize('assigned_labresults','assigned lab results',language)]]</paper-item>
                            </paper-listbox >
                        </paper-dropdown-menu>
                        <!--<paper-tooltip for="show-all" offset="0">[[localize('buff_msgs','buffered msgs',language)]]</paper-tooltip>-->
                        <!--<paper-tooltip for="show-unassigned" offset="0">[[localize('unassigned_labresults','unassigned lab results',language)]]</paper-tooltip>-->
                        <!--<paper-tooltip for="show-assigned" offset="0">[[localize('assigned_labresults','assigned lab results',language)]]</paper-tooltip>-->
                        <!--[[localize('assigned_labresults','assigned lab results',language)]]-->
                    </template>
                </div>

                <div class="indicators">
                    <template is="dom-if" if="[[!_isEqual(bufferedMsgs,0)]]">
                        <div id="stamp-indicator" class="stamp-indicator hasNew"><iron-icon icon="warning"></iron-icon><span class="label">[[bufferedMsgs]]</span></div>
                        <paper-tooltip for="stamp-indicator" offset="0">[[localize('buff_msgs','buffered msgs',language)]]</paper-tooltip>
                    </template>

                    <div id="capacity-indicator">
                        <div class="mb4"><iron-icon icon="cloud"></iron-icon>
                            <span>
                                <template is="dom-if" if="[[ehealthSession]]">
                                    [[localize('mail_cap','mailbox capacity',language)]] ([[capacityPercent]]%)
                                </template>
                                <template is="dom-if" if="[[!ehealthSession]]">
                                    [[localize('ehe_is_not_con','eHealth is not connected',language)]]
                                </template>
                            </span>
                        </div>
                        <template is="dom-if" if="[[ehealthSession]]"><paper-progress value$="[[capacityPercent]]" min="0" max="100" class$="[[_mailBoxCapacityColor]]"></paper-progress></template>
                    </div>
                    <template is="dom-if" if="[[actualCapacity]] >= 100">
                        <template is="dom-if" if="[[ehealthSession]]">
                            <paper-tooltip for="capacity-indicator" offset="0">[[actualCapacity]]%</paper-tooltip>
                        </template>
                    </template>
                </div>

            </div>
            <div class="second-panel col-right">
                <ht-spinner class="center" active="[[isLoadingMailList]]"></ht-spinner>
                <vaadin-grid id="mail-list" class="material" multi-sort="[[multiSort]]"
                             active-item="{{activeItem}}" items="[[messages]]"
                             on-tap="click" on-removed-opened="_deselectMessages"
                             selection-mode="multi" width="100%" pageSize="50">
                    <template is="dom-if" if="[[selectList.selection.item]] != 'sentbox'">
                        <vaadin-grid-column flex-grow="0" width="46px">
                            <template>
                                <vaadin-checkbox on-checked-changed="_itemSelected" data-item$="[[item]]" class="checkbox"></vaadin-checkbox>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="44px">
                            <template class="header">
                                <iron-icon id="hasLab-header" icon="icons:assignment"></iron-icon>
                                <paper-tooltip position="right" for="hasLab-header">[[localize('boxtitle.labResult','Lab results',language)]]</paper-tooltip>
                            </template>
                            <template>
                                <template is="dom-if" if="[[hasLabResult(item)]]">
                                    <div id="hasLab-[[item.id]]" class$="labicon unassigned-[[isUnassigned(item)]]"></div>
                                    <template is="dom-if" if="[[isUnassigned(item)]]">
                                        <paper-tooltip position="right" for="hasLab-[[item.id]]">[[localize('un_attachs','Unassigned Lab Results',language)]]</paper-tooltip>
                                    </template>
                                    <template is="dom-if" if="[[!isUnassigned(item)]]">
                                        <paper-tooltip position="right" for="hasLab-[[item.id]]">[[localize('boxtitle.labResult','Lab results',language)]]</paper-tooltip>
                                    </template>
                                </template>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="104px">
                            <template class="header">
                                <vaadin-grid-sorter path="received" direction="asc">[[localize('dat','Date',language)]]</vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell frozen">[[_timeFormat(item.received)]]</div>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="0" width="48px">
                            <template class="header">
                                <iron-icon icon="mail" id="unread-icon"></iron-icon>
                                <paper-tooltip position="right" for="unread-icon">[[localize('is_read','read',language)]]/[[localize('is_not_read','not read',language)]]</paper-tooltip>
                            </template>
                            <template>
                                <template is="dom-if" if="[[!isUnread(item)]]">
                                    <iron-icon icon="done" id="read-[[item.id]]"></iron-icon>
                                    <paper-tooltip position="right" for="read-[[item.id]]">[[localize('is_read','read',language)]]</paper-tooltip>
                                </template>
                                <template is="dom-if" if="[[isUnread(item)]]">
                                    <iron-icon icon="mail" id="unread-[[item.id]]"></iron-icon>
                                    <paper-tooltip position="right" for="unread-[[item.id]]">[[localize('is_not_read','not read',language)]]</paper-tooltip>
                                </template>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="1">
                            <template class="header">
                                <vaadin-grid-sorter path="fromAddress"><b>[[localize('sen','Sender',language)]]</b>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell frozen">
                                    <template is="dom-if" if="[[!isUnread(item)]]">
                                        [[item.fromAddress]]
                                    </template>
                                    <template is="dom-if" if="[[isUnread(item)]]">
                                        <span class="unread-msg" id="unread-[[item.id]]-title">[[item.fromAddress]]</span>
                                        <paper-tooltip position="left" for="unread-[[item.id]]-title">[[localize('is_not_read','not read',language)]]</paper-tooltip>
                                    </template>
                                </div>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column flex-grow="3">
                            <template class="header">
                                <vaadin-grid-sorter path="subject">[[localize('sub','Subject',language)]]
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell frozen">
                                    [[item.subject]]
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <template is="dom-if" if="[[hasLabResult(item)]]">
                            <vaadin-grid-column flex-grow="1">
                                <template class="header">
                                    [[localize('pat','Patient',language)]]
                                </template>
                                <template>
                                    <template is="dom-repeat" items="[[_getResInfos(msg)]]" as="resInfo">[[resInfo.firstName]] [[resInfo.lastName]], </template>
                                </template>
                            </vaadin-grid-column>
                        </template>

                        <vaadin-grid-column width="138px" flex-grow="0">
                            <template class="header">

                            </template>
                            <template>
                                <div style="text-align:right;">
                                    <template is="dom-if" if="[[isImportant(item)]]">
                                        <iron-icon id="important-[[item.id]]" icon="warning"></iron-icon>
                                        <paper-tooltip position="left" for="important-[[item.id]]">[[localize('significant','important',language)]]</paper-tooltip>
                                    </template>
                                    <template is="dom-if" if="[[isCrypted(item)]]">
                                        <iron-icon id="crypted-[[item.id]]" icon="lock"></iron-icon>
                                        <paper-tooltip position="left" for="crypted-[[item.id]]">[[localize('encrypted','encrypted',language)]]</paper-tooltip>
                                    </template>
                                    <template is="dom-if" if="[[hasAnnex(item)]]">
                                        <iron-icon id="hasAnnex-[[item.id]]" icon="editor:attach-file"></iron-icon>
                                        <paper-tooltip position="left" for="hasAnnex-[[item.id]]">[[localize('has_attach','Has attachments',language)]]</paper-tooltip>
                                    </template>
                                </div>
                            </template>
                        </vaadin-grid-column>
                    </template>
                </vaadin-grid>
                <div class="bottom-commands">
                    <template is="dom-if" if="[[!isLoadingMailList]]">
                        <span>[[localize('pages','Pages',language)]]&nbsp;:</span>
                        <div><paper-button id="previous-page-change" class="change-page" on-tap="_prevPage"><iron-icon icon="chevron-left"></iron-icon></paper-button></div>
                        <div id="page-selector" class="selector">
                            <template is="dom-repeat" items="[[pages]]">
                                <paper-button class="page-number" on-tap="_selectPage" data-item$="[[item]]" selected$="[[_isPage(page, item)]]">[[item]]</paper-button>
                            </template>
                        </div>
                        <div><paper-button id="next-page-change" class="change-page" on-tap="_nextPage"><iron-icon icon="chevron-right"></iron-icon></paper-button></div>
                        <div class="grid-size-indicator">[[gridSize]]&nbsp;[[localize('mes','Messages',language)]]
                            <template is="dom-if" if="[[!_isEqual(selectList.selection.item,'sentbox')]]"> ([[unreadCount]]&nbsp;[[localize('are_not_read','Unread',language)]])</template>
                        </div>
                        <div><paper-icon-button id="scrolltop" class="scroll-top" icon="arrow-upward" on-tap="_scrollToTop"></paper-icon-button></div>
                        <paper-tooltip for="previous-page-change" position="left" offset="5">[[localize('page_prev','Previous page',language)]]</paper-tooltip>
                        <paper-tooltip for="next-page-change" position="right" offset="-5">[[localize('page_next','Next page',language)]]</paper-tooltip>
                        <paper-tooltip for="scrolltop" position="left">[[localize('scrolltop_list','Scroll to top of the list',language)]]</paper-tooltip>
                    </template>
                </div>
            </div>
        </template>
    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';

        class HtMsgList extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-list';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    selectedMessages: {
                        type: Object,
                        notify: true
                    },
                    activeItem: {
                        type: Object,
                        observer: '_activeItemChanged'
                    },
                    messages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    selectList: {
                        type: Object
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        }
                    },
                    listTitle:{
                    	type: String
                    },
                    isLoadingMailList: {
                        type: Boolean,
                        value: false
                    },
                    checkedMessages: {
                        type: Array,
                        value: []
                    },
                    page: {
                        type: Number,
                        value: 1
                    },
                    pages: {
                        type: Array,
                        value: []
                    },
                    bufferedMsgs: {
                        type: Number,
                        value: 0
                    },
                    mailboxCapacity: {
                        type: Number,
                        value: 0
                    },
                    mailboxMaxCapacity: {
                        type: Number,
                        value: 0
                    },
                    capacityPercent: {
                        type: Number,
                        value: 0
                    },
                    isLabresultBox: {
                        type: Boolean,
                        value: false
                    },
                    allSelected: {
                        type: Boolean,
                        value: null
                    },
                    selectedLabFilter: {
                        type: Number,
                            value: 0
                    },
                    actualCapacity: {
                        type: Number,
                        value: 0
                    },
                    refreshAllowed: {
                        type: Boolean
                    },
                    gridSize: {
                        type: Number,
                        value: 0
                    },
                    ehealthSession: {
                        type: Boolean,
                        value: false
                    },
                    unreadCount: {
                        type: Number,
                        value: 0
                    },
                    pageStart: {
                        type: Number,
                        value: 0
                    },
                    pageEnd: {
                        type: Number,
                        value: 50
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return ['_refresh(selectList,selectList.*)','_messagesChanged(messages, page)','_getBoxCapacity(messages)','_isConnectedToEhbox(api.tokenId)'];
            }

            ready() {
                super.ready();
                this._isRefreshAllowed()
            }

            _isConnectedToEhbox() {
                this.set("ehealthSession", this.api.tokenId ? true : false)
            }

            _getBoxCapacity() {
                if (this.api.keystoreId && this.api.tokenId && this.api.credentials.ehpassword) {
                    this.api.fhc().Ehboxcontroller().getInfosUsingGET(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword)
                        .then(boxInfo=>{
                            this.set('bufferedMsgs',boxInfo.nbrMessagesInStandBy)
                            this.set('mailboxCapacity',boxInfo.currentSize)
                            this.set('mailboxMaxCapacity',boxInfo.maxSize)
                            this.set('actualCapacity',((this.mailboxCapacity / this.mailboxMaxCapacity)*100).toFixed(2))
                            if (this.actualCapacity >= 100) this.set('_mailBoxCapacityColor','full')
                            this.set('capacityPercent', this.actualCapacity <= 100 ? this.actualCapacity : '+100')
                        })
                }
            }

            _getResInfos(msg) {
                this.api.document().findByMessage(this.user.healthcarePartyId, msg)
                    .then(docs => {
                        if (docs.length) {
                            let resInfos = []
                            return docs.filter(doc => doc.id && doc.attachmentId && doc.secretForeignKeys)
                                .map(doc => {
                                    this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(this.user.healthcarePartyId, doc.id, _.size(doc.encryptionKeys) ? doc.encryptionKeys : doc.delegations).then(({extractedKeys: enckeys}) =>
                                        this.api.beresultimport().canHandle(doc.id,enckeys.join(',')).then(isResult => {
                                            if (isResult) {
                                                this.api.beresultimport().getInfos(doc.id, true, this.language || 'fr').then(resInfo =>{
                                                    resInfos.push(resInfo) // `${resInfo.sex} ${resInfo.firstName} ${resInfo.lastName} `
                                                })
                                            }
                                        })
                                    )
                                }) || resInfos
                        } else return ['N/A']
                    })
            }

            _isPage(page,item) {return page === item}
            _selectPage(e) {
                this.set('page',parseInt(e.target.dataset.item))
            }
            _prevPage() {
                if (this.page > 1) this.set('page',this.page - 1)
            }
            _nextPage() {
                if (this.page < this.pages.length) this.set('page',this.page + 1)
            }

            _messagesChanged(messages,page) {
                console.log('_messagesChanged')
                const grid = this.shadowRoot.getElementById('mail-list')
                if (grid && messages && page) {
                    this.set('gridSize',grid.size)
                    if (this.selectList.selection.item !== 'sentbox') {
                        this.set('unreadCount',messages.filter(m=>this.isUnread(m)).length)
                    }
                    // pagination starts here
                    const pageSize = grid.getAttribute('pageSize') || 50
                    this.set('pages',[])
                    const numberOfPages = Math.floor(messages.length / pageSize)
                    for (let i=0;i<numberOfPages;i++) this.push('pages',i+1)
                    if (!this.pages.length) this.push('pages',1)
                    let start = page == 1 ?  0 : page * pageSize;
                    let end = (page == 1 ? 1 : page + 1) * pageSize;
                    this.set('pageStart', start ||0)
                    this.set('pageEnd', end ||pageSize)
                    grid.items = messages.slice(start, end);
                    // pagination ends here
                    this._scrollToTop()
                }
                this._getBoxCapacity()
                this._deselectAll()
                this.set('isLoadingMailList', false)
            }

            _scrollToTop() {
                const grid = this.shadowRoot.getElementById('mail-list')
                if (grid) {
                    grid.style.opacity = 0
                    setTimeout(()=>grid._scrollToIndex(0),250) // timeOut for css transition
                    setTimeout(()=>grid.style.opacity = 1,500)
                }
            }

            _isRefreshAllowed() {
                const lastLoad = localStorage.getItem('lastEhboxRefresh') ? parseInt(localStorage.getItem('lastEhboxRefresh')) : -1
                const allowed = (lastLoad + (10*60000) <= Date.now() || lastLoad==-1) ? true : false
                this.set('refreshAllowed',allowed)
            }
			_newMsg(){
				this.dispatchEvent(new CustomEvent('selection-messages-change', { detail: { selection: { item: null } } }));
				this.findMessagesByTransportGUID('SENTBOX:*').then(messages => this.set('messages', messages || []));
			}

            getInbox() {
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    return this.sortByDatesAndGUID(messages.rows)
                        .filter(msg => msg.fromAddress !== 'EFACT')
                        .filter(msg => !msg.transportGuid.startsWith('BIN'))
                        .filter(msg => !msg.transportGuid.startsWith('GMD'))
                        .filter(m=>!m.transportGuid.startsWith('PROSE:'))
                        .filter(m=>!m.transportGuid.startsWith('HIDDEN:')) // legacy
                        .filter(m=>!((m.status&1<<14)!==0))
                }).then(messages => {
                    this.set('messages', _.orderBy(messages, ['received'], ['desc']))
                    this._deselectAll()
                });
            }

            getEheIn(){
                this.findMessagesByTransportGUID('INBOX:*').then(messages => {
                    let msgs = messages.filter(msg => !msg.transportGuid.startsWith('BIN'));
                    this.set('messages', msgs || [])
                });
            }

            isUnread(m) {
                return (m.status & (1 << 1)) !== 0 ? true : false
            }
            isImportant(m) {
                return (m.status & (1 << 2)) !== 0 ? true : false
            }
            isCrypted(m) {
                return (m.status & (1 << 3)) !== 0 ? true : false
            }
            hasAnnex(m) {
                return (m.status & (1 << 4)) !== 0 ? true : false
            }
            hasLabResult(m) {
                return Object.keys(m.assignedResults || {}).length || (m.unassignedResults || []).length ? true : false
            }
            isUnassigned(m) {
                return (m.unassignedResults && (m.unassignedResults.length > 0)) ? true : false
            }

            getUnreadEmail() {
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (this.isUnread(m)) {//status unread
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg).filter(msg => !msg.transportGuid.startsWith('BIN'));
                }).then(messages => this.set('messages', messages || []));
            }

            getSentMessages() {
                this.api.message().findMessagesByToAddress('SENTBOX', null, null, 1000).then(messages => {
                    return this.sortByDates(messages.rows)
                        .filter(msg => !msg.transportGuid.startsWith('BIN'))
                        .filter(m=>((m.status&1<<14)!==0) == false);
                }).then(messages => this.set('messages', messages || []));
            }

            getSubmitMessages(){
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (!(m.status & 1 << 8 == 0)) {//status STATUS_SUBMITTED
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg).filter(msg => !msg.transportGuid.startsWith('BIN'));
                }).then(messages => this.set('messages', messages || []));
            }

            getLabResult(){ // all labresult
                console.log('Unassigned || Assigned')
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (m.assignedResults && m.unassignedResults && (Object.keys(m.assignedResults).length >= 1 || m.unassignedResults.length >= 1)) {//status labResult
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg).filter(msg => !msg.transportGuid.startsWith('BIN')).filter(m=>(m.status&(1<<14)) !== 1);
                }).then(messages => {
                    this.set('messages', messages || [])
                    this._deselectAll()
                    this._isRefreshAllowed()
                });
            }
            _getPatsFromMsg(m) {
                this.api.document().findByMessage(this.user.healthcarePartyId, m).then(docs => {
                    if(docs.length) {
                        let unimportedPats = ''
                        return docs.filter(doc => doc.id && doc.attachmentId && doc.secretForeignKeys).map(doc => {
                            this.api.beresultimport().getInfos(doc.id).then(resultInfo=>{
                                if (resultInfo.length) {
                                    resultInfo.map(res => {
                                        unimportedPats+= res.firstName+' '+res.lastName+', '
                                    })
                                    return unimportedPats+(resultInfo.length>1)?'...':''
                                } else {
                                    return ''
                                }
                            })
                        })
                    }
                })
            }

            getReport(){
                // this.findMessagesByTransportGUID('REPORT:OUT:*').then(messages => {
                //     let msgs = messages.filter(msg => !msg.transportGuid.startsWith('BIN'));
                //     this.set('messages', msgs || [])
                // });
                console.log('sent labresult')
                this.api.message().findMessagesByToAddress('SENTBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        console.log(m,'sentlabres',m.status,(m.status & (1 << 0)) )
                        if (m.status & (1 << 0)) {//status labResult
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg).filter(msg => !msg.transportGuid.startsWith('BIN'));
                }).then(messages => this.set('messages', messages || []));
            }

            getEInv(){
                console.log(this.messages)
                this.api.message().findMessagesByTransportGuid('EFACT:OUT:*', null, null, 1000).then(messages => {
                    console.log(messages.rows)
                    return this.sortByDates(messages.rows).filter(msg => !msg.transportGuid.startsWith('BIN'));
                }).then(messages => this.set('messages', messages || []));
            }

            getReportIn(){
                this.findMessagesByTransportGUID('REPORT:IN:*').then(messages => {
                    let msgs = messages.filter(msg => !msg.transportGuid.startsWith('BIN'));
                    this.set('messages', msgs || [])
                });
            }

            getMycarenetIn() {
                this.findMessagesByTransportGUID('GMD:IN:*').then(messages => this.set('messages', messages || []));
            }

            getEInvIn(){
                this.findMessagesByTransportGUID('EFACT:IN:*').then(messages => this.set('messages', messages || []));
            }

			getChap4In(){
				this.findMessagesByTransportGUID('CHAP4IN:*').then(messages => this.set('messages', messages || []));
			}

            getAssigned(){ // assigned labresult
                console.log('Assigned')
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (m.assignedResults && m.unassignedResults && (Object.keys(m.assignedResults).length >= 1 && m.unassignedResults.length == 0)) acc.push(m)
                        return acc
                    }, [])
                    return this.sortByDates(msg).filter(m=>(m.status&(1<<14)) !== 1);
                }).then(messages => {
                    this.set('messages', messages || [])
                    this._deselectAll()
                    this._isRefreshAllowed()
                });
            }
            getUnassigned(){ // unassigned labresult
                console.log('Unassigned')
                this.api.message().findMessagesByToAddress('INBOX', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (m.unassignedResults &&  m.unassignedResults.length >= 1) acc.push(m)
                        return acc
                    }, [])
                    return this.sortByDates(msg).filter(msg => !msg.transportGuid.startsWith('BIN')).filter(m=>(m.status&(1<<14)) !== 1);
                }).then(messages => {
                    this.set('messages', messages || [])
                    this._deselectAll()
                    this._isRefreshAllowed()
                });
            }

            getEheOut(){
                this.findMessagesByTransportGUID('SENTBOX:*').then(messages => this.set('messages', messages || []));
            }

			getChap4Out(){
				this.findMessagesByTransportGUID('CHAP4OUT:*').then(messages => this.set('messages', messages || []));
			}

            getProtOut(){
                this.findMessagesByTransportGUID('BINSENTBOX:*').then(messages => this.set('messages', messages || []));
            }

            getEFactBatch(){
                this.findMessagesByTransportGUID('EFACT:BATCH:*').then(messages => this.set('messages', messages || []));
            }

            getGMD(){
                this.findMessagesByTransportGUID('GMD:IN:*').then(messages => this.set('messages', messages || []));
            }

            getEhealthMessages(){
				// return this.findMessagesByTransportGUID('SENTBOX:*', null, null, 1000)
                //     .then(messages => this.set('messages', messages || []));

				this.api.message().findMessagesByTransportGUIDs('SENTBOX:*', null, null, 1000).then(messages => {
                    const msg = messages.rows.reduce((acc, m) => {
                        if (!(m.status && 1 << 8 == 0)) {//status STATUS_SUBMITTED
                            acc.push(m)
                        }
                        return acc
                    }, [])
                    return this.sortByDates(msg).filter(m=>(m.status&(1<<14)) !== 1);
                }).then(messages => this.set('messages', messages || []));

            }

            getHidden(){
                return this.findMessagesByTransportGUIDs(['INBOX:*','SENTBOX:*','HIDDEN'], null, null, 1000) // 'hidden' needed for legacy
                    .then(messages => {
                        return this.sortByDatesAndGUID(messages)
                            .filter(m=>(((m.status&(1<<14)) !== 0) || m.transportGuid.startsWith('HIDDEN')))
                    })
                    .then(m=> this.set('messages', m || []) )
            }
            getTrash(){
				return this.findMessagesByTransportGUIDs(['BININBOX:*','BINSENTBOX:*'], null, null, 1000)
					.then(messages => this.set('messages', this.sortByDatesAndGUID(messages) || []));
            }

            findMessagesByTransportGUID(guid){
                return this.api.message().findMessagesByTransportGuid(guid, null, null, 1000).then(messages => {
                    // console.log('findMessagesByTransportGUID',messages)
                    return this.sortByDatesAndGUID(messages.rows);
                })
            }

            findMessagesByTransportGUIDs(guids){
				let p = []
				guids.forEach(guid => {
					p.push(this.findMessagesByTransportGUID(guid))
				});
                return Promise.all(p).then(items =>{
                	let results = [];
                	items.forEach(item => results = results.concat(item));
                    return results;
                });
            }

            _refresh() {
                console.log('refresh')
                if (this.selectList && this.selectList.selection) {
                    this.set('isLoadingMailList', true)
                	let item = this.selectList.selection.item
					if(!['newMsg','Refresh'].includes(item)) this.setListTitle(item);
                    this._actionFromItem(item)
                    this.set('isLabresultBox', (item === "labResult") ? true : false )
                }
                this.dispatchEvent(new CustomEvent('selection-messages-change', { detail: { selection: { item: null } } }));
                this._isRefreshAllowed()
                this._deselectAll();
                this.updateGridElementsSize()
            }

            _actionFromItem(item) {
                if(!item){
                    return
                }
                const a = {
                    newMsg:             this._newMsg,
                    inbox:              this.getInbox,
                    unread:             this.getUnreadEmail,
                    sentbox:            this.getSentMessages,
                    submit:             this.getSubmitMessages,
                    labResult:          this.getLabResult,
                    reportOut:          this.getReport,
                    e_invOut:           this.getEInv,
                    ehealthMessages:    this.getEhealthMessages,
                    e_invIn:            this.getEInvIn,
                    reportIn:           this.getReportIn,
                    eheIn:              this.getEheIn,
                    mycarenet:          this.getMycarenetIn,
                    Chap4In:            this.getChap4In,
                    protIn:             this.getAssigned,
                    unsettedProtIn:     this.getUnassigned,
                    eheOut:             this.getEheOut,
                    protOut:            this.getProtOut,
                    EFactBatch:         this.getEFactBatch,
                    GMD:                this.getGMD,
                    trash:              this.getTrash,
                    hidden:             this.getHidden,
                    Refresh:            null // Fake selection to refresh binding
                }
                this.set('page',1)
                return a[item] && a[item].call(this)
            }

            sortByDates(messages){
				return messages.sort(function (a, b) {
					return b.received - a.received ;
				});
			}

			sortByDatesAndGUID(messages){
				return messages.sort(function (a, b) {
					if(b.received === a.received){
						let bGuid = (b.transportGuid+'').split(":")[1] || "";
						let aGuid = (a.transportGuid+'').split(":")[1] || "";
						return bGuid > aGuid? 1: -1;
                    }
                    else{
                    	return b.received - a.received;
                    }
                });
			}

            getToAddresses(item){
                return item.toAddresses.reduce((acc, i) =>{return acc + ", " + i}, "" )
            }

            click(e) {
                this.set('selectedMessages', this.activeItem);
                this.dispatchEvent(new CustomEvent('selection-messages-change', { detail: { selection: { item: this.selectedMessages } } }));
                // this._deselectAll();
            }

            _deselectMessages() {
                this.set('activeItem', null)
                this.click()
            }

            _itemSelected(e) {
                if (e.path[0].checked) {
                    const checkedMsg = JSON.parse(e.target.dataset.item)
                    if (!this.allSelected) this.push('checkedMessages', checkedMsg)
                } else {
                    this.splice('checkedMessages', this.checkedMessages.indexOf(e.target.dataset.item))
                    this.set('allSelected',false)
                }
                console.log(this.checkedMessages)
            }

            _toggleSelectAll() {
                let mailList = this.shadowRoot.querySelector('#mail-list');
                this.set('allSelected',this.allSelected != null ? !this.allSelected : true)
                this.set('checkedMessages',this.allSelected ? mailList.items : [])
                let allCheckboxes = mailList? mailList.querySelectorAll('.checkbox') : []
                const selectedState = this.allSelected
                allCheckboxes.forEach(box=>{
                    box.checked = selectedState;
                })
            }

            _deselectAll() {
                this.set('allSelected',null)
                let mailList = this.shadowRoot.querySelector('#mail-list');
                let allCheckboxes = mailList? mailList.querySelectorAll('.checkbox') : []
                allCheckboxes.forEach(box=>{
                    box.checked = false;
                })
                this.set('checkedMessages',[])
            }

            _restoreMsgs(){
                const checkedMsgs = this.checkedMessages
                if(checkedMsgs.length) {
                    checkedMsgs.forEach(msg =>{
                        msg.status = msg.status&0<<14
                        this.api.message().modifyMessage(msg).then((m) => {
                            _.assign(msg,m)
                            this.dispatchEvent(new CustomEvent('item-delete', {detail: {selection: {item: "Refresh"}}}))
                            this._refresh()
                        })
                    }) // foreach end
                }
            }

            _hideMsg() {
                let checkedMsgs = this.checkedMessages
                if(checkedMsgs.length) {
                    checkedMsgs.forEach(msg=>{
                        msg.status = msg.status|(1<<14)
                        this.api.message().modifyMessage(msg).then((m)=>{
                            _.assign(msg,m)
                            this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } }))
                            this._refresh()
                        })
                    }) // foreach end
                    this.set('selectedLabFilter',0)
                }
            }

			_msgToBin() {
                let checkedMsgs = this.checkedMessages
                if (checkedMsgs.length) {
                    checkedMsgs.forEach(msg => {
                        const id = msg.transportGuid.substring(msg.transportGuid.indexOf(':') + 1)
                        if (msg.transportGuid.includes('INBOX')) {
                            this.api.fhc().Ehboxcontroller().moveMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, id, 'INBOX', 'BININBOX').then(res=>{
                                if (res) {
                                    msg.transportGuid = 'BININBOX:' + id
                                    this.api.message().modifyMessage(msg).then((m)=> {
                                        _.assign(msg,m)
                                        this.dispatchEvent(new CustomEvent('item-delete', {detail: {selection: {item: "Refresh"}}}))
                                        this._refresh()
                                    })
                                }
                            })
                        }
                        if (msg.transportGuid.includes('SENTBOX')) {
                            this.api.fhc().Ehboxcontroller().moveMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, id, 'SENTBOX', 'BINSENTBOX').then(res=>{
                                if (res) {
                                    msg.transportGuid = 'BINSENTBOX:' + id
                                    this.api.message().modifyMessage(msg).then((m)=> {
                                        _.assign(msg,m)
                                        this.dispatchEvent(new CustomEvent('item-delete', {detail: {selection: {item: "Refresh"}}}))
                                        this._refresh()
                                    })
                                }
                            })
                        }
                    }) // foreach end
                    this.set('selectedLabFilter',0)
                }
            }

            _outOfBin() {
                let checkedMsgs = this.checkedMessages
                if(checkedMsgs.length) {
                    checkedMsgs.forEach(msg => {
                        const id = msg.transportGuid.substring(msg.transportGuid.indexOf(':') + 1)
                        if (msg.transportGuid.includes('INBOX')) {
                            msg.transportGuid = 'INBOX:' + id
                            this.api.message().modifyMessage(msg).then((m)=>{
                                _.assign(msg,m)
                                this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } }))
                                this._refresh()
                            })
                        }
                        if (msg.transportGuid.includes('SENTBOX')) {
                            msg.transportGuid = 'SENTBOX:' + id
                            this.api.message().modifyMessage(msg).then((m)=>{
                                _.assign(msg,m)
                                this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } }))
                                this._refresh()
                            })
                        }
                    }) // foreach end
                }
            }

            _deleteMsgsForever() {
                const checkedMsgs = this.checkedMessages
                if (checkedMsgs.length) {
                    let inboxIds = []
                    let sentboxIds = []

                    checkedMsgs.forEach(msg=>{
                        const id = msg.transportGuid.substring(msg.transportGuid.indexOf(':')+1)
                        if (msg.transportGuid.includes('INBOX')) inboxIds.push(id)
                        if (msg.transportGuid.includes('SENTBOX')) sentboxIds.push(id)
                    })

                    if (inboxIds.length){
                        // this.api.fhc().Ehboxcontroller().moveMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [inboxIds], 'INBOX', 'BININBOX').then(()=>{
                            this.api.fhc().Ehboxcontroller().deleteMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [inboxIds], 'BININBOX')
                                .then(()=>this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } })))
                                    .then(()=>this._refresh())
                        // })
                    }
                    if (sentboxIds.length) {
                        // this.api.fhc().Ehboxcontroller().moveMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [sentboxIds], 'SENTBOX', 'BINSENTBOX').then(()=>{
                            this.api.fhc().Ehboxcontroller().deleteMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [sentboxIds], 'BINSENTBOX')
                                .then(()=>this.dispatchEvent(new CustomEvent('item-delete', { detail: { selection: { item: "Refresh" } } })))
                                    .then(()=>this._refresh())
                        // })
                    }
                }
            }

            _isEqual(a,b) {return (a === b)}

            _timeFormat(date) {
                return date && this.api.moment(date).format('DD/MM/YYYY') || '';
            }

			_activeItemChanged(item){
                let mailList = this.shadowRoot.querySelector('#mail-list');
                if(mailList) mailList.selectedItems = item ? [item] : [];
            }

            setListTitle(title){
            	this.set("listTitle",this.localize("boxtitle." + title,'List',this.language))
            }

            _displayRestoreButton(){
                return (this.selectList.selection.item == 'trash')
            }

            updateGridElementsSize() {
                const grid = this.shadowRoot.getElementById('mail-list')
                grid && grid.notifyResize()
            }

		}

        customElements.define(HtMsgList.is, HtMsgList);
    </script>
</dom-module>
